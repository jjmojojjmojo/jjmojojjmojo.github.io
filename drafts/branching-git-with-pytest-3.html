<!DOCTYPE html>
<html lang="en">
<head>
<!-- Open Graph / Facebook -->
<meta content="website" property="og:type"/>
<meta content="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html" property="og:url"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3 - The Collected Works of jjmojojjmojo " property="og:title"/>
<meta content="https://jjmojojjmojo.github.io/theme/images/default-social-full.jpg" property="og:image"/>
<!-- Twitter -->
<meta content="summary_large_image" property="twitter:card"/>
<meta content="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html" property="twitter:url"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3 - The Collected Works of jjmojojjmojo " property="twitter:title"/>
<meta content="https://jjmojojjmojo.github.io/theme/images/default-social-full.jpg" property="twitter:image"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3 - The Collected Works of jjmojojjmojo " name="title"/>
<meta content="https://jjmojojjmojo.github.io/theme/images/default-social-full.jpg" property="og:image"/>
<meta content="https://jjmojojjmojo.github.io/theme/images/default-social-full.jpg" property="twitter:image"/>
<title>   Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3 - The Collected Works of jjmojojjmojo 
</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://jjmojojjmojo.github.io/theme/css/main.css" rel="stylesheet" type="text/css"/>
<link href="https://jjmojojjmojo.github.io/theme/css/syntax-solarized-light.css" id="highlight-css" rel="stylesheet" type="text/css"/>
<script src="https://jjmojojjmojo.github.io/theme/js/zepto.min.js"></script>
<link href="https://jjmojojjmojo.github.io/feeds/all.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Full Atom Feed" type="application/atom+xml"/>
<link href="https://jjmojojjmojo.github.io/feeds/all.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Full RSS Feed" type="application/rss+xml"/>
<link href="https://jjmojojjmojo.github.io/feeds/category.tutorial.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Categories Atom Feed" type="application/atom+xml"/>
<link href="https://jjmojojjmojo.github.io/feeds/category.tutorial.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Categories RSS Feed" type="application/rss+xml"/>
<meta content="This is part three of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" name="description"/>
<meta content="This is part three of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" property="og:description"/>
<meta content="This is part three of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" property="twitter:description"/>
<meta content="python" name="tags"/>
<meta content="git" name="tags"/>
<meta content="branching" name="tags"/>
<meta content="development process" name="tags"/>
</head>
<body class="home" id="index">
<header class="body" id="banner">
<h1><a href="https://jjmojojjmojo.github.io/"><img id="header-home-icon" src="/theme/icons/home.svg"/> <span id="header-site-title">The Collected Works of jjmojojjmojo <strong></strong></span></a></h1>
<ul id="menu">
<li><a href="https://jjmojojjmojo.github.io/pages/about.html">About</a></li>
<li><a href="https://jjmojojjmojo.github.io/pages/contact.html">Contact</a></li>
<li><a href="https://jjmojojjmojo.github.io/pages/index.html">Pages</a></li>
<li><a href="https://jjmojojjmojo.github.io/categories.html">Categories</a></li>
<li><a href="https://jjmojojjmojo.github.io/tags.html">Tags</a></li>
</ul>
<span id="settings-button">
<a href="https://jjmojojjmojo.github.io/pages/settings.html" title="Settings">
<img alt="Gear Icon For Settings" src="/theme/icons/settings.svg"/>
</a>
</span>
</header><!-- /#banner -->
<div id="notice">
<div id="notice-content">
<div style="text-align: center">
<big>ðŸ¦„</big> <strong>Hiring?</strong> Josh is looking for work! <a href="https://jjmojojjmojo.github.io/pages/hire-me.html">More info</a>. <big>ðŸ¦„</big>
</div> </div>
</div>
<div id="content-wrapper">
<section class="body" id="content">
<header>
<h2 class="entry-title">
<a href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html" rel="bookmark" title="Permalink to Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3">Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 3</a></h2>
</header>
<footer class="post-info">
<time class="published" datetime="2019-07-03T09:00:00-04:00">
      Wed 03 July 2019
    </time>
<address class="vcard author">
      By           <a class="url fn" href="https://jjmojojjmojo.github.io/author/jjmojojjmojo.html">jjmojojjmojo</a>
</address>
</footer><!-- /.post-info -->
<div>
<div id="toc"><ul><li><a class="toc-href" href="#setup" title="Setup">Setup</a></li><li><a a="" add="" and="" another="" bug="" class="toc-href" feature="" fix="" href="#let" on="" s="" some="" step="" title="Let" toes="">Let's Add A Feature, Fix Another Bug, and Step On Some Toes!</a></li><li><a class="toc-href" href="#clone two copies of the repository" title="Clone Two Copies Of The Repository">Clone Two Copies Of The Repository</a></li><li><a class="toc-href" href="#develper a builds a new feature: quote of the day" title="Develper A Builds A New Feature: Quote Of The Day">Develper A Builds A New Feature: Quote Of The Day</a></li><li><a class="toc-href" href="#developer b fixes a bug and deals with a git conflict" title="Developer B Fixes A Bug And Deals With a Git Conflict">Developer B Fixes A Bug And Deals With a Git Conflict</a></li><li><a class="toc-href" href="#merge, now with problems" title="Merge, Now With Problems">Merge, Now With Problems</a></li><li><a class="toc-href" href="#tag the fixed version" title="Tag The Fixed Version">Tag The Fixed Version</a></li><li><a class="toc-href" href="#conclusion" title="Conclusion">Conclusion</a></li><li><a class="toc-href" href="#resources, what to do if you messed up" title="Resources, What To Do If You Messed Up">Resources, What To Do If You Messed Up</a></li></ul></div>
</div>
<div class="warning">
<h2>WARNING</h2>
  You are viewing a <strong>draft</strong> document. It may contain inaccurate, misleading, or unvetted information.
  </div>
<div class="entry-content status-draft">
<!-- Emoji substitutions, because I can't help myself (and my editor doesn't show -->
<!-- emoji for some reason - better to do this since I can replace these with -->
<!-- icons or whatever I want) -->
<p><strong>This is part three of a three-part series.</strong> This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using <a class="reference external" href="https://docs.pytest.org">pytest</a> and <a class="reference external" href="https://git-scm.com/">git</a>, via feature branches. Along the way we'll touch on application design and discuss best practices.</p>
<p>In this installment, we will:</p>
<ul class="simple">
<li>Simulate collaborative work by two developers.</li>
<li>Use the workflow we learned in <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a> to add a new feature, and fix a new bug.</li>
<li>Create a merge conflict and resolve it.</li>
</ul>
<!-- PELICAN_END_SUMMARY -->
<div class="section" id="setup">
<h2 id="setup">Setup</h2>
<p>As with part 2, you will need to make sure you've got everything set up as outlined in <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html#setup">part 1</a>, and have merged the changes made in <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a> to <code>master</code>.</p>
<p>Here's a condensed summary:</p>
<ol class="arabic">
<li><p class="first">Ensure you have git, python 3.7+, and venv installed.</p>
</li>
<li><p class="first">Make a bare clone of the base repository to act as our <em>remote</em>:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git clone --bare https://github.com/jjmojojjmojo/random_quote.git random_quote_remote
</pre></div>
</li>
<li><p class="first">Clone our remote:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git clone random_quote_remote random_quote
</pre></div>
</li>
<li><p class="first">Initialize the virtual environment, and install our requirements and project:</p>
<div class="highlight"><pre><span></span><span class="gp">  $</span> <span class="nb">cd</span> random_quote
<span class="gp">  $</span> python -m venv .
<span class="gp">  $</span> <span class="nb">source</span> bin/activate
<span class="go">  (random_quote) $ pip install -r requirements.txt</span>
<span class="go">  (random_quote) $ pip install -e .</span>
</pre></div>
</li>
<li><p class="first">Initialize the database, add some randomly generated quotes:</p>
<div class="highlight"><pre><span></span><span class="go">  (random_quote) $ python scripts/generate_quotes.py</span>
<span class="go">  (random_quote) $ python</span>
<span class="go">  &gt;&gt;&gt; from random_quote import util</span>
<span class="go">  &gt;&gt;&gt; util.init("test.db")</span>
<span class="go">  util.ingest("quotes.csv", "test.db")</span>
</pre></div>
</li>
<li><p class="first">Add the changes from <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html">part 1</a> and <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a>. If you had trouble or would like to skip all of that, you can simply checkout the <code>part2</code> branch</p>
</li>
</ol>
<p>Note that you will have to do this to <em>each</em> clone <em>a</em> and <em>b</em> below.</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="gp">  $</span> <span class="nb">cd</span> ../a
<span class="gp">  $</span> git checkout part2
<span class="gp">  $</span> <span class="nb">cd</span> ../b
<span class="gp">  $</span> git checkout part2
</pre></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>ðŸŒˆ We have branches for all of the major work done in the series:</p>
<dl class="docutils">
<dt><code>part1</code></dt>
<dd>All the changes from <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html">part 1</a>.</dd>
<dt><code>part2</code></dt>
<dd>All the changes from <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html">part 1</a> and
<a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a></dd>
<dt><code>qotd</code></dt>
<dd>Developer <strong>A</strong>'s feature from <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html">part 3</a>.</dd>
<dt><code>index-info</code></dt>
<dd>Developer <strong>B</strong>'s bug fix from <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html">part 3</a>.</dd>
<dt><code>part3</code></dt>
<dd>All the changes from <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html">part 1</a>,
<a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a> <em>and</em> <a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-3.html">part 3</a>!</dd>
</dl>
<p>Feel free to <code>git checkout</code> if you need to reset your code, or jump around.</p>
<p class="last">Use <code>git stash</code> to keep any uncomitted changes for latter. See <a class="reference external" href="https://git-scm.com/book/en/v1/Git-Tools-Stashing">the git documentation</a> for more information. ðŸ¦„</p>
</div>
</blockquote>
</div>
<div class="section" id="let-s-add-a-feature-fix-another-bug-and-step-on-some-toes">
<h2 id="let's add a feature, fix another bug, and step on some toes!">Let's Add A Feature, Fix Another Bug, and <em>Step On Some Toes</em>!</h2>
<p>In this part of the guide, we're going to simulate two developers working on different tasks in the same code base.</p>
<p>Developer <strong>"A"</strong> will be adding a new feature: "Quote of the Day".</p>
<p>This feature has the following requirements:</p>
<ul class="simple">
<li>Each day, a new random quote is selected, and made available at <code>/</code></li>
<li>The quote is saved, and a list of historical quotes can be seen at <code>/qotd</code></li>
</ul>
<p>Developer <strong>"B"</strong> will be fixing a bug: "Root is a 404".</p>
<p>This bug is more of an oversight. Remember when we first tested the app, visiting <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> would return a 404 "Not Found" error. This is not a great practice, even though it's technically true, since there is really no resource located at <code>/</code>. Most people expect to see some sort of information at the root of a website.</p>
<p>So to fix this bug, developer B will be writing up a little info about what HTTP API endpoints are available to be served when a request for <code>/</code> comes in.</p>
<p>The astute reader might notice that these two tasks are in <em>conflict</em>. Both developers are changing what a request for <code>/</code> returns.</p>
<p>This is good for us, because this makes it possible to walk through how to deal with conflicts ðŸ˜€.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In real life, this situation would have been avoided through <strong>basic communication</strong>.</p>
<p>The API is something that shouldn't be altered lightly, and so a discussion amongst developers <em>should</em> happen whenever it's going to change.</p>
<p class="last">However, things like this do happen from time to time. ðŸ¦„</p>
</div>
<p>Before we begin, lets deactivate our virtual environment:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> deactivate
<span class="gp">$</span>
</pre></div>
</div>
<div class="section" id="clone-two-copies-of-the-repository">
<h2 id="clone two copies of the repository">Clone Two Copies Of The Repository</h2>
<p>To get started, lets clone two fresh copies of our <code>random_quote_remote</code> bare repository that we made earlier. We'll call them simply <code>a</code> and <code>b</code> so we don't get confused ðŸ˜Ž.</p>
<p>Let's make sure we're in the correct directory.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ..
<span class="gp">$</span> ls
<span class="go">random_quote</span>
<span class="go">random_quote_remote</span>
</pre></div>
<p>We can see from the output of <code>ls</code> that our original checkout is present, and the special bare copy we made to use as a remote is there as well.</p>
<p>Next, we'll <code>git clone</code> the remote twice.</p>
<p>Make a copy for developer <strong>A</strong>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git clone random_quote_remote a
<span class="go">Cloning into 'a'...</span>
<span class="go">done.</span>
</pre></div>
<p>And another for developer <strong>B</strong>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git clone random_quote_remote b
<span class="go">Cloning into 'b'...</span>
<span class="go">done.</span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have opted to skip following <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest.html">part 1</a> and
<a class="reference external" href="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html">part 2</a>, you'll need to <code>git checkout part2</code> in each repository before proceeding.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>We're going to work on the feature first, then the bug, so things shouldn't be too confusing. Pay attention to the shell prompt in the examples, when the <code>venv</code> virtual environment is active, the prompt changes to the name of the directory. We've carried the prompt changes through to the examples in this guide, so you'll know what clone you're working on:</p>
<p><strong>Developer A</strong>:</p>
<div class="highlight"><pre><span></span><span class="go"> (a) $</span>
</pre></div>
<p><strong>Developer B</strong>:</p>
<div class="last"><div class="highlight"><pre><span></span><span class="go"> (b) $</span>
</pre></div>
</div></div>
</div>
<div class="section" id="develper-a-builds-a-new-feature-quote-of-the-day">
<h2 id="develper a builds a new feature: quote of the day">Develper <em>A</em> Builds A New Feature: Quote Of The Day</h2>
<p>As we discussed when covering the feature requirements, we want our code to have an end point that will always return the "quote of the day" for each 24-hour period. We'd also like to keep a historical record of all the previous quotes that were saved.</p>
<p>There are a few ways to approach this, but there are two sub-features that need to be designed:</p>
<ol class="arabic simple">
<li>Generating a random quote every day.</li>
<li>Keeping historical records of past quotes.</li>
</ol>
<div class="section" id="first-lets-branch">
<h3>First, Lets Branch</h3>
<p>In repository <code>a</code>, create a new branch called <code>qotd</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> a
<span class="gp">$</span> git checkout -b qotd
<span class="go">Switched to a new branch 'qotd'</span>
</pre></div>
</div>
<div class="section" id="init">
<h3>Init</h3>
<p>Remember that since this is a fresh clone, we'll need to initialize the virtual environment.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> python -m venv .
<span class="gp">$</span> <span class="nb">source</span> bin/activate
<span class="gp">(a) $</span> pip install -r requirements.txt
<span class="gp">(a) $</span> pip install -e .
</pre></div>
<p>Next, copy the database file from your other clone:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> cp ../random_quote/test.db .
</pre></div>
<p>Or initialize a new one:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> python scripts/generate_quotes.py
<span class="gp">(random_quote) $</span> python
<span class="gp">&gt;</span>&gt;&gt; from random_quote import util
<span class="gp">&gt;</span>&gt;&gt; util.init<span class="o">(</span><span class="s2">"test.db"</span><span class="o">)</span>
<span class="go">util.ingest("quotes.csv", "test.db")</span>
</pre></div>
</div>
<div class="section" id="design-daily-quotes">
<h3>Design: Daily Quotes</h3>
<p>Off hand, a few possibilities exist for handling this. ðŸ¤”</p>
<p>We could:</p>
<ol class="arabic simple">
<li>Define a process, that, at midnight each night, uses the <code>RandomQuoteManager</code> to select a random quote. This would happen outside of the application or people using it. It could be a manual process, or <a class="reference external" href="https://en.wikipedia.org/wiki/Cron">automated as a scheduled job or task</a>.</li>
<li>Write a function that will pre-generate random quotes for each day of a given time period. This could also be run by a human, or automated to happen on a given interval (once a year, once a month, etc).</li>
<li>Wait until a quote of the day is requested, generate it on demand and return it, or return the current quote of the day if it's already been generated.</li>
</ol>
<p>The first two possibilities have advantages when the historical listing of previous quotes of the day is important. There will be a quote for every day, and if users need that, those approaches are more useful. In either case, there will never be a day (unless the process or function doesn't run or cover a particular day) where a quote isn't generated.</p>
<p>On the other hand, generating quotes on demand means that we'll only ever have quotes for days when <em>at least one user</em> requested a quote of the day. The advantage to this is that we never store more data than we need to. The down-side is that we can't count on any given day to have a quote. If our API has a lot of use, it may never be an issue, but there will likely always be holes in the data. As before, it really depends on how the historical quotes are used.</p>
<p>There are other considerations as well. Generating the quote on demand means that the quote generation happens at most once per day (but also <em>at least</em> once per day), whereas the other two options can batch the load of generating quotes. In option 2, we could generate <em>thousands</em> of days of quotes if we wanted to, all at once. In this way, pre-populating the quotes moves the burden of generating a quote away from the process of a user requesting a quote of the day. This keeps the API from becoming less responsive.</p>
<p>Our app is doing simple things, and generating a random quote is a pretty quick process. So the impact on users, even if a special quote of the day was generated for every single one, every day, would be minimal. In other applications, pre-loading is preferred, because the cost of generating the data that's being provided to the user can be higher and can impact their ability to effectively use the application. You don't want the fact that you're generating data on the fly to make your API less responsive.</p>
<p>All that considered, our use case is simple, and our process for making a quote of the day will be lightweight, so we'll opt to generate our quote of the day on the fly, as needed. We'll build the functionality such that it's easy to automate this process later if generating a quote becomes more expensive, thus getting the best of both worlds.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>One other thing we can do that might help is use <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">the HTTP caching headers</a> to tell clients that they only need to make a new request to the quote of the day endpoint once per day.</p>
<p class="last">This is out of scope for this guide, but something to always consider when building web applications. ðŸŒˆ</p>
</div>
</div>
<div class="section" id="design-past-quotes-of-the-day">
<h3>Design: Past Quotes Of The Day</h3>
<p>The other aspect of this feature is keeping old quotes around after the day they're generated.</p>
<p>Since we're already using a relational database, it's a good candidate for storing quotes of the day.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This may seem obvious, but it's another important thing to remember: just because we're already using a certain pattern or method of storing data, it doesn't automatically make it the <em>best</em> pattern or method. ðŸ˜Ž</p>
</div>
<p>We can add a new table, called <code>quote_of_the_day</code> to store each generated quote. We'll query that database table and use SQL to return the right quote for the current day.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">We are building a rudimentary <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_(computing)">cache</a> here. This pattern is extremely useful in application development, especially web development.</p>
</div>
<p>Here's our updated ER diagram:</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/er-diagram-second-pass.png"/>
</div>
<p>The new <code>quote_of_the_day</code> table consists of four columns:</p>
<ul class="simple">
<li><code>quote_id</code>, an integer, the ID of the quote that was selected. We'll put a <a class="reference external" href="https://en.wikipedia.org/wiki/Foreign_key">foreign key constraint</a> on the <code>id</code> column in the <code>quotes</code> table</li>
</ul>
<p>The other three columns will encode the day, month and year:</p>
<ul class="simple">
<li><code>day</code>, integer, the day of the month (1-31)</li>
<li><code>month</code>, integer, the month (1-12)</li>
<li><code>year</code>, integer, the year (e.g. 2019)</li>
</ul>
<p>We'll put a <a class="reference external" href="https://en.wikipedia.org/wiki/Unique_key">unique constraint</a> on these three columns - this prevents anyone from inserting a second quote of the day for any given month/day/year.</p>
<p>By using three columns, we have a few benefits:</p>
<ul>
<li><p class="first">Integers are (usually) stored in a form that takes up less space/memory.</p>
</li>
<li><p class="first">We can easily get all the quotes for a given month, or year by just using a <code>WHERE</code> clause</p>
<blockquote>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">-- Get all quote id's from March of 2025</span>
<span class="k">SELECT</span> <span class="n">quote_id</span> <span class="k">FROM</span> <span class="n">qote_of_the_day</span> <span class="k">WHERE</span> <span class="k">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="k">year</span><span class="o">=</span><span class="mi">2025</span>
</pre></div>
</td></tr></table></div></blockquote>
</li>
<li><p class="first">There's no need to worry about the <em>time</em> portion of the typical date-time storage format (<a class="reference external" href="https://en.wikipedia.org/wiki/ISO_8601">ISO8601</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Julian_calendar">Julian</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Unix_time">Unix</a>). This means we don't have to be concerned with timezones, or what happens when a <a class="reference external" href="https://en.wikipedia.org/wiki/Locale_(computer_software)">locale</a> difference makes a given time occur on a different calendar day.</p>
</li>
</ul>
<p>The SQL needed to generate the new table looks like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">quote_of_the_day</span> <span class="p">(</span>
    <span class="n">quote_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">day</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">month</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">year</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">quote_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">quotes</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="k">UNIQUE</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="k">month</span><span class="p">,</span> <span class="k">year</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="design-api-endpoints">
<h3>Design: API Endpoints</h3>
<p>Our new feature will require two new endpoints:</p>
<ul class="simple">
<li>a GET request to <code>/</code> will show the quote of the day (and create it if it's not present), as a single JSON object.</li>
<li>a GET request to <code>/qotd</code> will return a JSON list of quote objects that were previously generated.</li>
</ul>
</div>
<div class="section" id="implementation-quote-of-the-day-api">
<h3>Implementation: Quote Of The Day API</h3>
<p>We'll opt to create a new psuedo-manager class, called <code>QuoteOfTheDay</code>. It will be responsible for retrieving a quote for a given day. It will retrieve an existing quote if one is present, generate a new one and save it if not. The default will be the current day, but it will be possible to create or retrieve a quote for <em>any</em> day in the same manner.</p>
<p>For convenience, we'll add an instance of <code>QuoteOfTheDay</code> to <code>RandomQuoteManager</code>, as the <code>qotd</code> property.</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/application-overview-second-pass.png"/>
</div>
<p>Before we start, we need to add the new table to our <code>test.db</code> file. First, add the following to <code>src/random_quote/schema.sql</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">quote_of_the_day</span> <span class="p">(</span>
    <span class="n">quote_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">day</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">month</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">year</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">quote_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">quotes</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="k">UNIQUE</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="k">month</span><span class="p">,</span> <span class="k">year</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</td></tr></table></div><p>Next we'll use our <code>util.init()</code> function, as we did when originally setting up the database:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> python
<span class="gp">&gt;</span>&gt;&gt; from random_quote.util import init
<span class="gp">&gt;</span>&gt;&gt; init<span class="o">(</span><span class="s2">"test.db"</span><span class="o">)</span>
<span class="gp">&gt;</span>&gt;&gt; quit<span class="o">()</span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We can re-run <code>init()</code> as often as we like because of the <code>IF NOT EXISTS</code> clause in <code>CREATE TABLE</code> and <code>CREATE INDEX</code>. Otherwise, we'd have to either <code>DROP</code> the old tables/index first, or run each <code>CREATE</code> statement separately.</p>
</div>
<p>Now we can add the code for our <code>QuoteOfTheDay</code> class. We'll place this in a new <code>src/random_quote/qotd.py</code> module.</p>
<p>Here's the code you need to add.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">Generate a random quote of the day.</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>

<span class="k">class</span> <span class="nc">QuoteOfTheDay</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_filename</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.manager</span> <span class="kn">import</span> <span class="n">RandomQuoteManager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span>  <span class="o">=</span> <span class="n">RandomQuoteManager</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_date_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Helper method to convert a date to the day/month/year that is</span>
<span class="sd">        stored in the database.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return the quote of the day for a given date, or the current date</span>
<span class="sd">        if one isn't specified.</span>

<span class="sd">        If no quote exists for that date, one is generated and saved.</span>
<span class="sd">        """</span>
        <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_parts</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">                  SELECT quotes.quote,</span>
<span class="s2">                         quotes.created,</span>
<span class="s2">                         qotd.quote_id,</span>
<span class="s2">                         qotd.day,</span>
<span class="s2">                         qotd.month,</span>
<span class="s2">                         qotd.year</span>
<span class="s2">                    FROM quotes, quote_of_the_day as qotd</span>
<span class="s2">                   WHERE quotes.id = qotd.quote_id</span>
<span class="s2">                     AND day=?</span>
<span class="s2">                     AND month=?</span>
<span class="s2">                     AND year=?</span>
<span class="s2">                  """</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Add a quote of the day for a given date, or the current date</span>
<span class="sd">        if one isn't specified.</span>
<span class="sd">        """</span>
        <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_parts</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

        <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">            INSERT INTO quote_of_the_day</span>
<span class="s2">                        (quote_id, day, month, year)</span>
<span class="s2">                 VALUES (?, ?, ?, ?)</span>
<span class="s2">           """</span><span class="p">,</span>
           <span class="p">(</span><span class="n">quote</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">'quote_id'</span><span class="p">:</span> <span class="n">quote</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span>
            <span class="s1">'quote'</span><span class="p">:</span> <span class="n">quote</span><span class="p">[</span><span class="s1">'quote'</span><span class="p">],</span>
            <span class="s1">'created'</span><span class="p">:</span> <span class="n">quote</span><span class="p">[</span><span class="s1">'created'</span><span class="p">],</span>
            <span class="s1">'day'</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span>
            <span class="s1">'month'</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span>
            <span class="s1">'year'</span><span class="p">:</span> <span class="n">year</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Retrieve all existing quotes of the day.</span>
<span class="sd">        """</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">                  SELECT quotes.quote,</span>
<span class="s2">                         quotes.created,</span>
<span class="s2">                         qotd.quote_id,</span>
<span class="s2">                         qotd.day,</span>
<span class="s2">                         qotd.month,</span>
<span class="s2">                         qotd.year</span>
<span class="s2">                    FROM quotes, quote_of_the_day as qotd</span>
<span class="s2">                   WHERE quotes.id = qotd.quote_id</span>
<span class="s2">                ORDER BY qotd.year, qotd.month, qotd.day</span>
<span class="s2">                  """</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>We implement <code>QuoteOfTheDay</code> as a class.</p>
<p>The constructor, <code>__init__()</code> take two parameters. The first, like <code>RandomQuoteManager</code> and <code>RandomQuoteApp</code> is the path to the sqlite database file.</p>
<p>The second parameter is an optional <code>RandomQuoteManager</code> instance. If one is provided, it is used as-is. However, if that parameter is omitted, a new instance is created using the passed-in database file.</p>
<p><code>RandomQuoteManager</code> will have a corresponding optional <code>QuoteOfTheDay</code> instance, so the constructor uses a <em>conditional import</em> to prevent issues with a never-ending import cycle. If <code>random_quote.manager</code> imports <code>random_quote.qotd</code> and <code>random_quote.qotd</code> imports <code>random_quote.manager</code> in their module scope, it creates a sort of infinite loop of imports.</p>
<p>We use this <code>RandomQuoteManager</code> instance to get a random quote in the <code>add()</code> method.</p>
<p>In both cases, the corresponding instance is used to provide an extended API. This is a simplistic form of <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a>, allowing the user to configure their <code>RandomQuoteManager</code> to their liking before passing it, or providing a completely different kind of object that implements the same interface.</p>
<p>The rest of the module should be fairly self-explanatory.</p>
<p>One important thing to note is that the <code>get()</code> method automatically calls <code>add()</code> in the event that no quote of the day is found for the given date.</p>
</div>
<p>We'll also need to add an import to <code>src/random_quote/__init__.py</code>, so we can access <code>QuoteOfTheDay</code> from the <code>random_quote.qotd</code> module:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">manager</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">wsgi</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">qotd</span>
</span></pre></div>
</td></tr></table></div><p>Next we'll add the <code>qotd</code> property to <code>RandomQuoteManager</code> via it's constructor, in <code>src/random_quote/manager.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">API code for dealing with the quote database.</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.qotd</span> <span class="kn">import</span> <span class="n">QuoteOfTheDay</span>
</span>
<span class="n">RAND_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="n">RAND_MAX</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>

<span class="k">class</span> <span class="nc">RandomQuoteManager</span><span class="p">:</span>
<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_filename</span><span class="p">,</span> <span class="n">qotd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">qotd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span> <span class="o">=</span> <span class="n">QuoteOfTheDay</span><span class="p">(</span><span class="n">db_filename</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span> <span class="o">=</span> <span class="n">qotd</span>
</span>
<span class="o">...</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This change allows for API extension and <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> that is similar to (and complements) the implementation of <code>QuoteOfTheDay.__init__()</code>.</p>
</div>
<p>It's a good idea to make a commit after this work is done. This should be second nature by now, but lets walk through the steps, since we're doing something new: adding an untracked file.</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git status
<span class="go">On branch qotd</span>
<span class="go">Changes not staged for commit:</span>
<span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="go">  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>

<span class="go">    modified:   src/random_quote/__init__.py</span>
<span class="go">    modified:   src/random_quote/schema.sql</span>
<span class="go">    modified:   src/random_quote/manager.py</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="hll"><span class="go">    src/random_quote/qotd.py</span>
</span><span class="go">    test.db</span>

<span class="go">no changes added to commit (use "git add" and/or "git commit -a")</span>
</pre></div>
<p>Note that we now have a file we care about in the <code>Untracked files</code> section, <code>src/random_quote/qotd.py</code>.</p>
<p>We have to <code>git add</code> it in order to get it into our commit:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git add src/random_quote/qotd.py
</pre></div>
<p>Now, <code>git status</code> shows <code>src/random_quote/qotd.py</code> as a new file:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git status
<span class="go">On branch qotd</span>
<span class="go">Changes to be committed:</span>
<span class="go">  (use "git reset HEAD &lt;file&gt;..." to unstage)</span>

<span class="hll"><span class="go">    new file:   src/random_quote/qotd.py</span>
</span>
<span class="go">Changes not staged for commit:</span>
<span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="go">  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>

<span class="go">    modified:   src/random_quote/__init__.py</span>
<span class="go">    modified:   src/random_quote/manager.py</span>
<span class="go">    modified:   src/random_quote/schema.sql</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    test.db</span>
</pre></div>
<p>Now <code>git commit</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git commit -a -m<span class="s2">"Added first-pass of quote of the day functionality"</span>
<span class="go">[qotd 53ae911] Added first-pass of quote of the day functionality</span>
<span class="go"> 4 files changed, 132 insertions(+), 3 deletions(-)</span>
<span class="go"> create mode 100644 src/random_quote/qotd.py</span>
</pre></div>
</div>
<div class="section" id="back-end-api-tests">
<h3>Back-End API Tests</h3>
<p>We'll put the main quote of the day tests in <code>src/random_quote/tests/test_qotd.py</code>.</p>
<p>We'll make use of the <code>preconfigured_manager()</code> fixture. This will use <code>fix_random()</code>, and populate the database with some quotes for us.</p>
<p>Then add the tests to <code>src/random_quote/tests/test_qotd.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">Test the "Quote of the day" functionality.</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">def</span> <span class="nf">get_quote_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Helper function to get a quote id for the given day/month/year</span>
<span class="sd">    """</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT quote_id FROM quote_of_the_day WHERE day = ? AND month = ? AND year = ?"</span><span class="p">,</span> <span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_add_qotd</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Add a new quote of the day, for the current day.</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">get_quote_id</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">check</span> <span class="o">==</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote_id"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_add_qotd_with_date</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Add a new quote of the day, for a given day.</span>
<span class="sd">    """</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">get_quote_id</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2025</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">check</span> <span class="o">==</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote_id"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_add_duplicate</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Try to add an additional quote of the day.</span>
<span class="sd">    """</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">):</span>
        <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_without_date</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get a quote of the day, no date specified. Should create a new QOTD.</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">get_quote_id</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">check</span> <span class="o">==</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote_id"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_get_with_date</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get a quote of the day, for a specified date. Should create a new QOTD.</span>
<span class="sd">    """</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">get_quote_id</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2025</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">check</span> <span class="o">==</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote_id"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_all</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Add and retrieve several quotes of the day.</span>
<span class="sd">    """</span>
    <span class="n">date1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">date2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">date1</span>
    <span class="n">date3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">date2</span>

    <span class="n">quote1</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date1</span><span class="p">)</span>
    <span class="n">quote2</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date2</span><span class="p">)</span>
    <span class="n">quote3</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date3</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote2</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote3</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This test suite is fairly self-explanatory.</p>
<p>The common theme with the test cases is that each test uses the current date or a specific date to identify if a quote is being stored. The <code>get_quote_id()</code> helper function assists with this.</p>
<p>Essentially, we're running each test, and then checking the database to see if the expected record was inserted.</p>
</div>
<p>Lets also add a new test case to <code>src/random_quote/tests/test_manager.py</code> to make sure that the <code>qotd</code> property exists:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>75
76
77
78
79
80
81</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_qotd</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Ensure the qotd property exists.</span>
<span class="sd">    """</span>
    <span class="kn">from</span> <span class="nn">random_quote.qotd</span> <span class="kn">import</span> <span class="n">QuoteOfTheDay</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">qotd</span><span class="p">,</span> <span class="n">QuoteOfTheDay</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Run the tests:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> pytest src
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0</span>
<span class="go">rootdir: [...]/a</span>
<span class="go">collected 17 items</span>

<span class="go">src/random_quote/tests/test_manager.py .......                            [ 41%]</span>
<span class="go">src/random_quote/tests/test_qotd.py ......                                [ 76%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ....                                  [100%]</span>

<span class="go">=========================== 17 passed in 0.20 seconds ===========================</span>
</pre></div>
<p>Now, <code>git add</code> the <code>src/random_quote/tests/test_qotd.py</code> file, and commit.</p>
</div>
<div class="section" id="implementation-web-api-endpoints">
<h3>Implementation: Web API Endpoints</h3>
<p>Here's the updated path map:</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/path-map-second-pass.png"/>
</div>
<p>To implement the quote of the day functionality in <code>RandomQuoteApp</code>, we'll add the methods <code>qotd()</code> and <code>qotd_listing()</code> which will return the current quote of the day, or all quotes of the day, respectively:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">qotd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return today's quote of the day.</span>
<span class="sd">        """</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

        <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">qotd_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        List all existing quotes of the day.</span>
<span class="sd">        """</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

        <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table></div><p>Then we need to update the routing, in <code>__call__()</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
<span class="hll">            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
</span><span class="hll">                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="hll">            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/qotd"</span><span class="p">:</span>
</span><span class="hll">                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd_listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="hll">            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/quotes"</span><span class="p">:</span>
</span>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/quote"</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/random"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>We can run the http server again and try it out in our browser:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<p>If you look at <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>, you'll notice a quote of the day is returned, instead of a 404:</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-root-second-pass.png"/>
</div>
<p>And loading <a class="reference external" href="http://127.0.0.1:8080/qotd">http://127.0.0.1:8080/qotd</a> returns a list, showing the quote that was just generated:</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-qotd-first-pass.png"/>
</div>
</div>
<div class="section" id="tests-for-the-web-api">
<h3>Tests For The Web API</h3>
<p>Now we need to add tests to <code>src/random_quote/tests/test_wsgi.py</code>. First we need to add a necessary import, since we're going to be using some functions from <code>datetime</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">Functional tests of the WSGI application.</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="hll"><span class="kn">import</span> <span class="nn">datetime</span>
</span></pre></div>
</td></tr></table></div><p>Then add three new tests to the bottom of the file:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_root</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for /</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>

    <span class="n">json_quote</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json_quote</span> <span class="o">==</span> <span class="n">quote</span>

<span class="k">def</span> <span class="nf">test_qotd_empty</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd - no existing quotes</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="n">quotes</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">test_qotd</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote1</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
    <span class="n">quote2</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">26</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote1</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote2</span>
</pre></div>
</td></tr></table></div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">To quit <code>gunicorn</code>, type control-C.</p>
</div>
<p>Running the tests, we see the new ones have been picked up:</p>
<div class="highlight"><pre><span></span><span class="go">(a) pytest -v src</span>
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0 -- [...]/a/bin/python</span>
<span class="go">cachedir: .pytest_cache</span>
<span class="go">rootdir: [...]/a</span>
<span class="go">collected 20 items</span>

<span class="go">src/random_quote/tests/test_manager.py::test_add_quote PASSED             [  5%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_get_quote PASSED             [ 10%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_remove_quote PASSED          [ 15%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_all PASSED                   [ 20%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_random_quote PASSED          [ 25%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_unknown_id PASSED            [ 30%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_qotd PASSED                  [ 35%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_add_qotd PASSED                 [ 40%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_add_qotd_with_date PASSED       [ 45%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_add_duplicate PASSED            [ 50%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_get_without_date PASSED         [ 55%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_get_with_date PASSED            [ 60%]</span>
<span class="go">src/random_quote/tests/test_qotd.py::test_all PASSED                      [ 65%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote PASSED                [ 70%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_all_quotes PASSED               [ 75%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_random_quote PASSED             [ 80%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote_unknown_id PASSED     [ 85%]</span>
<span class="hll"><span class="go">src/random_quote/tests/test_wsgi.py::test_root PASSED                     [ 90%]</span>
</span><span class="hll"><span class="go">src/random_quote/tests/test_wsgi.py::test_qotd_empty PASSED               [ 95%]</span>
</span><span class="hll"><span class="go">src/random_quote/tests/test_wsgi.py::test_qotd PASSED                     [100%]</span>
</span>
<span class="go">=========================== 20 passed in 0.52 seconds ===========================</span>
</pre></div>
<p>Commit your changes.</p>
</div>
<div class="section" id="version-bump">
<h3>Version Bump</h3>
<p>As we did in <a class="reference external" href="https://jjmojojjmojo.github.io/branching-git-with-pytest-2.rst">part 2</a>, change the version in <code>setup.py</code>. This time, set the version to <strong>0.2.0</strong>, since we have a new feature that is backwards-compatible with the <strong>0.1.0</strong> version.</p>
<p>Don't forget to re-install (<code>pip install -e .</code>), re-run the tests (<code>pytest src</code>), and <code>git commit</code> your changes.</p>
</div>
<div class="section" id="rebase-to-master">
<h3>Rebase To <code>master</code></h3>
<p>Since we've only done this process once, lets walk through it again.</p>
<p>First we need to <code>git fetch</code> any outstanding remote changes:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git fetch origin master
</pre></div>
<p>Next, interactive <code>git rebase</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git rebase -i master
</pre></div>
<p>Be sure to <code>pick</code> the oldest (first) commit, and <code>squash</code> the rest. Don't forget to write a nice log entry when <code>git rebase</code> gives you the chance.</p>
<p>You can try preserving the old commit messages and adding a summary on the first line:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>FEATURE: Quote Of The Day

Added first-pass of quote of the day functionality
Added tests for Quote Of The Day feature
Added HTTP API support for the quote of the day
Set version to 0.2.0
</pre></div>
</td></tr></table></div><p>Re-run the tests to make sure nothing went wrong (there should be 20 passing tests):</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> pytest src
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0</span>
<span class="go">rootdir: [...]/a</span>
<span class="go">collected 20 items</span>

<span class="go">src/random_quote/tests/test_manager.py .......                            [ 35%]</span>
<span class="go">src/random_quote/tests/test_qotd.py ......                                [ 65%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py .......                               [100%]</span>

<span class="go">=========================== 20 passed in 0.61 seconds ===========================</span>
</pre></div>
</div>
<div class="section" id="checkout-and-merge-master">
<h3>Checkout And Merge <code>master</code></h3>
<p>First, <code>git checkout</code> the <code>master</code> branch:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git checkout master
<span class="go">Switched to branch 'master'</span>
<span class="go">Your branch is up to date with 'origin/master'.</span>
</pre></div>
<p>Then <code>git merge</code> to your <code>qotd</code> feature branch:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git merge qotd
<span class="go">Updating c2a655e..150ba38</span>
<span class="go">Fast-forward</span>
<span class="go"> src/random_quote/__init__.py           |   3 +-</span>
<span class="go"> src/random_quote/manager.py            |   9 ++-</span>
<span class="go"> src/random_quote/qotd.py               | 114 ++++++++++++++++++++++++++++++++++</span>
<span class="go"> src/random_quote/schema.sql            |  11 +++-</span>
<span class="go"> src/random_quote/tests/conftest.py     |  26 +++++++-</span>
<span class="go"> src/random_quote/tests/test_manager.py |  10 ++-</span>
<span class="go"> src/random_quote/tests/test_qotd.py    |  96 ++++++++++++++++++++++++++++</span>
<span class="go"> src/random_quote/tests/test_wsgi.py    |  42 ++++++++++++-</span>
<span class="go"> src/random_quote/wsgi.py               |  29 ++++++++-</span>
<span class="go"> 9 files changed, 332 insertions(+), 8 deletions(-)</span>
<span class="go"> create mode 100644 src/random_quote/qotd.py</span>
<span class="go"> create mode 100644 src/random_quote/tests/test_qotd.py</span>
</pre></div>
<p>Run the tests again (<code>pytest src</code>)</p>
</div>
<div class="section" id="push">
<h3>Push</h3>
<p>Finally, publish the changes using <code>git push</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> git push origin master
<span class="go">Enumerating objects: 25, done.</span>
<span class="go">Counting objects: 100% (25/25), done.</span>
<span class="go">Delta compression using up to 8 threads</span>
<span class="go">Compressing objects: 100% (13/13), done.</span>
<span class="go">Writing objects: 100% (14/14), 3.44 KiB | 3.44 MiB/s, done.</span>
<span class="go">Total 14 (delta 6), reused 0 (delta 0)</span>
<span class="go">To [...]/random_quote_remote</span>
<span class="go">   c2a655e..150ba38  master -&gt; master</span>
</pre></div>
</div>
</div>
<div class="section" id="developer-b-fixes-a-bug-and-deals-with-a-git-conflict">
<h2 id="developer b fixes a bug and deals with a git conflict">Developer <em>B</em> Fixes A Bug And Deals With a Git Conflict</h2>
<p>Now, switch to the <code>b</code> clone. We're going to pretend that developer <strong>B</strong> is doing their bug-fix concurrently with the feature that developer <strong>A</strong> just pushed.</p>
<p>First, <code>deactivate</code> the virtual environment:</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> deactivate
<span class="gp">$</span>
</pre></div>
<p>Then change into the <code>b</code> directory:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ../b
</pre></div>
<p>Initialize, activate, install, run the tests:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> python -m venv .
<span class="gp">$</span> <span class="nb">source</span> bin/activate
<span class="gp">(b) $</span> pip install -r requirements.txt
<span class="gp">(b) $</span> pip install -e .
<span class="gp">(b) $</span> pytest src
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0</span>
<span class="go">rootdir: [...]/b</span>
<span class="go">collected 10 items</span>

<span class="go">src/random_quote/tests/test_manager.py ......                             [ 60%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ....                                  [100%]</span>

<span class="go">=========================== 10 passed in 0.49 seconds ===========================</span>
</pre></div>
<p>Note there are only 10 tests. This is because our copy of <code>master</code> is from <em>before</em> developer <strong>A</strong> did their work.</p>
<p>Next, copy the database file again, from your original <code>random_quote</code> checkout,</p>
<div class="highlight"><pre><span></span><span class="gp">(a) $</span> cp ../random_quote/test.db .
</pre></div>
<p>Or re-initialize, if you'd like:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> python scripts/generate_quotes.py
<span class="gp">(random_quote) $</span> python
<span class="gp">&gt;</span>&gt;&gt;
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">random_quote</span> <span class="kn">import</span> <span class="n">util</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">util</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s2">"test.db"</span><span class="p">)</span>
<span class="go">util.ingest("quotes.csv", "test.db")</span>
</pre></div>
<div class="section" id="design">
<h3>Design</h3>
<p>This bug fix is simply just returning <em>something</em> when an HTTP client makes a GET request for <code>/</code>.</p>
<p>We'll add a static HTML file to the source that will provide links to, and useful info about, each of the API endpoints. It will be served when a GET request is made for <code>/</code>.</p>
<p>We'll use the <code>webob.static.FileApp</code> class to serve the file. This handles buffering and streaming properly for us.</p>
</div>
<div class="section" id="make-the-branch">
<h3>Make The Branch</h3>
<p>Lets check out and create our branch. We'll call this one <code>index-info</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git checkout -b index-info
<span class="go">Switched to a new branch 'index-info'</span>
</pre></div>
</div>
<div class="section" id="fix-the-bug">
<h3>Fix The Bug</h3>
<p>Lets construct a simple <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5">HTML5</a> file that has the information about the API within it. The links will be <em>relative</em>. This allows for flexibility in how we host the API. We'll put it in a special directory within the source.</p>
<p>First, create the new <code>src/random_quote/static</code> directory:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> mkdir src/random_quote/static
</pre></div>
<p>We're using this name because it indicates there are files that need to be served without being processed. We're setting up an entire directory to give us some flexibility in the future. We may want to add some additional static assets (such as images or CSS files) to our API documentation, or build some sort of front-end for the browser. We can switch to using the <code>webob.static.DirectoryApp</code> class and serve the entire directory at once.</p>
<p>Add the following to <code>src/random_quote/static/index.html</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Random Quote API<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Random Quote API<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Welcome to the Random Quote API. This API provides random quote functionality via HTTP.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>API Endpoints<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">em</span><span class="p">&gt;</span>All endpoints only work with GET requests. All responses are JSON<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"quote/1"</span><span class="p">&gt;</span>/quote/1<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Retrieve a specific quote by its ID. In this example, we are retrieving quote #1.<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"quotes"</span><span class="p">&gt;</span>/quotes<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Retrieve all quotes.<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"random"</span><span class="p">&gt;</span>/random<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Retrieve a random quote<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div><p>Naming this file <code>index.html</code> is a signal to other developers that this file is intended to be the default file served up when the <code>/</code> (or <em>root</em> path) is requested. This is a convention that goes back to the early days of HTTP servers, and is still in use today.</p>
<p>We need a way to figure out where <code>src/random_quote/static</code> lives. When this application is deployed as a python egg, it could be installed anywhere, and <code>gunicorn</code> (or whatever WSGI server we use) could be running, again, anywhere. We need to find an absolute path to the <code>src/random_quote/static</code> directory.</p>
<p>We have an example of how to do this already, in <code>src/random_quote/util.py</code>, in the <code>schema()</code> function:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">schema</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    Return the location of the SQL schema.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">"schema.sql"</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Here we use Python's built-in special <code>__file__</code> variable that returns the path to the currently executing module (<a class="reference external" href="http://www.blog.pythonlibrary.org/2013/10/29/python-101-how-to-find-the-path-of-a-running-script/">more detail</a>). We then use a couple of functions from the <a class="reference external" href="https://docs.python.org/3/library/os.path.html">os.path</a> module to construct a path in a system-agnostic way.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python runs on many platforms, and most code you will write is compatible with all of them. It's best practice to construct paths using <code>os.path</code> (or <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#module-pathlib">pathlib</a>). This abstracts away differences like using forward slashes (<code>/</code>, unix-like systems) and backward slashes (\, windows), making it easy to switch platforms or run code in different developer environments.</p>
</div>
<p>We can do the same thing with our new <code>static</code> directory. But since we may be using it to serve multiple files, we'll add a little extra functionality to request a more specific path if needed. We'll call the function <code>static()</code>. Add the following to the end of <code>src/random_quote/util.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">static</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return the full path to a file the static directory.</span>
<span class="sd">    """</span>
    <span class="n">static</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">"static"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">static</span>
</pre></div>
</td></tr></table></div><p>If we don't pass a <code>path</code> argument, we get the path to just the <code>static</code> directory, otherwise, the <code>path</code> is added to the end.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">We're adding this flexibility because it's likely we'll want to serve other static files, like images, CSS, javascript, etc.</p>
</div>
<p>Next, we need to add an import for <code>webob.static.FileApp</code>, and our new <code>util.static()</code> function, to <code>src/random_quote/wsgi.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">"""</span>
<span class="sd">WSGI Applications</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">manager</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
</span><span class="kn">from</span> <span class="nn">webob</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">webob.exc</span> <span class="kn">import</span> <span class="n">HTTPError</span><span class="p">,</span> <span class="n">HTTPNotFound</span><span class="p">,</span> <span class="n">HTTPMethodNotAllowed</span><span class="p">,</span> <span class="n">HTTPBadRequest</span>
<span class="hll"><span class="kn">from</span> <span class="nn">webob.static</span> <span class="kn">import</span> <span class="n">FileApp</span>
</span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">RandomQuoteApp</span><span class="p">:</span>
<span class="o">...</span>
</pre></div>
</td></tr></table></div><p>And alter the routing:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
<span class="hll">            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
</span><span class="hll">                <span class="n">response</span> <span class="o">=</span> <span class="n">FileApp</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">))</span>
</span><span class="hll">            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/quotes"</span><span class="p">:</span>
</span>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/quote"</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/random"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">error_response</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Lets start up the web server, and take a quick look:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<p>If we visit <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> in a browser, we will see the new landing page. We can click the links and they should work.</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-root-third-pass.png"/>
</div>
<p>Committing our changes is just like we've done before. Be sure to <code>git add</code> the <code>src/random_quote/static/index.html</code> file.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Git is a bit odd about how it looks at files and directories. You may notice that running <code>git status</code> lists the <code>src/random_quote/static</code> directory, but not <code>index.html</code> specifically.</p>
<p class="last">You can go ahead and <code>git add</code> the <code>src/random_quote/static</code> directory if you want. Just be aware that <code>git add</code> will add <em>any</em> files it finds in that directory or its subdirectories.</p>
</div>
</div>
<div class="section" id="test-for-the-new-index-page">
<h3>Test For The New Index Page</h3>
<p>The test for this fix is pretty simplistic. We just need to make sure there isn't a 404 status returned when making a GET request for <code>/</code>. We can use <code>TestApp</code> to do this, via the <code>preconfigured_wsgi_app()</code> fixture established in <code>src/random_quote/tests/conftest.py</code>.</p>
<p>We should also make sure we're getting the right <em>kind</em> of content, by checking the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">Content-Type header</a>. A JSON response (<code>application/json</code>), instead of an HTML one (<code>text/html</code>) would indicate something went wrong.</p>
<p>Add this test to the end of <code>src/random_quote/tests/test_wsgi.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>67
68
69
70
71
72</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_root</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for the root path.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s1">'text/html'</span>
</pre></div>
</td></tr></table></div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">We could go further with this, and ensure the links actually work. <a class="reference external" href="https://docs.pylonsproject.org/projects/webtest/en/latest/api.html#webtest.response.TestResponse.click">WebTest's response objects have a click() method</a> that could be used to be a bit more thorough.</p>
</div>
<p>We run the tests again to make sure our new case was picked up, and that we didn't break anything else:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> pytest -v src

<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0 -- [...]/b/bin/python</span>
<span class="go">cachedir: .pytest_cache</span>
<span class="go">rootdir: [...]/b</span>
<span class="go">collected 11 items</span>

<span class="go">src/random_quote/tests/test_manager.py::test_add_quote PASSED             [  9%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_get_quote PASSED             [ 18%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_remove_quote PASSED          [ 27%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_all PASSED                   [ 36%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_random_quote PASSED          [ 45%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_unknown_id PASSED            [ 54%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote PASSED                [ 63%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_all_quotes PASSED               [ 72%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_random_quote PASSED             [ 81%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote_unknown_id PASSED     [ 90%]</span>
<span class="hll"><span class="go">src/random_quote/tests/test_wsgi.py::test_get_root PASSED                 [100%]</span>
</span>
<span class="go">=========================== 11 passed in 0.20 seconds ===========================</span>
</pre></div>
<p>Commit the tests.</p>
</div>
<div class="section" id="id1">
<h3>Version Bump</h3>
<p>We've fixed a bug, and so we need to change the version number in <code>setup.py</code> again. This time, it will be <strong>0.1.2</strong>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"random_quote"</span><span class="p">,</span>
<span class="hll">    <span class="n">version</span><span class="o">=</span><span class="s2">"0.1.2"</span><span class="p">,</span>
</span>    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">'random_quote'</span><span class="p">],</span>
    <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">''</span><span class="p">:</span><span class="s1">'src'</span><span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">'webob'</span><span class="p">],</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Be sure to <code>pip install -e .</code> again and re-run the tests before committing your changes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You'll notice that our version is now a whole minor revision behind the version we set when adding the "Quote of the day" feature. Remember, in our "b" repository, we're unaware those changes have been made.</p>
</div>
</div>
<div class="section" id="rebase">
<h3>Rebase</h3>
<p>Lets proceed to do the rebase as usual.</p>
<p>First, we need to <code>git fetch</code> any remote changes we haven't seen yet:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git fetch
<span class="go">remote: Enumerating objects: 29, done.</span>
<span class="go">remote: Counting objects: 100% (29/29), done.</span>
<span class="go">remote: Compressing objects: 100% (16/16), done.</span>
<span class="go">remote: Total 17 (delta 8), reused 0 (delta 0)</span>
<span class="go">Unpacking objects: 100% (17/17), done.</span>
<span class="go">From [...]/random_quote_remote</span>
<span class="go">   c2a655e..9057fd0  master     -&gt; origin/master</span>
</pre></div>
<p>Unlike the last couple of times we called <code>git fetch</code>, we actually have changes to download. This is evidenced by the output above.</p>
<p>When we run <code>git rebase -i master</code>, it works as usual. Be sure to run the tests again (there should still only be <em>11</em> tests).</p>
</div>
</div>
<div class="section" id="merge-now-with-problems">
<h2 id="merge, now with problems">Merge, Now With <em>Problems</em></h2>
<p>Now we need to merge <code>master</code> with our local <code>index-info</code> branch.</p>
<p>First, we check out <code>master</code></p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git checkout master
<span class="go">Switched to branch 'master'</span>
<span class="go">Your branch is behind 'origin/master' by 1 commit, and can be fast-forwarded.</span>
<span class="go">  (use "git pull" to update your local branch)</span>
</pre></div>
<p>Note that git tells us that our branch is behind <code>origin/master</code> by 1 commit, and suggests that we use <code>git pull</code> to update. <code>git pull</code> is like doing a <code>fetch</code> followed by <code>git merge</code>.</p>
<p>Remember, this isn't <em>our</em> branch, all of our changes are still within the <code>index-info</code> branch. We're just doing an update of changes to <code>master</code>, that should merge without incident.</p>
<p>Lets do a <code>git pull</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git pull
<span class="go">Updating fa45753..5e45295</span>
<span class="go">Fast-forward</span>
<span class="go"> setup.py                               |   2 +-</span>
<span class="go"> src/random_quote/__init__.py           |   3 +-</span>
<span class="go"> src/random_quote/manager.py            |   7 ++-</span>
<span class="go"> src/random_quote/qotd.py               | 114 +++++++++++++++++++++++++++++++++++++++++++++++</span>
<span class="go"> src/random_quote/schema.sql            |  11 ++++-</span>
<span class="go"> src/random_quote/tests/test_manager.py |  10 ++++-</span>
<span class="go"> src/random_quote/tests/test_qotd.py    |  96 +++++++++++++++++++++++++++++++++++++++</span>
<span class="go"> src/random_quote/tests/test_wsgi.py    |  42 ++++++++++++++++-</span>
<span class="go"> src/random_quote/wsgi.py               |  28 +++++++++++-</span>
<span class="go"> 9 files changed, 306 insertions(+), 7 deletions(-)</span>
<span class="go"> create mode 100644 src/random_quote/qotd.py</span>
<span class="go"> create mode 100644 src/random_quote/tests/test_qotd.py</span>
</pre></div>
<p>You see we've pulled in the changes made to master while we were working. This doesn't affect our code in our local <code>index-info</code> branch. For that, we need to <code>git merge</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git merge index-info
<span class="go">Auto-merging src/random_quote/wsgi.py</span>
<span class="go">CONFLICT (content): Merge conflict in src/random_quote/wsgi.py</span>
<span class="go">Auto-merging src/random_quote/tests/test_wsgi.py</span>
<span class="go">CONFLICT (content): Merge conflict in src/random_quote/tests/test_wsgi.py</span>
<span class="go">Auto-merging setup.py</span>
<span class="go">CONFLICT (content): Merge conflict in setup.py</span>
<span class="go">Automatic merge failed; fix conflicts and then commit the result.</span>
</pre></div>
<p><strong>Oh no!</strong> We have some <em>conflicts</em>. This means there are areas of files that git couldn't merge. Typically this means files where the changes are diffuse, or specific lines can't be matched up.</p>
<p>It's important to note that the files that are in conflict get marked up to preserve the conflict.</p>
<p>If you look into <code>src/random_quote/tests/test_wsgi.py</code>, you can see what that looks like:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_root</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="hll"><span class="sd">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
</span><span class="sd">    Make a GET request for /</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>

    <span class="n">json_quote</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json_quote</span> <span class="o">==</span> <span class="n">quote</span>

<span class="k">def</span> <span class="nf">test_qotd_empty</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd - no existing quotes</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="n">quotes</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">test_qotd</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote1</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
    <span class="n">quote2</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">26</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote1</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote2</span>
<span class="hll"><span class="o">=======</span>
</span>    <span class="n">Make</span> <span class="n">a</span> <span class="n">GET</span> <span class="n">request</span> <span class="k">for</span> <span class="n">the</span> <span class="n">root</span> <span class="n">path</span><span class="o">.</span>
    <span class="s2">"""</span>
<span class="s2">    response = preconfigured_wsgi_app.get("/")</span>
<span class="s2">    assert response.content_type == 'text/html'</span>
<span class="hll"><span class="s2">&gt;&gt;&gt;&gt;&gt;&gt;&gt; index-info</span>
</span></pre></div>
</td></tr></table></div><p>Now <code>git status</code> shows the conflicting files:</p>
<div class="highlight"><pre><span></span><span class="go">(b) git status</span>
<span class="go">On branch master</span>
<span class="go">Your branch is up to date with 'origin/master'.</span>

<span class="hll"><span class="go">You have unmerged paths.</span>
</span><span class="go">  (fix conflicts and run "git commit")</span>
<span class="go">  (use "git merge --abort" to abort the merge)</span>

<span class="go">Changes to be committed:</span>

<span class="go">    new file:   src/random_quote/static/index.html</span>
<span class="go">    modified:   src/random_quote/util.py</span>

<span class="go">Unmerged paths:</span>
<span class="go">  (use "git add &lt;file&gt;..." to mark resolution)</span>

<span class="hll"><span class="go">    both modified:   setup.py</span>
</span><span class="hll"><span class="go">    both modified:   src/random_quote/tests/test_wsgi.py</span>
</span><span class="hll"><span class="go">    both modified:   src/random_quote/wsgi.py</span>
</span>
<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    test.db</span>
</pre></div>
<p>Taking a look at the the other two files in question, we see that the primary issue arises because we're doing two different actions when an HTTP client makes a GET request for <code>/</code>, as you might expect. It's important to note the reason for the conflict is that the <em>specific lines</em> that changed are in conflict, not the overall changes.</p>
<p>The secondary issue is that we have conflicting version numbers in <code>setup.py</code>:</p>
<p><code>src/random_quote/wsgi.py</code>:</p>
<blockquote>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/qotd"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd_listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="o">=======</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">FileApp</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">index</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</td></tr></table></div></blockquote>
<p><code>setup.py</code>:</p>
<blockquote>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"random_quote"</span><span class="p">,</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">"0.2.0"</span><span class="p">,</span>
<span class="o">=======</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">"0.1.2"</span><span class="p">,</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">index</span><span class="o">-</span><span class="n">info</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">'random_quote'</span><span class="p">],</span>
    <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">''</span><span class="p">:</span><span class="s1">'src'</span><span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">'webob'</span><span class="p">],</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div></blockquote>
<p>Before we can resolve these conflicts, we need to make a decision about the <em>right</em> thing to do when a GET request is made for <code>/</code>, and what the <em>correct</em> version number should be.</p>
<p>The "Quote Of The Day" feature added a quote of the day at <code>/</code>. Our "API Index Information" bug fix added documentation at the same location.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This is <strong>not</strong> a conversation that should happen in a vacuum. This is a major API change, and as we mentioned before, ideally it would have been settled before the two developers even started working.</p>
<p>Communication is key to avoid these conflicts, and it's the only way to get past them when they manage to get through.</p>
<p class="last">The first thing you should always do when a merge conflict happens is <strong>reach out to the other developer</strong> and make sure you're all on the same page.</p>
</div>
<p>Thinking about it objectively, it's probably best to keep the documentation at <code>/</code>. That's the most useful for our users.</p>
<p>Now, we need to figure out <em>how</em> one would request a quote of the day, if something else is being returned at <code>/</code>.</p>
<p>The Quote Of The Day feature put the listing of all quotes of the day on <code>/qotd</code>, but that endpoint is probably better suited for returning today's quote of the day.</p>
<p>So, now we just need a way to present all quotes of the day, so lets move that to <code>/qotd-history</code>.</p>
<p>Here's an updated path map to show how things route:</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/path-map-third-pass.png"/>
</div>
<p>Next, we need to decide which version number to use. In this case, we should consider the <em>end result</em> of our merge.</p>
<p>Developer <strong>B's</strong> version is <strong>0.1.2</strong>, and developer <strong>A's</strong> is <strong>0.2.0</strong>.</p>
<p>What we'll do is do the next <strong>bug fix</strong> version (or <em>patch version</em>) of the <strong>API update</strong> (or <em>minor version</em>), which gives us <strong>0.2.1</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This has the advantage of also preserving any tags that were made for the two versions. We skipped that step here for the sake of brevity, but having three tags, one for <strong>0.1.2</strong>, <strong>0.2.0</strong> and <strong>0.2.1</strong> means we can deploy any of those three versions independently. This gives us a great deal of flexibility. ðŸ¦„</p>
</div>
<p>Lets fix <code>setup.py</code> first. We just need to take out the markers (<code>=====</code> and <code>&gt;&gt;&gt;&gt;</code>) and any duplicated lines, leaving only the stuff we need. When you're finished, <code>setup.py</code> will look like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"random_quote"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">"0.2.1"</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">'random_quote'</span><span class="p">],</span>
    <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">''</span><span class="p">:</span><span class="s1">'src'</span><span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">'webob'</span><span class="p">],</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Now lets fix <code>src/random_quote/wsgi.py</code>. The conflict is in <code>__call__()</code>, in the routing.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/qotd"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd_listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="o">=======</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">FileApp</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">index</span><span class="o">-</span><span class="n">info</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/quotes"</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/quote"</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/random"</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>To fix this, we need to preserve the case when the request looks for <code>/</code>, but also add the new paths we discussed above.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">FileApp</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/qotd"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/qotd-history"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qotd_listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/quotes"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/quote"</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/random"</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">error_response</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>You can use a <a class="reference external" href="https://en.wikipedia.org/wiki/Comparison_of_file_comparison_tools">diff tool</a> to fix merge conflicts in an interactive way.</p>
<p class="last">Check out <a class="reference external" href="https://git-scm.com/docs/git-mergetool">git mergetool</a> for details.</p>
</div>
<p>Before we can do a manual test, we need to add the changes to the database schema. This is done using <code>util.init()</code>, run from the interpreter:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> python
<span class="go">Python 3.7.3 (default, Mar 30 2019, 03:37:43)</span>
<span class="go">[Clang 10.0.0 (clang-1000.11.45.5)] on darwin</span>
<span class="go">Type "help", "copyright", "credits" or "license" for more information.</span>
<span class="gp">&gt;</span>&gt;&gt;
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">random_quote.util</span> <span class="kn">import</span> <span class="n">init</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">init</span><span class="p">(</span><span class="s2">"test.db"</span><span class="p">)</span>
</pre></div>
<p>Now we can start up <code>gunicorn</code> again:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<p>And open <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>,</p>
<blockquote>
<div class="figure align-center" style="width: 60%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-root-third-pass.png"/>
</div>
</blockquote>
<p><a class="reference external" href="http://127.0.0.1:8080/qotd">http://127.0.0.1:8080/qotd</a>,</p>
<blockquote>
<div class="figure align-center" style="width: 60%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-qotd-second-pass.png"/>
</div>
</blockquote>
<p>And <a class="reference external" href="http://127.0.0.1:8080/qotd-history">http://127.0.0.1:8080/qotd-history</a></p>
<blockquote>
<div class="figure align-center" style="width: 60%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-qotd-history.png"/>
</div>
</blockquote>
<p>The next conflict is in one of the test files, <code>src/random_quote/tests/test_wsgi.py</code>. Lets fix that next.</p>
<p>The only conflict is near the bottom, where the 'qotd' tests step on the 'index-info' tests. We can fix this by moving some code around and changing the requested paths:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_root</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for the root path.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s1">'text/html'</span>

<span class="k">def</span> <span class="nf">test_qotd_empty</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd-history - no existing quotes</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd-history"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="n">quotes</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">test_qotd_listing</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd-history</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote1</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
    <span class="n">quote2</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">26</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd-history"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote1</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote2</span>

<span class="k">def</span> <span class="nf">test_qotd</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Retrieve the current quote of the day</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">json_quote</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json_quote</span> <span class="o">==</span> <span class="n">quote</span>
<span class="k">def</span> <span class="nf">test_get_root</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for the root path.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s1">'text/html'</span>

<span class="k">def</span> <span class="nf">test_qotd_empty</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd-history - no existing quotes</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd-history"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="n">quotes</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">test_qotd_listing</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Request the list of quotes of the day at /qotd-history</span>
<span class="sd">    """</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote1</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
    <span class="n">quote2</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">26</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd-history"</span><span class="p">)</span>

    <span class="n">quotes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote1</span>
    <span class="k">assert</span> <span class="n">quotes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">quote2</span>

<span class="k">def</span> <span class="nf">test_qotd</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Retrieve the current quote of the day</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/qotd"</span><span class="p">)</span>

    <span class="n">json_quote</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qotd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json_quote</span> <span class="o">==</span> <span class="n">quote</span>
</pre></div>
</td></tr></table></div><p>Now we can run the tests to make sure everything still works:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> pytest src
<span class="go">================================ test session starts =================================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.3, py-1.8.0, pluggy-0.12.0</span>
<span class="go">rootdir: [...]/b</span>
<span class="go">collected 21 items</span>

<span class="go">src/random_quote/tests/test_manager.py .......                                 [ 33%]</span>
<span class="go">src/random_quote/tests/test_qotd.py ......                                     [ 61%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ........                                   [100%]</span>

<span class="go">============================= 21 passed in 0.36 seconds ==============================</span>
</pre></div>
<p>Before we proceed, we have one last thing to do: we need to update the web API documentation at <code>/</code> to reflect the new API endpoints that we added as part of resolving the conflicts.</p>
<div class="section" id="documentation-update">
<h3>Documentation Update</h3>
<p>Add the following links to <code>src/random_quote/static/index.html</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"qotd"</span><span class="p">&gt;</span>/qotd<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Retrieve today's "Quote of the day."<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"qotd-history"</span><span class="p">&gt;</span>/qotd-history<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;</span>Retrieve all previous "Quote of the day." entries.<span class="p">&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div><p>Start up <code>gunicorn</code> again:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<p>If we open <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> in a browser, the new page is shown, and the links do what they're supposed to.</p>
<div class="figure align-center" style="width: 80%">
<img alt="" src="https://jjmojojjmojo.github.io/images/branching-git-pytest/screen-cap-root-fourth-pass.png"/>
</div>
</div>
<div class="section" id="complete-the-merge">
<h3>Complete the merge</h3>
<p>Now that we've untangled this mess, we need to finish up the merge.</p>
<p><code>git status</code> reminds us that we're in the middle of merging:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git status
<span class="go">On branch master</span>
<span class="go">Your branch is up to date with 'origin/master'.</span>

<span class="go">You have unmerged paths.</span>
<span class="go">  (fix conflicts and run "git commit")</span>
<span class="go">  (use "git merge --abort" to abort the merge)</span>

<span class="go">Changes to be committed:</span>

<span class="go">    new file:   src/random_quote/static/index.html</span>
<span class="go">    modified:   src/random_quote/util.py</span>

<span class="go">Unmerged paths:</span>
<span class="go">  (use "git add &lt;file&gt;..." to mark resolution)</span>

<span class="go">    both modified:   setup.py</span>
<span class="go">    both modified:   src/random_quote/tests/test_wsgi.py</span>
<span class="go">    both modified:   src/random_quote/wsgi.py</span>

<span class="go">Changes not staged for commit:</span>
<span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="go">  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>

<span class="go">    modified:   src/random_quote/static/index.html</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    test.db</span>
</pre></div>
<p>To finish the merge, we first need to let git know the conflicted files are fixed. We do this by using <code>git add</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git add src/random_quote/tests/test_wsgi.py
<span class="gp">(b) $</span> git add src/random_quote/wsgi.py
<span class="gp">(b) $</span> git add setup.py
</pre></div>
<p>Now <code>git status</code> tells us what we need to do next:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git status
<span class="go">On branch master</span>
<span class="go">Your branch is up to date with 'origin/master'.</span>

<span class="hll"><span class="go">All conflicts fixed but you are still merging.</span>
</span><span class="hll"><span class="go">  (use "git commit" to conclude merge)</span>
</span>
<span class="go">Changes to be committed:</span>

<span class="go">    modified:   setup.py</span>
<span class="go">    new file:   src/random_quote/static/index.html</span>
<span class="go">    modified:   src/random_quote/tests/test_wsgi.py</span>
<span class="go">    modified:   src/random_quote/util.py</span>
<span class="go">    modified:   src/random_quote/wsgi.py</span>

<span class="go">Changes not staged for commit:</span>
<span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="go">  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>

<span class="go">    modified:   src/random_quote/static/index.html</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    test.db</span>
</pre></div>
<p>To complete the merge, we just need to do what <code>git status</code> is telling us: <code>git commit</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git commit -a -m<span class="s2">"Resolved API endpoint conflicts"</span>
<span class="go">[master 36c0796] Resolved API endpoint conflicts</span>
</pre></div>
<p>Now we can <code>git push</code> our changes to the remote:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git push origin master
<span class="go">Enumerating objects: 37, done.</span>
<span class="go">Counting objects: 100% (36/36), done.</span>
<span class="go">Delta compression using up to 8 threads</span>
<span class="go">Compressing objects: 100% (18/18), done.</span>
<span class="go">Writing objects: 100% (23/23), 2.59 KiB | 2.59 MiB/s, done.</span>
<span class="go">Total 23 (delta 12), reused 0 (delta 0)</span>
<span class="go">To [...]/random_quote_remote</span>
<span class="go">   9057fd0..5ccabd1  master -&gt; master</span>
</pre></div>
</div>
</div>
<div class="section" id="tag-the-fixed-version">
<h2 id="tag the fixed version">Tag The Fixed Version</h2>
<p>As a last step, we just need to <code>git tag</code> our new version, and push it to the remote:</p>
<div class="highlight"><pre><span></span><span class="gp">(b) $</span> git tag v0.2.1
<span class="gp">(b) $</span> git push origin v0.2.1
<span class="go">Total 0 (delta 0), reused 0 (delta 0)</span>
<span class="go">To [...]/random_quote_remote</span>
<span class="go"> * [new tag]         v0.2.1 -&gt; v0.2.1</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2 id="conclusion">Conclusion</h2>
<p>In this final section, we covered resolving merge conflicts.</p>
<p>Now, you should be well-versed in working with git branches and using pytest to ensure you don't break things. ðŸ¦„</p>
<p>If you have any ideas, problems, or suggestions, don't hesitate to <a class="reference external" href="https://jjmojojjmojo.github.io/pages/contact.html">contact the author</a>.</p>
</div>
<div class="section" id="resources-what-to-do-if-you-messed-up">
<h2 id="resources, what to do if you messed up">Resources, What To Do If You Messed Up</h2>
<p>Feel free to <a class="reference external" href="https://jjmojojjmojo.github.io/pages/contact.html">contact the author</a> if you have any problems with this guide.</p>
<p>Check out <a class="reference external" href="http://sethrobertson.github.io/GitFixUm/fixup.html">http://sethrobertson.github.io/GitFixUm/fixup.html</a> for a nice general git troubleshooting guide! It's extremely well done.</p>
</div>
</div><!-- /.entry-content -->
</section>
</div>
<footer class="body" id="contentinfo">
<div id="footer-text-wrapper">
<div id="footer-text">&copy; 2019 Josh Johnson. All Rights Reserved. <a href="https://jjmojojjmojo.github.io/pages/about.html">About</a></div>
</div>
</footer>
<script src="https://jjmojojjmojo.github.io/theme/js/main.js"></script>
</body>
</html>