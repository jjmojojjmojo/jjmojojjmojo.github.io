<!DOCTYPE html>
<html lang="en">
<head>
<!-- Open Graph / Facebook -->
<meta content="website" property="og:type"/>
<meta content="/drafts/circuitpython-state-part-7.html" property="og:url"/>
<meta content="State And Events In CircuitPython: Part 5: A Generic State Dispatcher - The Collected Works of jjmojojjmojo " property="og:title"/>
<meta content="/theme/images/default-social-full.jpg" property="og:image"/>
<!-- Twitter -->
<meta content="summary_large_image" property="twitter:card"/>
<meta content="https://jjmojojjmojo.github.io/drafts/circuitpython-state-part-7.html" property="twitter:url"/>
<meta content="State And Events In CircuitPython: Part 5: A Generic State Dispatcher - The Collected Works of jjmojojjmojo " property="twitter:title"/>
<meta content="/theme/images/default-social-full.jpg" property="twitter:image"/>
<meta content="State And Events In CircuitPython: Part 5: A Generic State Dispatcher - The Collected Works of jjmojojjmojo " name="title"/>
<meta content="/theme/images/default-social-full.jpg" property="og:image"/>
<meta content="/theme/images/default-social-full.jpg" property="twitter:image"/>
<title>   State And Events In CircuitPython: Part 5: A Generic State Dispatcher - The Collected Works of jjmojojjmojo 
</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/theme/css/main.css" rel="stylesheet" type="text/css"/>
<link href="/theme/css/syntax-solarized-light.css" id="highlight-css" rel="stylesheet" type="text/css"/>
<script src="/theme/js/zepto.min.js"></script>
<link href="/feeds/all.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Full Atom Feed" type="application/atom+xml"/>
<link href="/feeds/all.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Full RSS Feed" type="application/rss+xml"/>
<link href="/feeds/category.tutorial.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Categories Atom Feed" type="application/atom+xml"/>
<link href="/feeds/category.tutorial.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Categories RSS Feed" type="application/rss+xml"/>
<meta content="In this installment, we'll explore ways of reducing code, and creating more generic event handling code. Configuration During Instantiation When we create a new instance of a class, the constuctor is called. In Python, constructors have a special name, __init__(). Up until now, we've used the constructors of our classes &hellip;" name="description"/>
<meta content="In this installment, we'll explore ways of reducing code, and creating more generic event handling code. Configuration During Instantiation When we create a new instance of a class, the constuctor is called. In Python, constructors have a special name, __init__(). Up until now, we've used the constructors of our classes &hellip;" property="og:description"/>
<meta content="In this installment, we'll explore ways of reducing code, and creating more generic event handling code. Configuration During Instantiation When we create a new instance of a class, the constuctor is called. In Python, constructors have a special name, __init__(). Up until now, we've used the constructors of our classes &hellip;" property="twitter:description"/>
<meta content="circuitpython" name="tags"/>
<meta content="python" name="tags"/>
<meta content="hardware" name="tags"/>
<meta content="state" name="tags"/>
</head>
<body class="home" id="index">
<header class="body" id="banner">
<h1><a href="/"><img id="header-home-icon" src="/theme/icons/home.svg"/> <span id="header-site-title">The Collected Works of jjmojojjmojo <strong></strong></span></a></h1>
<ul id="menu">
<li><a href="/pages/about.html">About</a></li>
<li><a href="/pages/contact.html">Contact</a></li>
<li><a href="/pages/index.html">Pages</a></li>
<li><a href="/categories.html">Categories</a></li>
<li><a href="/tags.html">Tags</a></li>
</ul>
<span id="settings-button">
<a href="/pages/settings.html" title="Settings">
<img alt="Gear Icon For Settings" src="/theme/icons/settings.svg"/>
</a>
</span>
</header><!-- /#banner -->
<div id="content-wrapper">
<section class="body" id="content">
<header>
<h2 class="entry-title">
<a href="/drafts/circuitpython-state-part-7.html" rel="bookmark" title="Permalink to State And Events In CircuitPython: Part 5: A Generic State Dispatcher">State And Events In CircuitPython: Part 5: A Generic State Dispatcher</a></h2>
</header>
<footer class="post-info">
<time class="published" datetime="2018-06-11T15:07:00-04:00">
      Mon 11 June 2018
    </time>
<address class="vcard author">
      By           <a class="url fn" href="/author/jjmojojjmojo.html">jjmojojjmojo</a>
</address>
</footer><!-- /.post-info -->
<div>
<div id="toc"><ul><li><a class="toc-href" href="#configuration during instantiation" title="Configuration During Instantiation">Configuration During Instantiation</a></li><li><a class="toc-href" href="#passing functions as configuration and dependency injection" title="Passing Functions As Configuration And Dependency Injection">Passing Functions As Configuration And Dependency Injection</a></li><li><a class="toc-href" href="#state that reconciles itself" title="State That Reconciles Itself">State That Reconciles Itself</a></li><li><a class="toc-href" href="#a generic button dispatcher" title="A Generic Button Dispatcher">A Generic Button Dispatcher</a></li><li><a class="toc-href" href="#the code" title="The Code">The Code</a></li><li><a class="toc-href" href="#events across multiple buttons" title="Events Across Multiple Buttons">Events Across Multiple Buttons</a></li><li><a class="toc-href" href="#consolidating handlers" title="Consolidating Handlers">Consolidating Handlers</a></li><li><a class="toc-href" href="#muti-button events" title="Muti-Button Events">Muti-Button Events</a></li><li><a class="toc-href" href="#a quick note about getters and setters" title="A Quick Note About Getters and Setters">A Quick Note About Getters and Setters</a></li><li><a class="toc-href" href="#dispatch using a global state object" title="Dispatch Using A Global State Object">Dispatch Using A Global State Object</a></li></ul></div>
</div>
<div class="warning">
<h2>WARNING</h2>
  You are viewing a <strong>draft</strong> document. It may contain inaccurate, misleading, or unvetted information.
  </div>
<div class="entry-content status-draft">
<!-- Emoji substitutions, because I can't help myself (and my editor doesn't show -->
<!-- emoji for some reason - better to do this since I can replace these with -->
<!-- icons or whatever I want) -->
<p>In this installment, we'll explore ways of reducing code, and creating more generic event handling code.</p>
<!-- PELICAN_END_SUMMARY -->
<div class="section" id="configuration-during-instantiation">
<h2 id="configuration during instantiation">Configuration During Instantiation</h2>
<p>When we create a new instance of a class, the <em>constuctor</em> is called. In Python, constructors have a special name, <tt class="docutils literal">__init__()</tt>.</p>
<p>Up until now, we've used the constructors of our classes to just set up the default state of our objects. However, like all methods, it's possible to allow a constructor to accept parameters.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All instance methods always take an instance object, named <tt class="docutils literal">self</tt> by convention, as the first parameter.</p>
</div>
<p>These parameters can be used for whatever purpose we choose, but are typically used to configure how the instance should operate.</p>
<p>Recall the classes from the last example from part 4:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Status</span><span class="p">:</span>
    <span class="n">_sample_rate</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">_event_check</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">_threshold</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">_ranges</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20460</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20460</span><span class="p">,</span> <span class="mi">40920</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">40920</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">previous_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"low"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"medium"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"high"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">TemperatureStatus</span><span class="p">(</span><span class="n">Status</span><span class="p">):</span>
    <span class="n">_threshold</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">_ranges</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">thermistor</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LightStatus</span><span class="p">(</span><span class="n">Status</span><span class="p">):</span>
    <span class="n">_threshold</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="n">_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">photocell</span><span class="o">.</span><span class="n">value</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">TemperatureStatus</span><span class="p">()</span>
<span class="n">light</span> <span class="o">=</span> <span class="n">LightStatus</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>In these classes, the configuration is handled by overriding properties in the base class. If you want to change the colors for each range of values, or the threshold, etc, you have to create a new class and extend <tt class="docutils literal">Status</tt>.</p>
<p>This was a great example of polymorphism at work. It's easy to read and use. However, there are times when this extra code is unneeded. With complex classes, or in situations where a lot has to change, it can be tedious to have to write the same code over and over. There tends to be a minimum amount of code that must be written to use a base class - this is called <em>boilerplate</em>. As elegant as it can be, it can also become quite tedious.</p>
<p>It's also hard to change values while the code is executing. We're using <em>class attributes</em> so they can be overriden in child classes. This means that we can't easily change these values once we invoke the class and create the instance.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>ðŸ¤” Remember, <em>class attributes</em> are different from <em>instance attributes</em>.</p>
<p><strong>Class attributes</strong> are defined in the class. They can be accessed from instances, and overridden by child classes. They cannot be changed from an instance.</p>
<p><strong>Instance attributes</strong> exist in the instance, after its instantiated. They are not affected by class inheritance. They can be changed by instances.</p>
<p>Where we run into trouble, particularly in Python, is when we try to change a <em>class attribute</em> from within an <em>instance</em>.</p>
<p class="last">If we try to set a class attribute in an instance, we end up creating a local instance attribute with the same name.</p>
</div>
<p>To avoid some of these issues, we can use the constructor to configure our instances.</p>
<p>Here's code that functions just as before, but refactored such that it is entirely configured during instance creation:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Status</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_input</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">event_check</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span> <span class="o">=</span> <span class="n">read_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_check</span> <span class="o">=</span> <span class="n">event_check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>

        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20460</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20460</span><span class="p">,</span> <span class="mi">40920</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">40920</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">previous_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">photocell_read</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">photocell</span><span class="o">.</span><span class="n">value</span>

<span class="k">def</span> <span class="nf">thermistor_read</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">thermistor</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span>
    <span class="n">thermistor_read</span><span class="p">,</span>
    <span class="n">ranges</span><span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">light</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span>
    <span class="n">photocell_read</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="p">})</span>
</pre></div>
</td></tr></table></div><p>This code can be dropped into the last example, and it will function exactly the same.</p>
<p>Here's an overview of the changes:</p>
<ul class="simple">
<li>We've eschewed the use of child classes. All of the functionality that we care about is implemented within the main <tt class="docutils literal">Status</tt> class.</li>
<li>The class attributes for colors, thresholds and the like are now passed as parameters to the constructor.</li>
<li>We've set defaults for every one of those arguments, except <tt class="docutils literal">read_input</tt>.</li>
</ul>
<p>One thing thats important to discuss before we go on is the use of <tt class="docutils literal">None</tt> for the default <tt class="docutils literal">color</tt> and <tt class="docutils literal">ranges</tt> arguments. This is done because only <em>immutable</em> types can be set as default values in a function or method definition. This typically means strings, numbers (integers, floats), and tuples. Anything else will create unexpected behavior.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The <a class="reference external" href="https://docs.quantifiedcode.com/python-anti-patterns/index.html">Little Book Of Python Anti-Patterns</a> has a <a class="reference external" href="https://docs.quantifiedcode.com/python-anti-patterns/correctness/mutable_default_value_as_argument.html">nice illustration</a> of the problems you can run into when trying to use a mutable object as a default.</p>
<p class="last">There's also a <a class="reference external" href="http://effbot.org/zone/default-values.htm">classic explanation</a> over at <a class="reference external" href="http://effbot.org">effbot.org</a>.</p>
</div>
<p>So instead of setting the default there, we use a value we can easily differentiate from what we want, <tt class="docutils literal">None</tt>. We then check to see if the argument <tt class="docutils literal">is None</tt> to ensure the user hasn't passed something similar but not <tt class="docutils literal">None</tt> itself (which is passed automatically when the argument isn't provided).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This some what strained phrasing is because if we were to use something else, like <tt class="docutils literal">False</tt> or an empty string <tt class="docutils literal">""</tt>, we would have trouble telling if the user passed an empty dictionary <tt class="docutils literal">{}</tt>, another "false" object like <tt class="docutils literal">0</tt>, etc.</p>
<p><tt class="docutils literal">None</tt> is a nice choice because it is a global <em>singleton</em>, meaning there is one and only one <tt class="docutils literal">None</tt>. We know for sure that if <tt class="docutils literal">None</tt> was passed, the user didn't provide any value.</p>
<p class="last">Now, we can also take advantage of the fact that <tt class="docutils literal">None</tt> is also a boolean false value - if we just check if the value is true, and if it's not, that could mean they passed any number of 'false' values, <tt class="docutils literal">""</tt>, <tt class="docutils literal">0</tt>, <tt class="docutils literal">[]</tt>, etc. This is risky because it's "magical", but can sometimes be useful.</p>
</div>
<p>The other particularly novel change is that we're passing in a function as the first argument <tt class="docutils literal">read_input</tt>. In the next section, we'll jump into what sort of interesting things we can do with that concept.</p>
</div>
<div class="section" id="passing-functions-as-configuration-and-dependency-injection">
<h2 id="passing functions as configuration and dependency injection">Passing Functions As Configuration And Dependency Injection</h2>
<p>In the example above, we're passing <em>functions</em> (<tt class="docutils literal">thermistor_read</tt> and <tt class="docutils literal">photocell_read</tt>) to the constructor of our <tt class="docutils literal">Status</tt> class. The function is passed into the <tt class="docutils literal">read_input</tt> argument. We then assign the function to a 'private' instance attribute called <tt class="docutils literal">_read_input</tt>, and ultimately call that function inside of our class method <tt class="docutils literal">read_input()</tt>. So our <tt class="docutils literal">read_input()</tt> method is a <em>proxy</em> for whatever function was passed into the constructor.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This is a simple example of <a class="reference external" href="https://en.wikipedia.org/wiki/Proxy_pattern">The Proxy Pattern</a>.</p>
</div>
<p>Passing functions as arguments is a really interesting feature of Python and a few other languages that can be a little weird at first glance.</p>
<p>We briefly touched on <em>immutable</em> vs <em>mutable</em> objects earlier. <strong>Mutable</strong> basically means "can be changed", so <strong>immutable</strong> means "can not be changed". Immutable values in Python include strings, most numbers, and tuples. Note how you interact with these objects: you use methods, and operators, but you always get a new object as a result. In fact, you aren't allowed to change them:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span> <span class="o">=</span> <span class="s2">"hello python"</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"!"</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">'str' object does not support item assignment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="go">'HELLO PYTHON'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span>
<span class="go">'hello python'</span>
</pre></div>
</td></tr></table></div><p>This contrasts with something like a list, which has a very simiar API to a string - except you can change it, and perform actions on it without creating a new object:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span> <span class="o">=</span> <span class="s2">"hello python"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span>
<span class="go">['h', 'e', 'l', 'l', 'o', ' ', 'p', 'y', 't', 'o', 'n']</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"!"</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span>
<span class="go">['h', 'e', 'l', 'l', 'o', ' ', 'p', 'y', 't', 'o', '!']</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mylist</span>
<span class="go">[' ', '!', 'e', 'h', 'l', 'l', 'o', 'o', 'p', 't', 'y']</span>
</pre></div>
</td></tr></table></div><p>This is important because of another concept in programming that is important to be aware of: <em>passing by reference</em>. It's a <a class="reference external" href="https://stackoverflow.com/questions/373419/whats-the-difference-between-passing-by-reference-vs-passing-by-value">much discussed</a> topic, but we can summarize it like this:</p>
<div class="line-block">
<div class="line">When an object is passed to a function (or method) <strong>by reference</strong>, changes to the object inside the function affect the object <strong>outside the function</strong>.</div>
</div>
<p><strong>TODO: find a good write up about variable scope and passing by reference in python</strong></p>
<p>The alternative to this, is <em>passing by value</em>:</p>
<div class="line-block">
<div class="line">When an object is passed <strong>by value</strong> to a function (or method), the object is <strong>copied</strong> and changes to the object inside the function <strong>do not affect</strong> the object outside the function.</div>
</div>
<p>What does this have to do with passing a function to our constructor, and mutability? In Python, <strong>mutable types are always passed by reference</strong>.</p>
<p>So, when we pass a dictionary, a list, or a complex object to a function, changes to that object inside the function can be seen in the code after its called:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">alter_dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">d</span><span class="p">[</span><span class="s2">"gotcha"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"hello"</span><span class="p">:</span> <span class="s2">"python"</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mydict</span>
<span class="go">{'hello': 'python'}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alter_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mydict</span>
<span class="go">{'hello': 'python', 'gotcha': True}</span>
</pre></div>
</td></tr></table></div><p>This is not the case with immutable objects, like strings:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">uppercase</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span> <span class="o">=</span> <span class="s2">"hello python"</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">uppercase</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mystring</span>
<span class="go">'hello python'</span>
</pre></div>
</td></tr></table></div><p>In Python, <strong>functions are mutable objects</strong>. So we can pass them, and their original code will be executed when they are called inside of another function:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">call_me</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s2">"python"</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">f</span><span class="p">(</span><span class="n">who</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="s2">"python"</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">goodbye</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="s2">"python"</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">"goodbye"</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">call_me</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
<span class="go">hello python</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">call_me</span><span class="p">(</span><span class="n">goodbye</span><span class="p">)</span>
<span class="go">goodbye python</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">call_me</span><span class="p">(</span><span class="n">goodbye</span><span class="p">,</span> <span class="s2">"javascript"</span><span class="p">)</span>
<span class="go">goodbye javascript</span>
</pre></div>
</td></tr></table></div><p>You can see how we can call functions, pass functions as arguments, and even pass arguments that are passed as arguments to the functions we pass! ðŸ¦„</p>
<p>We leverage this in our new <tt class="docutils literal">Status</tt> class above to allow the user to pass any callable object to the constructor, to configure how the value that controls the status light is checked.</p>
<p>This opens a lot of really interesting possibilities. In fact, an entire design pattern has been developed around this basic idea, called <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>.</p>
<p>You may have noticed one other major difference between our original example and this new one: <em>we are no longer dispatching to event methods</em>.</p>
<p>We can fix this by leveraging our new dependency injection knowledge (here's the whole working script so you can try this out):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">thermistor</span><span class="p">,</span> <span class="n">photocell</span>

<span class="kn">from</span> <span class="nn">state</span> <span class="kn">import</span> <span class="n">state</span>

<span class="k">class</span> <span class="nc">Status</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_input</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">event_check</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span> <span class="o">=</span> <span class="n">read_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_check</span> <span class="o">=</span> <span class="n">event_check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>

        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20460</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20460</span><span class="p">,</span> <span class="mi">40920</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">40920</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">=</span> <span class="n">low</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">previous_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"low"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"medium"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"high"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">photocell_read</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">photocell</span><span class="o">.</span><span class="n">value</span>

<span class="k">def</span> <span class="nf">thermistor_read</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">thermistor</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">thermistor_high</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Temp is High!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">thermistor_medium</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Temp is Medium!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">thermistor_low</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Temp is Low!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">photocell_high</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Light is High!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">photocell_medium</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Light is Medium!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">photocell_low</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Light is Low!"</span><span class="p">)</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span>
    <span class="n">thermistor_read</span><span class="p">,</span>
    <span class="n">ranges</span><span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">high</span><span class="o">=</span><span class="n">thermistor_high</span><span class="p">,</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">thermistor_medium</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">thermistor_low</span><span class="p">)</span>

<span class="n">light</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span>
    <span class="n">photocell_read</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">high</span><span class="o">=</span><span class="n">photocell_high</span><span class="p">,</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">photocell_medium</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">photocell_low</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">light</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"light"</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">color</span>
</pre></div>
</td></tr></table></div><p><strong>TODO: video of this in action</strong></p>
<p>Now, we are able to handle any (or none) of the events for each instance of our <tt class="docutils literal">Status</tt> class as needed for our project.</p>
<p>This particular approach is a good one when we will frequently only be using a subset of the events. It's less ideal when we typically want to provide a custom event function for the same events over and over.</p>
<p>There are a couple of options there:</p>
<ul class="simple">
<li>We can collect the callables into a dictionary, like we do the colors or ranges.</li>
<li>We can create a new class that defines a list of event methods, and implement it for each type of status. We pass the whole object and the <tt class="docutils literal">Status</tt> class knows which methods to call.</li>
<li>We do the same, but instead we pass the <em>instance methods</em> instead of functions.</li>
</ul>
<p>All of these options are viable and useful.</p>
<p>The second and third option are particularly interesting in that the methods could be methods of objects we use for other things. Lets explore that.</p>
<p>First, we can create a class that encapsulates the basic sampling functionality of the <tt class="docutils literal">Status</tt> class:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AnalogInput</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_input</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reporting_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span> <span class="o">=</span> <span class="n">read_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span> <span class="o">=</span> <span class="n">reporting_rate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>We will create an <tt class="docutils literal">AnalogInput</tt> object for each sensor. These objects will handle all of the data tracking and sampling. We've continued to use the "constructor configuration" approach for this class, and so you have to pass a callable that will return the value of the input, just as before.</p>
<p>One major difference is that, instead of calling <tt class="docutils literal">dispatch()</tt> when a change event is detected, we instead change the internal <tt class="docutils literal">changed</tt> attribute. So instead of encapsulating four events (<em>high</em>, <em>medium</em>, <em>low</em> and <em>changed</em>), we are only encapsulating the one <em>changed</em> event.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>changed</em> event was obscured within the <tt class="docutils literal">update()</tt> method in our previous implementation. We've replicated it in the <tt class="docutils literal">__call__()</tt> method of <tt class="docutils literal">AnalogInput</tt>.</p>
</div>
<p>The other change is that we've constructed our class to be <em>callable</em> - instances of the <tt class="docutils literal">AnalogInput</tt> class can now be called just like a function to update it, instead of calling the <tt class="docutils literal">update()</tt> method.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Like <tt class="docutils literal">__init__()</tt>, <tt class="docutils literal">__call__()</tt> is one of Python's "magic" methods. These methods are used by the language to control behavior of objects under certain circumstances.</p>
<p class="last">Rafe Kettler has a great guide to all the amazing things you can do with magic methods online, <a class="reference external" href="https://rszalski.github.io/magicmethods/">A Guide to Python's Magic Methods</a>.</p>
</div>
<p>One final note, it may be a little confusing to see <tt class="docutils literal">_value</tt> and <tt class="docutils literal">value</tt> used to basically do the same thing: store the current value of the analog input. The difference is that <tt class="docutils literal">value</tt> is the value from the <em>last time things changed</em>, and <tt class="docutils literal">_value</tt> is the up-to-the-second value.</p>
<p>We can configure the classes easily, and use the <tt class="docutils literal">changed</tt> attribute to trigger other events:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">thermistor</span><span class="p">,</span> <span class="n">photocell</span>

<span class="err">ï»¿</span><span class="k">class</span> <span class="nc">AnalogInput</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_input</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reporting_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span> <span class="o">=</span> <span class="n">read_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span> <span class="o">=</span> <span class="n">reporting_rate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="err">ï»¿</span><span class="k">def</span> <span class="nf">read_temperature</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">thermistor</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_light</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">photocell</span><span class="o">.</span><span class="n">value</span>

    <span class="n">temp_input</span> <span class="o">=</span> <span class="n">AnalogInput</span><span class="p">(</span><span class="n">read_temperature</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">light_input</span> <span class="o">=</span> <span class="n">AnalogInput</span><span class="p">(</span><span class="n">read_light</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">temp_input</span><span class="p">()</span>
        <span class="n">light_input</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">temp_input</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Temperature changed!"</span><span class="p">,</span> <span class="n">temp_input</span><span class="o">.</span><span class="n">previous</span><span class="p">,</span> <span class="n">temp_input</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">light_input</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Light level changed!"</span><span class="p">,</span> <span class="n">light_input</span><span class="o">.</span><span class="n">previous</span><span class="p">,</span> <span class="n">light_input</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Next, we can create a generic <tt class="docutils literal">StatusEvents</tt> class, that detects the changes in state and dispatches events:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StatusEvents</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_obj</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_obj</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>

        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20460</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20460</span><span class="p">,</span> <span class="mi">40920</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">40920</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">=</span> <span class="n">low</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">previous_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"low"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"medium"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"high"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Changed!"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">previous</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>Again, we've opted to use the <tt class="docutils literal">__call__()</tt> method instead of <tt class="docutils literal">update()</tt>. But the rest of the code is nearly identical to our old <tt class="docutils literal">Status</tt> class. The main exception being that we are expecting an <tt class="docutils literal">AnalogInput</tt> object instead of a function to handle the reading, and of course, we aren't doing any of the sampling word we factored into <tt class="docutils literal">AnalogInput</tt>.</p>
<p>At the moment, we don't have anything terribly useful to do with our events.</p>
<p>First, lets get our color status</p>
<p>We can still pass functions for each of the event handlers, but instead, lets make a couple of classes that do some simple things to show us everything is working:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PrintEventHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"High '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Medium '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Low '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LEDHighNoticeHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">led</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="n">led</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div><p>These two classes have completely different purposes. <tt class="docutils literal">PrintEventHandler</tt> prints a notice to the console when each event occurs.</p>
<p><tt class="docutils literal">LEDHighNoticeHandler</tt> turns an LED (assumed to be a <tt class="docutils literal">ï»¿DigitalInOut</tt> object, we'll use the onboard red LED on pin 13) on or off when the <tt class="docutils literal">AnalogInput</tt> is in the "high" range.</p>
<p><tt class="docutils literal">PrintEventHandler</tt> takes one parameter, a name, so we can tell in the console which input we're seeing an event for.</p>
<p>The single argument to the constructor of <tt class="docutils literal">LEDHighNoticeHandler</tt> is taking a slightly different approach, compared to what we've done in previous examples. Instead of using the global <tt class="docutils literal">led</tt> object, or treating this class as a container for state attributes and turning the LED on/off elsewhere, we're passing an LED object to the constructor, and manipulating it when the events are fired.</p>
<p>Here's how the whole menagerie of classes work together:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">thermistor</span><span class="p">,</span> <span class="n">photocell</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">"light"</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"light"</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">"temp"</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">"light"</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">AnalogInput</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_input</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reporting_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span> <span class="o">=</span> <span class="n">read_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span> <span class="o">=</span> <span class="n">reporting_rate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_input</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporting_rate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">event_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PrintEventHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"High '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Medium '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Low '</span><span class="si">%s</span><span class="s2">' event detected"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LEDHighNoticeHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">led</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="n">led</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">StatusEvents</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_obj</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_obj</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>

        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20460</span><span class="p">),</span>
                <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20460</span><span class="p">,</span> <span class="mi">40920</span><span class="p">),</span>
                <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">40920</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">=</span> <span class="n">low</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">high</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_medium</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_level</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">previous_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"low"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"medium"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">"high"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Changed!"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">previous</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read_temperature</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">thermistor</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_light</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">photocell</span><span class="o">.</span><span class="n">value</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="n">temp_input</span> <span class="o">=</span> <span class="n">AnalogInput</span><span class="p">(</span><span class="n">read_temperature</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">light_input</span> <span class="o">=</span> <span class="n">AnalogInput</span><span class="p">(</span><span class="n">read_light</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">temp_handler</span> <span class="o">=</span> <span class="n">LEDHighNoticeHandler</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
<span class="n">light_handler</span> <span class="o">=</span> <span class="n">PrintEventHandler</span><span class="p">(</span><span class="s2">"light"</span><span class="p">)</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">StatusEvents</span><span class="p">(</span>
    <span class="n">temp_input</span><span class="p">,</span>
    <span class="n">ranges</span><span class="o">=</span> <span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">high</span><span class="o">=</span><span class="n">temp_handler</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">temp_handler</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">temp_handler</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>

<span class="n">light</span> <span class="o">=</span> <span class="n">StatusEvents</span><span class="p">(</span>
    <span class="n">light_input</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'low'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">'medium'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">'high'</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">high</span><span class="o">=</span><span class="n">light_handler</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">light_handler</span><span class="o">.</span><span class="n">medium</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">light_handler</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">temp</span><span class="p">()</span>
    <span class="n">light</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"light"</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">color</span>
</pre></div>
</td></tr></table></div><p><strong>TODO: video of this code in action, with the console from Mu</strong></p>
<p>One really interesting aspect of this version of the code is that we're passing <em>instance methods</em> instead of regular functions to handle each event.</p>
</div>
<div class="section" id="state-that-reconciles-itself">
<h2 id="state that reconciles itself">State That Reconciles Itself</h2>
<p>Recall the three-phases of state:</p>
<a href="/images/fullsize/nonblocking-state-flowchart.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-flowchart.jpg" srcset="/images/responsive/nonblocking-state-flowchart-2500.jpg 2500w,/images/responsive/nonblocking-state-flowchart-2000.jpg 2000w,/images/responsive/nonblocking-state-flowchart-1800.jpg 1800w,/images/responsive/nonblocking-state-flowchart-1600.jpg 1600w,/images/responsive/nonblocking-state-flowchart-1200.jpg 1200w,/images/responsive/nonblocking-state-flowchart-1000.jpg 1000w,/images/responsive/nonblocking-state-flowchart-800.jpg 800w,/images/responsive/nonblocking-state-flowchart-400.jpg 400w,/images/responsive/nonblocking-state-flowchart-200.jpg 200w" style="width: 80%;"/></a>
<p>In the last section, we touched on a new way of implementing the reconciliation phase in another object. We can expand on that to clean up our main loop a little bit.</p>
<p>Let's refactor our current <tt class="docutils literal">State</tt> class to be a more accurate representation of what it does: handles button release events.</p>
</div>
<div class="section" id="a-generic-button-dispatcher">
<h2 id="a generic button dispatcher">A Generic Button Dispatcher</h2>
<p>Having established a way of tracking state over time, and the concept of <em>events</em>, we can generalize the button logic into a <em>dispatcher</em> - code that detects the events and then dispatches to pre-defined <em>handlers</em>. In other words, it detects an event, and runs code for us.</p>
<p>We can take the <tt class="docutils literal">State</tt> class that we've been working on and extend it to detect the three most common button events: <em>press</em>, <em>release</em>, and <em>hold</em>.</p>
<p>We can then take advantage of a key feature of Python to make the handlers really flexible. In Python, functions are <em>first class objects</em>. This means that they can be assigned to variables, and passed around just like an integer or list.</p>
<p>Using this feature, we can configure our state class when we instantiate it, by passing function names to the constructor. We can store the functions as instance attributes and execute them later when we need to dispatch an event.</p>
<p>The first step is to specify the events we want to detect in terms of what conditions must occur for them to be triggered.</p>
<p>We're going to focus on button events here, but remember events can be whatever we want.</p>
<div class="section" id="event-1-press">
<h3>Event 1: Press</h3>
<p>Recall from the last section that a <em>press</em> event happens when the button <em>wasn't</em> pressed, and now it is.</p>
<p>But lets be very specific so we can make sure we've covered all of the conditions in our code. That means we also have to take into account button debounce.</p>
<p>So, for a <em>press</em> event to occur:</p>
<ul class="simple">
<li>The button pin has gone from "LOW" to "HIGH" (<tt class="docutils literal">False</tt> to <tt class="docutils literal">True</tt>).</li>
<li>The button pin has read "HIGH" (<tt class="docutils literal">True</tt>) for more than 0.2 seconds.</li>
</ul>
<p>Let's review the logic for this event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># WARING: pseudo(ish) code</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># digital pin object</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debounce</span> <span class="n">time</span> <span class="n">has</span> <span class="n">passed</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="event-2-release">
<h3>Event 2: Release</h3>
<p>A <em>release</em> event occurs when the user stops pressing the button. This usually happens immediately after a <em>press</em> event, but this is not always the case - there may be a delay if the button was held down.</p>
<p>Specifically, a release event has occurred when:</p>
<ul class="simple">
<li>The button pin has gone from "HIGH" to "LOW" (<tt class="docutils literal">True</tt> to <tt class="docutils literal">False</tt>).</li>
</ul>
<p>Debouncing can sometimes be required but for the most part, considering the event triggered at the first notice of the pin reading "LOW" will be sufficient.</p>
<p>Here's what the logic looks like:</p>
<p>Let's review the logic for this event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># WARING: pseudo(ish) code</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># digital pin object</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
    <span class="c1"># button has been released</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="event-3-hold">
<h3>Event 3: Hold</h3>
<p>This is a new event we haven't covered before. <em>Hold</em> can be looked at in two different ways. The first way is to consider a hold event as a one-time occurance, where a hold event has occurred after a <em>release</em> event that follows a <em>press</em> event and a set period of time has passed between the two.</p>
<p>The second way, is to think of a <em>hold</em> an event that happens over and over every so often while a button is being held down.</p>
<p>It's a bit easier to explain the difference between the two in code.</p>
<p>The first way would look something like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># warning: pseudo(ish) code!</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># properly configured digital pin</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># time that we started holding</span>
<span class="n">held_since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="c1"># remember the following is being run with a delay for debounce</span>
<span class="n">every</span> <span class="n">debounce</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">held_since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># button has been released</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">held_since</span> <span class="o">&gt;</span> <span class="n">some_threshold</span><span class="p">:</span>
            <span class="c1"># button has been held</span>
</pre></div>
</td></tr></table></div><p>Contrast that with treating a hold event as a recurring event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># warning: pseudo(ish) code!</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># properly configured digital pin</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># is the button being held</span>
<span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># checkin to detect a hold</span>
<span class="n">hold_check</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="c1"># remember the following is being run with a delay for debounce</span>
<span class="n">every</span> <span class="n">debounce</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">hold_check</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">hold_check</span> <span class="o">&gt;</span> <span class="n">some_hold_threshold</span><span class="p">:</span>
        <span class="n">holding</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">holding</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># dispatch the hold event</span>
        <span class="c1"># this will happen every time we debounce</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># button has been released</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</td></tr></table></div><p>Both approaches are valid, and which one to use will depend on your application.</p>
<p>The first approach works well when we don't need to do anything <em>during</em> the time a button is being held down. An example of a use case for this would be holding a button for, say 2 seconds to change into a different <em>mode</em>, or holding the button in for 5 seconds to power the project off.</p>
<p>The second approach allows us to take action while the button is being pressed and held. Examples of use cases for this include holding a button to advance a clock to set the time and emulating the scroll wheel on a mouse. It has the advantage over the first approach, besides continuing to act, of being able to take the number of times the hold event has fired into account. This allows us to do things like accelerate the rate of increase on the clock or move the scroll wheel faster the longer the button is held.</p>
<p>For this article, we'll implement the second approach, since the project that inspired this article uses it.</p>
<p>So, to quantify our event, a <em>hold</em> occurs when:</p>
<ul class="simple">
<li>The button pin has gone from "LOW" to "HIGH" (<tt class="docutils literal">False</tt> to <tt class="docutils literal">True</tt>), or a <em>press</em> event has previously occurred.</li>
<li>The button pin has read "HIGH" (<tt class="docutils literal">True</tt>) for more than 0.4 seconds.</li>
<li>The event continues to occur every 0.4 seconds until a <em>release</em> event occurs.</li>
</ul>
</div>
</div>
<div class="section" id="the-code">
<h2 id="the code">The Code</h2>
<p>As mentioned earlier, Python allows functions to be passed around like any other value. We can leverage that fact to make a dispatcher that is very flexible.</p>
<p>In the code below, we pass a series of predefined functions to our dispatcher constructor that it will use to determine what the current value of the button is, and call when each type of event is detected.</p>
<p>While we develop the generic dispatcher, we'll just print the events to the console to keep things simple.</p>
<p>We're going to focus on just handling button-related events. We'll rename the class from <tt class="docutils literal">State</tt> to <tt class="docutils literal">ButtonDispatch</tt>. We're only going to deal with one button at a time. We'll also remove the state attributes and methods that aren't button-related (<tt class="docutils literal">rgb</tt>, <tt class="docutils literal">led</tt>, <tt class="docutils literal">random_color()</tt>, etc). This way we can use a separate <tt class="docutils literal">ButtonDispatch</tt> object for every button we have, instead of adding a lot of complexity to a single class to handle many different buttons.</p>
<p>We've also moved the logic from the <tt class="docutils literal">update()</tt> method to <tt class="docutils literal">__call__()</tt> - this is a special ("magic") method you can define to make an object <em>callable</em>, like a function.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Check: </span><span class="si">{}</span><span class="s2">, State: </span><span class="si">{}</span><span class="s2"> Checkin: </span><span class="si">{}</span><span class="s2">&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">():</span>
    <span class="n">reutrn</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="n">dispatch</span> <span class="o">=</span> <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>There's a lot of new code here, so lets take this example line by line, from the top.</p>
<p><strong>Lines 1-4</strong> are the imports we need from external libraries, including <tt class="docutils literal">time</tt> to track the passing of time, the <tt class="docutils literal">setup</tt> module to abstract away differences between our boards, and <tt class="docutils literal">random</tt> to generate random colors.</p>
<p><strong>Lines 6-72</strong> define our <tt class="docutils literal">ButtonDispatch</tt> class.</p>
<p><strong>Lines 7 and 8</strong> are global configuration variables, defined as <em>class attributes</em>, and intended for "private" use. The <tt class="docutils literal">_debounce</tt> attribute is used to set how frequently the state object checks the button (avoiding button bouncing).</p>
<p>The <tt class="docutils literal">_hold_threshold</tt> value is new, and is used to determine the difference between simply pressing the button, and holding it down. We need this because we are handling both the <em>press</em> and <em>hold</em> events in our dispatcher.</p>
<p>On <strong>line 10</strong>, the constructor takes some arguments.</p>
<ul class="simple">
<li><tt class="docutils literal">self</tt> is automatically passed to any instance method. It references the instance that this method is being called on.</li>
<li><tt class="docutils literal">check</tt>, is a function that will be called to read the button pin. It's expected to return <tt class="docutils literal">True</tt> if the button is pressed, and <tt class="docutils literal">False</tt> if it's not. <tt class="docutils literal">check</tt> is a required argument.</li>
<li><tt class="docutils literal">press</tt> is a function that will be called whenever a <em>press</em> event is detected. It is expected to take no attributes. Its return value isn't used by the <tt class="docutils literal">ButtonDispatch</tt> class. This is a optional argument, and will default to <tt class="docutils literal">None</tt>.</li>
<li><tt class="docutils literal">release</tt> is a function that will be called whenever a <em>release</em> event is detected. It is also expected to take no attributes, and its return value isn't used by the dispatcher. It's also optional, and defaults to <tt class="docutils literal">None</tt>.</li>
<li>Finally, <tt class="docutils literal">hold</tt> is a function that will be called multiple times (every <tt class="docutils literal">_hold_threshold</tt> seconds) when the button is being held down. It differs a bit from the other two functions in that it is required to take a single argument, which will be the number of times the <em>hold</em> event was detected in a row. It is also an optional argument, defaulting to <tt class="docutils literal">None</tt>.</li>
</ul>
<p>These functions would typically be considered <em>event handlers</em> in most event dispatch contexts.</p>
<p><strong>Lines 12-15</strong> establish the default state attributes the dispatcher uses to do its work. <tt class="docutils literal">checkin</tt> is the time keeping attribute. <tt class="docutils literal">holding</tt> is used to indicate if the button is currently being held. <tt class="docutils literal">hold_count</tt> tracks how many times the <em>hold</em> event has been detected. Finally <tt class="docutils literal">state</tt> is the state of the button, the last time it was read.</p>
<p><strong>Line 18</strong> stashes the <tt class="docutils literal">check</tt> function passed to the constructor in an instance variable (<tt class="docutils literal">get_value</tt>) so it can be used later. This is a really cool feature of Python: you can pass functions around like any other kind of data. This means you can pass them to a constructor and assign them to an instance attribute like we've done here. To call the <tt class="docutils literal">check</tt> function passed in the constructor, we can call <tt class="docutils literal">self.get_value()</tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This can be a little confusing, since this looks a lot like an instance method. The way to tell the difference is that an instance method always receives a <tt class="docutils literal">self</tt> attribute as its first argument.</p>
</div>
<p><strong>Lines 21-23</strong> assign the event handlers to instance attributes in the same way. We've named the instance attributes <tt class="docutils literal">onpress</tt>, <tt class="docutils literal">onrelease</tt> and <tt class="docutils literal">onhold</tt> - these names are a call back to event handlers in HTML. They are named such to differentiate them from the instance methods that are called when events are detected.</p>
<p>The <tt class="docutils literal">release</tt>, <tt class="docutils literal">check</tt>, <tt class="docutils literal">hold</tt>, and <tt class="docutils literal">press</tt> methods defined on <strong>lines 25-52</strong> are proxies for the functions that were passed in the constructor. With the exception of <tt class="docutils literal">check</tt>, they all follow the same pattern. They first update any state attributes required because of the event detection. Then they check if the handler was defined (<tt class="docutils literal">is not None</tt>), and if it was, they call it. Finally, they update the <tt class="docutils literal">checkin</tt> time.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It may seem a little odd that these functions are so simplistic. But the structure of the class has a specific purpose.</p>
<p>The dispatcher has been constructed this way so that you could build one with the <em>same</em> API, that doesn't rely on external functions being passed into the constructor.</p>
<p>You can instead hard-code what you want to happen in each event. To do different things for different buttons, you can use <a class="reference external" href="https://www.python-course.eu/python3_inheritance.php">class inheritence</a> to add in the special functionality.</p>
<p class="last">I find passing functions into the constructor to be much more flexible and straightforward, but the other approach is valid too, so I designed the class to be compatible with it.</p>
</div>
<p>On <strong>lines 54-69</strong>, the <tt class="docutils literal">__call__()</tt> 'magic' method makes instances of <tt class="docutils literal">ButtonDispatch</tt> <em>callable</em> - they can be invoked just like a function (we utilize this on <strong>line 89</strong>). When they are invoked that way, the <tt class="docutils literal">__call__()</tt> method is called. We use this as a central access point for making the event dispatch work.</p>
<p><tt class="docutils literal">__call__()</tt> starts by logging the current time in a variable called <tt class="docutils literal">current</tt> on <strong>line 55</strong>. We do this to avoid multiple calls to <tt class="docutils literal">time.monotonic()</tt>, so the following logic will be cleaner, and also more consistent (time will pass from line to line of the code as it's running).</p>
<p><strong>Lines 68-60</strong> detects and handles the <em>hold</em> event. Here, <em>hold</em> has occurred every time the button state is <tt class="docutils literal">True</tt>, and it's been <tt class="docutils literal">_hold_threshold</tt> seconds since the last check-in. On <strong>line 59</strong> the <tt class="docutils literal">holding</tt> attribute is set to <tt class="docutils literal">True</tt>, and then <strong>line 60</strong> calls the <tt class="docutils literal">hold()</tt> instance method.</p>
<p><strong>Lines 63-65</strong> detect and handle the <em>press</em> event. <em>Press</em> happens when the state of the button is <tt class="docutils literal">False</tt> but the button pin reads <tt class="docutils literal">True</tt> <em>and</em> it's been <tt class="docutils literal">_debounce</tt> seconds since the last check-in.</p>
<p>The <em>release</em> event is detected and handled on <strong>lines 68 and 69</strong>. <em>Release</em> happens when the state of the button is <tt class="docutils literal">True</tt>, but the pin reads <tt class="docutils literal">False</tt>. We could debounce here as well, but I haven't seen a need in my projects.</p>
<p><strong>Lines 71-72</strong> provide a <tt class="docutils literal">__repr__()</tt> method for easier debugging.</p>
<p><strong>Lines 74-83</strong> define the functions we will pass to <tt class="docutils literal">ButtonDispatch</tt> on <strong>line 86</strong>.</p>
<p><tt class="docutils literal">value()</tt> is a simple wrapper for our <tt class="docutils literal">check</tt> function from the <tt class="docutils literal">setup</tt> module.</p>
<p>The rest of the functions are event handlers. They simply print something out to the console to indicate that the event occurred.</p>
<p>Finally, on <strong>lines 86-89</strong>, the <tt class="docutils literal">ButtonDispatch</tt> class is instantiated, and our main loop is run. The main loop just calls the <tt class="docutils literal">dispatch</tt> object on each iteration. It's a lot less complex because we've moved <em>all</em> of the logic into the <tt class="docutils literal">ButtonDispatch</tt> class, and all of the actions that we need to take when the button is pressed into the event handlers.</p>
</div>
<p>Since the function used to check the physical state of the button is configured by creating a function and passing it to the constructor, we can use the same dispatcher for multiple kinds of inputs besides buttons - touch pads, rotary encoders, etc.</p>
<p>We can opt to skip certain events by passing <tt class="docutils literal">None</tt> to the constructor for the handlers we don't want to implement.</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-01.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-01.mp4">link to the video</a> instead.</p>
</video>
</div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>This implementation is designed to still do the <em>accounting</em> for each event even if no event is set - it may be more efficient to avoid calling the press/hold/release method if one isn't provided.</p>
<p class="last">You may also want to consider removing events, such as <em>hold</em>, if you aren't using them in your project.</p>
</div>
</div>
<div class="section" id="events-across-multiple-buttons">
<h2 id="events across multiple buttons">Events Across Multiple Buttons</h2>
<p>When transitioning our <tt class="docutils literal">State</tt> class to our generic event dispatcher, we lost the ability to track both buttons.</p>
<p>The utility of using a class for our dispatcher code starts to really shine as we use more buttons - all we need to do is create a <tt class="docutils literal">ButtonDispatch</tt> instance for each button.</p>
<p>We'll just need to write a duplicate of <tt class="docutils literal">value()</tt> that returns the value for the correct button, and duplicate the handlers so we can do something different for each button.</p>
<p>We can put our <tt class="docutils literal">ButtonDispatch</tt> objects into a list to make them easier to work with.</p>
<p>Here's what the code looks like (the <tt class="docutils literal">ButtonDispatch</tt> class doesn't change):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -- snip --</span>

<span class="k">def</span> <span class="nf">value_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press_a</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release_a</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold_a</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button A held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value_b</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press_b</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button B pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release_b</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button B released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold_b</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button B held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_a</span><span class="p">,</span> <span class="n">press_a</span><span class="p">,</span> <span class="n">release_a</span><span class="p">,</span> <span class="n">hold_a</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_b</span><span class="p">,</span> <span class="n">press_b</span><span class="p">,</span> <span class="n">release_b</span><span class="p">,</span> <span class="n">hold_b</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-02.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-02.mp4">link to the video</a> instead.</p>
</video>
</div><p>As you can see, things can get a little complex though when dealing with multiple actions for multiple events. We just have two buttons here, imagine if we had 10! That would be 30 event handlers!</p>
<p>There are a couple of strategies we can take.</p>
<p>First, it may not even be a real concern. Most of the time, we won't need handlers for every event for every button. Second, the buttons and the functionality they invoke will be separated.</p>
<p>In practice, most code will look more like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ... snip ...</span>

<span class="k">def</span> <span class="nf">value_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value_b</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">say_hey</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"HEYDIE HEYDIE HEYDIE HEY"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">say_ho</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"HIDIE HIDIE HIDIE HO"</span><span class="p">)</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_a</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">say_hey</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_b</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">say_ho</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-03.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-03.mp4">link to the video</a> instead.</p>
</video>
</div><p>But in the event that we really need to handle many buttons in an efficient way (imagine building a 101 key keyboard), we can consolidate handlers such that a single function can handle the same event for many buttons. We just need to differentiate between buttons when the handler is dispatched.</p>
</div>
<div class="section" id="consolidating-handlers">
<h2 id="consolidating handlers">Consolidating Handlers</h2>
<p>To address that, we can add a <em>token</em> to the <tt class="docutils literal">ButtonDispatch</tt> class that each instance stores, identifying which button caused an event. The token gets passed to the event functions. Since the token indicates which button was pressed, the event function can take different action depending on which button invoked it.</p>
<p>Here's what that looks like:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button </span><span class="si">{}</span><span class="s2">|Check: </span><span class="si">{}</span><span class="s2">, State: </span><span class="si">{}</span><span class="s2"> Checkin: </span><span class="si">{}</span><span class="s2">&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button </span><span class="si">{}</span><span class="s2"> pressed!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button </span><span class="si">{}</span><span class="s2"> released!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"HEYDIE HEYDIE HEYDIE HEY"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"HIDIE HIDIE HIDIE HO"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button </span><span class="si">{}</span><span class="s2"> held for </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>This code hasn't changed much from the last version. Here are the changes that were made to allow the same handlers to be used for multiple buttons:</p>
<ul class="simple">
<li>The <tt class="docutils literal">ButtonDispatch</tt> constructor (<strong>Line 11</strong>) now has <em>two</em> required arguments, <tt class="docutils literal">token</tt> and <tt class="docutils literal">check</tt>. <tt class="docutils literal">token</tt> is used to differentiate between different buttons. We've used a string here, but it really could be anything, as long as the event handler functions understand it. The token is stored as an instance attribute on <strong>line 13</strong>.</li>
<li>The token (<tt class="docutils literal">self.token</tt>) is passed to the event handlers and <tt class="docutils literal">check</tt> function (<strong>lines 31, 38, 44 and 52</strong>).</li>
<li>The handlers and check function defined on <strong>lines 76-92</strong> all take <tt class="docutils literal">token</tt> as their first argument.</li>
<li>In the case of <tt class="docutils literal">value()</tt> (<strong>line 76</strong>), the <tt class="docutils literal">token</tt> is just passed along to the <tt class="docutils literal">check()</tt> function from our <tt class="docutils literal">setup</tt> abstraction module.</li>
<li>The handlers all print out the <tt class="docutils literal">token</tt> (<strong>lines 80, 83 and 92</strong>).</li>
<li>The <tt class="docutils literal">release()</tt> handler actually has some logic in it so that it behaves differently depending on the value of <tt class="docutils literal">token</tt> (or which button was pressed), additionally printing a different message.</li>
<li>Finally, you can see how the <tt class="docutils literal">token</tt> is passed when the  <tt class="docutils literal">ButtonDispatch</tt> objects are instantiated on <strong>lines 95 and 96</strong>.</li>
</ul>
</div>
<p>Here's a video of this code running, again on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-04.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-04.mp4">link to the video</a> instead.</p>
</video>
</div><p>The primary difference here is just the addition of the <tt class="docutils literal">token</tt> property, and the added requirement that it is now a parameter of each event handler function.</p>
<p>Now using only three event functions, we can handle events for many, many buttons. Each event will produce a different effect depending on which button triggered it (in this case different messages will be printed to the console).</p>
<p>The token has also been passed to the <tt class="docutils literal">check()</tt> function, so that has been centralized as well.</p>
<p>This is a common pattern in programming, a form of <a class="reference external" href="https://en.wikipedia.org/wiki/Message_passing">message passing</a>.</p>
<p>You may also have noticed that you can press both buttons <em>simultaneously</em>. The events are not actually firing at the same time, however, they are firing one after the other. It just happens so quickly that they appear to be simultaneous.</p>
</div>
<div class="section" id="muti-button-events">
<h2 id="muti-button events">Muti-Button Events</h2>
<p>This is a great accomplishment, and will work well for even quite complex projects. However, we have painted ourselves into a corner of sorts. We can fire two different events when buttons are pressed at the same time, but we can't see the state of one button from the event of the others. This becomes problematic if we want one button to affect the actions of another.</p>
<p>You may have run into an application of this problem: holding down one button makes the meaning of another button change. Here's an example from an old digital alarm clock:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/blink-controller-alarm-clock-example.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/blink-controller-alarm-clock-example.mp4">link to the video</a> instead.</p>
</video>
</div><p>So we have the "mode" of one button changing because another button was held down.</p>
<p>This is again something that can (and should) be handled in different ways, depending on the situation.</p>
<p>The simplest way to deal with this is to use the <tt class="docutils literal">state</tt> and <tt class="docutils literal">holding</tt> properties of each <tt class="docutils literal">ButtonDispatch</tt> object. If the first button's <tt class="docutils literal">state</tt> is <tt class="docutils literal">True</tt>, and the second button's <tt class="docutils literal">holding</tt> property is also <tt class="docutils literal">True</tt>, then we have a alarm clock-setting style event occurring.</p>
<p>To make it work, we just have to track our own checkin time to further debounce the simultaneous press events:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ... snip ...</span>

<span class="err">ï»¿</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Both buttons pressed!"</span><span class="p">)</span>
            <span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>Here, we're tracking some external state values in global variables so we don't have to modify the <tt class="docutils literal">ButtonDispatch</tt> class to get what we want.</p>
<p><strong>Line 10</strong> looks at the state of both buttons - if they're both pressed (the <tt class="docutils literal">state</tt> attribute is <tt class="docutils literal">True</tt>), then both buttons must have been pressed and debounced.</p>
<p>We have to do a further debounce (<strong>line 11</strong>) because they may have not been pressed together - if they are pressed slightly out of sync, we can get a false reading as one button is being released, and the other is being pressed.</p>
<p>On <strong>lines 14 and 15</strong> we set the state of both buttons to <tt class="docutils literal">False</tt>. This ensures that the press or hold events won't be fired again now that we've handled them on our buttons' behalf.</p>
</div>
<p>This will cover most use cases. As mentioned before, complex button pressing scenarios are not common - they are necessary sometimes when there are a limited number of buttons, or the greater functionality of the project is rather complex (playing chords on a musical instrument for example).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This code prevents the <em>release</em> events from firing, and doesn't cover the <em>both buttons released</em> event. Handling this would require some refactoring and additional logic. It was left out of this example for the sake of simplicity - the technique covered next is the best way to handle anything more complex than a simple <em>both buttons pressed</em> sort of event as illustrated above.</p>
</div>
<p>When this extra complexity is necessary, it's best to separate the state of each button into a central state object, like we did earlier. We can either access that global object directly in our handlers, or pass it as an additional argument to them.</p>
<p>This will allow for more complex behaviors, like holding one button and pressing the other.</p>
</div>
<div class="section" id="a-quick-note-about-getters-and-setters">
<h2 id="a quick note about getters and setters">A Quick Note About Getters and Setters</h2>
<p>The code below introduces the concept from object-oriented programming called <em>getters</em> and <em>setters</em>.</p>
<p>The basic idea is that, instead of accessing a property of an object directly, you set up a method to retrieve the value (<em>get</em> it), and to store the value (<em>set</em> it).</p>
<p>In Python, its usually not necessary, unless you want to provide a convenient way of getting/setting a value that may be a little complex otherwise.</p>
<p>Here's a simple example, that illustrates the syntax used to do this in Python:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as state.py</span>
<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># private attribute used to store the actual</span>
        <span class="c1"># integer value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># getter - returns a string based on the integer stored</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Sunday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Monday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Tuesday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Wednesday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Thursday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Friday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Saturday"</span>

        <span class="k">return</span> <span class="s2">"Unknown"</span>

    <span class="c1"># setter - takes a string and stores an integer</span>
    <span class="nd">@day_of_week</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"sunday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"monday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"tuesday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"wedsnday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"thursday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"friday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"saturday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No idea what day '</span><span class="si">{}</span><span class="s2">' is"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>Most of the basics of making a class have been well explained in other examples. However, this example introduces some new concepts:</p>
<p><em>Line 6</em> establishes a "private" instance attribute called <tt class="docutils literal">_day_of_week</tt> - this is the attribute where the "real" value representing the day of the week is stored, as an <em>integer</em>. The name is intentionally the same as the getter/setter code below it, so you know that those methods are proxies for this value.</p>
<p>On <em>line 9</em>, we use the <tt class="docutils literal">@property</tt> decorator to transform the method defined below it (<tt class="docutils literal">day_of_week()</tt>) into a special kind of object. From the instances' perspective, <tt class="docutils literal">day_of_week</tt> will be an instance attribute just like any other - but when you access it (<tt class="docutils literal">self.day_of_week</tt>, or <tt class="docutils literal">state.day_of_week</tt>), it transparently invokes the <tt class="docutils literal">day_of_week()</tt> <em>method</em>.</p>
<p><tt class="docutils literal">@property</tt> allows us to create dynamic instance attributes. It's especially useful in situations like this where we want to present an API that looks like a "regular" instance, but does more behind the scenes.</p>
<p>After the definition of <tt class="docutils literal">day_of_week()</tt> on <strong>line 32</strong>, its passed to the <tt class="docutils literal">@property</tt> decorator and obtains new attributes. We use one of them <tt class="docutils literal">setter</tt> as a second decorator to indicate our next method, also called <tt class="docutils literal">day_of_week()</tt>, will be called when you assign a value to the <tt class="docutils literal">day_of_week</tt> attribute.</p>
<p>It may seem a little weird that we're naming the two methods the same. First, we want to make it clear to anyone reading the code that these two methods are related, and that together they define the <tt class="docutils literal">day_of_week</tt> attribute. We can give them the same name because technically, we're not defining two instance methods in the <tt class="docutils literal">State</tt> class. In reality, we're defining a <tt class="docutils literal">@property</tt> object, assigning it to the <tt class="docutils literal">day_of_week</tt> name, and then creating two <em>functions</em> that it will use to handle setting and getting of tat <tt class="docutils literal">day_of_week</tt> attribute for the instance.</p>
<p>The final thing that is worth pointing out is the error handling on <strong>lines 32 and 52</strong>.</p>
<p>The <tt class="docutils literal">day_of_week()</tt> getter looks at the value of <tt class="docutils literal">self._day_of_week</tt>, and returns a string corresponding to the English weekday of the stored value. If the value doesn't correspond to any expected numbers, the word <tt class="docutils literal">Unknown</tt> is returned instead, on <strong>line 32</strong>.</p>
<p>The <tt class="docutils literal">day_of_week()</tt> setter takes the <tt class="docutils literal">value</tt> argument and based on its content, sets the <tt class="docutils literal">self._day_of_week</tt> attribute to a corresponding number.</p>
<p>If the content of <tt class="docutils literal">value</tt> doesn't match any of the known English days of the week, the setter throws a <tt class="docutils literal">ValueError</tt> (<strong>line 52</strong>). When this happens the user will get an exception, and will see the message <tt class="docutils literal">No idea what day 'XXX' is</tt> (replacing <tt class="docutils literal">XXX</tt> with whatever the user passed in).</p>
<p>This is an advantage of using getters and setters in Python - you can do data <em>marshalling</em> where you translate a value from one kind to another (like the getter does), set <em>sane defaults</em> (like returning <tt class="docutils literal">Unknown</tt> when the day of the week is wrong in the getter) and you can do <em>validation</em> so that the user can't store bad data (like throwing the exception in the setter).</p>
</div>
<p>Here's how you'd work with it in the console:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="go">'Sunday'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">=</span> <span class="s2">"Friday"</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">_day_of_week</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="go">'Friday'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">=</span> <span class="s2">"Munundununceday"</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">"state.py"</span>, line <span class="m">47</span>, in <span class="n">day_of_week</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No idea what day '</span><span class="si">{}</span><span class="s2">' is"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="gr">ValueError</span>: <span class="n">No idea what day 'Munundununceday' is</span>
</pre></div>
</td></tr></table></div><p>So internally, we're storing the day of the week as an integer, but when you access <tt class="docutils literal">day_of_week</tt>, it returns a string. If we want to set the day of the week, we provide a string and it is translated into a integer for internal storage. We are able to add some error handling in the setter, that we wouldn't be able to do easily if we weren't using one.</p>
</div>
<div class="section" id="dispatch-using-a-global-state-object">
<h2 id="dispatch using a global state object">Dispatch Using A Global State Object</h2>
<p>Now that we understand how getters and setters work, we can use them to provide a simple way of accessing the external global state:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># global state object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s2">"</span><span class="si">{}</span><span class="s2">-holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)]</span>

    <span class="nd">@holding</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s2">"</span><span class="si">{}</span><span class="s2">-holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">]</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button </span><span class="si">{}</span><span class="s2">|Check: </span><span class="si">{}</span><span class="s2">, State: </span><span class="si">{}</span><span class="s2"> Checkin: </span><span class="si">{}</span><span class="s2">&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Button </span><span class="si">{}</span><span class="s2"> held for </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">multi_press</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">"A"</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A-holding'</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"A is holding while </span><span class="si">{}</span><span class="s2"> was pressed!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'B'</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Both buttons are being pressed"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multi_release</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">"A"</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A-holding'</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"A is holding and </span><span class="si">{}</span><span class="s2"> has been released"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A'</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">'B'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Both buttons released"</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"A"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"B"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"A-holding"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"B-holding"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"both"</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">multi_press</span><span class="p">,</span> <span class="n">multi_release</span><span class="p">,</span> <span class="n">hold</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">multi_press</span><span class="p">,</span> <span class="n">multi_release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>On <strong>line 9</strong>, we are now requiring an argument called <tt class="docutils literal">state</tt>. This is assumed to be a dictionary. It can contain anything you'd like, and the <tt class="docutils literal">ButtonDispatch</tt> class with add in its own keys for the state and holding status of its button. The key holding the state of the button will simply be named whatever was passed for <tt class="docutils literal">token</tt>. The holding status will be stored in a string, combining the <tt class="docutils literal">token</tt> with <tt class="docutils literal"><span class="pre">-holding</span></tt>.</p>
<p>The <tt class="docutils literal">state</tt> argument is stored in an instance variable called <tt class="docutils literal">_state</tt> on <strong>line 11</strong>.</p>
<p><strong>Lines 28-42</strong> contain the most drastic changes of this iteration. Here we use the <tt class="docutils literal">@property</tt> decorator so that any manipulation of <tt class="docutils literal">self.holding</tt>, or <tt class="docutils literal">self.state</tt> actually alters the global state object passed to the constructor.</p>
<p>All of the dispatch methods (<tt class="docutils literal">release()</tt>, <tt class="docutils literal">check()</tt>, <tt class="docutils literal">hold()</tt> and <tt class="docutils literal">press()</tt>, <strong>lines 54-71</strong>) now pass two arguments to the event handlers (or three in the case of <tt class="docutils literal">hold()</tt>) - the token and the global state object (<tt class="docutils literal">hold()</tt> also passes the number of times the event has occurred).</p>
<p>Notice how none of the other code had to change. The interface, all of the attribute and method names, have remained the same and function exactly like they did before.</p>
<p>The event handlers on <strong>lines 93-113</strong> now take the global state object. The new <tt class="docutils literal">multi_press()</tt> and <tt class="docutils literal">multi_release()</tt> functions use the global state to add new multi-button functionality.</p>
<p><tt class="docutils literal">multi_press()</tt> prints <tt class="docutils literal">"A is holding while B was pressed!"</tt> if the <tt class="docutils literal">token</tt> is not "A" (so, it's "B"), and the holding indicator stored in <tt class="docutils literal"><span class="pre">state["A-holding"]</span></tt> is <tt class="docutils literal">True</tt>.</p>
<p>If both buttons are pressed (<tt class="docutils literal"><span class="pre">state['A']</span></tt> and <tt class="docutils literal"><span class="pre">state['B']</span></tt> are <tt class="docutils literal">True</tt>), <tt class="docutils literal">multi_press()</tt> sets the <tt class="docutils literal"><span class="pre">state['both']</span></tt> variable to <tt class="docutils literal">True</tt>, indicating to other handlers that both buttons are pressed. It then takes action, printing <tt class="docutils literal">""Both buttons are being pressed"</tt> to the console.</p>
<p><tt class="docutils literal">multi_release()</tt> prints <tt class="docutils literal">"A is holding and B has been released"</tt> if the button that triggered the event is <em>not</em> the "A" button (<tt class="docutils literal">token</tt>), the "A" button is currently being held (<tt class="docutils literal"><span class="pre">state['A-holding']</span></tt>), and both buttons haven't been pressed (<tt class="docutils literal"><span class="pre">state['both']</span></tt> is <tt class="docutils literal">False</tt>).</p>
<p>If both buttons have been released, indicated by <tt class="docutils literal"><span class="pre">state['both']</span></tt> being <tt class="docutils literal">True</tt>, and the state of each button being <tt class="docutils literal">False</tt> (<tt class="docutils literal"><span class="pre">state['A']</span></tt> and <tt class="docutils literal"><span class="pre">state['B']</span></tt>), <tt class="docutils literal">multi_release()</tt> prints <tt class="docutils literal">"Both buttons released"</tt> to the console and sets <tt class="docutils literal"><span class="pre">state['both']</span></tt> to <tt class="docutils literal">False</tt>.</p>
<p>Finally, we see the <tt class="docutils literal">state</tt> object, implemented here as a dictionary, with the default values, defined on <strong>lines 115-121</strong>.</p>
</div>
<p>A few key differences to note:</p>
<ul class="simple">
<li>We are again using a global <tt class="docutils literal">state</tt> object, in this case a dictionary instead of a class for illustration purposes. While the state tracked in <tt class="docutils literal">ButtonDispatch</tt> is sufficient for almost all of the state we need for this example, in most applications, tracking would be necessary anyway. Having the button state outside of the <tt class="docutils literal">ButtonDispatch</tt> class also separates the button state tracking from the event detection and handling, but sharing the variable means we can keep all state in one place.</li>
<li>As mentioned earler, we're taking advantage of Python's <em>getters</em> and <em>setters</em> functionality so that when you change the <tt class="docutils literal">ButtonDispatch</tt> object's state, it's actually changing our <tt class="docutils literal">state</tt> dictionary. This is an example of the <a class="reference external" href="https://en.wikipedia.org/wiki/Proxy_pattern">Proxy Pattern</a> in action.</li>
<li>We've taken advantage of our new <tt class="docutils literal">state</tt> dictionary to track whether or not both buttons are pressed (the <tt class="docutils literal">both</tt> key). This acts as a <em>guard</em> so that we can differentiate between events.</li>
<li>We've been able to handle some very complex situations in a very simple way - we cover the <em>both buttons pressed</em>, <em>both buttons released</em>, <em>b button pressed while a button is held</em> and <em>b button released while a button is held</em> events without a lot of code.</li>
</ul>
<p>Here's a video of this code running on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-05.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-05.mp4">link to the video</a> instead.</p>
</video>
</div><p>There are many different ways of manipulating global (in the sense of application-wide) state, but this way is the least hard-coded - we take advantage of the fact that Python passes objects <em>by reference</em>, and pass the state object around, as opposed to relying on a global (in the sense of variable scope) object.</p>
<p>When something is <em>passed by reference</em>, it means that the original object isn't copied when it's passed to a function or assigned to another variable. This is more efficient, since only one copy of the object is used in many parts of the code. The side effect of this is that changes to the object, even when it's in a different scope, called by a different name, will affect the original object.</p>
<p>We take advantage of that so that our <tt class="docutils literal">ButtonDispatch</tt> class uses the passed-in <tt class="docutils literal">state</tt> dictionary to store its internal state. This effectively <em>externalizes</em> the state, and separates our concerns nicely.</p>
</div>
</div><!-- /.entry-content -->
</section>
</div>
<footer class="body" id="contentinfo">
<div id="footer-text-wrapper">
<div id="footer-text">&copy; 2019 Josh Johnson. All Rights Reserved. <a href="/pages/about.html">About</a></div>
</div>
</footer>
<script src="/theme/js/main.js"></script>
</body>
</html>