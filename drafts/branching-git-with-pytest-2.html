<!DOCTYPE html>
<html lang="en">
<head>
<!-- Open Graph / Facebook -->
<meta content="website" property="og:type"/>
<meta content="/drafts/branching-git-with-pytest-2.html" property="og:url"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2 - The Collected Works of jjmojojjmojo " property="og:title"/>
<meta content="/theme/images/default-social-full.jpg" property="og:image"/>
<!-- Twitter -->
<meta content="summary_large_image" property="twitter:card"/>
<meta content="https://jjmojojjmojo.github.io/drafts/branching-git-with-pytest-2.html" property="twitter:url"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2 - The Collected Works of jjmojojjmojo " property="twitter:title"/>
<meta content="/theme/images/default-social-full.jpg" property="twitter:image"/>
<meta content="Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2 - The Collected Works of jjmojojjmojo " name="title"/>
<meta content="/theme/images/default-social-full.jpg" property="og:image"/>
<meta content="/theme/images/default-social-full.jpg" property="twitter:image"/>
<title>   Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2 - The Collected Works of jjmojojjmojo 
</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/theme/css/main.css" rel="stylesheet" type="text/css"/>
<link href="/theme/css/syntax-solarized-light.css" id="highlight-css" rel="stylesheet" type="text/css"/>
<script src="/theme/js/zepto.min.js"></script>
<link href="/feeds/all.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Full Atom Feed" type="application/atom+xml"/>
<link href="/feeds/all.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Full RSS Feed" type="application/rss+xml"/>
<link href="/feeds/category.tutorial.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Categories Atom Feed" type="application/atom+xml"/>
<link href="/feeds/category.tutorial.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Categories RSS Feed" type="application/rss+xml"/>
<meta content="This is part two of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" name="description"/>
<meta content="This is part two of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" property="og:description"/>
<meta content="This is part two of a three-part series. This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using pytest and git, via feature branches. Along the way we'll touch on application &hellip;" property="twitter:description"/>
<meta content="python" name="tags"/>
<meta content="git" name="tags"/>
<meta content="branching" name="tags"/>
<meta content="development process" name="tags"/>
</head>
<body class="home" id="index">
<header class="body" id="banner">
<h1><a href="/"><img id="header-home-icon" src="/theme/icons/home.svg"/> <span id="header-site-title">The Collected Works of jjmojojjmojo <strong></strong></span></a></h1>
<ul id="menu">
<li><a href="/pages/about.html">About</a></li>
<li><a href="/pages/contact.html">Contact</a></li>
<li><a href="/pages/index.html">Pages</a></li>
<li><a href="/categories.html">Categories</a></li>
<li><a href="/tags.html">Tags</a></li>
</ul>
<span id="settings-button">
<a href="/pages/settings.html" title="Settings">
<img alt="Gear Icon For Settings" src="/theme/icons/settings.svg"/>
</a>
</span>
</header><!-- /#banner -->
<div id="notice">
<div id="notice-content">
<div style="text-align: center">
<big>ðŸ¦„</big> <strong>Hiring?</strong> Josh is looking for work! <a href="/pages/hire-me.html">More info</a>. <big>ðŸ¦„</big>
</div> </div>
</div>
<div id="content-wrapper">
<section class="body" id="content">
<header>
<h2 class="entry-title">
<a href="/drafts/branching-git-with-pytest-2.html" rel="bookmark" title="Permalink to Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2">Branching With Git And Testing With Pytest: A Comprehensive Guide: Part 2</a></h2>
</header>
<footer class="post-info">
<time class="published" datetime="2019-06-26T09:00:00-04:00">
      Wed 26 June 2019
    </time>
<address class="vcard author">
      By           <a class="url fn" href="/author/jjmojojjmojo.html">jjmojojjmojo</a>
</address>
</footer><!-- /.post-info -->
<div>
<div id="toc"><ul><li><a class="toc-href" href="#setup" title="Setup">Setup</a></li><li><a a="" bug="" class="toc-href" find="" href="#let" s="" title="Let">Let's Find A Bug!</a></li><li><a class="toc-href" href="#fix the bug: an overview" title="Fix The Bug: An Overview">Fix The Bug: An Overview</a></li><li><a class="toc-href" href="#create a branch" title="Create A Branch">Create A Branch</a></li><li><a class="toc-href" href="#replicate the bug in a test" title="Replicate The Bug In A Test">Replicate The Bug In A Test</a></li><li><a class="toc-href" href="#writing a failing test" title="Writing A Failing Test">Writing A Failing Test</a></li><li><a class="toc-href" href="#commit the failing test" title="Commit The Failing Test">Commit The Failing Test</a></li><li><a class="toc-href" href="#actually fix the bug" title="Actually Fix The Bug">Actually Fix The Bug</a></li><li><a class="toc-href" done="" href="#we" not="" quite="" re="" title="We" yet="">We're Not Quite Done Yet</a></li><li><a class="toc-href" href="#version bump" title="Version Bump">Version Bump</a></li><li><a class="toc-href" href="#fetch and rebase" title="Fetch and Rebase">Fetch and Rebase</a></li><li><a class="toc-href" href="#merge master and publish" title="Merge Master And Publish">Merge Master And Publish</a></li><li><a class="toc-href" href="#tag the version" title="Tag The Version">Tag The Version</a></li><li><a class="toc-href" href="#remote vs local branches" title="Remote vs Local Branches">Remote vs Local Branches</a></li><li><a class="toc-href" href="#conclusion/what" next="" s="" title="Conclusion/What">Conclusion/What's Next</a></li></ul></div>
</div>
<div class="warning">
<h2>WARNING</h2>
  You are viewing a <strong>draft</strong> document. It may contain inaccurate, misleading, or unvetted information.
  </div>
<div class="entry-content status-draft">
<!-- Emoji substitutions, because I can't help myself (and my editor doesn't show -->
<!-- emoji for some reason - better to do this since I can replace these with -->
<!-- icons or whatever I want) -->
<p><strong>This is part two of a three-part series.</strong> This is a comprehensive guide to a basic development workflow. Using a simple, but non-trivial web application, we learn how to write tests, fix bugs, and add features using <a class="reference external" href="https://docs.pytest.org">pytest</a> and <a class="reference external" href="https://git-scm.com/">git</a>, via feature branches. Along the way we'll touch on application design and discuss best practices.</p>
<p>In this installment, we will:</p>
<ul class="simple">
<li>Identify and fix a bug on a branch.</li>
<li>Build a new feature, also on a branch.</li>
<li>Use <code>git rebase</code> to keep our change history tidy.</li>
<li>Use tagging to mark new versions of our application.</li>
</ul>
<!-- PELICAN_END_SUMMARY -->
<div class="section" id="setup">
<h2 id="setup">Setup</h2>
<p>Make sure you've got everything set up as outlined in <a class="reference external" href="/branching-git-with-pytest.html">part 1</a>.</p>
<p>Here's a condensed summary:</p>
<ol class="arabic">
<li><p class="first">Ensure you have git, python 3.7+, and venv installed.</p>
</li>
<li><p class="first">Make a bare clone of the base repository to act as our <em>remote</em>:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git clone --bare https://github.com/jjmojojjmojo/random_quote.git random_quote_remote
</pre></div>
</li>
<li><p class="first">Clone our remote:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git clone random_quote_remote random_quote
</pre></div>
</li>
<li><p class="first">Initialize the virtual environment, and install our requirements and project:</p>
<div class="highlight"><pre><span></span><span class="gp">  $</span> <span class="nb">cd</span> random_quote
<span class="gp">  $</span> python -m venv .
<span class="gp">  $</span> <span class="nb">source</span> bin/activate
<span class="go">  (random_quote) $ pip install -r requirements.txt</span>
<span class="go">  (random_quote) $ pip install -e .</span>
</pre></div>
</li>
<li><p class="first">Initialize the database, add some randomly generated quotes:</p>
<div class="highlight"><pre><span></span><span class="go">  (random_quote) $ python scripts/generate_quotes.py</span>
<span class="go">  (random_quote) $ python</span>
<span class="go">  &gt;&gt;&gt; from random_quote import util</span>
<span class="go">  &gt;&gt;&gt; util.init("test.db")</span>
<span class="go">  util.ingest("quotes.csv", "test.db")</span>
</pre></div>
</li>
<li><p class="first">Add the <code>fix_random()</code> test fixture and the extra tests for random functionality. If you had trouble, or would like to skip <code>scripts/state/part1</code>, you can <code>git checkout</code> the <code>part1</code> branch:</p>
<div class="highlight"><pre><span></span><span class="go">  (random_quote) $ git checkout part1</span>
</pre></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>ðŸŒˆ We have branches for all of the major work done in the series:</p>
<dl class="docutils">
<dt><code>part1</code></dt>
<dd><p class="first last">All the changes from <a class="reference external" href="/branching-git-with-pytest.html">part 1</a>.</p>
</dd>
<dt><code>part2</code></dt>
<dd><p class="first last">All the changes from <a class="reference external" href="/branching-git-with-pytest.html">part 1</a> and
<a class="reference external" href="/drafts/branching-git-with-pytest-2.html">part 2</a></p>
</dd>
<dt><code>qotd</code></dt>
<dd><p class="first last">Developer <strong>A</strong>'s feature from <a class="reference external" href="/drafts/branching-git-with-pytest-3.html">part 3</a>.</p>
</dd>
<dt><code>index-info</code></dt>
<dd><p class="first last">Developer <strong>B</strong>'s bug fix from <a class="reference external" href="/drafts/branching-git-with-pytest-3.html">part 3</a>.</p>
</dd>
<dt><code>part3</code></dt>
<dd><p class="first last">All the changes from <a class="reference external" href="/branching-git-with-pytest.html">part 1</a>,
<a class="reference external" href="/drafts/branching-git-with-pytest-2.html">part 2</a> <em>and</em> <a class="reference external" href="/drafts/branching-git-with-pytest-3.html">part 3</a>!</p>
</dd>
</dl>
<p>Feel free to <code>git checkout</code> if you need to reset your code, or jump around.</p>
<p class="last">Use <code>git stash</code> to keep any uncomitted changes for latter. See <a class="reference external" href="https://git-scm.com/book/en/v1/Git-Tools-Stashing">the git documentation</a> for more information. ðŸ¦„</p>
</div>
</li>
</ol>
</div>
<div class="section" id="let-s-find-a-bug">
<h2 id="let's find a bug!">Let's Find A Bug!</h2>
<p>Let's run the application locally so we can play with it in a browser, and identify a bug to fix.</p>
<p><code>requirements.txt</code> has installed a web server for us called <a class="reference external" href="https://gunicorn.org/">Gunicorn</a>. It's a pure-python server that has a lot of great production-quality features.</p>
<p>We'll start the <code>gunicorn</code> server using a couple of useful command-line options, since we'll be messing with the code:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>Gunicorn is a multi-process server. This means it spawns multiple python processes and hands off web requests to them as needed, usually in a round-robin fashion. The processes are killed if they run for too long.</p>
<p>The first option, <code>-b</code> sets the <em>bind</em> port - it's an IP address followed by a port number. Numbers under 1024 are available to you without running with elevated privileges (aka "as root"). The default port is 8000. You can omit this parameter if you'd like, but it's really useful when you're running a bunch of stuff, or for deployment, so it's good practice to get used to using it.</p>
<p>Next option, <code>-t</code> sets the the timeout before a worker is killed and reclaimed. We set this to a very long time so if we are doing something like running a <a class="reference external" href="https://docs.python.org/3/library/pdb.html">pdb</a> session, it won't kick us out before we're done.</p>
<p>The next, <code>-w</code> sets the number of workers. By setting this to one, we can be sure that the <code>pdb</code> session will block all other requests until we're done.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default number of workers is actually already set to 1. However, this is a good switch to know, it's good practice to test your code under a muilti-process environment, since that's often how code will be deployed.</p>
</div>
<p>The last flag is <code>--reload</code>. This flag tells <code>gunicorn</code> to monitor our source files and reload the server if they change.</p>
<p>Finally, we specify which WSGI application to load in [module]:[callable] form. So we have a module called <code>wsgi.py</code> and our app instance is named <code>app</code>.</p>
<p>Here's what <code>wsgi.py</code> looks like:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random_quote</span> <span class="kn">import</span> <span class="n">wsgi</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">RandomQuoteApp</span><span class="p">(</span><span class="s2">"test.db"</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>This module imports the <code>RandomQuoteApp</code> class, and makes an instance of it that points to the <code>test.db</code> we just set up.</p>
</div>
<p>The server will print its logs out to the console so you can see when requests happen, and if any errors pop up.</p>
<p>Now, open a web browser to <a class="reference external" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> . You should get a 404 "Not Found" response. This is expected, since we aren't covering the case of a request for the root, (aka <code>/</code>) in our <code>RandomQuoteApp.__call__()</code> method.</p>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-root-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-root-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-root-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-root-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-root-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-root-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-root-first-pass-200.jpg 200w"/></a>
</div>
<p>We can use the web API in our browser.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I'm using a recent version of <a class="reference external" href="https://www.mozilla.org/en-US/firefox/">Firefox</a> for the screen shots below. It contains a built-in JSON browser if the <code>Content-Type</code> header is set correctly. Super handy ðŸŒˆ</p>
</div>
<p>To get a listing of all the quotes in your database, open <a class="reference external" href="http://127.0.0.1:8080/quotes">http://127.0.0.1:8080/quotes</a>:</p>
<blockquote>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-all-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-all-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-all-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-all-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-all-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-all-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-all-first-pass-200.jpg 200w"/></a>
</div>
</blockquote>
<p>To get a particular quote, open <a class="reference external" href="http://127.0.0.1:8080/quote/1">http://127.0.0.1:8080/quote/1</a> (where 1 is the id of the quote you want):</p>
<blockquote>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-one-quote-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-one-quote-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-one-quote-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-one-quote-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-one-quote-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-one-quote-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-one-quote-first-pass-200.jpg 200w"/></a>
</div>
</blockquote>
<p>To get a random quote, open <a class="reference external" href="http://127.0.0.1:8080/random">http://127.0.0.1:8080/random</a></p>
<blockquote>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-random-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-random-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-random-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-random-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-random-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-random-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-random-first-pass-200.jpg 200w"/></a>
</div>
</blockquote>
<p>Here's a handy map that shows how the various supported API endpoints invoke methods of <code>RandomQuoteApp</code>:</p>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/path-map-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/path-map-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/path-map-first-pass-2500.jpg 2500w,/images/branching-git-pytest/responsive/path-map-first-pass-2000.jpg 2000w,/images/branching-git-pytest/responsive/path-map-first-pass-1800.jpg 1800w,/images/branching-git-pytest/responsive/path-map-first-pass-1600.jpg 1600w,/images/branching-git-pytest/responsive/path-map-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/path-map-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/path-map-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/path-map-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/path-map-first-pass-200.jpg 200w"/></a>
</div>
<p>Now, lets find a bug. Try requesting a quote id that you know doesn't exist. Since we're using numeric ids, requesting an alphanumeric string, like <code>zzzzzz</code> would be a good choice. If we click on <a class="reference external" href="http://127.0.0.1:8080/quote/zzzzzz">http://127.0.0.1:8080/quote/zzzzzz</a>, what happens?</p>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-bad-id-bug.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-bad-id-bug.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-bad-id-bug-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-bad-id-bug-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-bad-id-bug-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-bad-id-bug-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-bad-id-bug-200.jpg 200w"/></a>
</div>
<p>Oh no, "Internal Server Error" is bad. Lets look at the log:</p>
<p><strong>TODO: fix the paths so they look like what the user is probably using</strong></p>
<div class="highlight"><pre><span></span><span class="go">[2019-06-09 18:31:11 -0400] [16676] [INFO] Starting gunicorn 19.9.0</span>
<span class="go">[2019-06-09 18:31:11 -0400] [16676] [INFO] Listening at: http://127.0.0.1:8080 (16676)</span>
<span class="go">[2019-06-09 18:31:11 -0400] [16676] [INFO] Using worker: sync</span>
<span class="go">[2019-06-09 18:31:11 -0400] [16679] [INFO] Booting worker with pid: 16679</span>
<span class="go">[2019-06-09 18:31:20 -0400] [16679] [ERROR] Error handling request /quote/zzzzzz</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File "[...]/random_quote/lib/python3.7/site-packages/gunicorn/workers/sync.py", line 135, in handle</span>
<span class="go">    self.handle_request(listener, req, client, addr)</span>
<span class="go">  File "[...]/random_quote/lib/python3.7/site-packages/gunicorn/workers/sync.py", line 176, in handle_request</span>
<span class="go">    respiter = self.wsgi(environ, resp.start_response)</span>
<span class="go">  File "[...]/random_quote/src/random_quote/wsgi.py", line 29, in __call__</span>
<span class="go">    response = self.get(request)</span>
<span class="go">  File "[...]/random_quote/src/random_quote/wsgi.py", line 54, in get</span>
<span class="go">    quote = self.manager.get(match.group(1))</span>
<span class="go">  File "[...]/random_quote/src/random_quote/manager.py", line 49, in get</span>
<span class="go">    return dict(result)</span>
<span class="go">TypeError: 'NoneType' object is not iterable</span>
</pre></div>
<p>In most web servers, when an exception isn't handled by the application, it "bubbles up" to the server and triggers the return of a 500, "Internal Server Error" response.</p>
<p>In the log, we can see the basic status info that <code>gunicorn</code> gives us, and then on line 6, the traceback begins. On line 17 we see the exception that caused the 500 error originated on line 49 of <code>src/random_quote/manager.py</code>, in the <code>get()</code> method.</p>
<p>Here's that method isolated so we can take a look at it:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Retrieve a specific quote from the database, identified by id_.</span>

<span class="sd">    Returns a dictionary.</span>
<span class="sd">    """</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT id, author, quote, created FROM quotes WHERE id = ?"</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>When the method was written, the author (ðŸ˜Ž) used the fact that the <code>sqlite3.Row</code> class can be transformed into a dictionary by passing it to <code>dict()</code>. However, they  missed the fact that the <code>fetchone()</code> method (line 47) returns <code>None</code> when no rows are returned.</p>
<p>Passing <code>None</code> to <code>dict()</code> on line 49 raises a <code>TypeError</code>, as we saw in the traceback.</p>
<p>Great, so now we've identified the bug. Let's fix it!</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you want to quit <code>gunicorn</code>, type Ctrl-C (hold the "control" or "ctl" key and press "c").</p>
</div>
</div>
<div class="section" id="fix-the-bug-an-overview">
<h2 id="fix the bug: an overview">Fix The Bug: An Overview</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-200.jpg 200w"/></a>
</div>
<p>In brief, we need to:</p>
<ol class="arabic simple">
<li>Create and check out a branch. (<code>git branch</code>, <code>git checkout</code>)</li>
<li>Write a <em>failing</em> test that replicates the bug.</li>
<li>Fix the bug.</li>
<li>Increase the version number.</li>
<li><code>git commit</code> our changes.</li>
<li><code>git fetch</code> any changes to master.</li>
<li><code>git rebase</code> against <code>master</code></li>
<li><code>git checkout master</code>.</li>
<li><code>git merge</code> to our branch.</li>
<li>Fix any conflicts.</li>
<li>Finish the merge (<code>git add</code>, <code>git commit</code>).</li>
<li>Run the tests.</li>
<li><code>git tag</code> the version.</li>
<li><code>git push</code> changes.</li>
</ol>
</div>
<div class="section" id="create-a-branch">
<h2 id="create a branch">Create A Branch</h2>
<p>Let's list the existing branches first:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git branch --list
<span class="go">* master</span>
</pre></div>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-a-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-a-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-a-cropped-200.jpg 200w"/></a>
</div>
<p>We see the <code>master</code> branch all by itself. <code>master</code> is the default name for the first branch in a repository. We have <em>checked out</em> the <code>master</code> branch, as indicated by the asterisk (*).</p>
<p>We need a good name for our branch. The name should be obvious and specific to this bug. If you use an issue tracking system, the issue number is a good idea. Since we aren't using an issue tracker for this guide, lets do something descriptive. We'll call our bug branch <code>bug-unknown-id</code>.</p>
<p>Here's how it is created:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git branch bug-unknown-id
</pre></div>
<p>Running <code>git branch --list</code> again, we can see our branch:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git branch --list
<span class="go">bug-unknown-id</span>
<span class="go">* master</span>
</pre></div>
<p>We're still "on" the <code>master</code> branch. We need to change branches, or <code>git checkout</code> our new branch:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git checkout bug-unknown-id
<span class="go">Switched to branch 'bug-unknown-id'</span>
<span class="gp">(random_quote) $</span> git branch --list
<span class="go">* bug-unknown-id</span>
<span class="go">master</span>
</pre></div>
<p>As we can see, when we call <code>git branch --list</code> again, our branch has the asterisk.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>You can save a step by passing the <code>-b</code> switch to <code>git checkout</code>, creating the branch before checking it out:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git checkout -b some-other-branch
<span class="go"> Switched to a new branch 'some-other-branch'</span>
</pre></div>
<p>And we can see it's been created <em>and</em> checked out:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git branch --list
<span class="go"> bug-unknown-id</span>
<span class="go"> master</span>
<span class="go"> * some-other-branch</span>
</pre></div>
<p>If we want to go back to another branch, we just need to <code>git checkout</code>:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git checkout bug-unknown-id
<span class="go"> Switched to branch 'bug-unknown-id'</span>
</pre></div>
<p>And we can see it's changed again using <code>git branch --list</code>:</p>
<div class="last"><div class="highlight"><pre><span></span><span class="gp"> $</span> git branch --list
<span class="go"> * bug-unknown-id</span>
<span class="go"> master</span>
<span class="go"> some-other-branch</span>
</pre></div>
</div></div>
</div>
<div class="section" id="replicate-the-bug-in-a-test">
<h2 id="replicate the bug in a test">Replicate The Bug In A Test</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-b-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-b-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-200.jpg 200w"/></a>
</div>
<p>We want to add a test that will fail until the bug is fixed. This way we can prevent <em>regressions</em>, or situations where the bug inadvertently comes up later. If it fails now, and we fix it, and it passes, then test case will fail if the bug ever shows up again.</p>
<div class="section" id="more-than-a-bug">
<h3>More Than A Bug</h3>
<p>One thing that sets this particular bug apart from the sort you might run into, is that this bug represents a <em>use case</em> we missed. Like the lack of testing for random quotes we fixed in our first commit, it's not really a bug so much as an oversight.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If this <em>was</em> bug-related, as opposed to an oversight, we could chose to use a name that incorporated the name of the bug or the bug's identifier in our bug tracking system.</p>
</div>
<p>Before we can proceed, we have to make a decision. We've identified an error state when we try to get an quote that doesn't exist in the database. But what <em>should</em> happen if there <em>isn't</em> an error?</p>
<p>There are a few possibilities:</p>
<ol class="arabic simple">
<li>We can raise some kind of <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html">exception</a>, preferably something custom that alerts the developer about what happened, with name like <code>NoQuoteFound</code>.</li>
<li>We can return a <em>token</em> (or <a class="reference external" href="https://en.wikipedia.org/wiki/Sentinel_value">sentinel value</a>) of some kind (<code>None</code>, like the sqlite3 DBAPI does, or <code>False</code>).</li>
<li>We can return an empty dictionary (<code>{}</code>), so the data type is the same, but it won't have the expected keys (it can also act as a token, since <code>bool({}) == False</code>)</li>
<li>We can return a "default" object with values indicative of missing data. For example, the <code>id</code> could be 0, the author <code>Unknown</code> and the <code>quote</code> could be <code>"There is no quote, only Zuul"</code>. The creation date could be long in the past. This way any templates or client code would still "work" in this situation, but it would be obvious something was amiss.</li>
</ol>
<p>Which one is best for your project is a technical decision for you and your team to make. There is a lot to consider with each option (and probably a few other options to consider!). To keep us out of the weeds in this guide, we'll arbitrarily choose the "token", option #2. ðŸ˜Ž</p>
<p>As such, we'll have <code>RandomQuoteManager.get()</code> return <code>None</code>, instead of another common sentinel, like <code>False</code>, so we're explicitly saying "there is no quote with that id" as opposed to "the request you made is not valid". The distinction is subtle here, but it could be more significant in other cases.</p>
</div>
</div>
<div class="section" id="writing-a-failing-test">
<h2 id="writing a failing test">Writing A Failing Test</h2>
<p>We are trying to replicate passing an unknown quote ID to <code>RandomQuoteManager.get()</code>. We can use the "normal" test from <code>src/random_quote/tests/test_manager.py</code> as a template:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_quote</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get a quote by id</span>
<span class="sd">    """</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote"</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Generic quote 2'</span>
</pre></div>
</td></tr></table></div><p>This test calls the <code>get()</code> method with a known id, and checks that the correct text was returned.</p>
<p>We'll name our new test case <code>test_unknown_id</code>. Like the branch name, it should be meaningful, and unique. By default (and convention), a test case has to start with the string <code>test_</code>.</p>
<p>Our <code>test_unknown_id()</code> test case will fail, because it will raise a <code>TypeError</code>. We'll also test that <code>RandomQuoteManager.get()</code> returns <code>None</code> as expected (once we've fixed it).</p>
<p>Let's put this test case at the end of <code>src/random_quote/tests/test_manager.py</code>, after the <code>test_random_quote()</code> case):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_unknown_id</span><span class="p">(</span><span class="n">preconfigured_manager</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Try to get a quote by an unknown id.</span>
<span class="sd">    """</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">preconfigured_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"zzzzz"</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quote</span> <span class="ow">is</span> <span class="bp">None</span>
</pre></div>
</td></tr></table></div><p>Running the tests, we can now see there are 8 tests now, and one fails:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pytest src -v
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.3, py-1.8.0, pluggy-0.12.0 -- [...]/random_quote/bin/python</span>
<span class="go">cachedir: .pytest_cache</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 9 items</span>

<span class="go">src/random_quote/tests/test_manager.py::test_add_quote PASSED             [ 11%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_get_quote PASSED             [ 22%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_remove_quote PASSED          [ 33%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_all PASSED                   [ 44%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_random_quote PASSED          [ 55%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_unknown_id FAILED            [ 66%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote PASSED                [ 77%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_all_quotes PASSED               [ 88%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_random_quote PASSED             [100%]</span>

<span class="go">=================================== FAILURES ====================================</span>
<span class="go">________________________________ test_unknown_id ________________________________</span>

<span class="go">preconfigured_manager = &lt;random_quote.manager.RandomQuoteManager object at 0x104572b00&gt;</span>

<span class="go">    def test_unknown_id(preconfigured_manager):</span>
<span class="go">        """</span>
<span class="go">        Try to get a quote by an unknown id.</span>
<span class="go">        """</span>
<span class="gp">&gt;</span>       <span class="nv">quote</span> <span class="o">=</span> preconfigured_manager.get<span class="o">(</span><span class="s2">"zzzzz"</span><span class="o">)</span>

<span class="go">src/random_quote/tests/test_manager.py:71:</span>
<span class="go">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</span>

<span class="go">self = &lt;random_quote.manager.RandomQuoteManager object at 0x104572b00&gt;</span>
<span class="go">id_ = 'zzzzz'</span>

<span class="go">    def get(self, id_):</span>
<span class="go">        """</span>
<span class="go">        Retrieve a specific quote from the database, identified by id_.</span>

<span class="go">        Returns a dictionary.</span>
<span class="go">        """</span>
<span class="go">        c = self.conn.cursor()</span>

<span class="go">        c.execute("SELECT id, author, quote, created FROM quotes WHERE id = ?", (id_,))</span>

<span class="go">        result = c.fetchone()</span>

<span class="gp">&gt;</span>       <span class="k">return</span> dict<span class="o">(</span>result<span class="o">)</span>
<span class="go">E       TypeError: 'NoneType' object is not iterable</span>

<span class="go">src/random_quote/manager.py:49: TypeError</span>
<span class="go">====================== 1 failed, 8 passed in 11.15 seconds ======================</span>
</pre></div>
<p>Since this test case raises a <code>TypeError</code>, it successfully replicates the bug.</p>
<p>At this point, it's not a bad idea to save our work, so lets look at our changes, and commit them.</p>
</div>
<div class="section" id="commit-the-failing-test">
<h2 id="commit the failing test">Commit The Failing Test</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-b-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-b-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-b-cropped-200.jpg 200w"/></a>
</div>
<p>This is identical to our previous commit process, but lets go through it again.</p>
<p>First, lets check what changed using <code>git status</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git status
<span class="hll"><span class="go">On branch bug-unknown-id</span>
</span><span class="go">Changes not staged for commit:</span>
<span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="go">  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>

<span class="go">    modified:   src/random_quote/tests/test_manager.py</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    quotes.csv</span>
<span class="go">    test.db</span>
<span class="go">    test_example.py</span>

<span class="go">no changes added to commit (use "git add" and/or "git commit -a")</span>
</pre></div>
<p>Note that git tells us which branch we're on. It's a good idea to get in the habit of looking at that line of output.</p>
<p>Next, we'll <code>git commit</code> our changes, using the <code>-m</code> parameter:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git commit -a -m<span class="s2">"Added failing test an unknown id is passed to RandomQuoteManager.get()"</span>
<span class="go">[bug-unknown-id 34afe34] Added failing test an unknown id is passed to RandomQuoteManager.get()</span>
<span class="go"> 1 file changed, 9 insertions(+), 1 deletion(-)</span>
</pre></div>
</div>
<div class="section" id="actually-fix-the-bug">
<h2 id="actually fix the bug">Actually Fix The Bug</h2>
<p>Recall that earlier, we decided that the <code>RandomQuoteManager.get()</code> method return <code>None</code> as a <em>sentinel</em> if a non-existent id is passed.</p>
<p>We can fix this in <code>src/random_quote/manager.py</code> by checking the return value of <code>c.fetchone()</code> before passing it to <code>dict()</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Retrieve a specific quote from the database, identified by id_.</span>

<span class="sd">    Returns a dictionary.</span>
<span class="sd">    """</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT id, author, quote, created FROM quotes WHERE id = ?"</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,))</span>

<span class="hll">    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="bp">None</span>
</span><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div><p>On lines 47 to 52, we've stashed the result from the database cursor into a temporary variable <code>result</code>, and then only feed it to <code>dict()</code> before returning if it's not <code>None</code>. If it is <code>None</code>, we return <code>None</code>. This way the user can do a simple check like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">quote</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_i_want</span><span class="p">)</span>
<span class="k">if</span> <span class="n">quote</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"HEY WE GOT ONE!"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"QUOTE {id_i_want} NOT FOUND!"</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>After making these changes, let's first make sure the code works in the browser. Lets restart gunicorn if it's not still running:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> gunicorn -b <span class="m">127</span>.0.0.1:8080 -t <span class="m">9999999</span> -w <span class="m">1</span> --reload wsgi:app
</pre></div>
<p>And open up <a class="reference external" href="http://127.0.0.1:8080/quote/zzzzzz">http://127.0.0.1:8080/quote/zzzzzz</a>.</p>
<div class="figure align-center" style="width: 80%">
<a href="/images/branching-git-pytest/fullsize/screen-cap-bad-id-first-pass.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/screen-cap-bad-id-first-pass.jpg" srcset="/images/branching-git-pytest/responsive/screen-cap-bad-id-first-pass-1200.jpg 1200w,/images/branching-git-pytest/responsive/screen-cap-bad-id-first-pass-1000.jpg 1000w,/images/branching-git-pytest/responsive/screen-cap-bad-id-first-pass-800.jpg 800w,/images/branching-git-pytest/responsive/screen-cap-bad-id-first-pass-400.jpg 400w,/images/branching-git-pytest/responsive/screen-cap-bad-id-first-pass-200.jpg 200w"/></a>
</div>
<p>At this point, we aren't getting the error anymore, but we aren't necessarily getting a useful result, since we're seeing the JSON serialization of <code>None</code>, the special Javascript value <code>null</code>. We'll deal with this issue in a minute. But our bug is now fixed.</p>
<p>Next, lets re-run our tests:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pytest -v src
<span class="go">============================= test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.3, py-1.8.0, pluggy-0.12.0 -- [...]/random_quote/bin/python</span>
<span class="go">cachedir: .pytest_cache</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 9 items</span>

<span class="go">src/random_quote/tests/test_manager.py::test_add_quote PASSED            [ 11%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_get_quote PASSED            [ 22%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_remove_quote PASSED         [ 33%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_all PASSED                  [ 44%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_random_quote PASSED         [ 55%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_unknown_id PASSED           [ 66%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote PASSED               [ 77%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_all_quotes PASSED              [ 88%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_random_quote PASSED            [100%]</span>

<span class="go">=========================== 9 passed in 0.23 seconds ===========================</span>
</pre></div>
<p>This time, lets take a deeper view of what has changed, using <code>git diff</code>.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>(random_quote) $ git diff
diff --git a/src/random_quote/manager.py b/src/random_quote/manager.py
index 762ef05..d9da9cf 100644
--- a/src/random_quote/manager.py
+++ b/src/random_quote/manager.py
@@ -46,7 +46,11 @@ class RandomQuoteManager:

         result = c.fetchone()

-        return dict(result)
+        if result is None:
+            return None
+        else:
+            return dict(result)
+

     def remove(self, id_):
         """
</pre></div>
</td></tr></table></div><p>The plus signs show what lines we added, and the minus signs show which were removed.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can use <code>git difftool</code> to view diffs in a graphical diff viewer. The <a class="reference external" href="https://git-scm.com/docs/git-difftool">git-difftool docuentation</a> has usage details.</p>
</div>
<p>Now since we like the changes that were made, we can make a commit:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git commit -a -m<span class="s2">"Fixed bug where a non-existent quote id would raise a TypeError"</span>
<span class="go">[bug-unknown-id d9d2408] Fixed bug where a non-existent quote id would raise a TypeError</span>
<span class="go">1 file changed, 6 insertions(+), 1 deletion(-)</span>
</pre></div>
</div>
<div class="section" id="we-re-not-quite-done-yet">
<h2 id="we're not quite done yet">We're Not Quite Done Yet</h2>
<p>As mentioned in the last section, making a web request for <code>/quote/zzzzz</code> no longer raises an exception, but it doesn't necessarily act in a way that's consistent with web standards.</p>
<p>In web APIs, it's best practice to use the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">HTTP status codes</a> to tell a client what you can about how they messed up. In this case, we're returning an empty value, which <em>sort of</em> tells them they messed up, but what we <em>really</em> want to tell the client is, "hey, you asked for a quote that doesn't exist".</p>
<p>The best status code for this situation is the <em>404 Not Found</em> code. Mozila describes it as, "The server can not find requested resource", which is exactly what's happened here.</p>
<p>So we need to get our <code>RandomQuoteApp</code> to detect when <code>RandomQuoteManager.get()</code> returns <code>None</code>, and send the correct HTTP status in the response.</p>
<p>As before, lets write the test first, expecting it to fail.</p>
<p>Again, we can look to a similar test case, this time in <code>src/random_quote/tests/test_wsgi.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_quote</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for a single pre-existing quote.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/quote/1"</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">'200 OK'</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>

    <span class="k">assert</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"rowid"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">quote</span><span class="p">[</span><span class="s2">"quote"</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Generic quote 1'</span>
</pre></div>
</td></tr></table></div><p>What we want to do in our new case, is request a bad id, and test for a 404 response, like we got in our browser earlier.</p>
<p>We can test this by adding the following test case to the end of <code>src/random_quote/tests/test_wsgi.py</code> (after <code>test_random_quote()</code>):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_quote_unknown_id</span><span class="p">(</span><span class="n">preconfigured_wsgi_app</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make a GET request for a single pre-existing quote, but the id doesn't exist.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">preconfigured_wsgi_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/quote/zzzzzz"</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">'404 Not Found'</span>
</pre></div>
</td></tr></table></div><p><code>WebTest.TestApp</code>, returned by our fixture, does a lot of checking for us. Normally, it will even raise an exception when a non-"200 OK" status is returned. So in order to check for a specific status, we need to let the <code>TestApp.get()</code> method know we are expecting a different response code. This is done with the <code>status</code> keyword parameter (it can be a specific number, or a pattern to match, like "4??").</p>
<p>When the tests run, we see the error, this time, it's raised by <code>WebTest.Testapp</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pytest -v src
<span class="go">============================= test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.3, py-1.8.0, pluggy-0.12.0 -- [...]/random_quote/bin/python</span>
<span class="go">cachedir: .pytest_cache</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 10 items</span>

<span class="go">src/random_quote/tests/test_manager.py::test_add_quote PASSED            [ 10%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_get_quote PASSED            [ 20%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_remove_quote PASSED         [ 30%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_all PASSED                  [ 40%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_random_quote PASSED         [ 50%]</span>
<span class="go">src/random_quote/tests/test_manager.py::test_unknown_id PASSED           [ 60%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote PASSED               [ 70%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_all_quotes PASSED              [ 80%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_random_quote PASSED            [ 90%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py::test_get_quote_unknown_id FAILED    [100%]</span>

<span class="go">=================================== FAILURES ===================================</span>
<span class="go">__________________________ test_get_quote_unknown_id ___________________________</span>

<span class="go">preconfigured_wsgi_app = &lt;webtest.app.TestApp object at 0x102fda6a0&gt;</span>

<span class="go">    def test_get_quote_unknown_id(preconfigured_wsgi_app):</span>
<span class="go">        """</span>
<span class="go">        Make a GET request for a single pre-existing quote, but the id doesn't exist.</span>
<span class="go">        """</span>
<span class="gp">&gt;</span>       <span class="nv">response</span> <span class="o">=</span> preconfigured_wsgi_app.get<span class="o">(</span><span class="s2">"/quote/zzzzzz"</span>, <span class="nv">status</span><span class="o">=</span><span class="m">404</span><span class="o">)</span>

<span class="go">src/random_quote/tests/test_wsgi.py:63:</span>
<span class="go">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</span>
<span class="go">lib/python3.7/site-packages/webtest/app.py:335: in get</span>
<span class="go">    expect_errors=expect_errors)</span>
<span class="go">lib/python3.7/site-packages/webtest/app.py:654: in do_request</span>
<span class="go">    self._check_status(status, res)</span>
<span class="go">_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</span>

<span class="go">self = &lt;webtest.app.TestApp object at 0x102fda6a0&gt;, status = 404</span>
<span class="go">res = &lt;200 OK application/json body=b'null'&gt;</span>

<span class="go">    def _check_status(self, status, res):</span>
<span class="go">        if status == '*':</span>
<span class="go">            return</span>
<span class="go">        res_status = res.status</span>
<span class="go">        if (isinstance(status, string_types) and '*' in status):</span>
<span class="go">            if re.match(fnmatch.translate(status), res_status, re.I):</span>
<span class="go">                return</span>
<span class="go">        if isinstance(status, string_types):</span>
<span class="go">            if status == res_status:</span>
<span class="go">                return</span>
<span class="go">        if isinstance(status, (list, tuple)):</span>
<span class="go">            if res.status_int not in status:</span>
<span class="go">                raise AppError(</span>
<span class="go">                    "Bad response: %s (not one of %s for %s)\n%s",</span>
<span class="go">                    res_status, ', '.join(map(str, status)),</span>
<span class="go">                    res.request.url, res)</span>
<span class="go">            return</span>
<span class="go">        if status is None:</span>
<span class="go">            if res.status_int &gt;= 200 and res.status_int &lt; 400:</span>
<span class="go">                return</span>
<span class="go">            raise AppError(</span>
<span class="go">                "Bad response: %s (not 200 OK or 3xx redirect for %s)\n%s",</span>
<span class="go">                res_status, res.request.url,</span>
<span class="go">                res)</span>
<span class="go">        if status != res.status_int:</span>
<span class="go">            raise AppError(</span>
<span class="gp">&gt;</span>               <span class="s2">"Bad response: %s (not %s)\n%s"</span>, res_status, status, res<span class="o">)</span>
<span class="go">E           webtest.app.AppError: Bad response: 200 OK (not 404)</span>
<span class="go">E           b'null'</span>

<span class="go">lib/python3.7/site-packages/webtest/app.py:689: AppError</span>
<span class="go">====================== 1 failed, 9 passed in 0.49 seconds ======================</span>
</pre></div>
<p>Now, let's make this test pass, by getting the <code>RandomQuoteApp.get()</code> method to return a 404 when <code>None</code> is returned by <code>RandomQuoteManager.get()</code>.</p>
<p><code>webob</code> comes with a few handy helper classes and 'canned' responses to make things like returning a 404 error code easy. In particular, it provides <code>webob.exc.HTTPNotFound</code>. It is a hybrid class that is a <code>webob.Response</code> object, but also a python <code>Exception</code>. It can be raised by part of your application, <em>caught</em> and returned to the user like any other <code>webob.Response</code> to let them know something went wrong.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We make use of this in the <code>RandomQuoteApp.__call__()</code> method, in the code we use to route requests to various methods and objects:</p>
<div class="last"><div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Invoke the WSGI application - routing.</span>

<span class="sd">    Based on the request path, invokes the appropriate method, passing a</span>
<span class="sd">    pre-constructed webob.Request object.</span>

<span class="sd">    Expects each method to return a webob.Response object, which will be</span>
<span class="sd">    invoked and returned as per the WSGI protocol.</span>
<span class="sd">    """</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/quotes"</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/quote"</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/random"</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">error_response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div></div></div>
<p>With the help of <code>webob.exc.HTTPNotFound</code>, we'll fix <code>RandomQuoteApp.get()</code>. Add the two highlighted lines to <code>src/random_quote/wsgi.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return a webob.Response object with a JSON payload containing the</span>
<span class="sd">        requested quote. The quote id is specified as the last part of the</span>
<span class="sd">        request path:</span>

<span class="sd">            /quote/12345</span>


<span class="sd">        """</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">"/([^/]+)$"</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>

        <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="hll">        <span class="k">if</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
</span><span class="hll">            <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

        <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">quote</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table></div><p>Now, when we run the tests again, the <code>test_get_quote_unknown_id()</code> case passes:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pytest src
<span class="go">============================== test session starts ==============================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.6.2, py-1.8.0, pluggy-0.12.0</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 10 items</span>

<span class="go">src/random_quote/tests/test_manager.py ......                             [ 60%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ....                                  [100%]</span>

<span class="go">=========================== 10 passed in 0.18 seconds ===========================</span>
</pre></div>
<p>The last thing to do is to commit these changes. We'll leave that as an exercise for the reader. Remember to <code>git status</code>, and feel free to use the <code>-m</code> flag to <code>git commit</code> if you'd like.</p>
</div>
<div class="section" id="version-bump">
<h2 id="version bump">Version Bump</h2>
<p>Our project uses <a class="reference external" href="https://semver.org/">semantic versioning</a>. The 'semver' website has all of the specifics, but the gist is that each version of the software is represented by a number, broken into three parts (to quote the spec):</p>
<ol class="arabic simple">
<li><strong>MAJOR</strong> version when you make incompatible API changes,</li>
<li><strong>MINOR</strong> version when you add functionality in a backwards-compatible manner, and</li>
<li><strong>PATCH</strong> version when you make backwards-compatible bug fixes.</li>
</ol>
<p>Each version is incremented as corresponding changes are made. Versions start at zero.</p>
<p>The goal is to make it easy to compare versions as the code evolves. It's also easier to make certain judgments about the code's stability and compatibility.</p>
<p>For example, if you built your application against version <strong>1.0.0</strong> of a library, you can assume that your application will continue to work with version <strong>1.0.4</strong> (the fourth bug fix), as well as <strong>1.2.0</strong> (the second time backwards-compatible features were added), and <strong>1.99.223</strong> (99th feature release, 223rd bug fix - <em>yikes</em>). But, you can expect your code to need modifications if you want to upgrade to version <strong>2.0.0</strong>.</p>
<p>Since our project is pre-release, but we're confident the API will stay stable, the project is initially versioned <strong>0.1.0</strong>.</p>
<p>Since our application is being distributed as a python egg, we're setting the version using the <code>version</code> argument to <code>setup()</code> in our <code>setup.py</code>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"random_quote"</span><span class="p">,</span>
<span class="hll">    <span class="n">version</span><span class="o">=</span><span class="s2">"0.1.0"</span><span class="p">,</span>
</span>    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">'random_quote'</span><span class="p">],</span>
    <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">''</span><span class="p">:</span><span class="s1">'src'</span><span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">'webob'</span><span class="p">],</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div><p>You can also add <strong>EXTENSIONS</strong> to the version when needed, like <strong>0.1.0-alpha</strong>. These extensions are useful for special releases, like handing off a pre-release version to testers or early adopters, or if you make a special variant of a release for a specific client.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>There are many ways to version software, <a class="reference external" href="https://en.wikipedia.org/wiki/Software_versioning">semantic versioning isn't the only one</a>. We've used it here because it's pretty common, and has some benefits. In particular, its very compatible with python packaging.</p>
<p class="last">Before you adopt it wholesale in your projects, be sure to read up on its faults and look at other perspectives. <a class="reference external" href="https://surfingthe.cloud/semantic-versioning-anti-pattern/">This post by Brandon Gillespie</a> and the <a class="reference external" href="https://news.ycombinator.com/item?id=13378637">Hacker News discussion about it</a> are great examples of what to look for.</p>
</div>
<p>Now that we have a basic understanding of semantic versioning, it may be apparent what we need to do, now that we've fixed our first bug: <strong>we need to update the version number</strong>.</p>
<p>Since this is the first bug, we just need to increment the last number. As such, our new version is <strong>0.1.1</strong>.</p>
<p>We'll leave making this change as an exercise for the user.</p>
<p>After the version change, be sure to re-install the application, using <code>pip</code>, as we did in the initial setup:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pip install -e .
<span class="go">Obtaining file://[...]/random_quote</span>
<span class="go">Requirement already satisfied: webob in ./lib/python3.7/site-packages (from random-quote==0.1.1) (1.8.5)</span>
<span class="go">Installing collected packages: random-quote</span>
<span class="go">  Found existing installation: random-quote 0.1.0</span>
<span class="go">    Uninstalling random-quote-0.1.0:</span>
<span class="go">      Successfully uninstalled random-quote-0.1.0</span>
<span class="go">  Running setup.py develop for random-quote</span>
<span class="go">Successfully installed random-quote</span>
</pre></div>
<p>And re-run the tests to make sure everything is still working:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> pytest src
<span class="go">==================================== test session starts =====================================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.4.1, py-1.8.0, pluggy-0.10.0</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 10 items</span>

<span class="go">src/random_quote/tests/test_manager.py ......                                          [ 60%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ....                                               [100%]</span>

<span class="go">================================= 10 passed in 0.18 seconds ==================================</span>
</pre></div>
<p>Finally, remember to use <code>git status</code> and <code>git diff</code> to make sure the changes are correct before committing, and be sure to write a useful log message.</p>
</div>
<div class="section" id="fetch-and-rebase">
<h2 id="fetch and rebase">Fetch and Rebase</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-c-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-c-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-c-cropped-200.jpg 200w"/></a>
</div>
<p>We now have a backlog containing a handful of changes, all regarding this bug:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git log --pretty<span class="o">=</span>oneline

<span class="go">5b81947745f2c184619a9d7c1a99546d9aa01662 (HEAD -&gt; bug-unknown-id) Increased the version number</span>
<span class="go">640c4e2431776e9b6c252bef1c7509fee1557c79 Added test for requesting a non-existant quote id in the HTTP API</span>
<span class="go">615a72a651293607e5429fc1b5bac1486cc2b486 Fixed bug where a non-existent quote id would raise a TypeError</span>
<span class="go">a2806131faa19444964868234ec02123d47f73ef Added failing test an unknown id is passed to RandomQuoteManager.get()</span>

<span class="go">-- snip --</span>
</pre></div>
<p>In order to make our changes part of the <code>master</code> branch, we need to incorporate them into the changes in that branch. This can be done with <code>git merge</code>, but all of our commits will be mixed into the commit log. This is bad.  Why? There are a handful of reasons:</p>
<ul class="simple">
<li>When someone looks at the log for the <code>master</code> branch, it will be messy.</li>
<li>Trying to understand everything that was changed across many commits is difficult.</li>
<li>If we messed up, and our bug fix needed to be reverted, it's hard to pinpoint exactly what we did.</li>
</ul>
<p>We can address all of these issues with <code>git rebase</code>. It also adds "piece of mind", allowing us to commit frequently with poorly written commit messages without worrying that they will pollute the main log. ðŸ˜Ž</p>
<p>Rebase allows us to do a lot, but the basic purpose is to alter commits, including taking existing commits and condensing them down, as we're going to do here.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code>git rebase</code> is a destructive action. <strong>It cannot be undone</strong> (well, <a class="reference external" href="https://stackoverflow.com/questions/134882/undoing-a-git-rebase">it can</a>, but it's not easy). It's a very intuitive tool and something you'll get comfortable with quickly. Just be careful.</p>
<p>There are several ways to protect yourself. The simplest is to just duplicate your checkout as a backup before you do your rebase:</p>
<div class="highlight"><pre><span></span><span class="go"> (random_quote) $ cd ..</span>
<span class="go"> (random_quote) $ cp -r random_quote random_quote_before_rebase_because_im_scared</span>
</pre></div>
<p class="last">Just be sure to delete it as soon as you're finished. Note that your virtual environment might not function. There are hard-coded paths in some of the environment files. To use the environment, you'll need to clean out the virtual environment directories/files (<code>lib</code>, <code>bin</code>, <code>include</code>, <code>pyvenv.cfg</code>) and re-run <code>python -m venv .</code>.</p>
</div>
<p>First, we'll use <code>git fetch</code> to retrieve the latest version of the <code>master</code> branch:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git fetch origin master
<span class="go">From [...]/random_quote_remote</span>
<span class="go"> * branch            master     -&gt; FETCH_HEAD</span>
</pre></div>
<p><code>git rebase</code> has an <em>interactive</em> mode that makes the process simple ðŸ¦„. Start by invoking <code>git rebase</code> with the <code>-i</code> switch and telling git what you want to rebase <em>to</em>. In our case, we want to rebase against the changes made to <code>master</code>, the branch we started with (this can be a branch, a specific commit id, or a tag):</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git rebase -i master
</pre></div>
<p>We'll be presented with a file in our editor (it will likely be <code>vim</code> on most platforms, but as discussed earlier, it's configurable and varies) that looks like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pick a280613 Added failing test an unknown id is passed to RandomQuoteManager.get()
pick 615a72a Fixed bug where a non-existent quote id would raise a TypeError
pick 640c4e2 Added test for requesting a non-existant quote id in the HTTP API
pick 5b81947 Increased the version number

# Rebase 370f975..5b81947 onto 370f975 (4 commands)
#
# Commands:
# p, pick &lt;commit&gt; = use commit
# r, reword &lt;commit&gt; = use commit, but edit the commit message
# e, edit &lt;commit&gt; = use commit, but stop for amending
# s, squash &lt;commit&gt; = use commit, but meld into previous commit
# f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message
# x, exec &lt;command&gt; = run command (the rest of the line) using shell
# b, break = stop here (continue rebase later with 'git rebase --continue')
# d, drop &lt;commit&gt; = remove commit
# l, label &lt;label&gt; = label current HEAD with a name
# t, reset &lt;label&gt; = reset HEAD to a label
# m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]
# .       create a merge commit using the original merge commit's
# .       message (or the oneline, if no original merge commit was
# .       specified). Use -c &lt;commit&gt; to reword the commit message.
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
</pre></div>
</td></tr></table></div><p>There are two sections to this file - the first is the list of commits (lines 1-3), in order from oldest to newest. The rest of the file is git, once again giving us really helpful in-line guidance. ðŸ¦„</p>
<p>Each commit line has three parts, separated by spaces:</p>
<ol class="arabic simple">
<li>the <em>command</em>, as referenced in the help text.</li>
<li>the <em>git id</em> - a unique string that represents that commit within the repository. The ids are a <em>hash</em> of a bunch of information, and are usually very long - they are different enough that it's possible to reference them using the "short" form here. This works most places where a git id is needed.</li>
<li>the first line of the <em>commit log message</em>, to help you understand what you're looking at.</li>
</ol>
<p>We just want to <code>squash</code> these commits down to one, so we need to <code>pick</code> one to use as the final commit. We need to ensure that we pick the oldest (the first one) so everything gets included.</p>
<p>With the correct commands in place, the first three lines look like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pick a280613 Added failing test an unknown id is passed to RandomQuoteManager.get()
squash 615a72a Fixed bug where a non-existent quote id would raise a TypeError
squash 640c4e2 Added test for requesting a non-existant quote id in the HTTP API
squash 5b81947 Increased the version number

# -- snip --
</pre></div>
</td></tr></table></div><p>When we save this file, <code>git rebase</code> will present us with <em>another</em> file - this is the commit log entry for our new squashed commit. Git does us a favor by aggregating all of the log entries for us, and giving us a summary of what the new commit looks like, in terms of what files changed:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span># This is a combination of 4 commits.
# This is the 1st commit message:

Added failing test an unknown id is passed to RandomQuoteManager.get()

# This is the commit message #2:

Fixed bug where a non-existent quote id would raise a TypeError

# This is the commit message #3:

Added test for requesting a non-existant quote id in the HTTP API

# This is the commit message #4:

Increased the version number

# Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
#
# Date:      Thu Jun 13 11:10:16 2019 -0400
#
# interactive rebase in progress; onto 370f975
# Last commands done (4 commands done):
#    squash 640c4e2 Added test for requesting a non-existant quote id in the HTTP API
#    squash 5b81947 Increased the version number
# No commands remaining.
# You are currently rebasing branch 'bug-unknown-id' on '370f975'.
#
# Changes to be committed:
#       modified:   setup.py
#       modified:   src/random_quote/manager.py
#       modified:   src/random_quote/tests/test_manager.py
#       modified:   src/random_quote/tests/test_wsgi.py
#
# Untracked files:
#       quotes.csv
#       test.db
#       test_example.py
#
</pre></div>
</td></tr></table></div><p>This gives us a chance to write a nice, concise log entry that covers everything we did to fix this bug. Remove lines 1-16 and replace with something like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>BUG: if a bad quote id was given (invalid, non-existent), a TypeError was raised.
</pre></div>
</td></tr></table></div><p>And as before, we want to be concise. If we needed to elaborate, we could do so on the subsequent lines.</p>
<p>After we save that file, git will tell us if the rebase was a success:</p>
<div class="highlight"><pre><span></span><span class="go">[detached HEAD e80d483] BUG: if a bad quote id was given (invalid, non-existent), a TypeError was raised.</span>
<span class="go"> Date: Tue May 7 11:05:01 2019 -0400</span>
<span class="go"> 3 files changed, 23 insertions(+), 4 deletions(-)</span>
<span class="go">Successfully rebased and updated refs/heads/bug-unknown-id.</span>
</pre></div>
<p>If we run <code>git log --pretty</code> again, we can see our old commits are gone, and the last one is present:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git log --pretty

<span class="go">commit e80d48320ea1e912d8d0c137b32a21f33492e8f5 (HEAD -&gt; bug-unknown-id)</span>
<span class="go">Author: Josh Johnson &lt;jjmojojjmojo@gmail.com&gt;</span>
<span class="go">Date:   Tue May 7 11:05:01 2019 -0400</span>

<span class="go">    BUG: if a bad quote id was given (invalid, non-existent), a TypeError was raised.</span>

<span class="go">-- snip --</span>
</pre></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>If you messed up the file causing a "recoverable" error, like say you tried to <code>squash</code> every commit and forgot to <code>pick</code> one, git will put you into an "in progress" state. Typically, this state is used when you need to fix conflicts (we'll cover that in <a class="reference external" href="{filename}/branching-git-with-pytest-3.html">part 3</a>), or do other work on the code to make a rebase complete successfully.</p>
<p>You might get an error like this:</p>
<div class="highlight"><pre><span></span><span class="go"> error: cannot 'squash' without a previous commit</span>
<span class="go"> You can fix this with 'git rebase --edit-todo' and then run 'git rebase --continue'.</span>
<span class="go"> Or you can abort the rebase with 'git rebase --abort'.</span>
</pre></div>
<p>You'll also see you have a rebase in progress when you run <code>git status</code>:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git status
<span class="go"> interactive rebase in progress; onto 70ae1f2</span>
<span class="go"> No commands done.</span>
<span class="go"> Next commands to do (3 remaining commands):</span>
<span class="go">    s b707557 Added test for a bug where specifying a nonexistent quote id throws a TypeError</span>
<span class="go">    s b751360 Fixed bug where a non-existent quote id would raise a TypeError</span>
<span class="go">   (use "git rebase --edit-todo" to view and edit)</span>
<span class="go"> You are currently editing a commit while rebasing branch 'bug-unknown-id' on '70ae1f2'.</span>
<span class="go">   (use "git commit --amend" to amend the current commit)</span>
<span class="go">   (use "git rebase --continue" once you are satisfied with your changes)</span>

<span class="go"> Untracked files:</span>
<span class="go">   (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">     test.db</span>

<span class="go"> nothing added to commit but untracked files present (use "git add" to track)</span>
</pre></div>
<p>Again, git tells us exactly what we need to do. If you just made a typo, the best thing to do is issue <code>git rebase --abort</code>. This will put you back to the way things were before you invoked <code>git rebase -i</code>:</p>
<div class="highlight"><pre><span></span><span class="gp"> $</span> git rebase --abort
</pre></div>
<p class="last">Now <code>git status</code> will look like it did before the aborted rebase.</p>
</div>
<p>To be sure we didn't loose anything or make any mistakes during the rebase, now we should run the tests again:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> pytest src
<span class="go">=========================== test session starts ===========================</span>
<span class="go">platform darwin -- Python 3.7.3, pytest-4.4.1, py-1.8.0, pluggy-0.10.0</span>
<span class="go">rootdir: [...]/random_quote</span>
<span class="go">collected 10 items</span>

<span class="go">src/random_quote/tests/test_manager.py ......                       [ 60%]</span>
<span class="go">src/random_quote/tests/test_wsgi.py ....                            [100%]</span>

<span class="go">======================== 10 passed in 0.18 seconds ========================</span>
</pre></div>
<p>We should see 10 tests as before, and they should all pass.</p>
</div>
<div class="section" id="merge-master-and-publish">
<h2 id="merge master and publish">Merge Master And Publish</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-d-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-d-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-d-cropped-200.jpg 200w"/></a>
</div>
<p>If we know someone has changed the code in <code>master</code> since we branched, we will need to incorporate those changes into our branch before we proceed.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">We know this hasn't happened, since we're the only ones working on this code. ðŸ˜€ Don't fret, we'll simulate a collaboration in <a class="reference external" href="/drafts/branching-git-with-pytest-3.html">part 3</a>!.</p>
</div>
<p>In either case, we still have to go through the same basic process.</p>
<p>Now, we'll <code>git checkout</code> <code>master</code>, and <code>git merge</code> our branch:</p>
<p>First the <code>git checkout</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git checkout master
<span class="go">Switched to branch 'master'</span>
<span class="go">Your branch is up to date with 'origin/master'.</span>
</pre></div>
<p>Then the <code>git merge</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git merge bug-unknown-id
<span class="go">Updating 370f975..94a4210</span>
<span class="go">Fast-forward</span>
<span class="go"> setup.py                               |  2 +-</span>
<span class="go"> src/random_quote/manager.py            |  7 +++++--</span>
<span class="go"> src/random_quote/tests/test_manager.py | 10 +++++++++-</span>
<span class="go"> src/random_quote/tests/test_wsgi.py    | 10 +++++++++-</span>
<span class="go"> 4 files changed, 24 insertions(+), 5 deletions(-)</span>
</pre></div>
<p><code>git status</code> shows us that we are one commit ahead of our remote repository:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git status
<span class="go">On branch master</span>
<span class="go">Your branch is ahead of 'origin/master' by 1 commit.</span>
<span class="go">  (use "git push" to publish your local commits)</span>

<span class="go">Untracked files:</span>
<span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>

<span class="go">    test.db</span>

<span class="go">nothing added to commit but untracked files present (use "git add" to track)</span>
</pre></div>
<p>To make our changes public, we just need to <code>git push</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git push origin master
</pre></div>
<p>Now we can see our bug fix as a single commit in the log:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git log --pretty

<span class="go">commit e80d48320ea1e912d8d0c137b32a21f33492e8f5 (HEAD -&gt; master, origin/master, origin/HEAD, bug-unknown-id)</span>
<span class="go">Author: Josh Johnson &lt;jjmojojjmojo@gmail.com&gt;</span>
<span class="go">Date:   Tue May 7 11:05:01 2019 -0400</span>

<span class="go">    BUG: if a bad quote id was given (invalid, non-existent), a TypeError was raised.</span>

<span class="go">-- snip --</span>
</pre></div>
</div>
<div class="section" id="tag-the-version">
<h2 id="tag the version">Tag The Version</h2>
<div class="figure align-right" style="width: 40%">
<a href="/images/branching-git-pytest/fullsize/workflow-overview-part2-e-cropped.jpg"><img alt="" sizes="" src="/images/branching-git-pytest/fullsize/workflow-overview-part2-e-cropped.jpg" srcset="/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-2500.jpg 2500w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-2000.jpg 2000w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-1800.jpg 1800w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-1600.jpg 1600w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-1200.jpg 1200w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-1000.jpg 1000w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-800.jpg 800w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-400.jpg 400w,/images/branching-git-pytest/responsive/workflow-overview-part2-e-cropped-200.jpg 200w"/></a>
</div>
<p>Git has a concept of "tagging" - where you can assign a user-friendly label to a specific commit. It can make it really easy for people to check out a specific point in the history of the code. Technically they are <em>optional</em>, but are a very useful tool.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are two types of tags, "lightweight" and "annotated". The specifics aren't important for this guide, just be aware there is a difference, and know that we are using lightweight tags here.</p>
</div>
<p>Git assumes that you want to tag the current commit if you don't specify one, so if we look at the last log entry, we'll know what's being tagged:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git log -n1
<span class="go">commit e80d48320ea1e912d8d0c137b32a21f33492e8f5 (HEAD -&gt; master, tag: v0.1.1, origin/master, origin/HEAD, bug-unknown-id)</span>
<span class="go">Author: Josh Johnson &lt;jjmojojjmojo@gmail.com&gt;</span>
<span class="go">Date:   Tue May 7 11:05:01 2019 -0400</span>

<span class="go">    BUG: if a bad quote id was given (invalid, non-existent), a TypeError was raised.</span>
</pre></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If we wanted to tag a different commit, we just need to note the id (in this case <code>e80d48320ea1e912d8d0c137b32a21f33492e8f5</code>). We can use just the first few characters to save some typing, like <code>e80d4832</code>.</p>
</div>
<p>We are going to name our tag <code>v0.1.1</code>. The exact format is up to you and people you collaborate with, but it's useful to use a common prefix to help classify what the tag <em>means</em>. In this case, we're using <code>v</code> to indicate a release version. This is helpful later when your project has possibly hundreds of tags, for may reasons besides marking released versions, since we can do pattern matching when listing tags.</p>
<p>Now for the actual tagging:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git tag v0.1.1
</pre></div>
<p>To see what tags we've made, we can run <code>git tag</code> without any arguments:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git tag
<span class="go">v0.1.1</span>
</pre></div>
<p>If we wanted to limit what tags we want to see, we can use the <code>-l</code> parameter:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git tag -l <span class="s2">"v*"</span>
<span class="go">v0.1.1</span>
</pre></div>
<p>We can remove a tag using the <code>-d</code> flag:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git tag -d v0.1.1
<span class="go">Deleted tag 'v0.1.1' (was e80d483)</span>
</pre></div>
<div class="section" id="remote-vs-local-tags">
<h3>Remote Vs Local Tags</h3>
<p>So far, we've only used <em>local</em> tags. These tags only exist in our working directory - they aren't available in our <em>remote</em>, or the repository we cloned. To make a tag remote, we use <code>git push</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git tag v0.1.1 <span class="c1"># need to remake since we deleted it above</span>
<span class="gp">(random_quote) $</span> git push origin v0.1.1
<span class="go">Total 0 (delta 0), reused 0 (delta 0)</span>
<span class="go">To [...]/random_quote_remote</span>
<span class="go"> * [new tag]         v0.1.1 -&gt; v0.1.1</span>
</pre></div>
<p>This is very similar to when we ran <code>git push</code> in the last section, but git knows we are only asking to send the new tag to the repository.</p>
<p>To delete a remote tag, we need to let <code>git push</code> know with the <code>--delete</code> flag:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git push origin --delete v0.1.1
<span class="go"> - [deleted]         v0.1.1</span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>At this point, if you've followed along, we've deleted our tag. It would be a good idea to recreate it. Here's a condensed version of the process:</p>
<div class="last"><div class="highlight"><pre><span></span><span class="go"> (random_quote) $ git tag v0.1.1</span>
<span class="go"> (random_quote) $ git push origin v0.1.1</span>
<span class="go"> Total 0 (delta 0), reused 0 (delta 0)</span>
<span class="go"> To [...]/random_quote_remote</span>
<span class="go">  * [new tag]         v0.1.1 -&gt; v0.1.1</span>
</pre></div>
</div></div>
</div>
</div>
<div class="section" id="remote-vs-local-branches">
<h2 id="remote vs local branches">Remote vs Local Branches</h2>
<p>As with tags, branches exist in <em>local</em> and <em>remote</em> versions. Our branch, so far, only exists in our clone of the repository. This is good, since we were able to fix our bug and merge our changes into <code>master</code> without having to show the code to anyone.</p>
<p>However, when you are collaborating with people, you'll often need to give them access to your code. This is done by making your branch <em>remote</em>.</p>
<p>We use <code>git push</code> to do this, just like we did with tags:</p>
<div class="highlight"><pre><span></span><span class="gp">(random_quote) $</span> git push origin bug-unknown-id
<span class="go">Total 0 (delta 0), reused 0 (delta 0)</span>
<span class="go">To [...]/random_quote_remote</span>
<span class="go"> * [new branch]      bug-unknown-id -&gt; bug-unknown-id</span>
</pre></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It's OK to push to your remote branch frequently. There are a few git actions that are a little more difficult (<a class="reference external" href="https://stackoverflow.com/questions/22682870/git-undo-pushed-commits/22683231">reverting your changes</a>, for example) once you've pushed, but remember, you are working on a branch, and you will be rebasing later, so there's little risk and you get the benefit of being able to back up your changes to the git remote and show your progress to your collaborators.</p>
</div>
</div>
<div class="section" id="conclusion-what-s-next">
<h2 id="conclusion/what's next">Conclusion/What's Next</h2>
<p>In this installment, we got a lot more comfortable writing tests and doing stuff with git. At this point, we're ready to do any sort of feature or bug work, and leave a clean commit log when we're done.</p>
<p>In the <a class="reference external" href="/drafts/branching-git-with-pytest-3.html">final part</a> of this series, we'll simulate two developers working on different branches and causing a conflict, which we'll learn how to resolve.</p>
</div>
</div><!-- /.entry-content -->
</section>
</div>
<footer class="body" id="contentinfo">
<div id="footer-text-wrapper">
<div id="footer-text">&copy; 2019 Josh Johnson. All Rights Reserved. <a href="/pages/about.html">About</a></div>
</div>
</footer>
<script src="/theme/js/main.js"></script>
</body>
</html>