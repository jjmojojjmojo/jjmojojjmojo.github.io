<!DOCTYPE html>
<html lang="en">
<head>
<title>   Exploring State: Non-Blocking Events In CircuitPython - The Collected Works of jjmojojjmojo 
</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/theme/css/main.css" rel="stylesheet" type="text/css"/>
<link href="/theme/css/syntax-solarized-light.css" id="highlight-css" rel="stylesheet" type="text/css"/>
<script src="/theme/js/zepto.min.js"></script>
<link href="/feeds/all.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Full Atom Feed" type="application/atom+xml"/>
<link href="/feeds/all.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Full RSS Feed" type="application/rss+xml"/>
<link href="/feeds/category.tutorial.atom" rel="alternate" title="The Collected Works of jjmojojjmojo Categories Atom Feed" type="application/atom+xml"/>
<link href="/feeds/category.tutorial.rss" rel="alternate" title="The Collected Works of jjmojojjmojo Categories RSS Feed" type="application/rss+xml"/>
<meta content="tutorial" name="tags"/>
<meta content="circuitpython" name="tags"/>
<meta content="hardware" name="tags"/>
<meta content="state" name="tags"/>
</head>
<body class="home" id="index">
<header class="body" id="banner">
<h1><a href="/"><img id="header-home-icon" src="/theme/icons/home.svg"/> <span id="header-site-title">The Collected Works of jjmojojjmojo <strong></strong></span></a></h1>
<ul id="menu">
<li><a href="/pages/about.html">About</a></li>
<li><a href="/pages/contact.html">Contact</a></li>
<li><a href="/pages/index.html">Pages</a></li>
<li><a href="/categories.html">Categories</a></li>
<li><a href="/tags.html">Tags</a></li>
</ul>
<span id="settings-button">
<a href="/pages/settings.html" title="Settings">
<img alt="Gear Icon For Settings" src="/theme/icons/settings.svg"/>
</a>
</span>
</header><!-- /#banner -->
<div id="content-wrapper">
<section class="body" id="content">
<header>
<h2 class="entry-title">
<a href="/drafts/non-blocking-events-in-circuitpython.html" rel="bookmark" title="Permalink to Exploring State: Non-Blocking Events In CircuitPython">Exploring State: Non-Blocking Events In CircuitPython</a></h2>
</header>
<footer class="post-info">
<time class="published" datetime="2018-06-11T15:07:00-04:00">
      Mon 11 June 2018
    </time>
<address class="vcard author">
      By           <a class="url fn" href="/author/lionfacelemonface.html">lionfacelemonface</a>
</address>
</footer><!-- /.post-info -->
<div>
<div id="toc"><ul><li><a class="toc-href" href="#the-project-the-platform" title="The Project, The Platform">The Project, The Platform</a></li><li><a class="toc-href" href="#audience" title="Audience">Audience</a></li><li><a class="toc-href" href="#demo-project" title="Demo Project">Demo Project</a></li><li><a class="toc-href" href="#materials" title="Materials">Materials</a></li><li><a class="toc-href" href="#abstractions-keeping-the-code-simple" title="Abstractions: Keeping The Code Simple">Abstractions: Keeping The Code Simple</a></li><li><a class="toc-href" href="#testing" title="Testing">Testing</a></li><li><a class="toc-href" href="#the-problem-debouncing-for-fun-and-profit" title="The Problem: Debouncing For Fun And Profit">The Problem: Debouncing For Fun And Profit</a></li><li><a class="toc-href" href="#basics-of-state" title="Basics Of State">Basics Of State</a></li><li><a class="toc-href" href="#state-considerations" title="State: Considerations">State: Considerations</a></li><li><a class="toc-href" href="#a-generic-state-dispatcher" title="A Generic State Dispatcher">A Generic State Dispatcher</a></li><li><a class="toc-href" href="#example-application-blink-controller" title="Example Application: Blink Controller">Example Application: Blink Controller</a></li><li><a class="toc-href" href="#what-to-do-when-you-run-out-of-memory" title="What To Do When You Run Out Of Memory">What To Do When You Run Out Of Memory</a></li></ul></div>
</div>
<div class="warning">
<h2>WARNING</h2>
  You are viewing a <strong>draft</strong> document. It may contain inaccurate, misleading, or unvetted information.
  </div>
<div class="entry-content status-draft">
<!-- Emoji substitutions, because I can't help myself (and my editor doesn't show -->
<!-- emoji for some reason - better to do this since I can replace these with -->
<!-- icons or whatever I want) -->
<p>In this article we'll cover dealing with state and working with events in a non-blocking way in <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/what-is-circuitpython">CircuitPython</a>, <a class="reference external" href="https://adafruit.com">Adafruit's</a> port of <a class="reference external" href="https://micropython.org/">MicroPython</a> for the  <a class="reference external" href="https://www.microchip.com/wwwproducts/en/ATSAMD21G18">ATSAMD21 Cortex M0 microprocessor</a>.</p>
<p>We'll explore the most common use case for state, <em>button debouncing</em>, but also explore state as a concept, and discuss patterns for dealing with it in a microcontroller environment.</p>
<p>While the code is being developed for CircuitPython, the concepts and patterns are universal, and apply to any microcontroller (and even some applications outside of embedded platforms).</p>
<!-- PELICAN_END_SUMMARY -->
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">At the time of writing, Adafruit has just released/announced the first boards in it's M4 line based on the  ATSAMD51 Cortex M4 chip! (namely the <a class="reference external" href="https://blog.adafruit.com/2018/06/12/new-product-adafruit-itsybitsy-m4-express-featuring-atsamd51/">ItsyBitsy M4 Express</a> and <a class="reference external" href="https://blog.adafruit.com/2018/06/27/coming-soon-adafruit-feather-m4-express-featuring-atsamd51-cortex-m4/">Feather M4 Express</a>).</p>
</div>
<div class="section" id="the-project-the-platform">
<h2 id="the-project-the-platform">The Project, The Platform</h2>
<p>All of the code and thought that in this article has its roots in a personal project. I wanted to make a low-impact tool to help me mouse more efficiently.</p>
<p>I found the answer in <a class="reference external" href="https://en.wikipedia.org/wiki/Capacitive_sensing">capacative touch</a>. This is the same technology behind modern cellphones and touchscreens.</p>
<p>I was psyched when I found out that the Adafruit M0 series of microcontroler boards provided up to <a class="reference external" href="https://learn.adafruit.com/adafruit-feather-m0-express-designed-for-circuit-python-circuitpython/circuitpython-cap-touch">7 touch capable pins</a> <em>and</em> they can become USB interface devices that can emulate a mouse or keyboard (and more). With these boards, there's no need for an external board or IC for touch or USB control, all I need is an M0, some conductive objects, and some code and I can do <a class="reference external" href="https://learn.adafruit.com/capacitive-touch-unicorn-horn/introduction">some insanely cool stuff</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The M4 boards <strong>do not</strong> support capacitive touch.</p>
</div>
<p>These boards also provide power management either built-in or it can be <a class="reference external" href="https://www.adafruit.com/product/2124">easily added</a>. It makes it easy to build a portable project that runs off of batteries, but still can be powered from the USB port (and in the case of a rechargable LiPoly battery pack, the USB port can be used to charge it as well).</p>
<p>What makes these boards a really killer platform for hobby projects is that the M0/M4 series also support <strong>CircuitPython</strong>, Adafruit's fork of MicroPython for these particular ARM controllers. It's <em>Python</em>, and one of the languages I'm most comfortable with.</p>
<p>Besides my personal preference, Python is a great language for learning, rapid prototyping, and general computing.</p>
<p>CircuitPython is being developed with the express goal of making MicroPython more accessible to new programmers. Because of this, it diverges a bit from MicroPython. MicroPython has already diverged a bit from standard Python as well.</p>
<p>The differences aren't significant enough to hinder people new to Python and/or microcontrollers, but if you already know MicroPython, or Python it might be a bit of an adjustment.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The full list of differences:</p>
<ul class="last simple">
<li><a class="reference external" href="https://circuitpython.readthedocs.io/en/3.x/#differences-from-micropython">CircuitPython vs MicroPython</a></li>
<li><a class="reference external" href="https://docs.micropython.org/en/latest/pyboard/genrst/index.html">MicroPython vs Python</a></li>
</ul>
</div>
<p>That aside, this is a really exciting platform. It stands to provide a gateway for non-programmers to get into computer science and electrical engineering. It's a great time to be alive!</p>
<p>It's not all 🌈's and 🦄's though. In spite of generally being a great platform, CircuitPython has some limitations, that everyone should be aware of. A much more powerful processor is required to run any flavor of MicroPython. Even with more power, the interpreted nature of Python makes code run, overall, slower than comparable compiled Arduino code.</p>
<p>Because a Python interpreter has to be constructed to execute Python code, the platform is also very RAM (<a class="reference external" href="https://en.wikipedia.org/wiki/Random-access_memory">random access memory</a>) intensive. RAM is a precious resource on any microcontroller, and CircuitPython eats up a lot of working memory before our program even runs. People experienced with microcontrollers will be used to dealing with this, but because of the interpreter, you're at a disadvantage before your code is even loaded. Programs will start to run out of memory when they approach 150-200 lines of code. That includes external libraries. That's not a lot to work with.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">We'll cover ways of reducing our memory footprint in this article. It's actually not as bad as it might seem.</p>
</div>
<p>Further, Python code, especially raw text, takes up a lot of space in another precious resource, <em>flash memory</em>. This is where our program code is stored. Again, this is nothing shocking if we've done any embedded development before, but using Python puts us at a bit of a disadvantage - our code can only be compiled down to an intermediary format, it can't be turned into compact machine code, so we have a lot less space to work with.</p>
<p>Beyond this, Adafruit has made it pretty clear that CircuitPython is geared toward <em>beginners</em>, and as such their priorities for adding features and the general design of the platform has that audience at the forefront. This can cause some frustration if you want to use a MicroPython or Arduino feature that hasn't been ported to CircuitPython, access an on-board peripheral or use an external IC/breakout board that Adafruit doesn't yet support.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This sounds way more dire than it is, and is changing all the time. CircuitPython is still relatively new and is under constant development. 💖 Adafruit has done an amazing job of supporting the onboard peripherals and the chips and breakout boards they sell in CircuitPython.</p>
<p class="last">I don't want to downplay what they've accomplished, but if you are coming from other MicroPython boards or the Arduino, or you aspire to build projects that use the full capacity of your microcontroller, you should be aware of what you're getting into.</p>
</div>
<p>With all that in mind, I'm happy to say Adafruit has done a great job overcoming the worst of these limitations with their M0 boards. Using the ARM based processors means much faster processor cycles - the M0 runs at 48Mhz, the M4 at 120Mhz (verses 8Mhz or 16Mhz for most common Arduino-compatible boards). There's a slowdown running Python on these boards, but for most applications it won't even be remotely noticeable.</p>
<p>These chips have a large amount of RAM to begin with, 32kb for the M0 and a whopping <em>192kb</em> for the M4 (compared to 2Kb for most common/classic Arduino chips).</p>
<p>To address the issue of flash memory, Adafruit provides the <em>express</em> series of M0/M4 boards - they add in 2MB of extra flash memory that <em>just works</em> for storing Python code (you can use it as general storage as well).</p>
<p>In practice, with the right development boards, the advantages of CircuitPython far outweigh the downsides. In exchange for slightly more expensive components, limited low-level accessibility, and sometimes having to write less-than-elegant Python, we get an incredibly powerful platform for rapid prototyping. I've been using it for a few months now and have found it to be exceedingly capable.</p>
<p>What makes most of these concerns completely moot is that Adafruit's CircuitPython-compatible boards fully support the Arduino IDE. So if we can't work within the limitations of CircuitPython, we can always switch to the Arduino tooling, and unlock the full potential of the M0/M4 chips.</p>
</div>
<div class="section" id="audience">
<h2 id="audience">Audience</h2>
<p>This guide is written for people who know basic Python, and have done rudimentary things with microcontrollers, like control LEDs and read from momentary switches.</p>
<p>It doesn't assume you are a Python expert, or have done anything too elaborate with microcontrollers - but it will expose you to some advanced concepts.</p>
<p>It's a good idea to work through <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/overview">Adafruit's "Welcome To CircuitPython"</a> guide before trying to dig into the topics covered here, but it's not necessary.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It wouldn't hurt to also work through <a class="reference external" href="https://learn.adafruit.com/circuitpython-essentials">CircuitPython Essentials</a> as well!</p>
</div>
<p>This article does dive really deep into details when exploring the concepts behind the code being developed. It also provides line-by-line explanations of each code example. So don't be afraid to give this guide a shot, even if you're really new to microcontrollers.</p>
<p>Please feel free to <a class="reference external" href="/pages/contact.html">contact the author</a> with questions, corrections, or suggestions on how to make this article more accessible!</p>
</div>
<div class="section" id="demo-project">
<h2 id="demo-project">Demo Project</h2>
<p>To illustrate state in action, I've devised a simple, but not overly contrived demonstration project.</p>
<p>It consists of two buttons, a single one-color LED, and a single "addressable" RGB LED. I've chosen these particular components because they are easy to obtain and hook up. In fact, the single LED and RGB LED (a DotStar or NeoPixel depending on the board) come integrated on all CircuitPython-capable boards.</p>
<div class="centered docutils container">
<a href="/images/fullsize/circuitplayground-express-closeup-neopixel-marked.jpg"><img alt="" sizes="(min-width: 1696.0px) 320px,(min-width: 1272.0px) 240px,(min-width: 1060.0px) 200px,(min-width: 848.0px) 160px,(min-width: 424.0px) 80px,(min-width: 212.0px) 40px" src="/images/fullsize/circuitplayground-express-closeup-neopixel-marked.jpg" srcset="/images/responsive/circuitplayground-express-closeup-neopixel-marked-1600.jpg 1600w,/images/responsive/circuitplayground-express-closeup-neopixel-marked-1200.jpg 1200w,/images/responsive/circuitplayground-express-closeup-neopixel-marked-1000.jpg 1000w,/images/responsive/circuitplayground-express-closeup-neopixel-marked-800.jpg 800w,/images/responsive/circuitplayground-express-closeup-neopixel-marked-400.jpg 400w,/images/responsive/circuitplayground-express-closeup-neopixel-marked-200.jpg 200w" style="width: 20%;"/></a>
<a href="/images/fullsize/itsybitsy-m0-express-closeup-dotstar-marked.jpg"><img alt="" sizes="(min-width: 848.0px) 160px,(min-width: 424.0px) 80px,(min-width: 212.0px) 40px" src="/images/fullsize/itsybitsy-m0-express-closeup-dotstar-marked.jpg" srcset="/images/responsive/itsybitsy-m0-express-closeup-dotstar-marked-800.jpg 800w,/images/responsive/itsybitsy-m0-express-closeup-dotstar-marked-400.jpg 400w,/images/responsive/itsybitsy-m0-express-closeup-dotstar-marked-200.jpg 200w" style="width: 20%;"/></a>
<a href="/images/fullsize/trinket-m0-closeup-dotstar-marked.jpg"><img alt="" sizes="(min-width: 1060.0px) 200px,(min-width: 848.0px) 160px,(min-width: 424.0px) 80px,(min-width: 212.0px) 40px" src="/images/fullsize/trinket-m0-closeup-dotstar-marked.jpg" srcset="/images/responsive/trinket-m0-closeup-dotstar-marked-1000.jpg 1000w,/images/responsive/trinket-m0-closeup-dotstar-marked-800.jpg 800w,/images/responsive/trinket-m0-closeup-dotstar-marked-400.jpg 400w,/images/responsive/trinket-m0-closeup-dotstar-marked-200.jpg 200w" style="width: 20%;"/></a>
<a href="/images/fullsize/gemma-m0-closeup-dotstar-marked.jpg"><img alt="" sizes="(min-width: 1060.0px) 200px,(min-width: 848.0px) 160px,(min-width: 424.0px) 80px,(min-width: 212.0px) 40px" src="/images/fullsize/gemma-m0-closeup-dotstar-marked.jpg" srcset="/images/responsive/gemma-m0-closeup-dotstar-marked-1000.jpg 1000w,/images/responsive/gemma-m0-closeup-dotstar-marked-800.jpg 800w,/images/responsive/gemma-m0-closeup-dotstar-marked-400.jpg 400w,/images/responsive/gemma-m0-closeup-dotstar-marked-200.jpg 200w" style="width: 20%;"/></a>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">On the CircuitPlayground, even the buttons are already integrated!</p>
</div>
<p>The features of the demo project are as follows:</p>
<dl class="docutils">
<dt>Phase 1:</dt>
<dd><ul class="first last simple">
<li>One button will control the rate of blink of the red LED.</li>
<li>The other button will turn the red LED on or off - it will not affect the blink rate.</li>
</ul>
</dd>
<dt>Phase 2:</dt>
<dd><ul class="first last simple">
<li>The functionality of Phase 1 will continue, except the RGB LED will blink as well. The "rate button" will change the blink rate of both LEDs.</li>
<li>Pressing both buttons will change the color of the RGB LED.</li>
</ul>
</dd>
<dt>Phase 3:</dt>
<dd><ul class="first last simple">
<li>Functionality of Phase 2 will persist, except holding the other button will determine if the rate button is changing the blink rate of the RGB LED or the red LED. If it's held, the RGB LED rate is changed. If It's not held, the red LED rate is changed.</li>
</ul>
</dd>
</dl>
<p>This is a fairly simple project but because of the complex button logic, it will really put our state and event code through its paces.</p>
</div>
<div class="section" id="materials">
<h2 id="materials">Materials</h2>
<p>If you'd like to follow along, you will need the following items:</p>
<ul class="simple">
<li>A CircuitPython-capable development board (M0/M4 series, express recommended).</li>
<li>Two momentary switches (buttons).</li>
<li>A micro-USB cable.</li>
<li>Connectors (jumper cables, alligator clips, solid-core wire; specifics will depend on which board you are using).</li>
<li>A breadboard.</li>
</ul>
<p>You can get all of these items from Adafruit, <a class="reference external" href="https://www.adafruit.com/wishlists/467781">here's a list</a>.</p>
<p>I've also sourced them and similar ones from Mouser, to give you some idea of possible substitutions: <a class="reference external" href="https://www.mouser.com/ProjectManager/ProjectDetail.aspx?AccessID=b9d0704608">shared cart</a>.</p>
<p>Amazon resellers will generally carry most of these things, even the Adafruit boards. It's a good idea to shop around, since there's a large gradient between cost, available options, shipping, and quality.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>I do not do affiliate links and do not endorse any particular storefront.</strong></p>
<p>My point in providing saved carts and wishlists is to help you find what you need.</p>
<p class="last">💖 That said, if given the opportunity, I will go on about Adafruit's quality and fast shipping, and this is based soley on my personal experiences with their online store and products. 🦄 💖</p>
</div>
<div class="section" id="the-development-board">
<h3>The Development Board</h3>
<p>Any of the M0 or M4 based boards <a class="reference external" href="https://www.adafruit.com/category/957">sold by Adafruit</a> should be compatible with the code in this article.</p>
<p>I am fortunate to own, in part due to recent attendance at PyCon 2018, <em>four</em> examples of the M0 boards, and have tested the code on each:</p>
<a href="/images/fullsize/nonblocking-m0-boards-2.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-m0-boards-2.jpg" srcset="/images/responsive/nonblocking-m0-boards-2-2500.jpg 2500w,/images/responsive/nonblocking-m0-boards-2-2000.jpg 2000w,/images/responsive/nonblocking-m0-boards-2-1800.jpg 1800w,/images/responsive/nonblocking-m0-boards-2-1600.jpg 1600w,/images/responsive/nonblocking-m0-boards-2-1200.jpg 1200w,/images/responsive/nonblocking-m0-boards-2-1000.jpg 1000w,/images/responsive/nonblocking-m0-boards-2-800.jpg 800w,/images/responsive/nonblocking-m0-boards-2-400.jpg 400w,/images/responsive/nonblocking-m0-boards-2-200.jpg 200w" style="width: 80%;"/></a>
<p>From left to right, we have
the <a class="reference external" href="https://www.adafruit.com/product/3333">CircuitPlayground Express</a>,
the <a class="reference external" href="https://www.adafruit.com/product/3727">ItsyBitsy M0 Express</a>,
the <a class="reference external" href="https://www.adafruit.com/product/3500">Trinket M0</a>,
and the <a class="reference external" href="https://www.adafruit.com/product/3500">GEMMA M0</a>. There's also a <a class="reference external" href="https://en.wikipedia.org/wiki/Quarter_(United_States_coin)">quarter</a> for scale. On the whole, these things are <em>tiny</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<a href="/images/fullsize/gemma-m0-closeup-obverse.jpg"><img alt="" class="align-right" sizes="(min-width: 1060.0px) 200px,(min-width: 848.0px) 160px,(min-width: 424.0px) 80px,(min-width: 212.0px) 40px" src="/images/fullsize/gemma-m0-closeup-obverse.jpg" srcset="/images/responsive/gemma-m0-closeup-obverse-1000.jpg 1000w,/images/responsive/gemma-m0-closeup-obverse-800.jpg 800w,/images/responsive/gemma-m0-closeup-obverse-400.jpg 400w,/images/responsive/gemma-m0-closeup-obverse-200.jpg 200w" style="width: 20%;"/></a>
<p>The GEMMA M0 I have is a special edition that was included in the SWAG bag at PyCon 2018 in Cleveland Ohio. It's functionally identical to the GEMMA you get from the Adafruit shop but it's a different color and has a special Pycon 2018 marking on the back.</p>
<p class="last">There was not a lot of fanfare about it, but I did find a <a class="reference external" href="https://www.youtube.com/watch?v=71eAnJeQu2U">video by Dan Bader</a> talking about it, and a great <a class="reference external" href="https://bigl.es/friday-fun-adafruit-gemma-m0-and-neopixels/">blog post by Les Pounder</a> putting it through its paces.</p>
</div>
<p>Which board should you use? It depends on your application, as each board has it's strengths.</p>
<p>The GEMMA, for example, is designed for wearable tech projects - it has a battery hookup and power regulator, as well as an on/off switch. The Trinket is absolutely lilliputian in its scale and a farily basic board. Both the GEMMA and Trinket have limited pins available. The ItsyBitsy and CircuitPlayground, being express boards, have extra flash memory. The CircuitPlayground has wearable features like the GEMMA, but it has a million nifty peripherals built in. It exposes a relatively small number of pins. In contrast, the ItsyBitsy is fairly barebones like the Trinket but has a <em>lot</em> of pins available.</p>
<p>The <a class="reference external" href="https://www.adafruit.com/category/946">Feather boards</a> (not pictured) have a ton of great built-in peripherals provide a standard platform for expansion boards called "<a class="reference external" href="https://www.adafruit.com/category/945">wings</a>". They are a great, super-compact alternative to the old-school Arduino and Arduino Shield platform. I have an ESP8266-based Feather and one based on the ATmega32u4 with bluetooth LE, and really like the platform.</p>
<p>Speaking of Arudino shields, Adafruit also makes an M0 board that's in the same form factor as the original Arduino, called the <a class="reference external" href="https://learn.adafruit.com/adafruit-metro-m0-express-designed-for-circuitpython">Metro M0 Express</a>. If you've already invested in a lot of Arduino shields, this is the board for you.</p>
<p>In any case, <strong>I would highly recommend doing any initial development on the CircuitPlayground Express</strong>. It has a dizzying array of peripherals built in, plus battery and power regulation, along with a large number of easy-to-work-with pads - it's appropriate for wearable projects as well as more traditional applications. It's easy to migrate to a smaller/less featureful board when a project starts to really come together.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>If your budget allows, and especially if you are just starting out, I'd suggest springing for the <a class="reference external" href="https://www.adafruit.com/product/2769">Circuit Playground Express Advanced Pack</a>. I had a couple of M0 boards and a lot of miscellaneous breakout boards before I picked up this kit, and I wish I had started with it instead.</p>
<p class="last">It gives you everything you need to explore the possibilities of the platform (save maybe some wire and a breadboard or two), without having to solder anything!</p>
</div>
<p>A few things to keep in mind with regard to the "lilypad" style boards (GEMMA, CircuitPlayground; so-called after one of the first "wearable" platforms, <a class="reference external" href="https://store.arduino.cc/usa/lilypad-arduino-main-board">The Adruino LilyPad</a>) verses the "standard" ones (Trinket, ItsyBitsy):</p>
<ul class="simple">
<li>Lilypad-style boards do not require any soldering or other assembly - you can just unpack them, plug in a USB cable, and start coding. You will typically use alligator clips, or conductive thread, to connect them to other components.</li>
<li>Standard boards will require some soldering. You'll either have to solder wires directly to the pin pads on the perimeter of the board, or use the provided headers.</li>
<li>You can, however, solder things to the lilypad-style pads for a sturdier connection.</li>
</ul>
</div>
<div class="section" id="connectors">
<h3>Connectors</h3>
<div class="section" id="alligator-clips">
<h4>Alligator Clips</h4>
<p>The CircuitPlayground has everything we need built in. It comes with two buttons soldered to the board (labeled "A" and "B"). So we don't really need any sort of connectors. For any other projects, you will need to pick up some alligator clips, but to follow along with this article, the CircuitPlayground is all you need.</p>
<a href="/images/fullsize/aligator-clips.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/aligator-clips.jpg" srcset="/images/responsive/aligator-clips-2500.jpg 2500w,/images/responsive/aligator-clips-2000.jpg 2000w,/images/responsive/aligator-clips-1800.jpg 1800w,/images/responsive/aligator-clips-1600.jpg 1600w,/images/responsive/aligator-clips-1200.jpg 1200w,/images/responsive/aligator-clips-1000.jpg 1000w,/images/responsive/aligator-clips-800.jpg 800w,/images/responsive/aligator-clips-400.jpg 400w,/images/responsive/aligator-clips-200.jpg 200w" style="width: 80%;"/></a>
</div>
<div class="section" id="alligator-clip-to-jumper-wire">
<h4>Alligator Clip To Jumper Wire</h4>
<p>The Gemma will require some Aligator-to-male jumper clips to connect the breadboard where the to the Gemma pads.</p>
<a href="/images/fullsize/aligator-to-jumper.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/aligator-to-jumper.jpg" srcset="/images/responsive/aligator-to-jumper-2500.jpg 2500w,/images/responsive/aligator-to-jumper-2000.jpg 2000w,/images/responsive/aligator-to-jumper-1800.jpg 1800w,/images/responsive/aligator-to-jumper-1600.jpg 1600w,/images/responsive/aligator-to-jumper-1200.jpg 1200w,/images/responsive/aligator-to-jumper-1000.jpg 1000w,/images/responsive/aligator-to-jumper-800.jpg 800w,/images/responsive/aligator-to-jumper-400.jpg 400w,/images/responsive/aligator-to-jumper-200.jpg 200w" style="width: 80%;"/></a>
</div>
<div class="section" id="jumper-wires">
<h4>Jumper Wires</h4>
<p>Other boards will require the use of jumper wires. For the sake of this article, the pre-made kind or cut pieces of solid-core wire will work. We've used both in the example circuits below.</p>
<a href="/images/fullsize/premade-jumper-wires-organized.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/premade-jumper-wires-organized.jpg" srcset="/images/responsive/premade-jumper-wires-organized-2500.jpg 2500w,/images/responsive/premade-jumper-wires-organized-2000.jpg 2000w,/images/responsive/premade-jumper-wires-organized-1800.jpg 1800w,/images/responsive/premade-jumper-wires-organized-1600.jpg 1600w,/images/responsive/premade-jumper-wires-organized-1200.jpg 1200w,/images/responsive/premade-jumper-wires-organized-1000.jpg 1000w,/images/responsive/premade-jumper-wires-organized-800.jpg 800w,/images/responsive/premade-jumper-wires-organized-400.jpg 400w,/images/responsive/premade-jumper-wires-organized-200.jpg 200w" style="width: 80%;"/></a>
<a href="/images/fullsize/solid-core-jumper-wires.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/solid-core-jumper-wires.jpg" srcset="/images/responsive/solid-core-jumper-wires-2500.jpg 2500w,/images/responsive/solid-core-jumper-wires-2000.jpg 2000w,/images/responsive/solid-core-jumper-wires-1800.jpg 1800w,/images/responsive/solid-core-jumper-wires-1600.jpg 1600w,/images/responsive/solid-core-jumper-wires-1200.jpg 1200w,/images/responsive/solid-core-jumper-wires-1000.jpg 1000w,/images/responsive/solid-core-jumper-wires-800.jpg 800w,/images/responsive/solid-core-jumper-wires-400.jpg 400w,/images/responsive/solid-core-jumper-wires-200.jpg 200w" style="width: 80%;"/></a>
<a href="/images/fullsize/nonblocking-lengths-of-wire.jpg"><img alt="" class="align-center" sizes="(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-lengths-of-wire.jpg" srcset="/images/responsive/nonblocking-lengths-of-wire-400.jpg 400w,/images/responsive/nonblocking-lengths-of-wire-200.jpg 200w" style="width: 80%;"/></a>
</div>
</div>
<div class="section" id="the-circuit">
<h3>The Circuit</h3>
<p>There are different ways you can set up buttons to work with the various M0 boards (save the CircuitPlayground, since it has them built-in), but for this article we'll use a breadboard and jumper wires.</p>
<p>The circuit ties one side of each button to ground, and then the other side to a pin on the board. This means that the buttons will read "LOW" when pressed. We'll use a "pull up" resistor to keep the high voltage from "floating". The resistor is built in to the microcontroller, so we can just turn them on in software.</p>
<p>I chose this approach for a few key reasons:</p>
<ul class="simple">
<li>It keeps the component count down - you don't need anything but the buttons and some wire. The other way of hooking up the buttons, where the button is tied to 3V, would require a resistor for each button. Most microcontrollers have pull up resistors built in these days, otherwise we'd also need an additional resistor for each pin as well.</li>
<li>It's safer, since we're connecting the buttons, and ultimately the microcontroller pins, to <em>ground</em> instead of a live current. We can't do much, if any, damage if we misconfigure the pins in software, or the button is damaged (this is why we need the resistors if we were to wire the buttons up the other way).</li>
<li>It's the most commonly used approach in the vast majority of tutorials and documentation these days, because of the previous two points. If you've used momentary switches with a microcontroller before, you're likely already familiar with this type of circuit.</li>
</ul>
<p>The trade off is that the button logic seems inverted compared to what common sense would dictate: when we press the button, it reads "LOW", and when it's not pressed, it reads "HIGH".</p>
<p>The CircuitPlayground Express is wired in the reverse configuration, and requires a pull-<em>down</em> resistor turned on in software. The logic is also inverted to be "correct". This was done this way to make teaching easier with the board, but it adds an inconsistency in my little platoon of M0 development boards. This will be dealt with below.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference external" href="https://en.wikipedia.org/wiki/Limor_Fried">Lady Ada</a> wrote a <a class="reference external" href="http://www.ladyada.net/learn/arduino/lesson5.html">classic tutorial</a> on the subject of wiring buttons to digital inputs. It explains everything, including the concept of "floating" really well. Highly recommended reading.</p>
</div>
<p>I've used three different kinds of breadboards I had on hand, and mixed up the kinds of connectors a bit to illustrate some different ways of wiring up the buttons.</p>
<div class="section" id="gemma-m0">
<h4>Gemma M0</h4>
<a href="/images/fullsize/nonblocking-gemma-demo-circuit.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-gemma-demo-circuit.jpg" srcset="/images/responsive/nonblocking-gemma-demo-circuit-2500.jpg 2500w,/images/responsive/nonblocking-gemma-demo-circuit-2000.jpg 2000w,/images/responsive/nonblocking-gemma-demo-circuit-1800.jpg 1800w,/images/responsive/nonblocking-gemma-demo-circuit-1600.jpg 1600w,/images/responsive/nonblocking-gemma-demo-circuit-1200.jpg 1200w,/images/responsive/nonblocking-gemma-demo-circuit-1000.jpg 1000w,/images/responsive/nonblocking-gemma-demo-circuit-800.jpg 800w,/images/responsive/nonblocking-gemma-demo-circuit-400.jpg 400w,/images/responsive/nonblocking-gemma-demo-circuit-200.jpg 200w" style="width: 80%;"/></a>
<p>With the Gemma, I used a "mini" breadboard. These breadboards are split into two halves by the screw holes at the top and bottom, and the "trench" in the middle. The tie points are connected in groups of five, running left to right. I've installed the buttons such that they straddle the trench. This was necessary because of a little plastic bit that sticks out between the pins.</p>
<p>I wanted to make sure I had easy access to the buttons, so I put all of the jumper connections on the left side. On the right side, I made a little ground "bus" by tying together the rows where I needed to connect the buttons to ground with some solid-core wire. I tied the ground jumper/alligator clip to the "bus" using a little piece of wire over the screw hole.</p>
<p>I clipped the black alligator clip to ground, the white one (button "A") to "D1" (also marked "A0" if you use it as an analog pin), and the yellow clip/button to "D0" ("A2").</p>
</div>
<div class="section" id="itsybitsy-m0-express">
<h4>ItsyBitsy M0 Express</h4>
<a href="/images/fullsize/nonblocking-itsybitsy-demo-circuit.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-itsybitsy-demo-circuit.jpg" srcset="/images/responsive/nonblocking-itsybitsy-demo-circuit-2500.jpg 2500w,/images/responsive/nonblocking-itsybitsy-demo-circuit-2000.jpg 2000w,/images/responsive/nonblocking-itsybitsy-demo-circuit-1800.jpg 1800w,/images/responsive/nonblocking-itsybitsy-demo-circuit-1600.jpg 1600w,/images/responsive/nonblocking-itsybitsy-demo-circuit-1200.jpg 1200w,/images/responsive/nonblocking-itsybitsy-demo-circuit-1000.jpg 1000w,/images/responsive/nonblocking-itsybitsy-demo-circuit-800.jpg 800w,/images/responsive/nonblocking-itsybitsy-demo-circuit-400.jpg 400w,/images/responsive/nonblocking-itsybitsy-demo-circuit-200.jpg 200w" style="width: 80%;"/></a>
<p>For the ItsyBitsy, I used a full-sized breadboard. On these breadboards, they have a similar split and trench down the middle. They also have a long bus on each side (top and bottom in this picture) marked negative and positive. Each group of tie points are connected. We've used them to run power from the ItsyBitsy to the rest of the board.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The buses can be removed and multiple breadboards can be connected to form larger areas to work with.</p>
</div>
<p>For ease of access, I've tied the left and right power rails together using some solid-core wire (far left). This isn't necessary for this project (we're only tying things to ground and pins on the ItsyBitsy), but it's a useful setup so I added it for demonstration purposes.</p>
<p>I've seated the ItsyBitsy, fitted with the supplied headers, into the top of the breadboard (row one, on the far right). I've tied it's 3V pin (positive 3.3 volts) to the top positive bus rail, and its G pin (negative, ground) to the negative rail on the bottom.</p>
<p>Because of the connections on the far left, all of the rails are live and connected like one big bus.</p>
<p>I've connected the buttons to ground on the top rail (rows 21, and 28).</p>
<p>I've connected button "A" (the grey button, white wire, row 23) to pin 11 on the ItsyBitsy (row 6 - "D11" in software).</p>
<p>I've connected button "B" (the yellow button, yellow wire, row 30) to pin 7 on the ItsyBitsy (row 9 - "D9" in software).</p>
</div>
<div class="section" id="trinket-m0">
<h4>Trinket M0</h4>
<a href="/images/fullsize/nonblocking-trinket-demo-circuit.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-trinket-demo-circuit.jpg" srcset="/images/responsive/nonblocking-trinket-demo-circuit-2500.jpg 2500w,/images/responsive/nonblocking-trinket-demo-circuit-2000.jpg 2000w,/images/responsive/nonblocking-trinket-demo-circuit-1800.jpg 1800w,/images/responsive/nonblocking-trinket-demo-circuit-1600.jpg 1600w,/images/responsive/nonblocking-trinket-demo-circuit-1200.jpg 1200w,/images/responsive/nonblocking-trinket-demo-circuit-1000.jpg 1000w,/images/responsive/nonblocking-trinket-demo-circuit-800.jpg 800w,/images/responsive/nonblocking-trinket-demo-circuit-400.jpg 400w,/images/responsive/nonblocking-trinket-demo-circuit-200.jpg 200w" style="width: 80%;"/></a>
<p>For the Trinket, I used a standard "half-sized" breadboard. It's just like the "full sized" on I used for the ItsyBitsy, but it's... half the size 🤔.</p>
<p>For this circuit, I used pre-made jumper wires exclusively.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It's a little messier using all jumpers, but it's really easy to change things up. In fact, I originally had the buttons wired to pins on the other side of the Trinket, but it was hard to see what was going on in the pictures. It was trivial to rearrange things to make it easier to see what's what.</p>
<p class="last">It's always a good idea to use jumper wires to start a project, and as things take shape, slowly replace them with solid-core wires. 🦄</p>
</div>
<p>I seated the Trinket with attached headers on row 1 (far right). I tied its ground ('Gnd' pin) to the left ground rail (-, in this picture it's on the top).</p>
<p>The buttons are tied to ground on the left side (rows 13 and 19).</p>
<p>The "A" button (grey, white jumper) is attached to pin "~1" (row 3, "D1" in software - this pin can also be an analog output, that's why it's marked with a tilde).</p>
<p>The "B" button (yellow, yellow jumper) is tied to pin 2 (row 4, "D2" in software).</p>
</div>
<div class="section" id="circuitplaground-express-problem-child">
<h4>CircuitPlaground Express: Problem Child</h4>
<p>Doing things this way with the standard boards presents a problem with our rockstar board: the CircuitPlayground Express has its buttons wired in the other manner. They require a pull-<em>down</em> resistor turned on in software, and will read "HIGH" when pressed.</p>
<p>Further, the pin assignments are different for every single board, and the boards differ in what kind of RGB LED they have onboard. In the next section, we'll address these minor differences with some clever Python code and the power of <em>abstraction</em>.</p>
</div>
</div>
</div>
<div class="section" id="abstractions-keeping-the-code-simple">
<h2 id="abstractions-keeping-the-code-simple">Abstractions: Keeping The Code Simple</h2>
<p>Because there are minor differences between the different boards, we're going to abstact them away using a python module. We'll call it <tt class="docutils literal">setup.py</tt>.</p>
<p>In programming, <em>abstraction</em> is providing an indirect way to work with something. That something might be code, concepts, a service like a database, or something physical like different development boards, as we're abstracting here.</p>
<p>Abstraction helps by providing a single, simplified <em>interface</em> to do things that may have a lot of complexity.</p>
<p>For example, instead of building an abstraction module like we're doing below, we could have a bunch of <tt class="docutils literal">if</tt> statements that, given we have a way to figure out what board we're running our code on, set up the right pins or pixels for us.</p>
<p>Something like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># psuedo code!</span>

<span class="k">if</span> <span class="n">itsy</span><span class="o">-</span><span class="n">bitsy</span><span class="p">:</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">dotstar</span>
  <span class="n">use</span> <span class="n">pins</span> <span class="n">D7</span> <span class="ow">and</span> <span class="n">D11</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">led</span> <span class="n">on</span> <span class="n">pin</span> <span class="n">D13</span>
<span class="k">elif</span> <span class="n">circuit</span><span class="o">-</span><span class="n">playground</span><span class="p">:</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">neopixel</span>
  <span class="n">use</span> <span class="n">pins</span> <span class="n">D4</span> <span class="ow">and</span> <span class="n">D5</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">led</span> <span class="n">on</span> <span class="n">pin</span> <span class="n">D13</span>
<span class="k">elif</span> <span class="n">trinket</span><span class="p">:</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">dotstar</span>
  <span class="n">use</span> <span class="n">pins</span> <span class="n">D1</span> <span class="ow">and</span> <span class="n">D2</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">led</span> <span class="n">on</span> <span class="n">pin</span> <span class="n">D13</span>
<span class="k">elif</span> <span class="n">gemma</span><span class="p">:</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">dotstar</span>
  <span class="n">use</span> <span class="n">pins</span> <span class="n">D0</span> <span class="ow">and</span> <span class="n">D1</span>
  <span class="nb">set</span> <span class="n">up</span> <span class="n">led</span> <span class="n">on</span> <span class="n">pin</span> <span class="n">D13</span>
</pre></div>
</td></tr></table></div><p>The problem with this approach is that, besides being messy, it's adding a lot of extra places where our code could break. And every new board you want to use adds more complexity.</p>
<p>But more importantly, you have to know <em>every detail</em> of <em>every board</em> you might use. Maybe someone wants to use our code and their LED is on pin 3. Maybe they are using touch pads instead of buttons. Maybe there's some new-fangled RGB LED product (we'll call them SunSpots&trade; 😉) that someone wants to use.</p>
<p>If we have this chain of <tt class="docutils literal">if</tt>'s, its up to <em>us</em> to add in support for these different ways of doing what we want to do.</p>
<p>In an abstraction, we decide on a standard way of accessing the code, or <em>interface</em>. That means we decide that variables and functions will be named a certain way. Functions will take certain parameters and return specific kinds of values.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Like many terms in technology, <em>interface</em> has multiple meanings in different contexts.</p>
<p>We're using the term in the sense of an <a class="reference external" href="https://en.wikipedia.org/wiki/Application_programming_interface">application programming interface</a>, usually abbreviated as <em>API</em>.</p>
<p class="last">Be careful when searching 😀.</p>
</div>
<p>Another term for this, that you'll hear used sometimes in computer science, is <em>contract</em>. I think that describes what the abstraction does a bit more concisely - you are saying to someone who wants to use your code "I promise that you can rely on my code working this way", and the user is saying "I agree to do things your way".</p>
<p>As long as the code for each board follows the contract, and anyone using the board-specific code does so through the interface, everything works in an interchangeable way.</p>
<p>I like to think about the interface in terms of the actual variables and functions you use, and the contract as the understanding of what inputs and outputs the interface uses, as well as the things the interface does when you call the functions or access the variables:</p>
<a href="/images/fullsize/abstraction-explained-1.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/abstraction-explained-1.jpg" srcset="/images/responsive/abstraction-explained-1-2500.jpg 2500w,/images/responsive/abstraction-explained-1-2000.jpg 2000w,/images/responsive/abstraction-explained-1-1800.jpg 1800w,/images/responsive/abstraction-explained-1-1600.jpg 1600w,/images/responsive/abstraction-explained-1-1200.jpg 1200w,/images/responsive/abstraction-explained-1-1000.jpg 1000w,/images/responsive/abstraction-explained-1-800.jpg 800w,/images/responsive/abstraction-explained-1-400.jpg 400w,/images/responsive/abstraction-explained-1-200.jpg 200w" style="width: 80%;"/></a>
<p>For this simple abstraction, I've decided to make five Python objects that define our interface:</p>
<ul class="simple">
<li>A pixel object (<tt class="docutils literal">rgb</tt>)</li>
<li>The built-in RED LED, represented by a <tt class="docutils literal">DigitalInOut</tt> object (<tt class="docutils literal">led</tt>)</li>
<li>2 buttons, represented by <tt class="docutils literal">DigitalInOut</tt> objects (<tt class="docutils literal">a_button</tt>, <tt class="docutils literal">b_button</tt>)</li>
<li>A function that returns the value of a button (<tt class="docutils literal">check()</tt>).</li>
</ul>
<p>These are the bits of code used by the demo project that will be different from board to board.</p>
<p>We'll put them into a Python module called <tt class="docutils literal">setup</tt>. Python modules are usually just Python files, so we'll store our abstraction in a file called <tt class="docutils literal">setup.py</tt>.</p>
<p>To use our abstraction, we just need to <tt class="docutils literal">import setup</tt> and then we can access, for example, <tt class="docutils literal">setup.rgb</tt> to mess with the RGB pixel. That actual variable might be a NeoPixel. It might be a DotStar. It might be something we've never heard of (like a SunSpot&trade;). It could be wired to any pin, configured any way. It doesn't matter. As long as that <tt class="docutils literal">rgb</tt> object works the same way (has the same interface) as a DotStar or NeoPixel, it complies with the <em>contract</em> and everything works:</p>
<a href="/images/fullsize/abstraction-explained-2.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/abstraction-explained-2.jpg" srcset="/images/responsive/abstraction-explained-2-2500.jpg 2500w,/images/responsive/abstraction-explained-2-2000.jpg 2000w,/images/responsive/abstraction-explained-2-1800.jpg 1800w,/images/responsive/abstraction-explained-2-1600.jpg 1600w,/images/responsive/abstraction-explained-2-1200.jpg 1200w,/images/responsive/abstraction-explained-2-1000.jpg 1000w,/images/responsive/abstraction-explained-2-800.jpg 800w,/images/responsive/abstraction-explained-2-400.jpg 400w,/images/responsive/abstraction-explained-2-200.jpg 200w" style="width: 80%;"/></a>
<p>🦄 There's even a nested abstraction here. Adafruit has already abstracted the pixel code away for us, by giving the <tt class="docutils literal">DotStar</tt> and <tt class="docutils literal">NeoPixel</tt> classes the same interface. So we can interact with a string of NeoPixels in the same way we can interact with a string of DotStars.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If someone wanted to use a different kind of RGB LED (SunSpots&trade;), as long they adhere to the interface of the abstraction Adafruit has provided, our code will still work. In fact, the SunSpots&trade; library would work <em>anywhere</em> <tt class="docutils literal">DotStar</tt> or <tt class="docutils literal">NeoPixel</tt> are used.</p>
</div>
<p>Now anyone who wants to follow this article, but maybe has a <a class="reference external" href="https://store.micropython.org/product/PYBv1.1">pyboard</a> or an <a class="reference external" href="https://www.espressif.com/en/products/hardware/esp8266ex/overview">ESP8266</a>-based board can follow along without having to constantly adapt the code to their situation. All they have to do is write a <tt class="docutils literal">setup.py</tt> module and make sure it has the expected objects.</p>
<p>So here's the code for each of the boards I have.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are using a board that has a built-in NeoPixel, but <em>isn't</em> a CircuitPlayground, use the DotStar code, but replace the DotStar lines (lines 3, 8 and 9) with the NeoPixel code from the CircuitPlayground example.</p>
</div>
<div class="section" id="for-the-circuitplayground">
<h3>For the CircuitPlayground</h3>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as setup.py</span>
<span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">neopixel</span>
<span class="kn">from</span> <span class="nn">digitalio</span> <span class="kn">import</span> <span class="n">DigitalInOut</span><span class="p">,</span> <span class="n">Direction</span><span class="p">,</span> <span class="n">Pull</span>

<span class="n">led</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D13</span><span class="p">)</span>
<span class="n">led</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">OUTPUT</span>

<span class="n">rgb</span> <span class="o">=</span> <span class="n">neopixel</span><span class="o">.</span><span class="n">NeoPixel</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">NEOPIXEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">a_button</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D4</span><span class="p">)</span>
<span class="n">a_button</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span>
<span class="n">a_button</span><span class="o">.</span><span class="n">pull</span> <span class="o">=</span> <span class="n">Pull</span><span class="o">.</span><span class="n">DOWN</span>

<span class="n">b_button</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D5</span><span class="p">)</span>
<span class="n">b_button</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span>
<span class="n">b_button</span><span class="o">.</span><span class="n">pull</span> <span class="o">=</span> <span class="n">Pull</span><span class="o">.</span><span class="n">DOWN</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a_button</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b_button</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This file will need to be saved on your <tt class="docutils literal">CIRCUITPY</tt> drive as <tt class="docutils literal">setup.py</tt>.</p>
<p><strong>Lines 2-4</strong> import external libraries needed for this module to function.</p>
<p>The <tt class="docutils literal">board</tt> library contains variables that are related to your specific development board. It contains all of the pin assignments, including some handy aliases for the built-in components (like the <tt class="docutils literal">board.NEOPIXEL</tt> variable used on <strong>line 9</strong>).</p>
<p>The <tt class="docutils literal">neopixel</tt> library gives us a way to control the 10 RGB LEDs that surround the CircuitPlayground. Depending on how your CircuitPython was installed, you may have to install this library yourself. This process is covered in detail on the <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/circuitpython-libraries">CircuitPython Libraries section</a> of the "Welcome To CircuitPython" guide.</p>
<p>The basics of the <tt class="docutils literal">neopixel</tt> library, specifically for this board, are disucessed in the <a class="reference external" href="https://learn.adafruit.com/adafruit-circuit-playground-express/circuitpython-neopixel">documentation</a>.</p>
<p>NeoPixels are a hugely cool peripheral, and you are not limited to just using the ones on your CircuitPlayground Express. Check out the <a class="reference external" href="https://learn.adafruit.com/adafruit-neopixel-uberguide/the-magic-of-neopixels">NeoPixel &Uuml;berguide</a> for comprehensive information about them.</p>
<p>On <strong>line 4</strong>, we import a few things from the <tt class="docutils literal">digitalio</tt> library. This library contains classes, variables and functions useful for reading and writing to digital pins (buttons, LEDs, etc). We're only importing the objects that we need to set up the buttons and built-in LED, <tt class="docutils literal">DigitalInOut</tt>, <tt class="docutils literal">Direction</tt>, and <tt class="docutils literal">Pull</tt>. Their purpose will be explained shortly.</p>
<p><strong>Lines 6 and 7</strong> set up the built-in red LED. It's attached to digital pin 13, so we pass <tt class="docutils literal">board.D13</tt> to the <tt class="docutils literal">DigitalInOut</tt> constructor. On <strong>Line 7</strong>, we set the <em>direction</em> of the pin to be an <em>output</em> - this means the pin is only going to be used for sending information, on in this case, sending power to the pin to turn on the LED.</p>
<p><tt class="docutils literal">led</tt> is now a <tt class="docutils literal">DigitalInOut</tt> object we can write to by setting its <tt class="docutils literal">value</tt> attribute to a boolean value (<tt class="docutils literal">True</tt> or <tt class="docutils literal">False</tt>).</p>
<p><strong>Lines 9 and 10</strong> configure the NeoPixel. We call the NeoPixel object simply <tt class="docutils literal">rgb</tt> to keep it as generic as possible. When we call the NeoPixel constructor, <tt class="docutils literal">neopixel.NeoPixel</tt>, we pass the pin where our pixels are installed (<tt class="docutils literal">board.NEOPIXEL</tt>), and the number of pixels we want to illuminate. We have 10 pixels available, but since we are mimicking a board with just one built-in, we pass <tt class="docutils literal">1</tt> to the constructor.</p>
<p>On <strong>Line 10</strong> we set the brightness of the pixel to <tt class="docutils literal">0.3</tt>. The brightness is a float between <tt class="docutils literal">0</tt> and <tt class="docutils literal">1.0</tt>. These pixels are <em>incredibly</em> bright, feel free to lower this to <tt class="docutils literal">0.1</tt> if <tt class="docutils literal">0.3</tt> is too intense, or increase it if you want to really light up your life. 😀</p>
<p><strong>Lines 12-14</strong> and <strong>lines 16-18</strong> set up our buttons. In the case of the CircuitPlayground, these are the built-in buttons, and need a pull-down resistor turned on to function. The pins are supplied via the <tt class="docutils literal">board</tt> module. The direction is set just like the <tt class="docutils literal">led</tt> on <strong>line 6</strong>, but in this case the direction is set to <tt class="docutils literal">Direction.INPUT</tt>, because these are pins to be <em>read</em> from, instead of written to. Finally on <strong>lines 14 and 18</strong>, we enable the pull-down resistor using the <tt class="docutils literal">pull</tt> property and the <tt class="docutils literal">Pull</tt> object from the <tt class="docutils literal">digitalio</tt> module.</p>
<p>Finally, on <strong>lines 20-24</strong>, we define a function called <tt class="docutils literal">check()</tt>. The purpose of this function is to abstract away the differences between how these various boards are wired up. In the case of the CircuitPlayground, the onboard buttons are wired in the "sane" manner such that pressing the button causes the pin to read <tt class="docutils literal">True</tt>, and not pressing the button, causes the pin to read <tt class="docutils literal">False</tt>. This is the opposite of how the other boards are configured.</p>
<p>This function will always return <tt class="docutils literal">True</tt> if the button is pressed, and <tt class="docutils literal">False</tt> if it's not, regardless of how the buttons are set up.</p>
<p><tt class="docutils literal">check()</tt> takes a single parameter, <tt class="docutils literal">token</tt>, which is used to indicate which button you want to check the value of. It's a simple string - when it's set to "A", <tt class="docutils literal">check()</tt> returns the value of the "A" button (<tt class="docutils literal">button_a</tt>), and when it's set to "B", <tt class="docutils literal">check()</tt> returns the value of the "B" button (<tt class="docutils literal">button_b</tt>).</p>
</div>
</div>
<div class="section" id="for-the-other-boards-with-dotstars">
<h3>For the other boards with DotStars</h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be sure to change the pin numbers to reflect how you wired up your buttons.</p>
</div>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as setup.py</span>
<span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">adafruit_dotstar</span>
<span class="kn">from</span> <span class="nn">digitalio</span> <span class="kn">import</span> <span class="n">DigitalInOut</span><span class="p">,</span> <span class="n">Direction</span><span class="p">,</span> <span class="n">Pull</span>

<span class="n">led</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D13</span><span class="p">)</span>
<span class="n">led</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">OUTPUT</span>

<span class="n">rgb</span> <span class="o">=</span> <span class="n">adafruit_dotstar</span><span class="o">.</span><span class="n">DotStar</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">APA102_SCK</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">APA102_MOSI</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">a_button</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D4</span><span class="p">)</span>
<span class="n">a_button</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span>
<span class="n">a_button</span><span class="o">.</span><span class="n">pull</span> <span class="o">=</span> <span class="n">Pull</span><span class="o">.</span><span class="n">UP</span>

<span class="n">b_button</span> <span class="o">=</span> <span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D3</span><span class="p">)</span>
<span class="n">b_button</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span>
<span class="n">b_button</span><span class="o">.</span><span class="n">pull</span> <span class="o">=</span> <span class="n">Pull</span><span class="o">.</span><span class="n">UP</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">a_button</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">b_button</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This file will need to be saved on your <tt class="docutils literal">CIRCUITPY</tt> drive as <tt class="docutils literal">setup.py</tt>.</p>
<p><strong>Lines 2-4</strong> import external libraries needed for this module to function.</p>
<p>The <tt class="docutils literal">board</tt> library contains variables that are related to your specific development board. It contains all of the pin assignments, including some handy aliases for the built-in components (like the <tt class="docutils literal">board.APA102_SCK</tt> variable used on <strong>line 9</strong>).</p>
<p>The <tt class="docutils literal">adafruit_dotstar</tt> module provides a way to control DotStars. DotStars are like NeoPixels, but use a different protocol. The differences are explained on <a class="reference external" href="https://learn.adafruit.com/adafruit-dotstar-leds/overview">the DotStar LED docuemntation page</a>.</p>
<p>You will have to install the <tt class="docutils literal">adafruit_dotstar</tt> library. This process is covered in detail on the <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/circuitpython-libraries">CircuitPython Libraries section</a> of the "Welcome To CircuitPython" guide.</p>
<p>The details of working with the DotStar library in CircuitPython is covered in <a class="reference external" href="https://learn.adafruit.com/circuitpython-essentials/circuitpython-dotstar">the CircuitPython DotStar section</a> of the CircuitPython Essentials document.</p>
<p>On <strong>line 4</strong>, we import a few things from the <tt class="docutils literal">digitalio</tt> library. This library contains classes, variables and functions useful for reading and writing to digital pins (buttons, LEDs, etc). We're only importing the objects that we need to set up the buttons and built-in LED, <tt class="docutils literal">DigitalInOut</tt>, <tt class="docutils literal">Direction</tt>, and <tt class="docutils literal">Pull</tt>. Their purpose will be explained shortly.</p>
<p><strong>Lines 6 and 7</strong> set up the built-in red LED. It's attached to digital pin 13, so we pass <tt class="docutils literal">board.D13</tt> to the <tt class="docutils literal">DigitalInOut</tt> constructor. On <strong>Line 7</strong>, we set the <em>direction</em> of the pin to be an <em>output</em> - this means the pin is only going to be used for sending information, on in this case, sending power to the pin to turn on the LED.</p>
<p><tt class="docutils literal">led</tt> is now a <tt class="docutils literal">DigitalInOut</tt> object we can write to by setting its <tt class="docutils literal">value</tt> attribute to a boolean value (<tt class="docutils literal">True</tt> or <tt class="docutils literal">False</tt>).</p>
<p><strong>Lines 9 and 10</strong> configure the DotStar. We call the DotStar object simply <tt class="docutils literal">rgb</tt> to keep it as generic as possible. DotStars are connected via <a class="reference external" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI</a>, so they require two pins to be specified in the constructor. We use the <tt class="docutils literal">board</tt> library to provide the two built-in pins that are pre-wired to all built-in DotStars, <tt class="docutils literal">board.APA102_SCK</tt> and <tt class="docutils literal">board.APA102_MOSI</tt>. Finally we pass <tt class="docutils literal">1</tt> to the constructor, to let the library know we are only controlling the single DotStar.</p>
<p>On <strong>Line 10</strong> we set the brightness of the pixel to <tt class="docutils literal">0.3</tt>. The brightness is a float between <tt class="docutils literal">0</tt> and <tt class="docutils literal">1.0</tt>. These pixels are <em>incredibly</em> bright, feel free to lower this to <tt class="docutils literal">0.1</tt> if <tt class="docutils literal">0.3</tt> is too intense, or increase it if you want to really light up your life. 😀</p>
<p><strong>Lines 12-14</strong> and <strong>lines 16-18</strong> set up our buttons. The pins are supplied via the <tt class="docutils literal">board</tt> module. The direction is set just like the <tt class="docutils literal">led</tt> on <strong>line 6</strong>, but in this case the direction is set to <tt class="docutils literal">Direction.INPUT</tt>, because these are pins to be <em>read</em> from, instead of written to. On these boards, we've wired all of the buttons so they connect to ground when pressed, so we have to use a pull up resistor so they function properly (<strong>lines 14 and 18</strong>) . This also means that our logic will be inverted relative to other wirirings (and common sense) - when the button is pressed, the pin will read <tt class="docutils literal">False</tt>, and when it's not pressed, it will read <tt class="docutils literal">True</tt>.</p>
<p>Finally, on <strong>lines 20-24</strong>, we define a function called <tt class="docutils literal">check()</tt>. The purpose of this function is to abstract away the differences between how these various boards are wired up. On <strong>lines 22 and 24</strong>, we use the <tt class="docutils literal">not</tt> operator to negate whatever we got from the button pin. This normalizes the output between these boards, and boards like the CircuitPlayground that are wired in the opposite manner.</p>
<p>This function will always return <tt class="docutils literal">True</tt> if the button is pressed, and <tt class="docutils literal">False</tt> if it's not, regardless of how the buttons are set up.</p>
<p><tt class="docutils literal">check()</tt> takes a single parameter, <tt class="docutils literal">token</tt>, which is used to indicate which button you want to check the value of. It's a simple string - when it's set to "A", <tt class="docutils literal">check()</tt> returns the value of the "A" button (<tt class="docutils literal">button_a</tt>), and when it's set to "B", <tt class="docutils literal">check()</tt> returns the value of the "B" button (<tt class="docutils literal">button_b</tt>).</p>
</div>
</div>
<div class="section" id="how-it-works">
<h3>How It Works</h3>
<p>To use this in our other code (<tt class="docutils literal">code.py</tt>), we just need to use Python's <tt class="docutils literal">import</tt> statement:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>
</pre></div>
</td></tr></table></div><p>Now, in our code, we use the <tt class="docutils literal">led</tt> variable to turn the red LED on/off, and use <tt class="docutils literal">rgb</tt> to control the NeoPixel/DotStar. We will use the <tt class="docutils literal">check()</tt> function to see if a button is being pressed, like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A has been pressed"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A has not been pressed"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button B has been pressed"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button B has not been pressed"</span><span class="p">)</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="testing">
<h2 id="testing">Testing</h2>
<p>Before digging into state and other fun stuff, its a good idea to run some super simple code to ensure that everything is wired up properly. I've written some minimalistic code you can use to verify everything is set up.</p>
<p>What this code does is turn the on the onboard LED when button "A" is pressed, and the RGB LED (either a dotstar for the ItsyBitsy, Trinket, or GEMMA boards, or a NeoPixel in the case of the CircuitPlayground) when button "B" is pressed.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">For details about controlling the onboard RGB LEDs, see <a class="reference external" href="https://learn.adafruit.com/circuitpython-essentials/circuitpython-internal-rgb-led">Adafruit's excellent documentation on the subject</a>.</p>
</div>
<p>Before running this code, make sure you've copied the proper RGB LED library over to your board, in the <tt class="docutils literal">lib</tt> folder.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you aren't familiar with this process, check out the <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/circuitpython-libraries">CircuitPython Libraries</a> section of the <a class="reference external" href="https://learn.adafruit.com/welcome-to-circuitpython/overview">"Welcome To CircuitPython"</a> guide.</p>
</div>
<p>Also make sure you have created a <tt class="docutils literal">setup.py</tt> module, as explained in <a class="reference internal" href="#abstractions-keeping-the-code-simple">the last section</a>.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">):</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<ul class="simple">
<li><strong>Lines 1 and 2</strong> import the necessary external objects and modules we need.</li>
<li>The <a class="reference external" href="https://circuitpython.readthedocs.io/en/3.x/shared-bindings/time/__init__.html">time</a> module provides functions related to the passage of time, usually in terms of seconds.</li>
<li><strong>Line 4</strong> starts off the standard "main loop" where our code runs.</li>
<li>On <strong>Line 5</strong>, we set the value of the <tt class="docutils literal">led</tt> object, or the red LED wired to pin 13, to whatever the value of the "A" button happens to be at that moment. If the value is <tt class="docutils literal">True</tt> (the button is pressed), the LED will turn on. If it's <tt class="docutils literal">False</tt> (the button is not pressed), the LED will turn off.</li>
</ul>
<p><strong>Lines 7-10</strong> have a similar function to line 5, except that the RGB LEDs are not simple on/off devices. They must have a color of some kind written to them, usually a tuple of three integers, each ranging from 0 to 255. Each integer in the tuple corresponds to a red, green, and blue LED element in the pixel (respectively), and sets its intensity level.</p>
<p>The NeoPixel and DotStar libraries provide an interface such that you can treat the pixel object like a standard Python list. This is how we are able to write a color to the first pixel using list indexing on <strong>lines 8 and 10</strong>.</p>
<p>In the case of <strong>line 10</strong>, we're writing "black" to the pixel by setting the red, green and blue values to 0 (by passing the tuple <tt class="docutils literal">(0, 0, 0)</tt>). This has the effect of turning it off, in the same way that setting the <tt class="docutils literal">led.value</tt> property to <tt class="docutils literal">False</tt> turns the red LED on pin 13 off.</p>
<p>Finally on <strong>line 12</strong>, we call <tt class="docutils literal">time.sleep()</tt> to pause the program for 0.2 seconds. This provides simple button debouncing (much more about button bounce will be discussed in the rest of this article, stay tuned).</p>
</div>
<p>Here's a short video demonstrating the test code and demo circuit on each of the boards I have:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/test-circuit-demo-all-boards.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/test-circuit-demo-all-boards.mp4">link to the video</a> instead.</p>
</video>
</div></div>
<div class="section" id="the-problem-debouncing-for-fun-and-profit">
<h2 id="the-problem-debouncing-for-fun-and-profit">The Problem: Debouncing For Fun And Profit</h2>
<p>Most projects will have to deal with "bouncy" inputs, buttons in particular.</p>
<p>"Bounce", in this sense, is essentially a noisy signal. Logically, you would think that if a button was pressed, that it would be a simple boolean value - it's "on" or "off". "HIGH" or "LOW", <tt class="docutils literal">True</tt> or <tt class="docutils literal">False</tt>.</p>
<p>In reality, these values refer to a voltage, or the lack of a voltate. For our boards that voltage is 3.3 volts. When the voltage is at 3.3 volts (plus/minus some wiggle room), the pin will read <tt class="docutils literal">True</tt> or "HIGH". The voltage is "on".</p>
<p>When there's no voltage (plus or minus some wiggle room), the pin will read <tt class="docutils literal">False</tt> or "LOW". The voltage is "off".</p>
<p>An ideal button being pressed and released might look something like this if we graphed the voltage:</p>
<a href="/images/fullsize/nonblocking-button-bounce-ideal.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-button-bounce-ideal.jpg" srcset="/images/responsive/nonblocking-button-bounce-ideal-2500.jpg 2500w,/images/responsive/nonblocking-button-bounce-ideal-2000.jpg 2000w,/images/responsive/nonblocking-button-bounce-ideal-1800.jpg 1800w,/images/responsive/nonblocking-button-bounce-ideal-1600.jpg 1600w,/images/responsive/nonblocking-button-bounce-ideal-1200.jpg 1200w,/images/responsive/nonblocking-button-bounce-ideal-1000.jpg 1000w,/images/responsive/nonblocking-button-bounce-ideal-800.jpg 800w,/images/responsive/nonblocking-button-bounce-ideal-400.jpg 400w,/images/responsive/nonblocking-button-bounce-ideal-200.jpg 200w" style="width: 80%;"/></a>
<p>The problem is that you will rarely ever get such straightforward readings. You'll instead get what looks like many pressings in quick succession:</p>
<a href="/images/fullsize/nonblocking-button-bounce-reality.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-button-bounce-reality.jpg" srcset="/images/responsive/nonblocking-button-bounce-reality-2500.jpg 2500w,/images/responsive/nonblocking-button-bounce-reality-2000.jpg 2000w,/images/responsive/nonblocking-button-bounce-reality-1800.jpg 1800w,/images/responsive/nonblocking-button-bounce-reality-1600.jpg 1600w,/images/responsive/nonblocking-button-bounce-reality-1200.jpg 1200w,/images/responsive/nonblocking-button-bounce-reality-1000.jpg 1000w,/images/responsive/nonblocking-button-bounce-reality-800.jpg 800w,/images/responsive/nonblocking-button-bounce-reality-400.jpg 400w,/images/responsive/nonblocking-button-bounce-reality-200.jpg 200w" style="width: 80%;"/></a>
<p>What causes this? It's due to the realities of turning physical interactions into digital signals: when a button is pressed, a piece of metal crosses two contacts, completing a circuit. The microcontroller has an internal threshold that decides how much current constitutes "on" (or HIGH), and how much constitutes "off" (or LOW) - the aforementioned "wiggle room". That threshold can be shockingly large - sometimes what you would think is a "weak" signal, the microcontroller interprets as "HIGH".</p>
<p>Then there's the buttons themselves. Most buttons are composed of two pieces of metal that are separated by a physical gap. When you press the button, the metal pieces are brought into physical contact, causing current to flow through them as if they were a solid conductive element (like a piece of wire or a copper trace on a PCB).</p>
<p>Since electricity <em>really</em> wants to flow, if given sufficient current and a short enough distance, it will jump through the air. When this happens inside of a button, it causes current to flow momentarily before the contacts are fully <em>in contact</em>, possibly causing a spike in the current being read from the microcontroller pin.</p>
<p>Further, inconsistencies in the metal due to manufacturing or wear can cause multiple subsequent spikes to be sent to the microcontroller prior to the most "solid" one. Even when continually holding down a button, the strength of the signal can vary quite a bit. Sometimes it varies enough to be noticed by the microprocessor.</p>
<p>As the button is released, the same issues happen <em>again</em>.</p>
<p>In the case of a capacitive input, the capacitance that is increased by the user interacting with it is detectable long before the user has contacted the pad. It's not always possible to determine precisely when someone has contacted the pad, or we're just detecting a change in capacitance because someone is simply near it (we can use this to our advantage in some applications). There's also potential issues with interference that can make the signal more noisy than it should be.</p>
<p>So where you think you can use a logical check of a pin's status (<tt class="docutils literal">if pin.value</tt>) in your code to determine if the button is pressed, and execute some code, it's not that simple. Without smoothing out the signal from the pin, your code will end up executing many times before the button is even fully pressed down. The number of times will vary from button to button, and can even vary from day to day.</p>
<p>Maybe for some applications, like turning on an LED while a button is pressed, it's not really a problem. But if pressing that button has <em>side effects</em> it can be really, really bad.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For an in-depth analysis of <em>button</em> bounce and possible solutions, check out <a class="reference external" href="http://www.ganssle.com/debouncing.htm">A Guide To Debouncing</a> from the <a class="reference external" href="http://www.ganssle.com/">Ganssle Group</a>. It's the best discussion I've found in my research, and often cited by other tutorials that you run into on the subject.</p>
</div>
<p>There's more to it than just noisy buttons, though. There are other "bouncy" signals that aren't quite as chaotic as button bounce, but need to be dealt with in the same way.</p>
<p>Remember, your main loop is executing many thousands of times per second. If you check a pin's status every loop, even if the button attached to it is fully "debounced", your code will still get called many, many times. A perfectly clean signal will still trigger your code to run over and over and over.</p>
<p>The easiest way to deal with this both of these issues, and the most common seen in "getting started" tutorials is to "sleep" the processor, to <em>block</em> for a few fractions of a second before checking an input's value.</p>
<p>"Blocking" is when you tie up the processor, preventing any code from executing, while you wait for something to happen.</p>
<p>We've already looked at code that blocks in the <a class="reference internal" href="#testing">Testing</a> section above. We're using a Python function called <tt class="docutils literal">time.sleep()</tt> that pauses processing for a given period of time (provided in seconds).</p>
<p>This approach effectively smoothes out the signal from our inputs, by reducing the frequency at which we check the status of the button. Instead of checking <em>48 million times</em> every second (the clock frequency of the M0), we're only checking <em>5 times</em> per second. We'll miss any variations in the signal that happen while the button "settles" after its pressed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The actual number of times your code runs is limited by many things, and even in an ideal situation will likely never <em>actually</em> run 48 million times per second. It might get close, 30 million, 10 million...</p>
</div>
<p>The problem is that while code is blocking, <em>nothing else can happen</em>.</p>
<p>This severely limits what we can do in our projects. Its harder to read from multiple inputs and write to multiple outputs. We become fixed to a set interval to do anything, because we physically <em>can't</em> do anything while the processor is sleeping.</p>
<p>So what can we do instead?</p>
<p>We have a few viable options:</p>
<ol class="arabic simple">
<li>For buttons, we can use an <a class="reference external" href="https://en.wikipedia.org/wiki/RC_circuit">R/C filter circuit</a> to clean the input (a.k.a. <em>hardware debouncing</em>).</li>
<li>We can use an IC that does debouncing for us.</li>
<li>We can use <a class="reference external" href="https://www.sparkfun.com/tutorials/326">interrupts</a>.</li>
<li>We can create a data structure that tracks the <em>state</em>, or status, of our inputs.</li>
</ol>
<p>Hardware debouncing is only really useful in situations where the debouncing needs to be <em>rock solid</em>. It requires more components, which increases the cost (something more of an issue in industry) and introduces more complexity (more of an issue for us as hobbyists). Even with really solid hardware debouncing, we still need to be concerned with button state - remember what feels like a momentary press for a human being is an event that lasts many many processor cycles - if the action triggered by the button runs every cycle and if we aren't being conscious of the button state, we're in trouble.</p>
<p>Debouncing ICs are rare and tend to be expensive. We could program another microcontroller to do debouncing for us, but again, its more expensive and adds complexity. And <em>yet again</em> we still have to be conscious of button state - it just might be happening in our "daughter" microcontroller instead of our main one.</p>
<p>Interrupts are extremely cool - you can configure the processor such that when a pin reads "HIGH", it triggers the execution of a predetermined chunk of code. Our M0 boards allow for interrupts on nearly every pin. However, interrupt functionality is not currently exposed in CircuitPython 💔, so it's a non-starter for us.</p>
<p>Ultimately, tracking <em>state</em> is really the best option most of the time - and as we've seen, even with other debouncing methods, we will still need to deal with it. Not sure what <em>state</em> even means? The next section will go into great detail.</p>
</div>
<div class="section" id="basics-of-state">
<h2 id="basics-of-state">Basics Of State</h2>
<p>Let's start with basic definitions. <em>State</em> is simply the status or phase of something. It's how you would describe something that can <em>transition</em>.</p>
<p>For example, water has three common states: gas (steam), solid (ice), liquid (usually just called <em>water</em>). State is a way to refer to attributes of that thing at a given time. When water is brought to its boiling point of 100&deg; C (212&deg; F), it becomes less dense, and given the opportunity, it will disperse throughout a space. When water is taken down to 0&deg; C (32&deg; F), it freezes, becoming more dense, and solid. It will expand. At other temperatures between 0&deg;C and 100&deg;C, water is a liquid. It flows.</p>
<p>Note how water has multiple properties in each state. We could record each of those properties numerically - the temperature, the volume, the density - even attributes that are more binary (true/false) like "solid" and "liquid". Keep this in the back of your mind for now.</p>
<p>Lets look at another example, this time from a area of life that lives and breathes metrics: sports.</p>
<p>Keeping score during a sporting event is a way of tracking state. A performance happens, a ball is hit, a race ends, and the score is recorded.</p>
<p>Here's a common scoreboard for sports like gymnastics:</p>
<a href="/images/fullsize/nonblocking-state-examples-01.jpg"><img alt="" class="align-center" sizes="(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-examples-01.jpg" srcset="/images/responsive/nonblocking-state-examples-01-1000.jpg 1000w,/images/responsive/nonblocking-state-examples-01-800.jpg 800w,/images/responsive/nonblocking-state-examples-01-400.jpg 400w,/images/responsive/nonblocking-state-examples-01-200.jpg 200w" style="width: 80%;"/></a>
<p>It's a single score, from a single judge. This scoreboard scores from 1-10, with down to hundredths of a point. This score is 9.70.</p>
<p>If we modeled the scoreboard in Python, we could use a single variable to store the score:</p>
<a href="/images/fullsize/nonblocking-state-examples-02.jpg"><img alt="" class="align-center" sizes="(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-examples-02.jpg" srcset="/images/responsive/nonblocking-state-examples-02-1000.jpg 1000w,/images/responsive/nonblocking-state-examples-02-800.jpg 800w,/images/responsive/nonblocking-state-examples-02-400.jpg 400w,/images/responsive/nonblocking-state-examples-02-200.jpg 200w" style="width: 80%;"/></a>
<p>Here, we simply name the variable <tt class="docutils literal">score</tt>. If we were modeling a real gymnastics match, we might want to differentiate between different scores, since there will be one for each judge, and each participant:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">entrant1_judge1</span> <span class="o">=</span> <span class="mf">9.70</span>
<span class="n">entrant1_judge2</span> <span class="o">=</span> <span class="mf">9.45</span>
<span class="n">entrant1_judge3</span> <span class="o">=</span> <span class="mf">10.0</span>

<span class="n">entrant2_judge1</span> <span class="o">=</span> <span class="mf">8.75</span>
<span class="n">entrant2_judge2</span> <span class="o">=</span> <span class="mf">9.00</span>
<span class="n">entrant2_judge3</span> <span class="o">=</span> <span class="mf">8.80</span>

<span class="n">entrant3_judge1</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">entrant3_judge2</span> <span class="o">=</span> <span class="mf">9.99</span>
<span class="n">entrant3_judge3</span> <span class="o">=</span> <span class="mf">9.98</span>
</pre></div>
</td></tr></table></div><p>This straight-forward, but a bit unwieldy. We're only set up for three judges, and three entrants, and a <em>single</em> match. In a tournament there may be 10 matches, and there could be dozens of entrants. That's a lot of variables to track, and all we're tracking is the scores. Imagine if we also wanted to give the entrants a name or id number, or track their vital statistics!</p>
<p>We can simplify and generalize things a bit by using Python's built-in data structures.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you aren't familiar with Python's built-in data structures, Adafruit has put together a <a class="reference external" href="https://learn.adafruit.com/basic-datastructures-in-circuitpython/overview">simple guide</a>.</p>
</div>
<p>There are many, many ways to model a match like this, here's just one using lists and dictionaries:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
        <span class="p">{</span>
         <span class="s2">"judge1"</span><span class="p">:</span> <span class="mf">9.70</span><span class="p">,</span>
         <span class="s2">"judge2"</span><span class="p">:</span> <span class="mf">9.45</span><span class="p">,</span>
         <span class="s2">"judge3"</span><span class="p">:</span> <span class="mf">10.0</span>
        <span class="p">},</span>
        <span class="p">{</span>
         <span class="s2">"judge1"</span><span class="p">:</span> <span class="mf">8.75</span><span class="p">,</span>
         <span class="s2">"judge2"</span><span class="p">:</span> <span class="mf">9.00</span><span class="p">,</span>
         <span class="s2">"judge3"</span><span class="p">:</span> <span class="mf">8.80</span>
        <span class="p">},</span>
        <span class="p">{</span>
         <span class="s2">"judge1"</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
         <span class="s2">"judge2"</span><span class="p">:</span> <span class="mf">9.99</span><span class="p">,</span>
         <span class="s2">"judge3"</span><span class="p">:</span> <span class="mf">9.98</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div><p>To access the second judge's score for the third entrant in the first match (remember list indexes start with 0):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s2">"judge2"</span><span class="p">]</span>
</pre></div>
</td></tr></table></div><p>So that works for modeling something like a gymnastics match, where you have somewhat similar data, but it is recorded multiple times.</p>
<p>In a microcontroller project, we're dealing more with what's called <em>global state</em> - state that is used by the whole project. We need to track our buttons and digital pins and sensors in one place, and use the values throughout our project.</p>
<p>A better analogy for our needs is the <em>scoreboard</em> from a team-based sport. A sports arena/field will have one giant board that tracks the state of the entire game - all relevant information you need to understand the progress of the game is available in one place. It's globally accessible, you can see it from any seat - you just need to look at it.</p>
<p>Here's a contrived example of a typical scoreboard from an American baseball stadium:</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The nuances and rules for American baseball are not relevant to this article, but if you aren't familiar and want to dig in, the <a class="reference external" href="https://en.wikipedia.org/wiki/Baseball">wikipedia article</a> is the place to start.</p>
</div>
<a href="/images/fullsize/nonblocking-state-examples-03.jpg"><img alt="" class="align-center" sizes="(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-examples-03.jpg" srcset="/images/responsive/nonblocking-state-examples-03-1600.jpg 1600w,/images/responsive/nonblocking-state-examples-03-1200.jpg 1200w,/images/responsive/nonblocking-state-examples-03-1000.jpg 1000w,/images/responsive/nonblocking-state-examples-03-800.jpg 800w,/images/responsive/nonblocking-state-examples-03-400.jpg 400w,/images/responsive/nonblocking-state-examples-03-200.jpg 200w" style="width: 80%;"/></a>
<p>It has various regions with indicators, usually lights, and numbers representing the state of the game. Each one represents an independent piece of important information. That information changes as the game progresses. Outs are made, points (runs) are scored, innings go by (there are 9 in a typical baseball game).</p>
<p>We can model a scoreboard as a series of variables, like we did initially for the gymnastics match:</p>
<a href="/images/fullsize/nonblocking-state-examples-04.jpg"><img alt="" class="align-center" sizes="(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-examples-04.jpg" srcset="/images/responsive/nonblocking-state-examples-04-1600.jpg 1600w,/images/responsive/nonblocking-state-examples-04-1200.jpg 1200w,/images/responsive/nonblocking-state-examples-04-1000.jpg 1000w,/images/responsive/nonblocking-state-examples-04-800.jpg 800w,/images/responsive/nonblocking-state-examples-04-400.jpg 400w,/images/responsive/nonblocking-state-examples-04-200.jpg 200w" style="width: 80%;"/></a>
<p>This is totally viable, and less problematic than doing the same thing for a gymnastics tournament, since these variables, collectively, are a single, central point of reference for what state the game is at, at any given moment.</p>
<p>There are alternative ways of modeling global state, however. The two primary ones are: using a <em>dictionary</em> and using a <em>class</em>.</p>
<p>A dictionary in Python is a key-value mapping, also known as an <em>associative array</em>, <em>hash</em>, or <em>hashmap</em>. Data is stored by name in a simple table. Here's what our scoreboard looks like as a dictionary:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">scoreboard</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"ball"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"out"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"strike"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"guest_score"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">"inning"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"home_score"</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div><p>We access the various values like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">outs</span> <span class="o">=</span> <span class="n">scoreboard</span><span class="p">[</span><span class="s2">"out"</span><span class="p">]</span>
<span class="n">scoreboard</span><span class="p">[</span><span class="s2">"inning"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">scoreboard</span><span class="p">[</span><span class="s2">"guest_score"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</td></tr></table></div><p>So we have a single, global variable, <tt class="docutils literal">scoreboard</tt>, that contains all of the information about the game. As the game progresses, <tt class="docutils literal">scoreboard</tt>'s members are updated.</p>
<p>This has the advantage over using a series of variables in that it is more compact, but flexible - we're only using up one variable name, and the names of our state attributes can be almost anything - words with spaces, dashes, even other objects.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For an object to be used as a dictionary key, it must be <a class="reference external" href="https://docs.python.org/3.6/glossary.html#term-hashable">hashable</a>.</p>
</div>
<p>Dictionaries are limited in that they are strictly mappings of some key to some value. There are times when you will need to add more functionality, and that's where <em>classes</em> come in.</p>
<p>A <em>class</em>, in the simplest terms, is a data structure that contains variables (called <em>attributes</em> or <em>properties</em>), and functions (called <em>methods</em>).</p>
<p>What makes classes special is that they are used as a blueprint for creating new objects. You define what your class looks like once, and then create <em>instances</em> of your class that store your data.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>There is a <em>ton</em> more to classes in Python. This is called <a class="reference external" href="https://en.wikipedia.org/wiki/Object-oriented_programming">Object-Oriented Programming</a> (OOP), and is a whole school of thought unto itself in programming (or <em>paradigm</em>).</p>
<p>I'm not going to go into too much detail here, since there is much to discuss.</p>
<p class="last">A good place to start is <a class="reference external" href="https://docs.python.org/3/tutorial/classes.html">the python OOP tutorial</a>.</p>
</div>
<p>For our purposes, classes provide a way of reasoning about state in a self-contained manner. The class contains all of our state variables, and it has methods that operate on it. We can extend the class if we need to, and can even use it to handle global state for multiple similar parts of our project.</p>
<p>Here's a simple example of a class that represents our scoreboard:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ScoreBoard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"guest"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">"home"</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inning</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_innings</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">tied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s2">"home"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s2">"guest"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">next_inning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inning</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inning</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tied</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Game is over"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extra_innings</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h3>Explanation</h3>
<div class="docutils container">
</div>
<p>This is a standard class definition.</p>
<p><strong>Line 1</strong> sets the name of the class.</p>
<p>Every method defined in the class will be passed at least one parameter, <tt class="docutils literal">self</tt>. <tt class="docutils literal">self</tt> is a reference to the current instance of the class.</p>
<p><strong>Lines 2-12</strong> define the <em>constructor</em> of the class, which is always named <tt class="docutils literal">__init__()</tt>. This method is called only once, when the class instance is initially created.</p>
<p>In Python, a class method name surrounded by two underscores on each side is considered "magic" - it has special meaning, like how this method is the constructor.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Magic methods are a extremely useful feature of Python, and are worth researching fully.</p>
<p class="last">Check out this <a class="reference external" href="https://rszalski.github.io/magicmethods/">comprehensive view of magic methods in Python</a> for more information.</p>
</div>
<p>The constructor is used to establish all of the default values for the instance attributes. That's what's occurring on <strong>lines 3-12</strong>.</p>
<p><em>Instance methods</em> are defined on <strong>lines 14-15</strong> (<tt class="docutils literal">tied()</tt>), and <strong>17-24</strong> (<tt class="docutils literal">next_inning()</tt>).</p>
<p>Instance methods are methods that operate on an instance of a class. A reference to the instance is passed to all instance methods, named <tt class="docutils literal">self</tt>. We call them <em>instance</em> methods to differentiate them from <em>class methods</em>. Class attributes are explained a bit later on in this article. The thing to know about class <em>methods</em> is that instead of the first parameter being a reference to the <em>instance</em>, its a reference to the <em>class</em>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Most of the time you won't have to deal with class methods. In fact, to use them, you must decorate a method with the special <tt class="docutils literal">@classmethod</tt> decorator.</p>
</div>
<p><tt class="docutils literal">tied()</tt> will returns <tt class="docutils literal">True</tt> if the game is tied, and <tt class="docutils literal">False</tt> if not.</p>
<p><tt class="docutils literal">next_inning()</tt> advances the inning, and ends the game when we reach inning number 9. That is, unless its a tied game, then it sets <tt class="docutils literal">self.extra_innings</tt> to <tt class="docutils literal">True</tt>, and continues counting.</p>
<p><tt class="docutils literal">tied()</tt> is a typical utility method, used by either someone interacting with the instance, or by the instance itself, to do some calculations based on the current values of the instance attributes.</p>
<p><tt class="docutils literal">next_inning()</tt> is used to <em>encapsulate</em> all of the logic that goes into determining if the game has ended or not, as well as doing any accounting necessary to move on to the next inning.</p>
</div>
<p>Here's how we interact with it:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">board</span> <span class="o">=</span> <span class="n">ScoreBoard</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">inning</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">tie</span><span class="p">()</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s2">"guest"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s2">"home"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">tie</span><span class="p">()</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">inning</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">extra_innings</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s2">"home"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">board</span><span class="o">.</span><span class="n">next_inning</span><span class="p">()</span>
<span class="go">Game is over</span>
</pre></div>
</td></tr></table></div><p>When we call the <tt class="docutils literal">next_inning()</tt> method, we have some logic to check if the game is tied at the 10th inning. If it is, the <tt class="docutils literal">extra_innings</tt> flag is set to <tt class="docutils literal">True</tt>. Otherwise, the game is over.</p>
<p>This is something special that classes give us over other ways of modeling state. We have a fully <em>encapsulated</em> state object - everything we do with state, and all the data we care about, lives inside that object, represented by the <tt class="docutils literal">ScoreBoard</tt> class.</p>
<p>Now lets look at how we can work this concept into a microcontroller project. We'll start by bringing things back to basics.</p>
<div class="section" id="state-and-microcontrollers">
<h3>State And Microcontrollers</h3>
<p>Lets apply state tracking to our <a class="reference internal" href="#testing">testing code</a>. Recall that to test our board, we set up a simple project that has the following functionality:</p>
<ul class="simple">
<li>While button "A" is pressed, the built-in red LED lights up.</li>
<li>While button "B" is pressed, the built-in NeoPixel or DotStar lights up in white.</li>
</ul>
<p>We'll extend this a little bit and:</p>
<ul class="simple">
<li>Every time button "B" is pressed, the built-in RGB LED (NeoPixel or DotStar) will light up in a <em>different color</em>.</li>
</ul>
<p>To make this work, here is the state we have to track:</p>
<ul class="simple">
<li>the value of button "A"</li>
<li>the value of button "B"</li>
<li>should the LED be on or off?</li>
<li>should the RGB LED be on or off?</li>
<li>what color should the RGB LED be?</li>
</ul>
<p>Again, we can simply use multiple variables to hold various state values, but we'll see how convoluted this can get:</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Remember this code is assuming you have created a <tt class="docutils literal">setup.py</tt> file as explained <a class="reference internal" href="#abstractions-keeping-the-code-simple">earlier</a>.</p>
</div>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="c1"># review of what the setup module does for us:</span>
<span class="c1">#</span>
<span class="c1">#   - led is our digital pin object connected to pin 13</span>
<span class="c1">#   - rgb is our DotStar or NeoPixel</span>
<span class="c1">#   - check() is a function that handles differences between button wiring</span>

<span class="c1"># these state variables need specific names</span>
<span class="n">led_state</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">button_a_state</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">button_b_state</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">rgb_state</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">rgb_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">button_a_state</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">button_b_state</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">button_a_state</span><span class="p">:</span>
        <span class="n">led_state</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led_state</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">button_b_state</span><span class="p">:</span>
        <span class="n">rgb_state</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb_state</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">led_state</span>

    <span class="k">if</span> <span class="n">rgb_state</span><span class="p">:</span>
        <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">rgb_color</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p><strong>Line 1 and 2</strong> are our standard imports.</p>
<p><strong>Line 11-15</strong> is where we define each of our state variables, and set their default state. Note that we had to use some inelegant names because we already have some objects that might conflict.</p>
<p><strong>Line 17-38</strong> is our main loop.</p>
<p><strong>Line 18 and 19</strong> read the button pins and update the button state variables.</p>
<p><strong>Lines 21-19</strong> update the LED and RGB pixel state variables based on the state of the buttons.</p>
<p><strong>Line 33-36</strong> uses the state variables to affect the real world, by turning on or off the LED and RGB pixel.</p>
<p>Finally, on <strong>line 38</strong>, we sleep for 0.2 seconds to debounce the buttons.</p>
</div>
<p>Before we go much further, lets draw an important distinction. Unlike a physical scoreboard at a baseball stadium, which acts as part of the experience of watching the game, our state merely <em>reflects</em> our reality.</p>
<p>The way we work with state is to alter it either <em>because</em> something happened (say, a button was pressed, much like scoring a point in a game), or to <em>cause</em> something to happen (this is different; like lighting up an LED, or changing a NeoPixel's color).</p>
<p>It's a three-pass system. First, state is assessed - input pins are read, sensors are queried. The state object is updated to reflect what was observed in real life.</p>
<p>The second pass involves looking at the state object and changing state based solely on that - something happened during the first pass that requires the state to change. A button's state has changed, so we need to update the state of the LED.</p>
<p>The final pass reconciles the state object with reality. This is where you would buzz a piezo speaker, update a display, or turn on an LED. These are considered <em>side effects</em> - when we execute code, like setting a digital pin to <tt class="docutils literal">True</tt>, our code has had effects outside of its scope.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this case, and for our purposes, the side effects usually affect the physical state of our project (the LED lights up). But in programming, side effects can be anything, and are usually affecting other parts of our code or our data.</p>
</div>
<p>Here's a diagram showing how it works:</p>
<a href="/images/fullsize/nonblocking-state-flowchart.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/nonblocking-state-flowchart.jpg" srcset="/images/responsive/nonblocking-state-flowchart-2500.jpg 2500w,/images/responsive/nonblocking-state-flowchart-2000.jpg 2000w,/images/responsive/nonblocking-state-flowchart-1800.jpg 1800w,/images/responsive/nonblocking-state-flowchart-1600.jpg 1600w,/images/responsive/nonblocking-state-flowchart-1200.jpg 1200w,/images/responsive/nonblocking-state-flowchart-1000.jpg 1000w,/images/responsive/nonblocking-state-flowchart-800.jpg 800w,/images/responsive/nonblocking-state-flowchart-400.jpg 400w,/images/responsive/nonblocking-state-flowchart-200.jpg 200w" style="width: 80%;"/></a>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">For our simple example, we can shortcut some of these steps (for example, just directly set the value of the led to that of its button). But it's good to think about things in this multiple-pass manner, since it makes more complex things much easier to reason about.</p>
</div>
<p>We need to add our "different color" feature. Before we do that, lets refactor our state variables into a class:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, RGB: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># first pass: check real life</span>
    <span class="n">state</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

    <span class="c1"># second pass: assess state</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button_a</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button_b</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># third pass: reconcile state</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This code is identical to the last example, except that we've replaced the state variables with a single state class, called <tt class="docutils literal">State</tt>.</p>
<p>The <tt class="docutils literal">State</tt> class, defined on <strong>lines 4-13</strong>, has two defined methods. The first is <tt class="docutils literal">__init__()</tt>, the constructor. It sets up the default values of all of the attributes of the <tt class="docutils literal">State</tt> instance.</p>
<p>The second defined method, <tt class="docutils literal">__repr__()</tt> is also special, like <tt class="docutils literal">__init__()</tt> - it is called whenever you need a <em>representation</em> of an instance object. It serves two purposes.</p>
<p>First, it can be used to return valid Python code that could be used to recreate your object.</p>
<p>The other purpose to provide a quick glance into what data the object holds - in this case it doesn't have to be valid Python - we indicate that we're using this purpose by wrapping our return value in angle brackets (<tt class="docutils literal">&lt;&gt;</tt>).</p>
<p>Every standard Python data type implements this method. Its what you see when you just evaluate an object:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"three"</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">[1, 2, 'three', 4, 6, 9]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span>
<span class="go">&lt;Buttons: False/False, LED: False, RGB: False, Color: (255, 255, 255)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span>
<span class="go">&lt;Buttons: False/False, LED: False, RGB: True, Color: (255, 255, 255)&gt;</span>
</pre></div>
</td></tr></table></div><p>Here we illustrate the standard Python type behavior by creating an then evaluating a simple list, then instantiate our <tt class="docutils literal">State</tt> class, evaluate it, change an attribute, and evaluate it again.</p>
<p>It's a good practice to define <tt class="docutils literal">__repr__()</tt> in your classes, as it helps when debugging.</p>
<p>In our <tt class="docutils literal">__repr__()</tt> method, we're using the <tt class="docutils literal">.format()</tt> string method to insert instance values into our return value.</p>
<p>On <strong>line 15</strong>, we instantiate our <tt class="docutils literal">State</tt> instance for use in our main loop.</p>
<p>In our main loop on <strong>lines 17-41</strong>, the logic is exactly the same as before, except we are accessing attributes of our <tt class="docutils literal">state</tt> object.</p>
</div>
<p>Interacting with the one <tt class="docutils literal">state</tt> object is a lot cleaner than dealing with five disparate variables. But what's really cool about using a class like this is that we can give our <tt class="docutils literal">state</tt> object its own <em>functionality</em>.</p>
<p>We do this by adding a method. As we covered earlier, methods are just functions that are part of a class. What sets them apart is their context. A function runs within the module where its defined. A method runs within the instance of the class where it was defined.</p>
<p>We'll take the "different" part of our feature requirement to an extreme, and add a method to the <tt class="docutils literal">State</tt> class that generates a totally <em>random</em> color:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
       <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, RGB: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="c1"># -- snip --</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This code replaces the first lines of the previous example. Everything from the initial imports, through to instantiating the <tt class="docutils literal">state</tt> object is replaced with the above, up to the <tt class="docutils literal"># <span class="pre">--</span> snip <span class="pre">--</span></tt> comment.</p>
<p>The first difference is that we've imported the <tt class="docutils literal">random</tt> module, on <strong>line 2</strong>. This is a standard Python module that provides an interface with a <a class="reference external" href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">psuedo-random number generator</a>.</p>
<p>The other change is the implementation of the <tt class="docutils literal">random_color()</tt> method on <strong>lines 13-18</strong>. This method uses the <tt class="docutils literal">randrange()</tt> function from the <tt class="docutils literal">random</tt> module to select three random numbers between 0 and 255 (the range of valid red, green, and blue amounts), and set <tt class="docutils literal">self.color</tt> to a tuple containing them.</p>
<p>So every time the <tt class="docutils literal">random_color()</tt> method is called, a new random color is generated and stored in the state object.</p>
</div>
<p>Now we can change the logic in our <tt class="docutils literal">while True</tt> loop to generate a random color.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># update the state</span>
    <span class="n">state</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

    <span class="c1"># take action - change the state</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button_a</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"LED: on"</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button_b</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"RGB on. Color: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">color</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">state</span><span class="o">.</span><span class="n">random_color</span><span class="p">()</span>

    <span class="c1"># take action - do things that cause side effects</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>Everything here has been explained before, with the exception of the following:</p>
<ul class="simple">
<li>We call the <tt class="docutils literal">random_color()</tt> method on <strong>line 42</strong>, so now we get a new color every time the button is not pressed.</li>
<li>We've added some debugging helpers, <tt class="docutils literal">print()</tt> calls, on <strong>lines 32 and 38</strong>. This way when watching the Python console, we can see what's going on, and keep an eye on how our state is changing.</li>
</ul>
</div>
<p>A few notes:</p>
<ul class="simple">
<li>With every loop, if the "b" button is not pressed, we call <tt class="docutils literal">state.random_color()</tt>. This means the color of the pixel is always changing, even when the RGB pixel isn't illuminated. This is sub-optimal. We never want to do work when we don't have. We'll address this situation in the next section when we start dealing with <em>events</em>.</li>
<li>There's an added <tt class="docutils literal">print()</tt> each time the state changes. This serves two purposes. First, it can be hard to see LEDs working in the video below, so I'll also demonstrate with a screen grab of Mu's console. Second, there are times when we'll be doing things repetitively and not realize it. If we're triggering some action more often then we intend to, it could be a bug. Calling <tt class="docutils literal">print()</tt> will let us see this in the console, even if we can't see it in our hardware.</li>
</ul>
<p>Here's a video of this code running on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/state-demo-trinket-01.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/state-demo-trinket-01.mp4">link to the video</a> instead.</p>
</video>
</div><p>Before we move on, lets <em>refactor</em> our code again, but just a little bit. Since <tt class="docutils literal">State</tt> is our keeper of state for our project, lets move <strong>all</strong> of the code that changes state into to a method of the <tt class="docutils literal">State</tt> class:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"LED on"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"RGB on. Color: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">color</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">random_color</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># update the state</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># take action - do things that cause side effects</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This code is identical to the last example, except for the addition of the <tt class="docutils literal">update()</tt> method to the <tt class="docutils literal">State</tt> class.</p>
<p><tt class="docutils literal">update()</tt> is defined starting on <strong>line 20</strong>. It's simply a copy/paste of the logic from the main loop in the last example, just altered so it references <tt class="docutils literal">self</tt> instead of <tt class="docutils literal">state</tt>.</p>
<p>We've added a call to <tt class="docutils literal">state.update()</tt> on <strong>line 44</strong>, to invoke the code that we moved into the <tt class="docutils literal">update()</tt> method.</p>
</div>
<p>Now the <tt class="docutils literal">State</tt> class is truly the authority for all things state-related. In OOP terms, it's <em>fully encapsulated</em>.</p>
<p>Now that we've explored what state is, and how we can write code to deal with it, we have opened ourselves up to some really neat possibilities. But since we're using <tt class="docutils literal">time.sleep()</tt>, our code is still blocking, and we're still limited by that. The next step is to utilize our new understanding of state to debounce without blocking.</p>
</div>
<div class="section" id="using-state-to-avoid-blocking">
<h3>Using State To Avoid Blocking</h3>
<p>The next step is to get rid of that blocking code. This is another thing our <tt class="docutils literal">State</tt> class can handle for us.</p>
<p>As discussed earlier, the reason why we block is to keep our code from running too fast. This keeps our signals from our buttons smooth, avoiding bouncing.</p>
<p>Another way to look at it is that we've introduced the passage of time into our main loop. We're fixing our code to an interval of 0.2 seconds, so we can wait until a button is completely pressed or released before we act, and so that our code won't run over and over without reason.</p>
<p>We can accomplish the same goal in a different way using state. Instead of putting a full stop on all of our code for 0.2 seconds, we can instead look at a some sort of clock at the start of every loop, and only <em>act</em> every 0.2 seconds. While we're waiting for time to pass, other code can run, getting rid of the blocking.</p>
<p>This means that the time we looked at the clock is a <em>new state attribute</em>. We can reference this new attribute to decide when to act.</p>
<p>So how do we track passing time? Most microcontrollers don't have true built-in clocks like PCs. Most computers have what's called a "<a class="reference external" href="https://en.wikipedia.org/wiki/Real-time_clock">real-time clock</a>", or RTC. It's typically an integrated circuit that counts time in a highly accurate way using some sort of oscillating crystal. A battery is used to keep power to the IC so that it won't loose track of time, especially when the PC is powered off.</p>
<p>While we can get microcontrollers with RTCs built in, and as add-on boards (Adafruit has several in their shop that have <a class="reference external" href="https://learn.adafruit.com/adafruit-pcf8523-real-time-clock/rtc-with-circuitpython">CircuitPython support</a>), they are typically reserved for applications where "clock time" is necessary - for example, a digital alarm clock, or logging sensor data.</p>
<p>Luckily, microcontrollers are in themselves a sort of <em>pseudo-clock</em>, because they operate on a regular processor cycle.</p>
<p>The processor cycles are fixed to a specific rate. For example, our M0 board "clocks" at 48 megahertz (<em>48,000,000</em> cycles per second). That means that every second, the processor scans the part of its memory where your program code lives, and executes the instructions it finds <em>fourty-eight million times</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The chips in these CircuitPython boards, the ATSAMD21 and ATSAMD51, have a built-in <em>oscillator</em>. They have circuitry in the chips that can generate a regular pulse that can be used for clocking the processor. Not all microcontrollers have these. You'll often see a little oblong silver cylinder on the board (a <a class="reference external" href="https://en.wikipedia.org/wiki/Crystal_oscillator">crystal oscillator</a>) - this is the real "clock" in that situation.</p>
<p class="last">The processor runs at the frequency of the outboard oscillator. In the case of the M0/M4 chips, you can choose to use an external oscillator or choose one of several built-in to the chip.</p>
</div>
<p>That cycle is very reliable, so it's possible to track it, and with some math, convert cycles to seconds passing over time.</p>
<p>There's a function in the <tt class="docutils literal">time</tt> module that does just that. It's called <tt class="docutils literal">time.monotonic()</tt>. When called, it returns the number of seconds that have passed since the processor was turned on.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Behind the scenes, CircuitPython is using so-called <a class="reference external" href="https://learn.adafruit.com/multi-tasking-the-arduino-part-2/timers">timer interrupts</a>, features of microcontrollers where you can tell the processor to execute specific code blocks at regular intervals based on processor cycles.</p>
</div>
<p><tt class="docutils literal">time.monotonic()</tt> returns a <em>float</em>, or <a class="reference external" href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floating-point number</a> - essentially a fraction, so it's ideal for our two-tenths-of-a-second debouncing rate.</p>
<p>Now, let's take advantage of this in our code.</p>
<p>First, we'll need to add a new attribute to our <tt class="docutils literal">State</tt> class. It will represent the last time we looked at the clock, or <em>checked in</em> with the processor. We'll call it <tt class="docutils literal">checkin</tt>.</p>
<p>Initially, we'll set it to the value of <tt class="docutils literal">time.monotonic()</tt>. By doing this in the constructor (<tt class="docutils literal">__init__()</tt>), we are calling <tt class="docutils literal">time.monotonic()</tt> when we create the <tt class="docutils literal">state</tt> variable from the <tt class="docutils literal">State</tt> class. So the initial value of <tt class="docutils literal">state.checkin</tt> will be the number of seconds from when the board was powered on, until that line of code is executed.</p>
<p>We'll look at <tt class="docutils literal">checkin</tt> every loop, and see if the current value of <tt class="docutils literal">time.monotonic()</tt> is at least 0.2 seconds larger - this would mean that 0.2 seconds have elapsed.</p>
<p>At that point we can update our state, in our case read the buttons.</p>
<p>Finally we need to set <tt class="docutils literal">checkin</tt> to the current value of <tt class="docutils literal">time.monotonic()</tt>, to mark the last time we checked the clock, and the cycle can start all over again.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"LED on"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">:</span>
                <span class="err">﻿</span><span class="k">print</span><span class="p">(</span><span class="s2">"RGB on. Color: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_color</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># update the state</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># take action - do things that cause side effects</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>Changes in this iteration:</p>
<ul class="simple">
<li>On <strong>line 6</strong>, we introduce the concept of a <em>private class attribute</em>, called <tt class="docutils literal">_debounce</tt> (class attributes and 'privacy' are discussed below). We're using it to hold the number of seconds we want to wait before deciding if a button was pressed or not.</li>
<li>On <strong>Line 14</strong>, the new <tt class="docutils literal">checkin</tt> attribute is established, and its default value is set to <tt class="docutils literal">time.monotonic()</tt> - so it will be a float of the number of seconds since the board was powered on (roughly). The specific default value will be the number of seconds since the board was powered on <em>when the class is instantiated</em> on <strong>line 46</strong>. As discussed above, this gives us a reference point for debouncing.</li>
<li>The <tt class="docutils literal">update()</tt> method has been altered to both utilize the <tt class="docutils literal">checkin</tt> attribute to only change the state every 0.2 seconds (<strong>line 24</strong>), and update the <tt class="docutils literal">checkin</tt> value after its done doing that (<strong>line 41</strong>).</li>
</ul>
</div>
<p>We've introduced a new concept beyond the addition of tracking time. Note the addtion of a variable in the class, defined outside of any methods, called <tt class="docutils literal">_debounce</tt>.</p>
<p><tt class="docutils literal">_debounce</tt> is a <em>class attribute</em>, meaning that it belongs to the <tt class="docutils literal">State</tt> class, and not to the instance object created from <tt class="docutils literal">State</tt> (in our code, the instance is named <tt class="docutils literal">state</tt>), even though we can access it from the instance (<tt class="docutils literal">self._debounce</tt> in our methods, or <tt class="docutils literal">state._debounce</tt> in our main code).</p>
<p>By making <tt class="docutils literal">_debounce</tt> a class attribute, we are indicating to anyone who uses our class that we don't intend for the value to be changed. However, if we were to change it, we would do so by accessing it as <tt class="docutils literal">State._debounce</tt>. What's really interesting is that changing <tt class="docutils literal">State._debounce</tt> would change <em>all</em> of the instances of <tt class="docutils literal">State</tt> too.</p>
<p>There's some nuance to it, but generally speaking, we use class attributes like this when we want to set a value that will rarely, if ever, change. We're using it here like a configuration setting.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference external" href="https://www.toptal.com/python/python-class-attributes-an-overly-thorough-guide">This post</a> does a great job of explaining instance attributes and class attributes in great depth.</p>
</div>
<p>There's something else noteworthy about <tt class="docutils literal">_debounce</tt>. We've prefixed it with an <em>underscore</em>. This indicates that it should be considered a <em>private</em> attribute. This means the attribute is intended for use only within the class methods, and it's not to be accessed from outside.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In Python, private attributes and methods are simply a <em>convention</em>. You shouldn't peek, but if you do, things will still work. The underscore is just a signal to other programmers that you don't intend the attribute to be used outside of the class.</p>
<p>In other languages, this is not the case - an attribute declared private will not be accessible <em>at all</em> outside of the class - it's like it doesn't exist.</p>
<p class="last">Since the concept of "privacy" in Python is merely a convention, it's better to express it not as "hidden" or "forbidden", but more so "an attribute name that I can't promise won't change, so don't count on it being there".</p>
</div>
<p>The changes are pretty subtle, but here's another video showing this version running on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/state-demo-trinket-02.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/state-demo-trinket-02.mp4">link to the video</a> instead.</p>
</video>
</div><p>At this point we've "unblocked" our code, and crafted a really clean way of working with state.</p>
<p>There is a small flaw here, as touched on earlier. The <tt class="docutils literal">random_color()</tt> method is being called nearly every 0.2 seconds, whether the button has been pressed or not. This is better than the first version of the code, where it was running almost every single loop, but it's still unnecessary.</p>
<p>What we want, is for the color to change only once, when you stop pressing the button. Or even when you first press it, before the <tt class="docutils literal">rgb</tt> state attribute is set to <tt class="docutils literal">True</tt>.</p>
<p>What that means is we want to detect when a button's state has changed from <tt class="docutils literal">True</tt> to <tt class="docutils literal">False</tt>, or <tt class="docutils literal">False</tt> to <tt class="docutils literal">True</tt>, and then take action.</p>
<p>What we want to do is called <em>event detection</em>.</p>
</div>
<div class="section" id="events">
<h3>Events</h3>
<p>In order to avoid calling <tt class="docutils literal">random_color()</tt> every single time we update our state whether the "b" button was pressed or not, we need to decide when the best time to call <tt class="docutils literal">random_color()</tt> is. For this example, we were calling <tt class="docutils literal">random_color()</tt> when the button was unpressed because if we didn't, the color would change every 0.2 seconds that you held the button down (or constantly before we were tracking time).</p>
<p>So when should we do it, to avoid calling <tt class="docutils literal">random_color()</tt> too frequently?</p>
<p>Think about how a button works. When you press it, the pin reads "HIGH" until you remove your finger (or "release" the button). Then it reads "LOW". These are two separate <em>events</em> - <strong>press</strong> and <strong>release</strong>.</p>
<ul class="simple">
<li><strong>Press</strong> happens when the button changes from "LOW" to "HIGH" - it wasn't pressed, and now it is.</li>
<li><strong>Release</strong> happens when the button changes from "HIGH" to "LOW" - it <em>was</em> pressed, and now <em>it isn't</em>.</li>
</ul>
<p>In Python, that means the <em>press</em> event happens when a pin's <tt class="docutils literal">value</tt> attribute used to read <tt class="docutils literal">False</tt>, and now it reads <tt class="docutils literal">True</tt>. A <em>release</em> even happens when a pin's <tt class="docutils literal">value</tt> used to read <tt class="docutils literal">True</tt> and now it's <tt class="docutils literal">False</tt>.</p>
<p>We know what the previous value was because we've stored in it our <tt class="docutils literal">state</tt> object. We can use that to detect the change in state.</p>
<p>The basic logic looks like this:</p>
<a href="/images/fullsize/basic-button-event-logic.jpg"><img alt="" class="align-center" sizes="(min-width: 2650.0px) 2000px,(min-width: 2120.0px) 1600px,(min-width: 1908.0px) 1440px,(min-width: 1696.0px) 1280px,(min-width: 1272.0px) 960px,(min-width: 1060.0px) 800px,(min-width: 848.0px) 640px,(min-width: 424.0px) 320px,(min-width: 212.0px) 160px" src="/images/fullsize/basic-button-event-logic.jpg" srcset="/images/responsive/basic-button-event-logic-2500.jpg 2500w,/images/responsive/basic-button-event-logic-2000.jpg 2000w,/images/responsive/basic-button-event-logic-1800.jpg 1800w,/images/responsive/basic-button-event-logic-1600.jpg 1600w,/images/responsive/basic-button-event-logic-1200.jpg 1200w,/images/responsive/basic-button-event-logic-1000.jpg 1000w,/images/responsive/basic-button-event-logic-800.jpg 800w,/images/responsive/basic-button-event-logic-400.jpg 400w,/images/responsive/basic-button-event-logic-200.jpg 200w" style="width: 80%;"/></a>
<p>Now that we can act <em>only</em> when the button transitions from one state to the other, we can call <tt class="docutils literal">random_color()</tt> in a more logical place, like right before we change the RGB pixel's state, when the button is pressed. We could also just do it when the button is released, more in line with the original logic.</p>
<p>Here's our code again, with the <tt class="docutils literal">random_color()</tt> call wrapped inside of a <em>press</em> event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Generating random color"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
             <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

            <span class="c1"># b button was pressed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"B button pressed"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_color</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"LED on"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"RGB on. Color: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"&lt;Buttons: {}/{}, LED: {}, Color: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># update the state</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># take action - do things that cause side effects</span>
    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This is a major shift in how our code works, but it's accomplished with a very minor change.</p>
<p>On <em>line 31</em>, we compare the current physical state of the button with the value we've stored in our state object. If it's changed from "not pressed" (<tt class="docutils literal">self.button_b</tt> is <tt class="docutils literal">False</tt>) to "pressed" (<tt class="docutils literal"><span class="pre">check("B")</span></tt> returns <tt class="docutils literal">True</tt>), then we've detected the <em>press</em> event.</p>
<p>We only change the color to a new random one (call <tt class="docutils literal">self.random_color()</tt>, <strong>line 33</strong>) when the button state has changed, instead of calling it whenever the button is being pressed.</p>
</div>
<p>We're now set up to handle even more events, like button holds. Or even complex events like pressing multiple buttons at once.</p>
<p>If you've done any programming in the past with GUIs, or front-end web application development, this may seem very familiar. It's very similar to how mouse and keyboard events are handled in these environments.</p>
<p>But don't be distracted by this! An event is not inherently tied to human interaction. An event can be <em>anything</em>. If it can be detected, we can call it an event, and take action when it happens (we can <em>handle</em> the event).</p>
<p>Imagine you have some environmental sensors. You can detect UV index, brightness of light, temperature, and relative humidity.</p>
<p>All of the following would be examples of events:</p>
<ul class="simple">
<li>The temperature increases by 10 degrees Fahrenheit.</li>
<li>The humidity drops by 20%.</li>
<li>The humidity drops by 20% <em>over the course of one hour</em>.</li>
<li>The UV index is over 6 and the temperature is over 85 degrees Farenheit.</li>
<li>There is very little light falling on the light sensor - <em>it's probably night time</em>.</li>
<li>It was nighttime, but now it's not, <em>it's probably sunrise</em>.</li>
</ul>
<p>You get the idea - all of these events would be handled by some code - change the color of a status LED, write a log message, send an SMS reminding you to put on some sunscreen, put the CPU into "low power" mode, etc.</p>
<p>You gain a lot of insight when you start to look at coding a microcontroller project as a problem of <em>managing state</em>. Changes in state trigger <em>events</em>. You <em>handle</em> those events with code. Very complex problems become very easy to reason about and debug.</p>
</div>
</div>
<div class="section" id="state-considerations">
<h2 id="state-considerations">State: Considerations</h2>
<p>There are many benefits to modeling our project code around state:</p>
<ul class="simple">
<li>We have ultimate flexibility. When it comes to debouncing or otherwise detecting events, we can avoid blocking. Generally speaking, managing state lets us decide what data care about, and define our own events based on what the state object looks like.</li>
<li>We can separate our concerns. Instead of mixing complex logic and interacting with components and peripherals, we can do one, then the other.</li>
<li>We have good transparency. It's obvious what data we care about, since it's all wrapped up in the state object. Using a global state object, we can inspect the state anywhere in our code.</li>
<li>The code can be factored in such a way that it is very simple to reason about. With a few rules attached to the state variables, we can condense a complex series of if/else statements into just a few that are easy to wrap our heads around.</li>
<li>Events are easy to detect, since we have a record of what things looked like in the past.</li>
</ul>
<p>This is great, but there are some drawbacks:</p>
<ul class="simple">
<li>We will ultimately end up using more memory. This isn't too big of a concern on a beefy platform like the M0 Express boards, but we still have limits to how much memory we can use and have to remain conscious of this.</li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">There is an excellent article series over on <a class="reference external" href="https://hackaday.com/2015/12/09/embed-with-elliot-debounce-your-noisy-buttons-part-i/">Hackaday</a> that covers debouncing in depth and illustrates a solution for the Arduino platform that is <em>extremely</em> memory efficient. Something like this could be adapted to CircuitPython if our state keeping variable got to be too memory intensive.</p>
</div>
<ul class="simple">
<li>The timing is likely to be ever-so-slightly inaccurate. While processor cycles are very consistent, counting them tends to loose accuracy over time (in PCs this is called "clock drift"). This is also due to the math being done - counting millions of cycles and dividing that by seconds and rounding to the precision available causes rounding errors.</li>
<li>There can still be blocking code, and aspects of Python (like <a class="reference external" href="https://wiki.python.org/moin/GlobalInterpreterLock">the GIL</a>) that can further throw off your timing, especially when your code is running for long periods of time (days).</li>
<li>The precision of <tt class="docutils literal">time.monotonic()</tt> is pretty shallow compared to the counters that CircuitPython uses behind the scenes to calculate it. Its typically only going to give you precision to hundredths of a second. Perfectly adequate for our purposes, but it could become an issue in some contexts (video games, for example).</li>
</ul>
<p>So there are things to be concerned about, but nothing that detracts from the utility of this approach.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">At the time of writing, there is an <a class="reference external" href="https://github.com/adafruit/circuitpython/issues/519">open issue</a> addressing the inaccuracy of <tt class="docutils literal">time.monotonic()</tt> in the CircuitPython github with a promising pull request attached. Worth keeping an eye on, and here's hoping that it gets more attention.</p>
</div>
<p>In the following sections, we'll take this approach further, and create an easy-to-use state object that will execute arbitrary code when certain things happen, particularly button events.</p>
</div>
<div class="section" id="a-generic-state-dispatcher">
<h2 id="a-generic-state-dispatcher">A Generic State Dispatcher</h2>
<p>Having established a way of tracking state over time, and the concept of <em>events</em>, we can generalize the button logic into a <em>dispatcher</em> - code that detects the events and then dispatches to pre-defined <em>handlers</em>. In other words, it detects an event, and runs code for us.</p>
<p>We can take the <tt class="docutils literal">State</tt> class that we've been working on and extend it to detect the three most common button events: <em>press</em>, <em>release</em>, and <em>hold</em>.</p>
<p>We can then take advantage of a key feature of Python to make the handlers really flexible. In Python, functions are <em>first class objects</em>. This means that they can be assigned to variables, and passed around just like an integer or list.</p>
<p>Using this feature, we can configure our state class when we instantiate it, by passing function names to the constructor. We can store the functions as instance attributes and execute them later when we need to dispatch an event.</p>
<p>The first step is to specify the events we want to detect in terms of what conditions must occur for them to be triggered.</p>
<p>We're going to focus on button events here, but remember events can be whatever we want.</p>
<div class="section" id="event-1-press">
<h3>Event 1: Press</h3>
<p>Recall from the last section that a <em>press</em> event happens when the button <em>wasn't</em> pressed, and now it is.</p>
<p>But lets be very specific so we can make sure we've covered all of the conditions in our code. That means we also have to take into account button debounce.</p>
<p>So, for a <em>press</em> event to occur:</p>
<ul class="simple">
<li>The button pin has gone from "LOW" to "HIGH" (<tt class="docutils literal">False</tt> to <tt class="docutils literal">True</tt>).</li>
<li>The button pin has read "HIGH" (<tt class="docutils literal">True</tt>) for more than 0.2 seconds.</li>
</ul>
<p>Let's review the logic for this event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># WARING: pseudo(ish) code</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># digital pin object</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debounce</span> <span class="n">time</span> <span class="n">has</span> <span class="n">passed</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="event-2-release">
<h3>Event 2: Release</h3>
<p>A <em>release</em> event occurs when the user stops pressing the button. This usually happens immediately after a <em>press</em> event, but this is not always the case - there may be a delay if the button was held down.</p>
<p>Specifically, a release event has occurred when:</p>
<ul class="simple">
<li>The button pin has gone from "HIGH" to "LOW" (<tt class="docutils literal">True</tt> to <tt class="docutils literal">False</tt>).</li>
</ul>
<p>Debouncing can sometimes be required but for the most part, considering the event triggered at the first notice of the pin reading "LOW" will be sufficient.</p>
<p>Here's what the logic looks like:</p>
<p>Let's review the logic for this event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># WARING: pseudo(ish) code</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># digital pin object</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
    <span class="c1"># button has been released</span>
    <span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="event-3-hold">
<h3>Event 3: Hold</h3>
<p>This is a new event we haven't covered before. <em>Hold</em> can be looked at in two different ways. The first way is to consider a hold event as a one-time occurance, where a hold event has occurred after a <em>release</em> event that follows a <em>press</em> event and a set period of time has passed between the two.</p>
<p>The second way, is to think of a <em>hold</em> an event that happens over and over every so often while a button is being held down.</p>
<p>It's a bit easier to explain the difference between the two in code.</p>
<p>The first way would look something like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># warning: pseudo(ish) code!</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># properly configured digital pin</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># time that we started holding</span>
<span class="n">held_since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="c1"># remember the following is being run with a delay for debounce</span>
<span class="n">every</span> <span class="n">debounce</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">held_since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c1"># button has been released</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">held_since</span> <span class="o">&gt;</span> <span class="n">some_threshold</span><span class="p">:</span>
            <span class="c1"># button has been held</span>
</pre></div>
</td></tr></table></div><p>Contrast that with treating a hold event as a recurring event:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># warning: pseudo(ish) code!</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">button</span> <span class="o">=</span> <span class="c1"># properly configured digital pin</span>

<span class="c1"># is the button pressed or not</span>
<span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># is the button being held</span>
<span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># checkin to detect a hold</span>
<span class="n">hold_check</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="c1"># remember the following is being run with a delay for debounce</span>
<span class="n">every</span> <span class="n">debounce</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># button has been pressed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">hold_check</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">hold_check</span> <span class="o">&gt;</span> <span class="n">some_hold_threshold</span><span class="p">:</span>
        <span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">holding</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># dispatch the hold event</span>
        <span class="c1"># this will happen every time we debounce</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c1"># button has been released</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>Both approaches are valid, and which one to use will depend on your application.</p>
<p>The first approach works well when we don't need to do anything <em>during</em> the time a button is being held down. An example of a use case for this would be holding a button for, say 2 seconds to change into a different <em>mode</em>, or holding the button in for 5 seconds to power the project off.</p>
<p>The second approach allows us to take action while the button is being pressed and held. Examples of use cases for this include holding a button to advance a clock to set the time and emulating the scroll wheel on a mouse. It has the advantage over the first approach, besides continuing to act, of being able to take the number of times the hold event has fired into account. This allows us to do things like accelerate the rate of increase on the clock or move the scroll wheel faster the longer the button is held.</p>
<p>For this article, we'll implement the second approach, since the project that inspired this article uses it.</p>
<p>So, to quantify our event, a <em>hold</em> occurs when:</p>
<ul class="simple">
<li>The button pin has gone from "LOW" to "HIGH" (<tt class="docutils literal">False</tt> to <tt class="docutils literal">True</tt>), or a <em>press</em> event has previously occurred.</li>
<li>The button pin has read "HIGH" (<tt class="docutils literal">True</tt>) for more than 0.4 seconds.</li>
<li>The event continues to occur every 0.4 seconds until a <em>release</em> event occurs.</li>
</ul>
</div>
<div class="section" id="the-code">
<h3>The Code</h3>
<p>As mentioned earlier, Python allows functions to be passed around like any other value. We can leverage that fact to make a dispatcher that is very flexible.</p>
<p>In the code below, we pass a series of predefined functions to our dispatcher constructor that it will use to determine what the current value of the button is, and call when each type of event is detected.</p>
<p>While we develop the generic dispatcher, we'll just print the events to the console to keep things simple.</p>
<p>We're going to focus on just handling button-related events. We'll rename the class from <tt class="docutils literal">State</tt> to <tt class="docutils literal">ButtonDispatch</tt>. We're only going to deal with one button at a time. We'll also remove the state attributes and methods that aren't button-related (<tt class="docutils literal">rgb</tt>, <tt class="docutils literal">led</tt>, <tt class="docutils literal">random_color()</tt>, etc). This way we can use a separate <tt class="docutils literal">ButtonDispatch</tt> object for every button we have, instead of adding a lot of complexity to a single class to handle many different buttons.</p>
<p>We've also moved the logic from the <tt class="docutils literal">update()</tt> method to <tt class="docutils literal">__call__()</tt> - this is a special ("magic") method you can define to make an object <em>callable</em>, like a function.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Check: {}, State: {} Checkin: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">():</span>
    <span class="n">reutrn</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="n">dispatch</span> <span class="o">=</span> <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>There's a lot of new code here, so lets take this example line by line, from the top.</p>
<p><strong>Lines 1-4</strong> are the imports we need from external libraries, including <tt class="docutils literal">time</tt> to track the passing of time, the <tt class="docutils literal">setup</tt> module to abstract away differences between our boards, and <tt class="docutils literal">random</tt> to generate random colors.</p>
<p><strong>Lines 6-72</strong> define our <tt class="docutils literal">ButtonDispatch</tt> class.</p>
<p><strong>Lines 7 and 8</strong> are global configuration variables, defined as <em>class attributes</em>, and intended for "private" use. The <tt class="docutils literal">_debounce</tt> attribute is used to set how frequently the state object checks the button (avoiding button bouncing).</p>
<p>The <tt class="docutils literal">_hold_threshold</tt> value is new, and is used to determine the difference between simply pressing the button, and holding it down. We need this because we are handling both the <em>press</em> and <em>hold</em> events in our dispatcher.</p>
<p>On <strong>line 10</strong>, the constructor takes some arguments.</p>
<ul class="simple">
<li><tt class="docutils literal">self</tt> is automatically passed to any instance method. It references the instance that this method is being called on.</li>
<li><tt class="docutils literal">check</tt>, is a function that will be called to read the button pin. It's expected to return <tt class="docutils literal">True</tt> if the button is pressed, and <tt class="docutils literal">False</tt> if it's not. <tt class="docutils literal">check</tt> is a required argument.</li>
<li><tt class="docutils literal">press</tt> is a function that will be called whenever a <em>press</em> event is detected. It is expected to take no attributes. Its return value isn't used by the <tt class="docutils literal">ButtonDispatch</tt> class. This is a optional argument, and will default to <tt class="docutils literal">None</tt>.</li>
<li><tt class="docutils literal">release</tt> is a function that will be called whenever a <em>release</em> event is detected. It is also expected to take no attributes, and its return value isn't used by the dispatcher. It's also optional, and defaults to <tt class="docutils literal">None</tt>.</li>
<li>Finally, <tt class="docutils literal">hold</tt> is a function that will be called multiple times (every <tt class="docutils literal">_hold_threshold</tt> seconds) when the button is being held down. It differs a bit from the other two functions in that it is required to take a single argument, which will be the number of times the <em>hold</em> event was detected in a row. It is also an optional argument, defaulting to <tt class="docutils literal">None</tt>.</li>
</ul>
<p>These functions would typically be considered <em>event handlers</em> in most event dispatch contexts.</p>
<p><strong>Lines 12-15</strong> establish the default state attributes the dispatcher uses to do its work. <tt class="docutils literal">checkin</tt> is the time keeping attribute. <tt class="docutils literal">holding</tt> is used to indicate if the button is currently being held. <tt class="docutils literal">hold_count</tt> tracks how many times the <em>hold</em> event has been detected. Finally <tt class="docutils literal">state</tt> is the state of the button, the last time it was read.</p>
<p><strong>Line 18</strong> stashes the <tt class="docutils literal">check</tt> function passed to the constructor in an instance variable (<tt class="docutils literal">get_value</tt>) so it can be used later. This is a really cool feature of Python: you can pass functions around like any other kind of data. This means you can pass them to a constructor and assign them to an instance attribute like we've done here. To call the <tt class="docutils literal">check</tt> function passed in the constructor, we can call <tt class="docutils literal">self.get_value()</tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This can be a little confusing, since this looks a lot like an instance method. The way to tell the difference is that an instance method always receives a <tt class="docutils literal">self</tt> attribute as its first argument.</p>
</div>
<p><strong>Lines 21-23</strong> assign the event handlers to instance attributes in the same way. We've named the instance attributes <tt class="docutils literal">onpress</tt>, <tt class="docutils literal">onrelease</tt> and <tt class="docutils literal">onhold</tt> - these names are a call back to event handlers in HTML. They are named such to differentiate them from the instance methods that are called when events are detected.</p>
<p>The <tt class="docutils literal">release</tt>, <tt class="docutils literal">check</tt>, <tt class="docutils literal">hold</tt>, and <tt class="docutils literal">press</tt> methods defined on <strong>lines 25-52</strong> are proxies for the functions that were passed in the constructor. With the exception of <tt class="docutils literal">check</tt>, they all follow the same pattern. They first update any state attributes required because of the event detection. Then they check if the handler was defined (<tt class="docutils literal">is not None</tt>), and if it was, they call it. Finally, they update the <tt class="docutils literal">checkin</tt> time.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It may seem a little odd that these functions are so simplistic. But the structure of the class has a specific purpose.</p>
<p>The dispatcher has been constructed this way so that you could build one with the <em>same</em> API, that doesn't rely on external functions being passed into the constructor.</p>
<p>You can instead hard-code what you want to happen in each event. To do different things for different buttons, you can use <a class="reference external" href="https://www.python-course.eu/python3_inheritance.php">class inheritence</a> to add in the special functionality.</p>
<p class="last">I find passing functions into the constructor to be much more flexible and straightforward, but the other approach is valid too, so I designed the class to be compatible with it.</p>
</div>
<p>On <strong>lines 54-69</strong>, the <tt class="docutils literal">__call__()</tt> 'magic' method makes instances of <tt class="docutils literal">ButtonDispatch</tt> <em>callable</em> - they can be invoked just like a function (we utilize this on <strong>line 89</strong>). When they are invoked that way, the <tt class="docutils literal">__call__()</tt> method is called. We use this as a central access point for making the event dispatch work.</p>
<p><tt class="docutils literal">__call__()</tt> starts by logging the current time in a variable called <tt class="docutils literal">current</tt> on <strong>line 55</strong>. We do this to avoid multiple calls to <tt class="docutils literal">time.monotonic()</tt>, so the following logic will be cleaner, and also more consistent (time will pass from line to line of the code as it's running).</p>
<p><strong>Lines 68-60</strong> detects and handles the <em>hold</em> event. Here, <em>hold</em> has occurred every time the button state is <tt class="docutils literal">True</tt>, and it's been <tt class="docutils literal">_hold_threshold</tt> seconds since the last check-in. On <strong>line 59</strong> the <tt class="docutils literal">holding</tt> attribute is set to <tt class="docutils literal">True</tt>, and then <strong>line 60</strong> calls the <tt class="docutils literal">hold()</tt> instance method.</p>
<p><strong>Lines 63-65</strong> detect and handle the <em>press</em> event. <em>Press</em> happens when the state of the button is <tt class="docutils literal">False</tt> but the button pin reads <tt class="docutils literal">True</tt> <em>and</em> it's been <tt class="docutils literal">_debounce</tt> seconds since the last check-in.</p>
<p>The <em>release</em> event is detected and handled on <strong>lines 68 and 69</strong>. <em>Release</em> happens when the state of the button is <tt class="docutils literal">True</tt>, but the pin reads <tt class="docutils literal">False</tt>. We could debounce here as well, but I haven't seen a need in my projects.</p>
<p><strong>Lines 71-72</strong> provide a <tt class="docutils literal">__repr__()</tt> method for easier debugging.</p>
<p><strong>Lines 74-83</strong> define the functions we will pass to <tt class="docutils literal">ButtonDispatch</tt> on <strong>line 86</strong>.</p>
<p><tt class="docutils literal">value()</tt> is a simple wrapper for our <tt class="docutils literal">check</tt> function from the <tt class="docutils literal">setup</tt> module.</p>
<p>The rest of the functions are event handlers. They simply print something out to the console to indicate that the event occurred.</p>
<p>Finally, on <strong>lines 86-89</strong>, the <tt class="docutils literal">ButtonDispatch</tt> class is instantiated, and our main loop is run. The main loop just calls the <tt class="docutils literal">dispatch</tt> object on each iteration. It's a lot less complex because we've moved <em>all</em> of the logic into the <tt class="docutils literal">ButtonDispatch</tt> class, and all of the actions that we need to take when the button is pressed into the event handlers.</p>
</div>
<p>Since the function used to check the physical state of the button is configured by creating a function and passing it to the constructor, we can use the same dispatcher for multiple kinds of inputs besides buttons - touch pads, rotary encoders, etc.</p>
<p>We can opt to skip certain events by passing <tt class="docutils literal">None</tt> to the constructor for the handlers we don't want to implement.</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-01.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-01.mp4">link to the video</a> instead.</p>
</video>
</div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>This implementation is designed to still do the <em>accounting</em> for each event even if no event is set - it may be more efficient to avoid calling the press/hold/release method if one isn't provided.</p>
<p class="last">You may also want to consider removing events, such as <em>hold</em>, if you aren't using them in your project.</p>
</div>
<p>When transitioning our <tt class="docutils literal">State</tt> class to our generic event dispatcher, we lost the ability to track both buttons.</p>
<p>The utility of using a class for our dispatcher code starts to really shine as we use more buttons - all we need to do is create a <tt class="docutils literal">ButtonDispatch</tt> instance for each button.</p>
<p>We'll just need to write a duplicate of <tt class="docutils literal">value()</tt> that returns the value for the correct button, and duplicate the handlers so we can do something different for each button.</p>
<p>We can put our <tt class="docutils literal">ButtonDispatch</tt> objects into a list to make them easier to work with.</p>
<p>Here's what the code looks like (the <tt class="docutils literal">ButtonDispatch</tt> class doesn't change):</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -- snip --</span>

<span class="k">def</span> <span class="nf">value_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press_a</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release_a</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold_a</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button A held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value_b</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press_b</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button B pressed!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release_b</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button B released!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold_b</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button B held for "</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_a</span><span class="p">,</span> <span class="n">press_a</span><span class="p">,</span> <span class="n">release_a</span><span class="p">,</span> <span class="n">hold_a</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_b</span><span class="p">,</span> <span class="n">press_b</span><span class="p">,</span> <span class="n">release_b</span><span class="p">,</span> <span class="n">hold_b</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-02.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-02.mp4">link to the video</a> instead.</p>
</video>
</div><p>As you can see, things can get a little complex though when dealing with multiple actions for multiple events. We just have two buttons here, imagine if we had 10! That would be 30 event handlers!</p>
<p>There are a couple of strategies we can take.</p>
<p>First, it may not even be a real concern. Most of the time, we won't need handlers for every event for every button. Second, the buttons and the functionality they invoke will be separated.</p>
<p>In practice, most code will look more like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ... snip ...</span>

<span class="k">def</span> <span class="nf">value_a</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value_b</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">say_hey</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"HEYDIE HEYDIE HEYDIE HEY"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">say_ho</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"HIDIE HIDIE HIDIE HO"</span><span class="p">)</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_a</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">say_hey</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">value_b</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">say_ho</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-03.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-03.mp4">link to the video</a> instead.</p>
</video>
</div><p>But in the event that we really need to handle many buttons in an efficient way (imagine building a 101 key keyboard), we can consolidate handlers such that a single function can handle the same event for many buttons. We just need to differentiate between buttons when the handler is dispatched.</p>
<p>To address that, we can add a <em>token</em> to the <tt class="docutils literal">ButtonDispatch</tt> class that each instance stores, identifying which button caused an event. The token gets passed to the event functions. Since the token indicates which button was pressed, the event function can take different action depending on which button invoked it.</p>
<p>Here's what that looks like:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button {}|Check: {}, State: {} Checkin: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button {} pressed!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button {} released!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"HEYDIE HEYDIE HEYDIE HEY"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"HIDIE HIDIE HIDIE HO"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button {} held for {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>This code hasn't changed much from the last version. Here are the changes that were made to allow the same handlers to be used for multiple buttons:</p>
<ul class="simple">
<li>The <tt class="docutils literal">ButtonDispatch</tt> constructor (<strong>Line 11</strong>) now has <em>two</em> required arguments, <tt class="docutils literal">token</tt> and <tt class="docutils literal">check</tt>. <tt class="docutils literal">token</tt> is used to differentiate between different buttons. We've used a string here, but it really could be anything, as long as the event handler functions understand it. The token is stored as an instance attribute on <strong>line 13</strong>.</li>
<li>The token (<tt class="docutils literal">self.token</tt>) is passed to the event handlers and <tt class="docutils literal">check</tt> function (<strong>lines 31, 38, 44 and 52</strong>).</li>
<li>The handlers and check function defined on <strong>lines 76-92</strong> all take <tt class="docutils literal">token</tt> as their first argument.</li>
<li>In the case of <tt class="docutils literal">value()</tt> (<strong>line 76</strong>), the <tt class="docutils literal">token</tt> is just passed along to the <tt class="docutils literal">check()</tt> function from our <tt class="docutils literal">setup</tt> abstraction module.</li>
<li>The handlers all print out the <tt class="docutils literal">token</tt> (<strong>lines 80, 83 and 92</strong>).</li>
<li>The <tt class="docutils literal">release()</tt> handler actually has some logic in it so that it behaves differently depending on the value of <tt class="docutils literal">token</tt> (or which button was pressed), additionally printing a different message.</li>
<li>Finally, you can see how the <tt class="docutils literal">token</tt> is passed when the  <tt class="docutils literal">ButtonDispatch</tt> objects are instantiated on <strong>lines 95 and 96</strong>.</li>
</ul>
</div>
<p>Here's a video of this code running, again on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-04.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-04.mp4">link to the video</a> instead.</p>
</video>
</div><p>The primary difference here is just the addition of the <tt class="docutils literal">token</tt> property, and the added requirement that it is now a parameter of each event handler function.</p>
<p>Now using only three event functions, we can handle events for many, many buttons. Each event will produce a different effect depending on which button triggered it (in this case different messages will be printed to the console).</p>
<p>The token has also been passed to the <tt class="docutils literal">check()</tt> function, so that has been centralized as well.</p>
<p>This is a common pattern in programming, a form of <a class="reference external" href="https://en.wikipedia.org/wiki/Message_passing">message passing</a>.</p>
<p>You may also have noticed that you can press both buttons <em>simultaneously</em>. The events are not actually firing at the same time, however, they are firing one after the other. It just happens so quickly that they appear to be simultaneous.</p>
<p>This is a great accomplishment, and will work well for even quite complex projects. However, we have painted ourselves into a corner of sorts. We can fire two different events when buttons are pressed at the same time, but we can't see the state of one button from the event of the others. This becomes problematic if we want one button to affect the actions of another.</p>
<p>You may have run into an application of this problem: holding down one button makes the meaning of another button change. Here's an example from an old digital alarm clock:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/blink-controller-alarm-clock-example.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/blink-controller-alarm-clock-example.mp4">link to the video</a> instead.</p>
</video>
</div><p>So we have the "mode" of one button changing because another button was held down.</p>
<p>This is again something that can (and should) be handled in different ways, depending on the situation.</p>
<p>The simplest way to deal with this is to use the <tt class="docutils literal">state</tt> and <tt class="docutils literal">holding</tt> properties of each <tt class="docutils literal">ButtonDispatch</tt> object. If the first button's <tt class="docutils literal">state</tt> is <tt class="docutils literal">True</tt>, and the second button's <tt class="docutils literal">holding</tt> property is also <tt class="docutils literal">True</tt>, then we have a alarm clock-setting style event occurring.</p>
<p>To make it work, we just have to track our own checkin time to further debounce the simultaneous press events:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ... snip ...</span>

<span class="err">﻿</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Both buttons pressed!"</span><span class="p">)</span>
            <span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>Here, we're tracking some external state values in global variables so we don't have to modify the <tt class="docutils literal">ButtonDispatch</tt> class to get what we want.</p>
<p><strong>Line 10</strong> looks at the state of both buttons - if they're both pressed (the <tt class="docutils literal">state</tt> attribute is <tt class="docutils literal">True</tt>), then both buttons must have been pressed and debounced.</p>
<p>We have to do a further debounce (<strong>line 11</strong>) because they may have not been pressed together - if they are pressed slightly out of sync, we can get a false reading as one button is being released, and the other is being pressed.</p>
<p>On <strong>lines 14 and 15</strong> we set the state of both buttons to <tt class="docutils literal">False</tt>. This ensures that the press or hold events won't be fired again now that we've handled them on our buttons' behalf.</p>
</div>
<p>This will cover most use cases. As mentioned before, complex button pressing scenarios are not common - they are necessary sometimes when there are a limited number of buttons, or the greater functionality of the project is rather complex (playing chords on a musical instrument for example).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This code prevents the <em>release</em> events from firing, and doesn't cover the <em>both buttons released</em> event. Handling this would require some refactoring and additional logic. It was left out of this example for the sake of simplicity - the technique covered next is the best way to handle anything more complex than a simple <em>both buttons pressed</em> sort of event as illustrated above.</p>
</div>
<p>When this extra complexity is necessary, it's best to separate the state of each button into a central state object, like we did earlier. We can either access that global object directly in our handlers, or pass it as an additional argument to them.</p>
<p>This will allow for more complex behaviors, like holding one button and pressing the other.</p>
</div>
<div class="section" id="a-quick-note-about-getters-and-setters">
<h3>A Quick Note About Getters and Setters</h3>
<p>The code below introduces the concept from object-oriented programming called <em>getters</em> and <em>setters</em>.</p>
<p>The basic idea is that, instead of accessing a property of an object directly, you set up a method to retrieve the value (<em>get</em> it), and to store the value (<em>set</em> it).</p>
<p>In Python, its usually not necessary, unless you want to provide a convenient way of getting/setting a value that may be a little complex otherwise.</p>
<p>Here's a simple example, that illustrates the syntax used to do this in Python:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as state.py</span>
<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># private attribute used to store the actual</span>
        <span class="c1"># integer value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># getter - returns a string based on the integer stored</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Sunday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Monday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Tuesday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Wednesday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Thursday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Friday"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"Saturday"</span>

        <span class="k">return</span> <span class="s2">"Unknown"</span>

    <span class="c1"># setter - takes a string and stores an integer</span>
    <span class="nd">@day_of_week.setter</span>
    <span class="k">def</span> <span class="nf">day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"sunday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"monday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"tuesday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"wedsnday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"thursday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"friday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"saturday"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_day_of_week</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No idea what day '{}' is"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>Most of the basics of making a class have been well explained in other examples. However, this example introduces some new concepts:</p>
<p><em>Line 6</em> establishes a "private" instance attribute called <tt class="docutils literal">_day_of_week</tt> - this is the attribute where the "real" value representing the day of the week is stored, as an <em>integer</em>. The name is intentionally the same as the getter/setter code below it, so you know that those methods are proxies for this value.</p>
<p>On <em>line 9</em>, we use the <tt class="docutils literal">@property</tt> decorator to transform the method defined below it (<tt class="docutils literal">day_of_week()</tt>) into a special kind of object. From the instances' perspective, <tt class="docutils literal">day_of_week</tt> will be an instance attribute just like any other - but when you access it (<tt class="docutils literal">self.day_of_week</tt>, or <tt class="docutils literal">state.day_of_week</tt>), it transparently invokes the <tt class="docutils literal">day_of_week()</tt> <em>method</em>.</p>
<p><tt class="docutils literal">@property</tt> allows us to create dynamic instance attributes. It's especially useful in situations like this where we want to present an API that looks like a "regular" instance, but does more behind the scenes.</p>
<p>After the definition of <tt class="docutils literal">day_of_week()</tt> on <strong>line 32</strong>, its passed to the <tt class="docutils literal">@property</tt> decorator and obtains new attributes. We use one of them <tt class="docutils literal">setter</tt> as a second decorator to indicate our next method, also called <tt class="docutils literal">day_of_week()</tt>, will be called when you assign a value to the <tt class="docutils literal">day_of_week</tt> attribute.</p>
<p>It may seem a little weird that we're naming the two methods the same. First, we want to make it clear to anyone reading the code that these two methods are related, and that together they define the <tt class="docutils literal">day_of_week</tt> attribute. We can give them the same name because technically, we're not defining two instance methods in the <tt class="docutils literal">State</tt> class. In reality, we're defining a <tt class="docutils literal">@property</tt> object, assigning it to the <tt class="docutils literal">day_of_week</tt> name, and then creating two <em>functions</em> that it will use to handle setting and getting of tat <tt class="docutils literal">day_of_week</tt> attribute for the instance.</p>
<p>The final thing that is worth pointing out is the error handling on <strong>lines 32 and 52</strong>.</p>
<p>The <tt class="docutils literal">day_of_week()</tt> getter looks at the value of <tt class="docutils literal">self._day_of_week</tt>, and returns a string corresponding to the English weekday of the stored value. If the value doesn't correspond to any expected numbers, the word <tt class="docutils literal">Unknown</tt> is returned instead, on <strong>line 32</strong>.</p>
<p>The <tt class="docutils literal">day_of_week()</tt> setter takes the <tt class="docutils literal">value</tt> argument and based on its content, sets the <tt class="docutils literal">self._day_of_week</tt> attribute to a corresponding number.</p>
<p>If the content of <tt class="docutils literal">value</tt> doesn't match any of the known English days of the week, the setter throws a <tt class="docutils literal">ValueError</tt> (<strong>line 52</strong>). When this happens the user will get an exception, and will see the message <tt class="docutils literal">No idea what day 'XXX' is</tt> (replacing <tt class="docutils literal">XXX</tt> with whatever the user passed in).</p>
<p>This is an advantage of using getters and setters in Python - you can do data <em>marshalling</em> where you translate a value from one kind to another (like the getter does), set <em>sane defaults</em> (like returning <tt class="docutils literal">Unknown</tt> when the day of the week is wrong in the getter) and you can do <em>validation</em> so that the user can't store bad data (like throwing the exception in the setter).</p>
</div>
<p>Here's how you'd work with it in the console:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="go">'Sunday'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">=</span> <span class="s2">"Friday"</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">_day_of_week</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="go">'Friday'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">=</span> <span class="s2">"Munundununceday"</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">"state.py"</span>, line <span class="m">47</span>, in <span class="n">day_of_week</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No idea what day '{}' is"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="gr">ValueError</span>: <span class="n">No idea what day 'Munundununceday' is</span>
</pre></div>
</td></tr></table></div><p>So internally, we're storing the day of the week as an integer, but when you access <tt class="docutils literal">day_of_week</tt>, it returns a string. If we want to set the day of the week, we provide a string and it is translated into a integer for internal storage. We are able to add some error handling in the setter, that we wouldn't be able to do easily if we weren't using one.</p>
</div>
<div class="section" id="dispatch-using-a-global-state-object">
<h3>Dispatch Using A Global State Object</h3>
<p>Now that we understand how getters and setters work, we can use them to provide a simple way of accessing the external global state:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># global state object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s2">"{}-holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)]</span>

    <span class="nd">@holding.setter</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s2">"{}-holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">]</span>

    <span class="nd">@state.setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button {}|Check: {}, State: {} Checkin: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Button {} held for {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">multi_press</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">"A"</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A-holding'</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"A is holding while {} was pressed!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'B'</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Both buttons are being pressed"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multi_release</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">"A"</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A-holding'</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"A is holding and {} has been released"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">'A'</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">'B'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Both buttons released"</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"A"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"B"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"A-holding"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"B-holding"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"both"</span><span class="p">:</span> <span class="bp">False</span>
<span class="p">}</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">multi_press</span><span class="p">,</span> <span class="n">multi_release</span><span class="p">,</span> <span class="n">hold</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">multi_press</span><span class="p">,</span> <span class="n">multi_release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>On <strong>line 9</strong>, we are now requiring an argument called <tt class="docutils literal">state</tt>. This is assumed to be a dictionary. It can contain anything you'd like, and the <tt class="docutils literal">ButtonDispatch</tt> class with add in its own keys for the state and holding status of its button. The key holding the state of the button will simply be named whatever was passed for <tt class="docutils literal">token</tt>. The holding status will be stored in a string, combining the <tt class="docutils literal">token</tt> with <tt class="docutils literal"><span class="pre">-holding</span></tt>.</p>
<p>The <tt class="docutils literal">state</tt> argument is stored in an instance variable called <tt class="docutils literal">_state</tt> on <strong>line 11</strong>.</p>
<p><strong>Lines 28-42</strong> contain the most drastic changes of this iteration. Here we use the <tt class="docutils literal">@property</tt> decorator so that any manipulation of <tt class="docutils literal">self.holding</tt>, or <tt class="docutils literal">self.state</tt> actually alters the global state object passed to the constructor.</p>
<p>All of the dispatch methods (<tt class="docutils literal">release()</tt>, <tt class="docutils literal">check()</tt>, <tt class="docutils literal">hold()</tt> and <tt class="docutils literal">press()</tt>, <strong>lines 54-71</strong>) now pass two arguments to the event handlers (or three in the case of <tt class="docutils literal">hold()</tt>) - the token and the global state object (<tt class="docutils literal">hold()</tt> also passes the number of times the event has occurred).</p>
<p>Notice how none of the other code had to change. The interface, all of the attribute and method names, have remained the same and function exactly like they did before.</p>
<p>The event handlers on <strong>lines 93-113</strong> now take the global state object. The new <tt class="docutils literal">multi_press()</tt> and <tt class="docutils literal">multi_release()</tt> functions use the global state to add new multi-button functionality.</p>
<p><tt class="docutils literal">multi_press()</tt> prints <tt class="docutils literal">"A is holding while B was pressed!"</tt> if the <tt class="docutils literal">token</tt> is not "A" (so, it's "B"), and the holding indicator stored in <tt class="docutils literal"><span class="pre">state["A-holding"]</span></tt> is <tt class="docutils literal">True</tt>.</p>
<p>If both buttons are pressed (<tt class="docutils literal"><span class="pre">state['A']</span></tt> and <tt class="docutils literal"><span class="pre">state['B']</span></tt> are <tt class="docutils literal">True</tt>), <tt class="docutils literal">multi_press()</tt> sets the <tt class="docutils literal"><span class="pre">state['both']</span></tt> variable to <tt class="docutils literal">True</tt>, indicating to other handlers that both buttons are pressed. It then takes action, printing <tt class="docutils literal">""Both buttons are being pressed"</tt> to the console.</p>
<p><tt class="docutils literal">multi_release()</tt> prints <tt class="docutils literal">"A is holding and B has been released"</tt> if the button that triggered the event is <em>not</em> the "A" button (<tt class="docutils literal">token</tt>), the "A" button is currently being held (<tt class="docutils literal"><span class="pre">state['A-holding']</span></tt>), and both buttons haven't been pressed (<tt class="docutils literal"><span class="pre">state['both']</span></tt> is <tt class="docutils literal">False</tt>).</p>
<p>If both buttons have been released, indicated by <tt class="docutils literal"><span class="pre">state['both']</span></tt> being <tt class="docutils literal">True</tt>, and the state of each button being <tt class="docutils literal">False</tt> (<tt class="docutils literal"><span class="pre">state['A']</span></tt> and <tt class="docutils literal"><span class="pre">state['B']</span></tt>), <tt class="docutils literal">multi_release()</tt> prints <tt class="docutils literal">"Both buttons released"</tt> to the console and sets <tt class="docutils literal"><span class="pre">state['both']</span></tt> to <tt class="docutils literal">False</tt>.</p>
<p>Finally, we see the <tt class="docutils literal">state</tt> object, implemented here as a dictionary, with the default values, defined on <strong>lines 115-121</strong>.</p>
</div>
<p>A few key differences to note:</p>
<ul class="simple">
<li>We are again using a global <tt class="docutils literal">state</tt> object, in this case a dictionary instead of a class for illustration purposes. While the state tracked in <tt class="docutils literal">ButtonDispatch</tt> is sufficient for almost all of the state we need for this example, in most applications, tracking would be necessary anyway. Having the button state outside of the <tt class="docutils literal">ButtonDispatch</tt> class also separates the button state tracking from the event detection and handling, but sharing the variable means we can keep all state in one place.</li>
<li>As mentioned earler, we're taking advantage of Python's <em>getters</em> and <em>setters</em> functionality so that when you change the <tt class="docutils literal">ButtonDispatch</tt> object's state, it's actually changing our <tt class="docutils literal">state</tt> dictionary. This is an example of the <a class="reference external" href="https://en.wikipedia.org/wiki/Proxy_pattern">Proxy Pattern</a> in action.</li>
<li>We've taken advantage of our new <tt class="docutils literal">state</tt> dictionary to track whether or not both buttons are pressed (the <tt class="docutils literal">both</tt> key). This acts as a <em>guard</em> so that we can differentiate between events.</li>
<li>We've been able to handle some very complex situations in a very simple way - we cover the <em>both buttons pressed</em>, <em>both buttons released</em>, <em>b button pressed while a button is held</em> and <em>b button released while a button is held</em> events without a lot of code.</li>
</ul>
<p>Here's a video of this code running on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-05.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/dispatcher-demo-trinket-05.mp4">link to the video</a> instead.</p>
</video>
</div><p>There are many different ways of manipulating global (in the sense of application-wide) state, but this way is the least hard-coded - we take advantage of the fact that Python passes objects <em>by reference</em>, and pass the state object around, as opposed to relying on a global (in the sense of variable scope) object.</p>
<p>When something is <em>passed by reference</em>, it means that the original object isn't copied when it's passed to a function or assigned to another variable. This is more efficient, since only one copy of the object is used in many parts of the code. The side effect of this is that changes to the object, even when it's in a different scope, called by a different name, will affect the original object.</p>
<p>We take advantage of that so that our <tt class="docutils literal">ButtonDispatch</tt> class uses the passed-in <tt class="docutils literal">state</tt> dictionary to store its internal state. This effectively <em>externalizes</em> the state, and separates our concerns nicely.</p>
</div>
</div>
<div class="section" id="example-application-blink-controller">
<h2 id="example-application-blink-controller">Example Application: Blink Controller</h2>
<p>Now that we've established a pattern for working with state, and have a generic event dispatch class for button presses, we can build a more realistic application.</p>
<p>This will illustrate how to use the <tt class="docutils literal">ButtonDispatch</tt> class with your own variation of the <tt class="docutils literal">State</tt> class to construct a project complex functionality with pretty simplistic code.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">An even more elaborate application can be explored in my <a class="reference external" href="/drafts/touchmouse.html">touch mouse project</a> 🐭 !</p>
</div>
<p>We'll use the state object for more than just tracking button state. We'll also use it to handle general on/off, as well regular flashing of two LEDs: the built-in red LED on pin 13, and the onboard RGB NeoPixel or DotStar. We'll also track the color of the NeoPixel/DotStar.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This is the culmination of all the test and example code we've been using throughout this article. 🦄</p>
</div>
<div class="section" id="phase-1">
<h3>Phase 1</h3>
<p>For a first pass, lets just control the red LED on pin 13. When the board boots, the LED will blink at a slow rate. If you press button A, the blink rate will increase. There will be 5 blink rates, and when you reach the fastest rate, pressing the A button again will reset back to the slowest one.</p>
<p>The B button will enable/disable the LED, but won't affect the blink rate.</p>
<p>In our new <tt class="docutils literal">State</tt> class, we'll be tracking the status of the LED, its current blink rate, whether the LED should be on or off (enabled), and the last time we flashed it.</p>
<p>We'll be using the same technique to flash the LED that we use to debounce the buttons - stash the current value <tt class="docutils literal">time.monotonic()</tt> in a variable, and every cycle compare that variable to the latest value. When enough time has elapsed, toggle the LED on or off, and update the variable.</p>
<p>We'll continue using the <tt class="docutils literal">__call__()</tt> method to handle updating the state, but this time we'll be deciding whether the LED should be on or off based on the <tt class="docutils literal">enabled</tt> attribute and the flashing logic outlined above.</p>
<p>We're going to make a slight change to the <tt class="docutils literal">ButtonDispatcher</tt> class, to accommodate the fact that our state object is no longer a dictionary. We have to use the <tt class="docutils literal">getattr()</tt> and <tt class="docutils literal">setattr()</tt> functions to alter the state object. These functions let you access arbitrary attributes (properties) on an object, so we can use the <tt class="docutils literal">token</tt> property to dynamically alter the state object.</p>
<p>We also changed from calling the button state slots "A-holding" and "B-holding" to "A_holding" and "B_holding", since dashes are not valid in attribute names in Python.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flash</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_flash</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">flash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># global state object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">"{}_holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>

    <span class="nd">@holding.setter</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">"{}_holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

    <span class="nd">@state.setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button {}|Check: {}, State: {} Checkin: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">flash</span> <span class="o">-=</span> <span class="mf">0.4</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">flash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">flash</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"Flash: "</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">flash</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="n">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span>
        <span class="err">﻿</span><span class="k">print</span><span class="p">(</span><span class="s2">"Enabled? "</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>

    <span class="n">state</span><span class="p">()</span>

    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>On <strong>lines 4-25</strong>, we have our <em>fully encapsulated</em> state class. This is very similar to what we've used in previous sections, except that it's tracking different things.</p>
<p>Note the state attributes (<strong>lines 6-13</strong>):
* <tt class="docutils literal">A</tt> and <tt class="docutils literal">B</tt> are the state of each button. These names come from the <tt class="docutils literal">token</tt> that gets passed to the <tt class="docutils literal">ButtonDispatch</tt> constructor.
* <tt class="docutils literal">A_holding</tt> and <tt class="docutils literal">B_holding</tt> track whether the buttons are being held down. These names are also generated based on the <tt class="docutils literal">token</tt> passed to the <tt class="docutils literal">ButtonDispatch</tt> constructor. Note that these differ from the key names we used for the same purpose in the last example (<tt class="docutils literal"><span class="pre">A-holding</span></tt> and <tt class="docutils literal"><span class="pre">B-holding</span></tt>). We've replaced the dash (<tt class="docutils literal">-</tt>) with an underscore (<tt class="docutils literal">_</tt>) because dashes are not valid in variable names.
* <tt class="docutils literal">led</tt> tracks the state of the red LED on pin 13.
* <tt class="docutils literal">flash</tt> tracks the blinking rate of the red LED, in seconds. This is a <em>delay</em>, so larger numbers mean a slower blink/flash rate.
* <tt class="docutils literal">last_flash</tt> is our clock check-in attribute specifically for the flashing of the LED. This attribute is used in consort with <tt class="docutils literal">flash</tt> to blink the LED at the set rate.
* Finally, <tt class="docutils literal">enabled</tt> tracks whether the LED should be blinking or not. It acts like an on/off switch, but it doesn't interrupt the flashing sequence - this is necessary because blinking the LED is really just turning it on and off - we need to be able to separately track turning the <em>whole sequence</em> on and off.</p>
<p>In <tt class="docutils literal">__call__()</tt> (<strong>lines 15-25</strong>), we handle all of the logic necessary to blink the LED.</p>
<p><strong>Lines 16-18</strong> handle the on/off state of the whole sequence. If <tt class="docutils literal">enabled</tt> is <tt class="docutils literal">False</tt>, the method sets the <tt class="docutils literal">led</tt> state to <tt class="docutils literal">False</tt> and then <em>short circuits</em> - by calling <tt class="docutils literal">return</tt> on <strong>line 18</strong>, the method immediately exits.</p>
<p>Blinking is handled by <strong>lines 20-25</strong>. The logic is nearly identical to the button debouncing logic we've used before (and in fact, you will typically see similar blocking code to our original blocking debounce using <tt class="docutils literal">time.sleep()</tt> in "getting started" projects that blink an LED). We check if enough time has passed. If it has, we toggle the LED: we use the <tt class="docutils literal">not</tt> operator to negate the current state of the LED on <strong>line 22</strong>. We then reset by updating <tt class="docutils literal">last_flash</tt> to the current value of <tt class="docutils literal">time.monotonic()</tt>.</p>
<p><tt class="docutils literal">ButtonDispatch</tt>, defined on <strong>lines 27-113</strong> has not changed from the last example, except to handle a class instance (object) instead of a dictionary. These changes happen on <strong>lines 52, 56, 60, and 64</strong>. We make use of the built-in Python functions <tt class="docutils literal">getattr()</tt> and <tt class="docutils literal">setattr()</tt>. These functions allow us to access (<tt class="docutils literal">getattr()</tt>) and store (<tt class="docutils literal">setattr()</tt>) values on a class instance using a <em>string</em>. This allows us to create dynamic attributes, as we're doing here. We construct the attribute where we store the button state or holding status based on the <tt class="docutils literal">token</tt> attribute of the <tt class="docutils literal">ButtonDispatch</tt> instance.</p>
<p>We have a generic <em>release</em> event handler, and a helper function that manipulates the state defined on <strong>lines 120-132</strong>.</p>
<p><tt class="docutils literal">increase_flash()</tt> looks at the state object and cycles through the various blink rates available. We've decided to flash between 2 and 0.4 seconds, in 0.4 second intervals - that equates to 5 distinct flashing rates.</p>
<p>Every time <tt class="docutils literal">increase_flash()</tt> is called, it decreases the <tt class="docutils literal">state.flash</tt> value by 0.4 seconds. If this value drops below 0, the function resets it back to the default, 2 seconds.</p>
<p>On <strong>line 125</strong>, we print the current value of the <tt class="docutils literal">flash</tt> state attribute so we can see what's going on.</p>
<p>We define our <em>release</em> event handler on <strong>lines 127-132</strong>. If the "A" button triggered the event, we call <tt class="docutils literal">increase_flash()</tt>. If the "B" button triggered the event, we turn on or off the blinking by toggling <tt class="docutils literal">state.endabled</tt>. Printing the current value of <tt class="docutils literal">state.enabled</tt> on <strong>line 132</strong> helps us ensure something is happening. This is especially important with the enable/disable feature, since the LED blinking looks a lot like turning it on and off (well, because that's what blinking is 🤔 ). By printing to the console, we can be sure our event is firing and the state is changing the way we intend.</p>
<p>Finally, <strong>Lines 135 and 136</strong> are worth noting because they show one way to bypass setting a certain event handler, by passing <tt class="docutils literal">None</tt> for the <tt class="docutils literal">press</tt> argument. Another way to do this would be with <em>keyword arguments</em>.</p>
<p>Throughout this tutorial, we've been using <em>positional</em> arguments. We specify just the values when we call a function/method, and we <em>must</em> put them in the correct order.</p>
<p>Keyword arguments specify the name of the argument from the function/method definition, followed by an equals sign, and the value you want to set. By using them, you can skip optional arguments, and the order isn't important.</p>
<p>You can mix the two, you just need to be sure to put the positional arguments <em>before</em> any keyword arguments.</p>
<p>Here's a couple of other ways we could have instantiated the <tt class="docutils literal">ButtonDispatch</tt> class for the "A" button:</p>
<div class="highlight"><pre><span></span><span class="c1"># using nothing but keyword arguments</span>
<span class="n">ButtonDispatch</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="n">release</span><span class="p">)</span>

<span class="c1"># using a mixture - keyword arguments must come *after* positional ones</span>
<span class="c1"># note how the order of keyword arguments doesn't matter.</span>
<span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="n">release</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>Here's the code in action on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-01.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-01.mp4">link to the video</a> instead.</p>
</video>
</div></div>
<div class="section" id="phase-2">
<h3>Phase 2</h3>
<p>Now, lets add in the RGB LED and some more complex behavior.</p>
<p>First, lets move our <tt class="docutils literal">ButtonDispatch</tt> code into its own module. We'll do this for three reasons.</p>
<ol class="arabic simple">
<li>It will make the code examples shorter.</li>
<li>This code is stable so we shouldn't have to mess with it.</li>
<li>We may run into memory issues and the easiest way to save some memory is to <a class="reference internal" href="#compile-modules-into-mpy-files">compile this complex code into an MPY file</a>.</li>
</ol>
<p>We should get in the habit of doing this when we have well defined code, this is a great place to start.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Just bear in mind that if you do compile <tt class="docutils literal">dispatch.py</tt> into an <tt class="docutils literal">.mpy</tt> file, you won't be able to edit it directly (you'll have to edit it outside of your board, compile it, and copy it over again), so only do this when the code is <em>rock solid</em> and you need the extra memory.</p>
</div>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as dispatch.py</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">ButtonDispatch</span><span class="p">:</span>
    <span class="n">_debounce</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_hold_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># global state object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># get the state of the button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">check</span>

        <span class="c1"># event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="o">=</span> <span class="n">press</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="o">=</span> <span class="n">hold</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">"{}_holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>

    <span class="nd">@holding.setter</span>
    <span class="k">def</span> <span class="nf">holding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">"{}_holding"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

    <span class="nd">@state.setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onrelease</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onhold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onpress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># button has been held</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>

        <span class="c1"># button has been pressed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debounce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">press</span><span class="p">()</span>

        <span class="c1"># button has been released</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s2">"&lt;Button {}|Check: {}, State: {} Checkin: {}&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>For this phase, we'll just work in the state and activation logic for the RGB LED, and flash it right along with the red one on pin 13:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dispatch</span> <span class="kn">import</span> <span class="n">ButtonDispatch</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">"led"</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">"rgb"</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">-=</span> <span class="mf">0.4</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">-=</span> <span class="mf">0.4</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"LED Flash:"</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span><span class="p">,</span> <span class="s2">"RGB Flash:"</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span><span class="p">:</span>
        <span class="n">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">"rgb"</span><span class="p">)</span>
        <span class="n">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">"led"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Enabled? "</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span>


<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
<span class="p">]</span>


<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>

    <span class="n">state</span><span class="p">()</span>

    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>The logic here is identical as the last example, except we've duplicated the state attributes and on/off logic for the RGB led, and had to rename some things to differentiate between the two (<tt class="docutils literal">flash</tt> has become <tt class="docutils literal">led_flash</tt> and <tt class="docutils literal">rgb_flash</tt>).</p>
<p>We've added <tt class="docutils literal">rgb_color</tt> to the <tt class="docutils literal">State</tt> class to track the color of the RGB led. This isn't used just yet, but will come in handy in the future.</p>
</div>
<p>A few noteworthy changes:</p>
<ul class="simple">
<li>We've added different state for both the RGB and red LED. This isn't necessary at this point. We're adding it in now in preparation for when we're controlling the blink rate of each LED independently.</li>
<li>We're tracking the desired color of the RGB LED in our <tt class="docutils literal">State</tt> class - this is not necessary at this point either, but this new state attribute will be used when we add color-changing functionality.</li>
<li>We've altered <tt class="docutils literal">increase_flash()</tt> to work for both LEDs by adding a new parameter, <tt class="docutils literal">which</tt> - a string indicating which LED you want to adjust the flashing rate for.</li>
<li>The standard red LED has two states, <em>on</em> and <em>off</em>. However, the DotStar/NeoPixel is actually 3 states, times the number of pixels: one each for Red, Green, and Blue. To turn it off, we can't just set it to <tt class="docutils literal">False</tt>, we instead have to write a "black" color - zero red, zero green, and zero blue.</li>
</ul>
<p>Here's what that looks like running on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-02.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-02.mp4">link to the video</a> instead.</p>
</video>
</div></div>
<div class="section" id="phase-3">
<h3>Phase 3</h3>
<p>Next, we'll add in multiple-button logic similar to what we did previously and add a new feature to rotate through a set of predetermined colors when both buttons are pressed.</p>
<p>We'll make use of the <a class="reference external" href="https://learn.adafruit.com/fancyled-library-for-circuitpython/overview">FancyLED library</a> to gamma-correct the RGB LED so the colors look nicer.</p>
<p>We'll also the brightness level, since we need it for the gamma-correction calculation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure you've copied the <tt class="docutils literal">adafruit_fancyled</tt> library folder over to your <tt class="docutils literal">CIRCUITPY</tt> drive. Place it in the <tt class="docutils literal">lib</tt> folder.</p>
</div>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dispatch</span> <span class="kn">import</span> <span class="n">ButtonDispatch</span>

<span class="kn">import</span> <span class="nn">adafruit_fancyled.adafruit_fancyled</span> <span class="kn">as</span> <span class="nn">fancy</span>

<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">colors</span> <span class="o">=</span>   <span class="p">((</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># red</span>
            <span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>    <span class="c1"># orange-red</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># orange</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># yellow</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># green</span>
            <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>   <span class="c1"># blue-green</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>      <span class="c1"># blue</span>
            <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">130</span><span class="p">),</span>     <span class="c1"># indigo</span>
            <span class="p">(</span><span class="mi">139</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>    <span class="c1"># violet</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>  <span class="c1"># white</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_holding</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">both</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_color_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_color</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">cycle_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_color_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_color_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_color_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_color_index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_flash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_led_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_rgb_flash</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">"led"</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">"rgb"</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">-=</span> <span class="mf">0.4</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">-=</span> <span class="mf">0.4</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"LED Flash:"</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">led_flash</span><span class="p">,</span> <span class="s2">"RGB Flash:"</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_flash</span><span class="p">)</span>

<span class="err">﻿</span><span class="k">def</span> <span class="nf">hold</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">hold_count</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">"held. Count:"</span><span class="p">,</span> <span class="n">hold_count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">press</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">A</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">both</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Both buttons are being pressed"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">both</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">"button being pressed"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">both</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"A"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">A_holding</span><span class="p">:</span>
            <span class="n">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">"led"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Enabled? "</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">"B"</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">A_holding</span><span class="p">:</span>
            <span class="n">increase_flash</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">"rgb"</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">both</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">),</span>
    <span class="n">ButtonDispatch</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dispatch</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">dispatch</span><span class="p">()</span>

    <span class="n">state</span><span class="p">()</span>

    <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">rgb_color</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><div class="explanation section">
<h4>Explanation</h4>
<div class="docutils container">
</div>
<p>We have a few new state attributes to deal with our new functionality.</p>
<p>On <strong>line 26</strong>, we've introduced the state attribute <tt class="docutils literal">both</tt>, used to indicate when we've detected that both buttons have been pressed.</p>
<p>On <strong>line 7</strong>, we've set the <tt class="docutils literal">brightness</tt> attribute on the NeoPixel/DotStar object from our <tt class="docutils literal">setup</tt> module to <tt class="docutils literal">1.0</tt>. These pixels are <em>bright</em>, so we normally won't use them at full brightness. However, setting the brightness to "full blast" here is necessary for getting the best results from the FancyLED library.</p>
<p>Note that this value must be a <em>float</em> - you will get somewhat odd errors if you set it to an integer (so be sure to set it to <tt class="docutils literal">1.0</tt> not <tt class="docutils literal">1</tt>).</p>
<p>We define our list of possible colors as a "tuple of tuples" on <strong>lines 9-18</strong>. Tuples work just like lists, except they are <em>immutable</em> - you can't change them once they're defined. This is perfect for our list of colors, since we have no need to change it.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The colors were chosen by searching for "RGB rainbow" and grabbing a few triplets that looked good. The exact colors could use some adjustment. If you try this code on different boards, you'll notice some variation between pixels, especially between DotStars and NeoPixels - this is expected. The electronics involved are different, and will produce slightly different wavelengths of light for each of the red, green, and blue elements.</p>
</div>
<p>We've added new state attributes to handle the cycling of colors on <strong>lines 38 and 39</strong>.</p>
<p>Brightness is now being tracked on <strong>line 41</strong>. This value could be defined outside of our <tt class="docutils literal">State</tt> class, since we're not altering it in this project. However, a handy feature you could add would be allowing the user to change the brightness, and that would require keeping in the state object.</p>
<p>We have a new method defined on <strong>lines  45-51</strong>, <tt class="docutils literal">cycle_color()</tt>, that handles changing the state to the next color in the global tuple we defined on <strong>lines 9-18</strong>.</p>
<p><tt class="docutils literal">cycle_color()</tt> keeps track of which color was last used, by <em>index</em> (<tt class="docutils literal">_color_index</tt>). To choose a color, it simply uses that attribute as the index of the <tt class="docutils literal">colors</tt> tuple (<strong>line 51</strong>).</p>
<p><tt class="docutils literal">_color_index</tt> defaults at -1 - this way, when <tt class="docutils literal">cycle_color()</tt> is first called, it will start with the first member of the <tt class="docutils literal">colors</tt> tuple (index 0).</p>
<p>To cycle to the next color, it just increments <tt class="docutils literal">_color_index</tt> (<strong>line 46</strong>). To avoid increasing <tt class="docutils literal">_color_index</tt> to a number higher than the highest index of <tt class="docutils literal">colors</tt>, and to start over at the first color,  <tt class="docutils literal">cycle_color()</tt> uses a little bit of math (<strong>line 48</strong>): after incrementing <tt class="docutils literal">_color_index</tt>, it checks to see if it's higher than the length of the <tt class="docutils literal">colors</tt> tuple <em>minus one</em>. Since tuple indexes start at 0, the highest index number is always the length of the tuple minus one (this is true for lists as well). We can add and remove colors to the <tt class="docutils literal">colors</tt> tuple and <tt class="docutils literal">cycle_color()</tt> will automatically adjust.</p>
<p>In our event handlers (<strong>lines 90-116</strong>), we've added some logic to handle multiple button presses. We've also implemented a handler for the <em>hold</em> event (<tt class="docutils literal">hold()</tt>, <strong>lines 90-91</strong>). This handler mostly serves for debugging purposes. We need to make sure that when we're pressing multiple buttons, the proper events are being triggered. Sometimes a <em>hold</em> might be triggered in error, and we need to see that.</p>
<p>Our <tt class="docutils literal">press()</tt> function is in charge of detecting when we're pressing <em>both</em> buttons. It's only function is to see if <tt class="docutils literal">state.A</tt> and <tt class="docutils literal">state.B</tt> are <tt class="docutils literal">True</tt> (both buttons have been pressed), and change <tt class="docutils literal">state.both</tt> to <tt class="docutils literal">True</tt>. We've added some debugging help by printing to the console if both buttons <em>weren't</em> pressed (<strong>line 98</strong>).</p>
<p><tt class="docutils literal">release()</tt> is where all of the functionality of our LED blinker is really happening - <strong>lines 101-105</strong>, we detect when both buttons have been released. This occurs when <tt class="docutils literal">state.both</tt> is <tt class="docutils literal">True</tt>, and <tt class="docutils literal">state.A</tt> and <tt class="docutils literal">state.B</tt> are both <tt class="docutils literal">False</tt>. So we've had a <em>press</em> event occur where both buttons were pressed, and now, both buttons are no longer pressed.
When this occurs, we clear the <tt class="docutils literal">state.both</tt> attribute by setting it to <tt class="docutils literal">False</tt>.</p>
<p>But before clearing the <tt class="docutils literal">state.both</tt> attribute, <tt class="docutils literal">release()</tt> calls <tt class="docutils literal">state.cycle_color()</tt> (<strong>line 102</strong>) so that the next time the RGB LED is turned on, it will use the next color in the <tt class="docutils literal">colors</tt> tuple.</p>
<p><strong>Lines 107-116</strong> handle the actions that need to be taken when either a single button has been released, or both buttons have been released.</p>
<p>The main logic branch (<strong>line 107</strong>) depends on the value of <tt class="docutils literal">state.both</tt> - if it's <tt class="docutils literal">True</tt> (both buttons have been pressed), then the multi-button logic kicks in. If it's <tt class="docutils literal">False</tt>, then the single-button logic is evaluated.</p>
<p>If both buttons are not being pressed (<tt class="docutils literal">state.both</tt> is <tt class="docutils literal">False</tt>), we first look at the <tt class="docutils literal">token</tt>. If it's "A", we check to be sure "A" isn't also being held down (<tt class="docutils literal">state.A_holding</tt>, <strong>line 108</strong>). If that's the case, we take action, increasing the blink rate of the <em>LED</em>. This means that if you just press "A", it increases the blink rate of the red LED - this is the previous functionality of the "A" button.</p>
<p>If both buttons are not being pressed, and the button that triggered the event is "B" (<tt class="docutils literal">token == "B"</tt>, <strong>line 110</strong>), we toggle the <tt class="docutils literal">enabled</tt> state attribute (this is the also the functionality that just pressing "B" had in the last iteration).</p>
<p>If both buttons <em>are</em> being pressed (<tt class="docutils literal">state.both</tt> is <tt class="docutils literal">True</tt>, handled by the <tt class="docutils literal">else</tt> statement on <strong>line 113</strong>), we then look to see which button has been released (which button triggered the <em>release</em> event). If it was the "B" button, and we're holding the "A" button (the <tt class="docutils literal">token</tt> is "B" and <tt class="docutils literal">state.A_holding</tt> is <tt class="docutils literal">True</tt>, <strong>line 114</strong>), we'll take action, increasing the blink rate of the <em>RGB led</em>. This is new functionality - if you hold down the "A" button, and press "B", it increases the RGB blink rate.</p>
<p>The last thing that <tt class="docutils literal">released()</tt> does in this branch of the logic, is clear the <tt class="docutils literal">state.both</tt> attribute by setting it to <tt class="docutils literal">False</tt>. This prevents any more logic regarding both buttons from happening. We're essentially saying "it's cool, we've handled this particular event, everyone else stand down".</p>
<p>Finally, the other noteworthy change is that we've employed the FancyLED library to gamma-correct the RGB LED color (<strong>line 132</strong>) so it looks nicer, especially at lower brightness levels. To explain this line, lets refactor it into separate statements, using some intermediate, temporary variables:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">fancy_color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">rgb_color</span><span class="p">)</span>
<span class="n">adjusted_fancy_color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy_color</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span>

<span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjusted_fancy_color</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>So first, we convert our <tt class="docutils literal">rgb_color</tt> state attribute, stored as a 3-member tuple of (red, green, blue), into a <tt class="docutils literal">CRGB</tt> object. <tt class="docutils literal">CRGB</tt> is a class that FancyLED uses for its calculations. All operations in the library work on these objects.</p>
<p>The constructor for <tt class="docutils literal">CRGB</tt> takes three arguments: <tt class="docutils literal">red</tt>, <tt class="docutils literal">green</tt>, and <tt class="docutils literal">blue</tt>, in that order. We use a nifty feature of Python called <em>argument unpacking</em> to expand our <tt class="docutils literal">rgb_color</tt> tuple into three separate values, and pass them as the three required arguments that <tt class="docutils literal">CRGB</tt> is expecting. Here's another way to look at it:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">red</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">green</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">rgb_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">blue</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">rfb_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">fancy_color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Once we have a <tt class="docutils literal">CRGB</tt> object (<tt class="docutils literal">fancy_color</tt>), we can do calculations on it. We pass that object to <tt class="docutils literal">fancy.gamma_adjust()</tt>, along with the brightness level we want. <tt class="docutils literal">fancy.gamma_adjust()</tt> returns another <tt class="docutils literal">CRGB</tt> object, which we've named <tt class="docutils literal">adjusted_fancy_color</tt>.</p>
<p>The NeoPixel and DotStar libraries don't understand <tt class="docutils literal">CRGB</tt> objects, so we have to convert them to a form that the libraries can understand before setting our pixel to the adjusted color.</p>
<p>There are a couple ways of accomplishing this. The first is to use the <tt class="docutils literal">red</tt>, <tt class="docutils literal">green</tt>, and <tt class="docutils literal">blue</tt> attributes of the <tt class="docutils literal">adjusted_fancy_color</tt> object to create a tuple:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">adjusted_fancy_color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy_color</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span>

<span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjusted_fancy_color</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">adjusted_fancy_color</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">adjusted_fancy_color</span><span class="o">.</span><span class="n">green</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>The NeoPixel and DotStar libraries can also take an <em>integer</em>, instead of a tuple. <tt class="docutils literal">CRGB</tt> has a <tt class="docutils literal">pack()</tt> method that will return a compatible integer. So we finally take advantage of that method when we set the pixel.</p>
<p>In the example code, we're doing all of these steps in one line. Whether to do it this way, break it up, or vary the approach in the ways we've just explored is entirely up to you - rarely will one way or the other be any more or less efficient. It really comes down to readability, for the most part.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is 100% true in general, and most of the time in CircuitPython projects. But be cautious - every line of code takes up precious memory you may need for your project. Sometimes you may have to make things a little messy to squeeze in a few more bytes so you can get things working.</p>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you are more experienced with Python, you may have thought that the <tt class="docutils literal">cycle_color()</tt> method would be a great usecase for a <em>generator</em>.</p>
<p>Generators are functions/methods that maintain some sort of state. Typically any variables defined inside of a function or method are lost when the it ends (or <tt class="docutils literal">return</tt>'s). A generator is different, in that it can be looped over, like a list or tuple (it's <em>iterable</em>), and as you loop over it, it calls your function each time, going back to the same point over and over, until it returns. That point is marked by using the special <tt class="docutils literal">yeild</tt> keyword.</p>
<p>Here's how a color cycling function might look, implemented as a generator:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span>   <span class="p">((</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>        <span class="c1"># red</span>
            <span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>      <span class="c1"># orange-red</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># orange</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># yellow</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>        <span class="c1"># green</span>
            <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>     <span class="c1"># blue-green</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>        <span class="c1"># blue</span>
            <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">130</span><span class="p">),</span>       <span class="c1"># indigo</span>
            <span class="p">(</span><span class="mi">139</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>      <span class="c1"># violet</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>    <span class="c1"># white</span>

<span class="k">def</span> <span class="nf">cycle_colors</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">color</span>

<span class="n">cycled_colors</span> <span class="o">=</span> <span class="n">cycle_colors</span><span class="p">()</span>
</pre></div>
</td></tr></table></div><p>We can use the built-in function <tt class="docutils literal">next()</tt> to get the next color in the cycle, <em>for ever</em>. It will always start back at the beginning - once the colors have all been returned, the <tt class="docutils literal">while</tt> loop starts the process all over again.</p>
<p>Here's how it looks, interacting with it in the console:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(255, 0, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(226, 87, 30)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(255, 127, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(255, 255, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(0, 255, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(150, 191, 51)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(0, 0, 255)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(75, 0, 130)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(139, 0, 255)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(255, 255, 255)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(255, 0, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">cycled_colors</span><span class="p">)</span>
<span class="go">(226, 87, 30)</span>
</pre></div>
</td></tr></table></div><p class="last">So why didn't we do it this way? It seems way more elegant, right? Well, this doesn't work well in CircuitPython 💔 . I very quickly ran out of memory when I implemented the generator this way. There are many possible explanations for this, but I bring this all up because generators are <em>awesome</em> and you should learn about them, but more importantly, it's an illustration of where the limitations of the platform start to affect how you design and implement your projects.</p>
</div>
<p>This iteration brings the following notable changes:</p>
<ul class="simple">
<li>We've brought in logic to cover pressing both buttons. This required adding a handler for the <em>press</em> event, and the addition of the <tt class="docutils literal">both</tt> state variable.</li>
<li>The possible colors have been stored in a tuple of tuples called <tt class="docutils literal">colors</tt>.</li>
<li>We're rotating through the colors using a method of the state object called <tt class="docutils literal">cycle_color()</tt>. It uses a new state variable, <tt class="docutils literal">_color_index</tt> to keep track of the location within the <tt class="docutils literal">color</tt> tuple of the color that was last used. <tt class="docutils literal">cycle_color()</tt> resets <tt class="docutils literal">_color_index</tt> to zero when it reaches the maximum index of <tt class="docutils literal">colors</tt>.</li>
<li>We're using <a class="reference external" href="https://learn.adafruit.com/fancyled-library-for-circuitpython/overview">FancyLED</a> to adjust the colors to better reflect our expectations. It has a lot more functionality than that, we're just scratching the surface.</li>
</ul>
<p>And the requisite video of this code in action on my Trinket M0:</p>
<div class="video-container">
<video controls="">
<source src="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-04.mp4" type="video/mp4"/>
<p>Your browser doesn't support HTML5 video. Here is
          a <a href="/videos/non-blocking-events-circuitpython/blink-controller-demo-trinket-04.mp4">link to the video</a> instead.</p>
</video>
</div></div>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>Now, we've added some very complex functionality to our project without having to write a lot of complex code. Further, we're not blocking to handle button debounce.</p>
<p>Ultimately, what we've learned here is a very useful <em>pattern</em> for writing embedded applications. Resist the urge to just grab the <tt class="docutils literal">ButtonDispatch</tt> class and use it without thinking about your use case. Implement your own version that only does what you need.</p>
<p>The last section outlines strategies to deal with running out of memory. As discussed earlier, memory can be a scarce resource on the CircuitPython platform, and while we've constructed quite a slick, neat codebase, we've added a lot of code to the mix that will eat into our available memory. You will run into memory issues with CircuitPython, it's just a matter of time, but using state the way we have, abstracting it away into really nice classes, can make that happen a little sooner than if we hadn't.</p>
</div>
</div>
<div class="section" id="what-to-do-when-you-run-out-of-memory">
<h2 id="what-to-do-when-you-run-out-of-memory">What To Do When You Run Out Of Memory</h2>
<p>Occasionally, especially as a project grows in complexity, you will run into an exception:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="go">#Traceback (most recent call last):</span>
<span class="go">  File "code.py", line 122, in &lt;module&gt;</span>
<span class="go">MemoryError: memory allocation failed, allocating 4096 bytes</span>
</pre></div>
</td></tr></table></div><p>This happens when you have exhausted the available memory on your CircuitPython board. As discussed earlier, running Python on a microcontroller comes at a cost, and the biggest cost is reduced memory available for your programs.</p>
<p>This section covers some strategies that can help reduce your memory footprint.</p>
<p>The most prominent way to reduce memory usage is using less code, since lines of code are the biggest consumers of memory.</p>
<p>Note that the optimizations discussed here almost all put limitations on your code, and shouldn't be used without need, or careful consideration.</p>
<p>That brings up a really important point, and something that a lot of new programmers don't learn early enough: be careful not to fall into a common programming trap: <em>pre-emptive optimization</em>.</p>
<p>Typically, you'll only need to optimize for memory consumption when you see the dreaded <tt class="docutils literal">MemoryError</tt> exception. It can be stressful - you think you have completed your project, or found the perfect library to add the functionality you need and <em>wham</em>, you're out of memory. But resist the temptation to try to head this off by obsessing about memory consumption before you actually run out.</p>
<p>Most of the time, its best to focus on finishing your project, not solving problems you don't have!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have other tips or tricks, or improvements to the techniques explored below, please <a class="reference external" href="/pages/contact.html">contact the author!</a>.</p>
</div>
<p>For comparison's sake, we're using the following code to test:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">state</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>On my GEMMA M0, it prints <tt class="docutils literal">8944</tt> when it starts up. That's the number we'll be comparing other approaches to.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is including our <a class="reference internal" href="#abstractions-keeping-the-code-simple">setup.py module</a> - so we're also loading the DotStar library and setting up both buttons, even though neither are necessary for this code.</p>
</div>
<p>Bear in mind though that these comparisons are just to ensure we're <em>actually</em> saving memory, it's not an evaluation of the effectiveness of a particular approach. The amount of savings and how significant it might be will entirely depend on your specific situation.</p>
<p>Also keep in mind that memory is periodically cleaned up. Every so often the so-called "garbage collector" clears unused values and temporary variables from memory. So over time, the amount of memory you use can and will change.</p>
<p>However, we don't have to think about that <em>too</em> much in our case, since our state objects will not typically change in a way that the garbage collector will affect - we're just replacing the initial values as the state changes. So checking the memory consumption at start up will give us an adequate amount of insight into how memory-intensive our state object might be.</p>
<div class="section" id="keeping-an-eye-on-memory-consumption">
<h3>Keeping An Eye On Memory Consumption</h3>
<p>We can use the <tt class="docutils literal">gc</tt> module to tell us how much memory our project is using. The function we care about is <tt class="docutils literal">gc.mem_free()</tt>.</p>
<p>This will be a fairly static value in most cases, so you can just print it before the main loop:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>

<span class="o">...</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="o">...</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="use-more-efficient-data-types-or-don-t-use-a-state-object-heartbreak">
<h3>Use More Efficient Data Types (or: Don't Use A State Object 💔)</h3>
<p>One of the more drastic, ways of slashing memory use is to switch from using an instance of a custom state class to using other data structures. Lets start with simple variables:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="n">state_button</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">state_led</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">state_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state_button</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state_checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">state_button</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">state_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state_button</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state_checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">state_button</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">state_checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state_button</span><span class="p">:</span>
        <span class="n">state_led</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state_led</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">state_led</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>This uses 9888 bytes of memory on my GEMMA. This approach gets messy quickly, but is still pretty easy to read.</p>
<p>Lets try a method that's a bit less readable but should save some memory: we'll use a single list to store our state:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="c1">#        button   led      checkin</span>
<span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span>   <span class="bp">False</span><span class="p">,</span>   <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()]</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

    <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>Using a list instead, my GEMMA reports 9984 bytes of free memory.</p>
<p>Here's what the same code looks like using a dictionary. It uses a tiny bit more memory, but it's quite a bit more readable:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"button"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"led"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s2">"checkin"</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">"button"</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="s2">"checkin"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">"button"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">"checkin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">"button"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="s2">"checkin"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">"button"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">"checkin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

    <span class="n">state</span><span class="p">[</span><span class="s2">"led"</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"button"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">"led"</span><span class="p">]:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>The dictionary version leaves 9808 bytes of free RAM.</p>
<p>For simple state like this, using a dictionary is probably the best way to go. If other parts of your project are memory intensive, or you need to use a lot of heavy third-party libraries, it's better to use less elegant code to deal with state than detract from core functionality.</p>
<p>CircuitPython and Python-proper provide other data structures that <em>may</em> save some memory, depending on the circumstances.</p>
<p>The one worth taking a look at is the <tt class="docutils literal">array</tt>. Python lists are dynamic - they can contain any kind of value: strings, integers, other lists, dictionaries, objects, anything.</p>
<p>Arrays are different. The <tt class="docutils literal">array.array</tt> class provides a more memory efficient kind of list that can only contain one type of data.</p>
<p>Here's our same state code, refactored to use an array of <em>unsigned short integers</em>:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="c1">#                         button   led      checkin</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">"H"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)])</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

    <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>My GEMMA reports <tt class="docutils literal">9760</tt> bytes of free memory. That's over 100 bytes <em>worse</em> than the dictionary version. However, some of that is due simply to the extra code brought in with the <tt class="docutils literal">array</tt> module. The savings might add up with more complex projects, especially when tracking many more state values.</p>
<p>Finally, we can try using what's called a <em>bitmask</em>. This is mostly useful for storing boolean values - things that can be either <tt class="docutils literal">True</tt> or <tt class="docutils literal">False</tt>.</p>
<p>Bits are the building blocks of all data and logic in computing. A bit represents a single binary value - 1 or 0. This equates to true or false, on or off, up or down, etc.</p>
<p>You can make larger number by arranging the 1's and 0's in sequence, just like decimal (base 10) numbers - except instead of using the numbers between 0 and 9, you can only use 0 or 1.</p>
<p>For example, the decimal number <strong>15</strong> has a 1 in the "tens" place, and a 5 in the "ones" place. 15 is 10 + 5.</p>
<p>The number 15 in binary is <strong>1111</strong>. There's a 1 in the ones place, a 1 in the <em>twos</em> place, a 1 in the <em>fours</em> place, and a 1 in the <em>eights</em> place. 1111 is 15, because 8 + 4 + 2 + 1 = 15.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The nuances and amazing properties of the binary number system and doing binary math is beyond the scope of this article.</p>
<p>Here are a couple of videos worth checking out that explain things:</p>
<p><strong>TBD: more/better explanations!!!</strong></p>
<ul class="last simple">
<li><a class="reference external" href="https://youtu.be/kcTwu6TFZ08">James May's Q&amp;A (Ep 11100)</a></li>
</ul>
</div>
<p>You can treat a binary number like an array of switches, and using binary math, flip each switch (bit) on or off to indicate a true or false state. This way you can store 32 state values in a single 32-bit integer. One variable that takes up as much space as the number 15 can store up to <em>32 values</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The exact number of possible values depends on how Python is storing the number and the specific platform you are running on.</p>
<p class="last">It's also unclear if using the same number of variables with Python's booleans (<tt class="docutils literal">True</tt>/<tt class="docutils literal">False</tt>) is less efficient.</p>
</div>
<p>The basic technique is to use what's called a "bitwise and" operation (in python we use the <tt class="docutils literal">&amp;</tt> symbol) - you give it two numbers, and it will return a number where all of its bits are the product of a logical "and" - if a bit is 0 in the first number, and 0 in the second, that bit will be 0 in the result. If a bit is 1 in the first number, and 0 in the second, the bit will be 0 in the result. If a bit is 1 in the first number and 1 in the second, the bit will be 1 in the result.</p>
<p>This ends up giving us a value that will be 0 if the bit we are interested in is 0, and something bigger than zero (depending on the location of the bit) if the bit is 1. This is something we can treat as a boolean value. It acts like a filter, giving us only the bits we have indicated as relevant in the second number.</p>
<p>Then, to change the bits (update our state), we use three different techniques:</p>
<ol class="arabic simple">
<li>We use the "exclusive or" (xor) bitwise operator <tt class="docutils literal">^</tt> to "flip" a bit - given two numbers, the xor operator will return number where, if there's a 1 in a given position in both numbers, a 0 will be set, otherwise, 1 will be set.</li>
<li>We use "bitwise or" (<tt class="docutils literal">|</tt>) to <em>set</em> a specific bit. Given two numbers, bitwise or returns a number where, if there's a 1 in a given position in either number, a 1 will be set. If there's a 1 in both numbers, or a 0 in both numbers, a 0 will be set.</li>
<li>We use a combination of "bitwise and" and "bitwise negation" (<tt class="docutils literal">&amp;</tt> and <tt class="docutils literal">~</tt>) to <em>unset</em> a specific bit. Negation will invert every bit (<tt class="docutils literal">0110</tt> becomes <tt class="docutils literal">1001</tt>), and bitwise and acts as our filter as explained earlier.</li>
</ol>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="c1"># 0b10 = button</span>
<span class="c1"># 0b01 = led</span>
<span class="n">state</span> <span class="o">=</span> <span class="mb">0b00</span>

<span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mb">0b10</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">^</span> <span class="mb">0b10</span>
            <span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mb">0b10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">^</span> <span class="mb">0b10</span>
            <span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mb">0b10</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">|</span> <span class="mb">0b01</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mb">0b01</span>

    <span class="k">if</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mb">0b01</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><p>So this also doesn't seem to save us much memory. My GEMMA reports ﻿9872 bytes free. However this could be much more significant if we were tracking many, many boolean values.</p>
</div>
<div class="section" id="drop-features">
<h3>Drop Features</h3>
<p>Sometimes you will have to give up some functionality in order to work within the limitations of your platform.</p>
<p>Start with the lowest priority features - the once you might call "nice to have".</p>
<p>Sometimes you can change the project's scope, instead of dropping features. Try not to do too much. Remove unnecessary flexibility.</p>
<p>An example: you have a component (a potentiometer or something) that lets the user control the brightness of an LED, and you're running out of memory.</p>
<p>Some things to ask yourself:</p>
<ul class="simple">
<li>Is it really necessary to control the brightness dynamically?</li>
<li>Could the brightness be controlled through some other means that would require less code?</li>
<li>Is the logic controlling it overly complex?</li>
<li>Is it too user friendly?</li>
<li>Am I using a library for the pot to function that I could implement differently?</li>
</ul>
</div>
<div class="section" id="pre-calculate-values">
<h3>Pre-calculate Values</h3>
<p>Using external libraries is a big source of extraneous code that can eat into our available memory.</p>
<p>Sometimes we're using an external library just to calculate a value that doesn't change, or isn't based on anything that couldn't be reduced to a fixed set of values.</p>
<p>Here's an example that flashes the RGB LED instead of the red one, changing the color every time. This version uses the <a class="reference external" href="https://learn.adafruit.com/fancyled-library-for-circuitpython/overview">FancyLED</a> library to do the math:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure you have copied <tt class="docutils literal">adafruit_fancyled</tt> folder to the <tt class="docutils literal">lib</tt> directory on your CircuitPython board.</p>
</div>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">adafruit_fancyled.adafruit_fancyled</span> <span class="kn">as</span> <span class="nn">fancy</span>

<span class="k">def</span> <span class="nf">random_color</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="o">*</span><span class="n">random_color</span><span class="p">()),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">state</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</td></tr></table></div><p>So every time we press the button, we get a new, random, gamma-corrected color on our DotStar.</p>
<p>But you will notice that the remaining RAM is pretty low, at 2752 bytes.</p>
<p>How do we keep the same basic functionality while reducing our memory usage, using pre-calculation?</p>
<p>First, lets reduce our scope a little bit. Do we really need <em>any</em> random color in the whole possible range? No, and in fact, most of the colors in the range are not super pretty or very bright, and a lot aren't that different from each other.</p>
<p>To solve that problem, lets establish a fixed set of colors we like, and only choose one of them at random.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -- snip --</span>

<span class="n">colors</span> <span class="o">=</span>   <span class="p">((</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># red</span>
            <span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>    <span class="c1"># orange-red</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># orange</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># yellow</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>      <span class="c1"># green</span>
            <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>   <span class="c1"># blue-green</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>      <span class="c1"># blue</span>
            <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">130</span><span class="p">),</span>     <span class="c1"># indigo</span>
            <span class="p">(</span><span class="mi">139</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>    <span class="c1"># violet</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>  <span class="c1"># white</span>

<span class="k">def</span> <span class="nf">random_color</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

<span class="c1"># -- snip --</span>
</pre></div>
</td></tr></table></div><p>Now, we've limited ourselves to only 10 colors, but our available RAM has gone up to 4688 bytes, and we haven't even done any real pre-calculation yet!</p>
<p>Next, you may note that all FancyLED is doing for us is some math, and that math really won't change - the variables involved are our color and the brightness level, and all of those values are fixed.</p>
<p>So instead of doing those calculations on the fly, we can instead do them ahead of time, and eliminate the FancyLED library altogether.</p>
<p>To precalculate the values, we can use a quick script that just prints them out for us:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">adafruit_fancyled.adafruit_fancyled</span> <span class="kn">as</span> <span class="nn">fancy</span>

<span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s2">"white"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"violet"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">148</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">211</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"purple"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"blue_green"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"green"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"orange_red"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"orange"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()),</span>
    <span class="p">(</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">fancy</span><span class="o">.</span><span class="n">gamma_adjust</span><span class="p">(</span><span class="n">fancy</span><span class="o">.</span><span class="n">CRGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">brightness</span><span class="o">=</span><span class="n">brightness</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">())</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"colors = ("</span><span class="p">)</span>
<span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"{:&gt;10},    # {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">")"</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>Now we can run this on our board, and copy what we see in the console into our code. We can then remove the dependency on FancyLED.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">check</span>

<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">adafruit_fancyled.adafruit_fancyled</span> <span class="kn">as</span> <span class="nn">fancy</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">(</span>
       <span class="mi">8421504</span><span class="p">,</span>    <span class="c1"># white</span>
       <span class="mi">1900620</span><span class="p">,</span>    <span class="c1"># violet</span>
       <span class="mi">8388736</span><span class="p">,</span>    <span class="c1"># purple</span>
           <span class="mi">128</span><span class="p">,</span>    <span class="c1"># blue</span>
       <span class="mi">1980929</span><span class="p">,</span>    <span class="c1"># blue_green</span>
         <span class="mi">32768</span><span class="p">,</span>    <span class="c1"># green</span>
       <span class="mi">8388608</span><span class="p">,</span>    <span class="c1"># red</span>
       <span class="mi">6031104</span><span class="p">,</span>    <span class="c1"># orange_red</span>
       <span class="mi">8395008</span><span class="p">,</span>    <span class="c1"># orange</span>
       <span class="mi">8421376</span><span class="p">,</span>    <span class="c1"># yellow</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">random_color</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">random_color</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">button</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">state</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</td></tr></table></div><p>This version of the code shows 8480 bytes free - a really big improvement.</p>
<p>You can take this approach a lot further than you might think. Brightness is a factor in Fancy's gamma correction algorithm. Lets say your project lets the user adjust brightness. Instead of calculating the gamma on the fly, if you use a fixed set of brightness levels, you can precalculate every possible color/brightness combination, and store them in a list of tuples, or a tuple for every brightness level.</p>
<p>It can seem like a lot of data, but tuples of integers are really compact.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The <a class="reference external" href="https://circuitpython.readthedocs.io/en/3.x/docs/library/array.html">array module</a> can be used to even <em>more</em> efficiently store your precalculated values.</p>
</div>
<p>You will always have to balance memory used for lines of code verses memory used to store pre-calculated values, but it's a great way to save memory.</p>
</div>
<div class="section" id="compile-modules-into-mpy-files">
<h3>Compile Modules Into MPY Files</h3>
<p>MicroPython provides a tool called <tt class="docutils literal"><span class="pre">mpy-cross</span></tt> that can take a python module and compile it into an intermediate form that takes up less memory. These files have the <tt class="docutils literal">.mpy</tt> suffix.</p>
<p>Adafruit has just recently begun distributing a precompiled version of this tool with new versions of CircuitPython.</p>
<p>To compile your code, you will first need to download the appropriate version of <tt class="docutils literal"><span class="pre">mpy-cross</span></tt> from <a class="reference external" href="https://github.com/adafruit/circuitpython/releases/">the distribution page</a>, for both your operating system and the version of CircuitPython you are using.</p>
<p>Place the tool in a directory in your <tt class="docutils literal">$PATH</tt>, or some place where you will be able to access it. You may need to make it executable (<tt class="docutils literal">chmod +x</tt>).</p>
<p>Once you have the tool, you will want to move some of your code into a separate module, and then import it into <tt class="docutils literal">code.py</tt>.</p>
<p>Given the example we've been using, you could break it up into the following files:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as state.py</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">(</span>
       <span class="mi">8421504</span><span class="p">,</span>    <span class="c1"># white</span>
       <span class="mi">1900620</span><span class="p">,</span>    <span class="c1"># violet</span>
       <span class="mi">8388736</span><span class="p">,</span>    <span class="c1"># purple</span>
           <span class="mi">128</span><span class="p">,</span>    <span class="c1"># blue</span>
       <span class="mi">1980929</span><span class="p">,</span>    <span class="c1"># blue_green</span>
         <span class="mi">32768</span><span class="p">,</span>    <span class="c1"># green</span>
       <span class="mi">8388608</span><span class="p">,</span>    <span class="c1"># red</span>
       <span class="mi">6031104</span><span class="p">,</span>    <span class="c1"># orange_red</span>
       <span class="mi">8395008</span><span class="p">,</span>    <span class="c1"># orange</span>
       <span class="mi">8421376</span><span class="p">,</span>    <span class="c1"># yellow</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">random_color</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button pressed"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="ow">and</span> <span class="n">check</span><span class="p">(</span><span class="s2">"A"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">random_color</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Button released"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div><div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># save as code.py</span>
<span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">setup</span> <span class="kn">import</span> <span class="n">led</span><span class="p">,</span> <span class="n">rgb</span>

<span class="kn">from</span> <span class="nn">state</span> <span class="kn">import</span> <span class="n">State</span>

<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">state</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">color</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</td></tr></table></div><p>Be careful to import any necessary libraries in your new module.</p>
<p>Next, you use the <tt class="docutils literal"><span class="pre">mpy-cross</span></tt> tool to convert your code into an mpy file.</p>
<p>It's a good idea to set up a special working directory for this purpose, there isn't a tool to "decompile" the code, and you will want to delete the original module from your board.</p>
<p>The process, in the terminal on a MacOS computer, looks like this:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/circuitpython-working
<span class="gp">$</span> cp /Volumes/CIRCUITPY/state.py ~/circuitpython-working
<span class="gp">$</span> <span class="nb">cd</span> ~/circuitpython-working
<span class="gp">$</span> mpy-cross state.py
<span class="gp">$</span> rm /Volumes/CIRCUITPY/state.py
<span class="gp">$</span> mv state.mpy /Volumes/CIRCUITPY/
</pre></div>
</td></tr></table></div><p>Before compiling the module, <tt class="docutils literal">gc.mem_free()</tt> returned 8160 bytes. After, it returns 8048. I'm not sure why this happened, I believe its because there are so many extra modules because of our <tt class="docutils literal">setup.py</tt> abstraction to make working with multiple boards in the examples easier.</p>
<p>You will typically see a difference, especially when compiling more complex code.</p>
<p>This is best saved for code that is really solid, since you can no longer edit the code right on your board.</p>
</div>
<div class="section" id="avoid-operations-that-create-temporary-variables">
<h3>Avoid Operations That Create Temporary Variables</h3>
<p>There are many places where Python will create a temporary variable. Temporary variables are used for only an instant, but can persist for a while before they are garbage collected.</p>
<p>Further, if the temporary variable is large or complex, it can eat up a lot of memory.</p>
<p>A few common places we'll discuss here are <em>string addition</em> and <em>list slicing</em>.</p>
<p>Strings are <em>immutable</em>, which means that they cannot be changed. String operations always return a new string, they never alter the string <em>in place</em>.</p>
<p>There are several ways you can combine strings in Python.</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>

<span class="n">free</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">()</span>

<span class="c1"># string interpolation (classic way)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"memory free </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">free</span><span class="p">,))</span>

<span class="c1"># format() method (newer way)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"memory free {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">free</span><span class="p">))</span>

<span class="c1"># string addition</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"memory free "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">free</span><span class="p">))</span>

<span class="c1"># multiple parameters to print()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"memory free"</span><span class="p">,</span> <span class="n">free</span><span class="p">)</span>
</pre></div>
</td></tr></table></div><p>The first two ways avoid excess memory issues. String addition creates an implicit temporary variable. It's worse here, since we also have to do a conversion ourselves from the int we have to a string.</p>
<p>I also included the last way, which isn't technically combining strings, but might not be obvious if you aren't familiar with modern Python: the <tt class="docutils literal">print()</tt> function takes a variable number of arguments, and it will print each one separated by a space.</p>
<p>The last version is the most memory efficient, especially if all your doing is printing some debugging text to the console.</p>
<p>The NeoPixel library supports all of the fancy slicing and other special indexing capabilities of Python's <tt class="docutils literal">list</tt>. However, behind the scenes using those features can be memory intensive.</p>
<p>Here's a simple "chaser" light display using all 10 NeoPixels on the CircuitPlayground Express, using slicing:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">neopixel</span>

<span class="n">rgb</span> <span class="o">=</span> <span class="n">neopixel</span><span class="o">.</span><span class="n">NeoPixel</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">NEOPIXEL</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">auto_write</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="kn">import</span> <span class="nn">gc</span>

<span class="n">black</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">white</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">rgb</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">]</span>
    <span class="n">rgb</span><span class="p">[::</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">]</span>
    <span class="n">rgb</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">rgb</span><span class="p">[::</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">white</span><span class="p">]</span>
    <span class="n">rgb</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">black</span><span class="p">]</span>
    <span class="n">rgb</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>
</pre></div>
</td></tr></table></div><p>The solution, if this becomes an issue, is to assign a color to each index  directly:</p>
<div class="highlight-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">neopixel</span>

<span class="n">rgb</span> <span class="o">=</span> <span class="n">neopixel</span><span class="o">.</span><span class="n">NeoPixel</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">NEOPIXEL</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">auto_write</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">rgb</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="kn">import</span> <span class="nn">gc</span>

<span class="n">black</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">white</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span>
    <span class="n">rgb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">white</span>
    <span class="n">rgb</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">())</span>
</pre></div>
</td></tr></table></div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>While this fixed a memory issue I had in the past, I can't make sense of the readings I get from <tt class="docutils literal">gc.mem_free()</tt> - the amount of available memory slowly winds down with each loop until the garbage collector runs and its recovered.</p>
<p class="last">This will require more research 🤔.</p>
</div>
</div>
<div class="section" id="remove-debugging-comments">
<h3>Remove Debugging/Comments</h3>
<p>Any line of code counts toward your memory count. Removing the two debugging print statements in the sample above saved 96 bytes of memory.</p>
<p>This technique should be left as a final pass step, after you've exhausted other ideas and your code is solid. Most of the time you won't have your CircuitPython board connected to a computer, so printing to the console is useless. However, during development, or when debugging, console access is a necessity. Working around a few helpful debugging statements is worth it so you have the memory overhead available to make fixing a problem easier.</p>
</div>
<div class="section" id="offload-to-external-boards-ics">
<h3>Offload To External Boards/ICs</h3>
<p>Sometimes trying to do too much on one microcontroller is just <em>too much</em>. So finding another component, IC, or even another microcontroller to offload the work to is a very viable option.</p>
<p>A good example is audio. On the M0/M4 boards, it's possible to play 16-bit monaural audio samples. It's a great feature to have built-in. However, audio samples are large, and playing them takes up a lot of memory that you may need for other tasks.</p>
<p>Luckily, you can get sound boards like the Adafruit AudioFX series to play  audio clips by writing to digital pins - all the loading and DAC work is done by the sound board, and that frees up your main M0 board for other things.</p>
<p>There are other applications involving driving LEDs, controlling LCD displays, handling large amounts of NeoPixels, and so on.</p>
<p>Frequently boards will communicate via I2C or SPI. You can implement those protocols yourself to get two M0 boards to talk to each other, sharing the load of your project.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I hope to explore cross-board communication with I2C and SPI in depth in a future blog post!</p>
</div>
</div>
<div class="section" id="switch-to-arduino">
<h3>Switch To Arduino</h3>
<p>Finally, there are times when your application is just too much for the CircuitPython platform. That's where the Arduino toolchain comes into play.</p>
<p>You can program your M0/M4 boards using the Arduino IDE just like any other compatible board. Most Arduino sketches will work without modification.</p>
<p>Adafruit has an <a class="reference external" href="https://learn.adafruit.com/adafruit-feather-m0-basic-proto/using-with-arduino-ide">overview of the process</a> of getting set up, as well as some <a class="reference external" href="https://learn.adafruit.com/adafruit-feather-m0-basic-proto/adapting-sketches-to-m0">porting notes</a> for running Arduino sketches on the M0/M4 series boards.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The links above are in the documentation for a specific product, the <a class="reference external" href="https://www.adafruit.com/product/2772">Feather M0 Basic Proto</a>, but they are completely generic. Sadly, they were the only docs the author could find at the time of writing. 💔</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The author has not had a chance to do much with M0 boards and the Arduino IDE yet, but hopes to explore the topic thoroughly in a future blog post. A gentle <a class="reference external" href="/pages/contact.html">shout out</a> might motivate him to do so sooner rather than later 😉.</p>
</div>
</div>
<div class="section" id="refactor-state-logic-into-dispatcher">
<h3>Refactor State Logic Into Dispatcher</h3>
<ul class="simple">
<li>Instead of passing the event handlers as functions, we can instead implement them as overrides in a in herited class.</li>
<li>Generalize the code even more - hard-code the event handlers inside of the <tt class="docutils literal">ButtonDispatch</tt> class based on the token.</li>
</ul>
</div>
<div class="section" id="use-ints-instead-of-strings">
<h3>Use ints instead of strings</h3>
<ul class="simple">
<li>instead of "BUTTON1", set BUTTON1 = 1</li>
</ul>
</div>
<div class="section" id="use-const">
<h3>Use const()</h3>
</div>
</div>
</div><!-- /.entry-content -->
</section>
</div>
<footer class="body" id="contentinfo">
<div id="footer-text-wrapper">
<div id="footer-text">&copy; 2018 Josh Johnson. All Rights Reserved. <a href="/pages/about.html">About</a></div>
</div>
</footer>
<script src="/theme/js/main.js"></script>
</body>
</html>